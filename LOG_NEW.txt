🎛️ Configurazioni AI saranno salvate su DATABASE MySQL
🎛️ AIConfigurationService inizializzato
   � Backend: DATABASE MySQL
   🔑 OpenAI API Key: ✅ Configurata
🏭 EmbeddingEngineFactory inizializzata
🎯 EmbeddingManager inizializzato
🚀 UMAP disponibile per riduzione dimensionale!
🚀 cuML GPU clustering disponibile!
💥 EmbeddingDestroyer inizializzato - Ready to destroy and rebuild!
🎯 SimpleEmbeddingManager inizializzato
✅ Blueprint esempi inizializzato correttamente
🔄 [LLMConfigService] Configurazione ricaricata
🔧 [LLMConfigService] Servizio inizializzato con config: /home/ubuntu/classificatore/config.yaml
🚀 Avvio server Flask - Debug: True
 * Serving Flask app 'server'
 * Debug mode: on
🔍 [DEBUG] GET /api/tenants - Avvio richiesta tenant con oggetti Tenant
🔍 [DEBUG] Chiamo get_available_tenants() per oggetti Tenant...
🏢 Recuperati 22 oggetti Tenant dalla tabella TAG.tenants
🔍 [DEBUG] Recuperati 22 oggetti Tenant dal database
🔍 [DEBUG] Primi 3 tenant convertiti: [{'tenant_id': 'a0fd7600-f4f7-11ef-9315-96000228e7fe', 'tenant_name': 'Alleanza', 'tenant_slug': 'alleanza', 'is_active': True}, {'tenant_id': '6bc4f06f-742e-11f0-acb8-96000228e7fe', 'tenant_name': 'BluPantheon', 'tenant_slug': 'blupantheon', 'is_active': True}, {'tenant_id': '0f9d6e90-d319-11ef-86a5-96000228e7fe', 'tenant_name': 'Boots', 'tenant_slug': 'boots', 'is_active': True}]
🔍 [DEBUG] Invio risposta con 22 tenant
🔍 [DEBUG] GET review cases per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] GET /api/tenants - Avvio richiesta tenant con oggetti Tenant
🔍 [DEBUG] Chiamo get_available_tenants() per oggetti Tenant...
🔍 [DEBUG] GET /api/prompts/a0fd7600-f4f7-11ef-9315-96000228e7fe/status - Avvio richiesta
🔍 [DEBUG] API: Recupero status prompt per tenant: a0fd7600-f4f7-11ef-9315-96000228e7fe
✅ [DEBUG] Riconosciuto come tenant_id UUID: a0fd7600-f4f7-11ef-9315-96000228e7fe
🔍 [DEBUG] Inizializzo PromptManager...
🔍 [DEBUG] Creo oggetto Tenant da a0fd7600-f4f7-11ef-9315-96000228e7fe...
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ [DEBUG] Tenant risolto: Humanitas (humanitas)
🔍 [DEBUG] Ottieni mongo reader per tenant: humanitas
🔧 Creazione MongoClassificationReader per cliente: humanitas
🔍 Risoluzione tenant da slug: humanitas
🏢 Recuperati 22 oggetti Tenant dalla tabella TAG.tenants
🔍 [DEBUG] Recuperati 22 oggetti Tenant dal database
🔍 [DEBUG] Primi 3 tenant convertiti: [{'tenant_id': 'a0fd7600-f4f7-11ef-9315-96000228e7fe', 'tenant_name': 'Alleanza', 'tenant_slug': 'alleanza', 'is_active': True}, {'tenant_id': '6bc4f06f-742e-11f0-acb8-96000228e7fe', 'tenant_name': 'BluPantheon', 'tenant_slug': 'blupantheon', 'is_active': True}, {'tenant_id': '0f9d6e90-d319-11ef-86a5-96000228e7fe', 'tenant_name': 'Boots', 'tenant_slug': 'boots', 'is_active': True}]
🔍 [DEBUG] Invio risposta con 22 tenant
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Alleanza (alleanza) UUID=a0fd7600-f4f7-11ef-9315-96000228e7fe
✅ [DEBUG] Tenant risolto: Alleanza (a0fd7600-f4f7-11ef-9315-96000228e7fe)
🔍 [DEBUG] Chiamo get_all_prompts_for_tenant con oggetto Tenant...
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto da slug (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da slug: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
✅ MongoClassificationReader creato per tenant: Humanitas (humanitas)
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
✅ Connesso a MongoDB database: classificazioni
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🔍 Review Queue recuperate 0 sessioni (representatives: True, propagated: True, outliers: True)
🏷️ Recupero etichette per tenant: Humanitas
🔍 [DEBUG] Recuperati 5 prompt dal PromptManager
🔍 [DEBUG] Statistiche: 5/5 attivi, 0 inattivi
✅ [DEBUG] Status calcolato: {'success': True, 'tenant_id': 'a0fd7600-f4f7-11ef-9315-96000228e7fe', 'tenant_name': 'Alleanza', 'total_prompts': 5, 'active_prompts': 5, 'inactive_prompts': 0, 'last_updated': '2025-08-25T08:54:43', 'status': 'ready', 'canOperate': True, 'requiredPrompts': [{'name': 'System Prompt', 'type': 'system', 'description': 'Prompt di sistema per la classificazione', 'exists': True}, {'name': 'User Template', 'type': 'user', 'description': 'Template per prompt utente', 'exists': True}, {'name': 'Classification Prompt', 'type': 'classification', 'description': 'Prompt per classificazione intelligente', 'exists': False}], 'missingCount': 1}
✅ [DEBUG] Status prompt per tenant_id a0fd7600-f4f7-11ef-9315-96000228e7fe: 5/5 attivi
🔍 [DEBUG] Invio risposta JSON per status prompt
📊 Calcolo statistiche per tenant: Humanitas
🔍 [DEBUG] GET /api/prompts/a0fd7600-f4f7-11ef-9315-96000228e7fe/status - Avvio richiesta
🔍 [DEBUG] API: Recupero status prompt per tenant: a0fd7600-f4f7-11ef-9315-96000228e7fe
✅ [DEBUG] Riconosciuto come tenant_id UUID: a0fd7600-f4f7-11ef-9315-96000228e7fe
🔍 [DEBUG] Inizializzo PromptManager...
🔍 [DEBUG] Creo oggetto Tenant da a0fd7600-f4f7-11ef-9315-96000228e7fe...
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Alleanza (alleanza) UUID=a0fd7600-f4f7-11ef-9315-96000228e7fe
✅ [DEBUG] Tenant risolto: Alleanza (a0fd7600-f4f7-11ef-9315-96000228e7fe)
🔍 [DEBUG] Chiamo get_all_prompts_for_tenant con oggetto Tenant...
🔍 [DEBUG] Recuperati 5 prompt dal PromptManager
🔍 [DEBUG] Statistiche: 5/5 attivi, 0 inattivi
✅ [DEBUG] Status calcolato: {'success': True, 'tenant_id': 'a0fd7600-f4f7-11ef-9315-96000228e7fe', 'tenant_name': 'Alleanza', 'total_prompts': 5, 'active_prompts': 5, 'inactive_prompts': 0, 'last_updated': '2025-08-25T08:54:43', 'status': 'ready', 'canOperate': True, 'requiredPrompts': [{'name': 'System Prompt', 'type': 'system', 'description': 'Prompt di sistema per la classificazione', 'exists': True}, {'name': 'User Template', 'type': 'user', 'description': 'Template per prompt utente', 'exists': True}, {'name': 'Classification Prompt', 'type': 'classification', 'description': 'Prompt per classificazione intelligente', 'exists': False}], 'missingCount': 1}
✅ [DEBUG] Status prompt per tenant_id a0fd7600-f4f7-11ef-9315-96000228e7fe: 5/5 attivi
🔍 [DEBUG] Invio risposta JSON per status prompt
🔍 [DEBUG] GET review cases per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] GET /api/prompts/015007d9-d413-11ef-86a5-96000228e7fe/status - Avvio richiesta
🔍 [DEBUG] API: Recupero status prompt per tenant: 015007d9-d413-11ef-86a5-96000228e7fe
✅ [DEBUG] Riconosciuto come tenant_id UUID: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Inizializzo PromptManager...
🔍 [DEBUG] Creo oggetto Tenant da 015007d9-d413-11ef-86a5-96000228e7fe...
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ [DEBUG] Tenant risolto: Humanitas (humanitas)
🔍 [DEBUG] Ottieni mongo reader per tenant: humanitas
🔧 Creazione MongoClassificationReader per cliente: humanitas
🔍 Risoluzione tenant da slug: humanitas
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ [DEBUG] Tenant risolto: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 [DEBUG] Chiamo get_all_prompts_for_tenant con oggetto Tenant...
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto da slug (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da slug: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
✅ MongoClassificationReader creato per tenant: Humanitas (humanitas)
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
✅ Connesso a MongoDB database: classificazioni
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🔍 Review Queue recuperate 0 sessioni (representatives: True, propagated: True, outliers: True)
🏷️ Recupero etichette per tenant: Humanitas
📊 Calcolo statistiche per tenant: Humanitas
🔍 [DEBUG] Recuperati 5 prompt dal PromptManager
🔍 [DEBUG] Statistiche: 5/5 attivi, 0 inattivi
✅ [DEBUG] Status calcolato: {'success': True, 'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'total_prompts': 5, 'active_prompts': 5, 'inactive_prompts': 0, 'last_updated': '2025-09-01T21:31:51', 'status': 'ready', 'canOperate': True, 'requiredPrompts': [{'name': 'System Prompt', 'type': 'system', 'description': 'Prompt di sistema per la classificazione', 'exists': True}, {'name': 'User Template', 'type': 'user', 'description': 'Template per prompt utente', 'exists': True}, {'name': 'Classification Prompt', 'type': 'classification', 'description': 'Prompt per classificazione intelligente', 'exists': False}], 'missingCount': 1}
✅ [DEBUG] Status prompt per tenant_id 015007d9-d413-11ef-86a5-96000228e7fe: 5/5 attivi
🔍 [DEBUG] Invio risposta JSON per status prompt
🎯 TRAINING SUPERVISIONATO - Cliente: 015007d9-d413-11ef-86a5-96000228e7fe
📋 Parametri utente semplificati:
  � Max sessioni review: 500
  🎯 Soglia confidenza: 0.95
  🔄 Forza review: False
  ⚖️  Soglia disagreement: 0.3
🔧 Inizializzazione pipeline per cliente: 015007d9-d413-11ef-86a5-96000228e7fe (con lock)
⚠️ [PIPELINE] DEPRECATO: uso di tenant_slug '015007d9-d413-11ef-86a5-96000228e7fe' - convertendo a oggetto Tenant
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
🔄 [PIPELINE] Conversione completata: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
✅ [CONFIG] Configurazione base caricata da /home/ubuntu/classificatore/Utils/../config.yaml
🎯 [PIPELINE CLUSTERING CONFIG] Caricati parametri personalizzati per tenant 015007d9-d413-11ef-86a5-96000228e7fe:
   allow_single_cluster: non_definito -> False
   alpha: non_definito -> 0.4
   cluster_selection_epsilon: non_definito -> 0.28
   cluster_selection_method: non_definito -> leaf
   max_cluster_size: non_definito -> 0
   metric: non_definito -> euclidean
   min_cluster_size: 5 -> 13
   min_samples: 3 -> 16
   only_user: non_definito -> False
   umap_metric: non_definito -> cosine
   umap_min_dist: non_definito -> 0
   umap_n_components: non_definito -> 17
   umap_n_neighbors: non_definito -> 30
   umap_random_state: non_definito -> 42
   use_umap: non_definito -> True

🚀 [FASE 1: INIZIALIZZAZIONE] Avvio pipeline...
🏥 [FASE 1: INIZIALIZZAZIONE] Tenant: humanitas
🎯 [FASE 1: INIZIALIZZAZIONE] Configurazione:
   📊 Confidence threshold: 0.7
   🤖 Auto mode: True
   🔄 Auto retrain: False
� [FASE 1: INIZIALIZZAZIONE] Inizializzazione lettore conversazioni...
✅ [CONFIG] Configurazione base caricata da /home/ubuntu/classificatore/Utils/../config.yaml
✅ [CONFIG] Config personalizzata tenant 015007d9-d413-11ef-86a5-96000228e7fe: 15 parametri
🎯 [ONLY_USER] Tenant 015007d9-d413-11ef-86a5-96000228e7fe: False (da config personalizzata)
🎯 [LETTORE] Tenant 015007d9-d413-11ef-86a5-96000228e7fe: only_user = False (da config tenant)
� [FASE 1: INIZIALIZZAZIONE] Inizializzazione aggregator...
   🔍 Schema: 'humanitas'
   🆔 Tenant ID: '015007d9-d413-11ef-86a5-96000228e7fe'
🎯 [SESSION AGGREGATOR] Inizializzazione con oggetto Tenant: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🎯 [ONLY_USER] Tenant 015007d9-d413-11ef-86a5-96000228e7fe: False (da config personalizzata)
🎯 [LETTORE] Tenant 015007d9-d413-11ef-86a5-96000228e7fe: only_user = False (da config tenant)
� [ONLY_USER] Schema None: False (legacy - no tenant_id)
🧠 [FASE 1: INIZIALIZZAZIONE] Sistema embedder dinamico (lazy loading)
🔧 [FASE 1: INIZIALIZZAZIONE] Parametri clustering:
   📊 Min cluster size: 13
   📊 Min samples: 16
🐛 DEBUG CLUSTER_ALPHA - PRIMA:
   📋 clustering_config.get('alpha', 1.0): 0.4
   📋 Type: <class 'float'>
🐛 DEBUG CLUSTER_ALPHA - DOPO CONVERSIONE:
   📋 cluster_alpha: 0.4
   📋 Type: <class 'float'>
🐛 DEBUG CLUSTER_ALPHA - FINALE:
   📋 cluster_alpha finale: 0.4
   📋 Type finale: <class 'float'>
   📋 Alpha > 0: True
✅ [CONFIG] Config personalizzata tenant 015007d9-d413-11ef-86a5-96000228e7fe: 15 parametri
🗂️  [UMAP] Parametri per tenant 015007d9-d413-11ef-86a5-96000228e7fe:
   use_umap: True
   n_neighbors: 30
   min_dist: 0
   n_components: 17
   metric: cosine
🔧 [FIX DEBUG] Parametri tenant passati a HDBSCANClusterer:
   min_cluster_size: 13
   min_samples: 16
   alpha: 0.4
   cluster_selection_method: leaf
   cluster_selection_epsilon: 0.28
   metric: euclidean
   allow_single_cluster: False
   max_cluster_size: 0
   🗂️  use_umap: True
   🗂️  umap_n_neighbors: 30
   🗂️  umap_min_dist: 0
   🗂️  umap_n_components: 17
🎯 [BERTOPIC] Parametri consistenti configurati:
   📊 HDBSCAN: 10 parametri
   📊 UMAP: 5 parametri
🔧 HDBSCANClusterer inizializzato:
   min_cluster_size: 13
   min_samples: 16
   metric: euclidean
   cluster_selection_epsilon: 0.28
   🗂️  UMAP enabled: True
     📏 n_neighbors: 30
     📐 min_dist: 0
     📊 n_components: 17
     🎯 metric: cosine
   🚀 GPU enabled: True
   💾 GPU memory limit: 80%
   🔄 CPU fallback: True
   ⚠️  [GPU MODE] Limitazioni cuML HDBSCAN:
     🚫 leaf_size=40 sarà IGNORATO su GPU
     ✅ Parametri supportati: cluster_selection_method, alpha, allow_single_cluster
🎯 [DEBUG REACT] Parametri configurati:
   cluster_selection_method: leaf
   alpha: 0.4
   allow_single_cluster: False
🧠 Inizializzazione memoria semantica...
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
⚠️  Fallback a config LEGACY per embedding
🔧 TokenizationManager inizializzato:
   📊 Modello tokenizer: cl100k_base
   🔢 Limite massimo token: 8000
   ✂️  Strategia troncamento: start
✅ TokenizationManager integrato in LaBSE per gestione conversazioni lunghe
🚀 Inizializzazione LaBSE embedder su device: cuda
📥 Caricamento modello sentence-transformers/LaBSE...
🚀 Caricamento diretto su GPU...
✅ Modello caricato con successo!
📊 Dimensione embedding: 768
🔧 Device: cuda
🎮 GPU: NVIDIA A10G
💾 GPU Memory: 23.7 GB
📈 GPU Memory utilizzata: 1.89 GB
� Primo parametro su device: cuda:0
🧪 Test del modello LaBSE...
🔍 Encoding 3 testi con LaBSE su device cuda...

🔍 TOKENIZZAZIONE PREVENTIVA LABSE CLUSTERING
============================================================
🔍 ELABORAZIONE CONVERSAZIONI PER CLUSTERING
   📊 Numero conversazioni: 3
   🆔 Session IDs forniti: No

📊 STATISTICHE ELABORAZIONE:
   🔢 Conversazioni totali: 3
   ✂️  Conversazioni troncate: 0
   📏 Token originali totali: 20
   📐 Token finali totali: 20
   📊 Range token: 6 - 7
✅ Tokenizzazione LaBSE completata:
   📊 Conversazioni processate: 3
   📊 Conversazioni troncate: 0
   📊 Token limite configurato: 8000
   ✅ Tutte le conversazioni entro i limiti, nessun troncamento
============================================================
✅ Embedding generati: shape (3, 768)
✅ Test modello completato con successo!
   Shape: (3, 768)
   Norme: [0.99999994 1.         1.        ]
   Device: cuda
🎯 Modello pronto per l'uso!
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
🧠 SemanticMemoryManager inizializzato
  🎯 Soglia riutilizzo etichette: 0.8
  🔍 Soglia similarità semantica: 0.8
  💾 Cache path: semantic_cache/humanitas_015007d9_memory
🔗 Inizializzazione ensemble classifier avanzato...
🔍 ML Ensemble Debugger inizializzato e ATTIVO
   📝 Debug file: ./debug_logs/ml_debug.log
🔍 ML Ensemble Debugger attivato
🔧 Tentativo di inizializzazione IntelligentClassifier tramite LLMFactory...
🧠 GPU Memory prima di LLM: 1.8GB/22.1GB (free: 20.3GB)
✅ Memoria GPU sufficiente, inizializzazione LLM tramite Factory...
🎛️ Configurazioni AI saranno salvate su DATABASE MySQL
🎛️ AIConfigurationService inizializzato
   � Backend: DATABASE MySQL
   🔑 OpenAI API Key: ✅ Configurata
🏭 LLM Factory inizializzato con cache invalidation intelligente
🔍 LLM FACTORY DEBUG: Chiamata ai_config_service.get_tenant_configuration(humanitas) normale...
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id humanitas
🔍 [DEBUG] Query eseguita per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Risultato database: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'embedding_config': None, 'llm_config': None, 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45)}
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🎯 LLM FACTORY DEBUG: Modello normale = 'mistral-nemo:latest'
🔧 Creazione LLM classifier mistral-nemo:latest per tenant humanitas
🚀 LLM FACTORY DEBUG: Avvio creazione nuovo classifier modello 'mistral-nemo:latest'
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto da slug (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
📋 Caricamento parametri LLM globali per tenant: 015007d9-d413-11ef-86a5-96000228e7fe
🎯 Config LLM caricata per 015007d9-d413-11ef-86a5-96000228e7fe (fonte: global)
   📝 Max output tokens: 150
   📊 Max input tokens: 8000
   🌡️  Temperature: 0.1
   🔢 Top K: 40, Top P: 0.9
🎯 Uso modello esplicito: mistral-nemo:latest
🔍 LLM Debugger inizializzato e ATTIVO
   📝 Debug file: ./debug_logs/llm_debug.log
   🎨 Visual formatting: True
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
🗄️ MongoClassificationReader inizializzato per tenant: Humanitas
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
Connessione al database TAG stabilita con successo
📋 Recuperati 29 tag dal database TAGS per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
⚠️  Fallback a config LEGACY per embedding
🔧 TokenizationManager inizializzato:
   📊 Modello tokenizer: cl100k_base
   🔢 Limite massimo token: 8000
   ✂️  Strategia troncamento: start
✅ LLM FACTORY DEBUG: Nuovo classifier creato: mistral-nemo:latest
✅ LLM Classifier mistral-nemo:latest (mistral-nemo:latest) creato e cached per tenant humanitas
🏭 LLM classifier ottenuto tramite Factory per tenant humanitas
🤖 LLM classifier creato automaticamente nell'ensemble: mistral-nemo:latest
💡 Possibile fine-tuning per humanitas
🔗 Advanced Ensemble Classifier inizializzato
   🧠 LLM weight: 0.60
   🤖 ML weight: 0.40
   🎯 Confidence threshold: 0.7
   🔄 Adaptive weights: True
   👤 Disaccordi gestiti da QualityGateEngine
📥 Caricamento ultimo modello per humanitas: humanitas_015007d9_20250901_180026
📥 Caricamento ensemble model...
✅ ML ensemble caricato
✅ Configurazione caricata
🔗 Ensemble model caricato da models/humanitas_015007d9_20250901_180026
✅ Modello caricato con successo

🔍 VERIFICA BERTOPIC LOADING:
   📋 BERTopic enabled: True
   📋 BERTopic available: True
   📁 Provider directory: models/humanitas_015007d9_20250901_180026_bertopic
   📁 Directory exists: True
   � File trovati: 3 -> ['metadata.json', 'bertopic_model', 'svd_model.pkl']

🔄 CARICAMENTO BERTOPIC:
   📁 Path completo: /home/ubuntu/classificatore/models/humanitas_015007d9_20250901_180026_bertopic
🔄 Caricamento BERTopic model da models/humanitas_015007d9_20250901_180026_bertopic/bertopic_model
✅ BERTopic model caricato con successo
📥 SVD caricato (svd_model.pkl)
   ⏱️ Caricamento completato in 0.21 secondi
   ✅ BERTopic provider caricato con successo
🔗 BERTopic provider impostato (top_k=10, one_hot=False)
   ✅ BERTopic provider configurato nell'ensemble
⏸️ Riaddestramento automatico disabilitato (modalità supervisione/API)
   💡 Per abilitare, usare auto_retrain=True nell'inizializzazione
✅ Classificatore LLM disponibile nell'ensemble
👤 Inizializzazione trainer interattivo...
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
🎯 SIMPLE MANAGER: Usando oggetto Tenant Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
📥 Primo embedder - creazione per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🚀 CREATING FRESH EMBEDDER per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🎛️ Configurazioni AI saranno salvate su DATABASE MySQL
🎛️ AIConfigurationService inizializzato
   � Backend: DATABASE MySQL
   🔑 OpenAI API Key: ✅ Configurata
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔧 FORCE NO CACHE: Bypass cache per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔥 FORCE NO CACHE: Bypasso cache e leggo DIRETTAMENTE dal database per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Query eseguita per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Risultato database: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'embedding_config': None, 'llm_config': None, 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45)}
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 SIMPLE MANAGER: Engine da DB per 015007d9-d413-11ef-86a5-96000228e7fe = 'labse'
🎯 Engine configurato: labse
🔧 DIRECT CREATE: labse
🐳 Tentativo connessione a servizio LaBSE dockerizzato...
🔗 LaBSE Remote Client inizializzato
   📡 Service URL: http://localhost:8081
   ⏱️  Timeout: 300s
   🔄 Max retries: 3
   🛡️ Fallback locale: True
🔧 Inizializzazione client remoto LaBSE...
✅ Servizio embedding online e funzionante
✅ Client remoto LaBSE inizializzato con successo
✅ LaBSE Remote Client configurato con successo
✅ FRESH EMBEDDER creato: LaBSERemoteClient per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🧠 Inizializzazione dedupplicatore intelligente...
💾 [FASE 1: INIZIALIZZAZIONE] Caricamento memoria semantica...
📦 Memoria semantica caricata da cache (77 sessioni)
   📊 Campioni: 75
   🏷️ Tag: 10
✅ [FASE 1: INIZIALIZZAZIONE] Completata in 4.80s
🎯 [FASE 1: INIZIALIZZAZIONE] Pipeline pronta per l'uso!
✅ Pipeline 015007d9-d413-11ef-86a5-96000228e7fe inizializzata
🚀 TRAINING SUPERVISIONATO CON DATASET COMPLETO
  📊 Estrazione: TUTTE le discussioni dal database
  🧩 Clustering: Su tutto il dataset disponibile
  👤 Review umana: Max 500 sessioni rappresentative
🎯 Confidence threshold aggiornato a: 0.95
🎓 TRAINING SUPERVISIONATO AVANZATO
� NUOVA LOGICA:
  🔄 Estrazione: TUTTE le discussioni dal database
  🧩 Clustering: Su tutto il dataset completo
  👤 Review umana: Massimo 500 sessioni rappresentative
--------------------------------------------------
📊 FASE 1: ESTRAZIONE COMPLETA DATASET

� [FASE 2: ESTRAZIONE] Avvio estrazione sessioni...
🏥 [FASE 2: ESTRAZIONE] Tenant: humanitas
📅 [FASE 2: ESTRAZIONE] Giorni indietro: 7
🔄 [FASE 2: ESTRAZIONE] Modalità COMPLETA attivata
🎯 [FASE 2: ESTRAZIONE] Ignorando limite - estrazione totale dataset
� [FASE 2: ESTRAZIONE] Modalità: COMPLETA
� [FASE 2: ESTRAZIONE] Connessione database...
📊 [DEBUG ONLY_USER] Estrazione sessioni aggregate dal schema 'humanitas'...
🎯 [DEBUG ONLY_USER] Parametro only_user = False (tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe)
📄 [DEBUG ONLY_USER] Estrazione completa (senza limite)
📄 [DEBUG ONLY_USER] Filtraggio standard: messaggi USER e AGENT
🔍 [DEBUG SQL] =============================================
🔍 [DEBUG SQL] Schema utilizzato: 'humanitas'
🔍 [DEBUG SQL] Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG SQL] Only User: False
� [DEBUG SQL] Filtro applicato: WHERE csm.said_by IN ('USER', 'AGENT')
🔍 [DEBUG SQL] =============================================
🔍 [DEBUG SQL] QUERY COMPLETA:
🔍 [DEBUG SQL] 
        SELECT cs.session_id
             , (SELECT a.agent_name
                  FROM `humanitas`.agents a
                 WHERE a.agent_id = cs.conversation_agent_id) AS conversation_agent_name
             , csm.conversation_status_message_id
             , csm.conversation_message
             , csm.said_by
             , csm.created_at AS message_created_at
          FROM `humanitas`.conversation_status cs
         INNER JOIN `humanitas`.conversation_status_messages csm
            ON cs.conversation_status_id = csm.conversation_status_id
         WHERE csm.said_by IN ('USER', 'AGENT')
         ORDER BY cs.session_id
             , cs.created_at ASC
             , csm.created_at ASC
             , csm.said_by ASC
        
🔍 [DEBUG SQL] =============================================
Connessione al database MySQL stabilita con successo
✅ [DEBUG ONLY_USER] Query eseguita con successo!
📊 [DEBUG ONLY_USER] Totale righe: 22250
👤 [DEBUG ONLY_USER] Messaggi USER: 11106
🤖 [DEBUG ONLY_USER] Messaggi AGENT: 11144
✅ [DEBUG ONLY_USER] Filtro funziona correttamente!
✅ Trovate 22250 righe da aggregare
🔄 [DEBUG ONLY_USER] Inizio generazione testo completo per 4453 sessioni
🔍 [DEBUG ONLY_USER] Sessione 0008ef4f-c2f4-4f5e-933e-646574f3638c: 3 USER, 3 AGENT
📝 [DEBUG ONLY_USER] Sessione 0008ef4f-c2f4-4f5e-933e-646574f3638c testo finale:
   [UTENTE] tags: 2
   [ASSISTENTE] tags: 2
   Lunghezza testo: 554 caratteri
🔍 [DEBUG ONLY_USER] Sessione 000b61d7-4431-40d2-b83c-9abbb70c98be: 4 USER, 4 AGENT
📝 [DEBUG ONLY_USER] Sessione 000b61d7-4431-40d2-b83c-9abbb70c98be testo finale:
   [UTENTE] tags: 3
   [ASSISTENTE] tags: 3
   Lunghezza testo: 1133 caratteri
🔍 [DEBUG ONLY_USER] Sessione 00160700-ac7f-463d-8fa0-fe57f74a73e6: 4 USER, 4 AGENT
✅ Aggregate 4453 sessioni uniche
🔄 Saltati 8906 messaggi di benvenuto (primi 2 per sessione)
🔄 Sessioni vuote (solo benvenuto): 944
📥 [FASE 2: ESTRAZIONE] Sessioni grezze: 4453
🔍 [FASE 2: ESTRAZIONE] Filtraggio sessioni...
🔍 Filtraggio sessioni vuote/irrilevanti...
✅ Filtro completato:
  📊 Sessioni originali: 4453
  ❌ Sessioni scartate: 944
  ✅ Sessioni valide: 3509
✅ [FASE 2: ESTRAZIONE] Completata in 0.67s
📊 [FASE 2: ESTRAZIONE] Dataset completo: 3509 sessioni
🗑️ [FASE 2: ESTRAZIONE] Filtrate: 944 sessioni vuote/irrilevanti
🎯 [FASE 2: ESTRAZIONE] Pronte per clustering completo
✅ Dataset completo: 3509 sessioni totali

📊 FASE 2: CLUSTERING COMPLETO

🚀 [FASE 4: CLUSTERING] Avvio clustering intelligente...
📊 [FASE 4: CLUSTERING] Dataset: 3509 sessioni
🎯 [FASE 4: CLUSTERING] Modalità: INTELLIGENTE
🧠 [FASE 4: CLUSTERING] Clustering incrementale (se possibile)...

🚀 [FASE 3: EMBEDDINGS] Avvio generazione embeddings...
� [FASE 3: EMBEDDINGS] Dataset: 3509 sessioni
📊 [FASE 3: EMBEDDINGS] Caratteristiche testo:
   📏 Lunghezza media: 1005 caratteri
   📏 Lunghezza massima: 29104 caratteri
   📏 Lunghezza minima: 75 caratteri
🧠 [FASE 3: EMBEDDINGS] Generazione embeddings...
🔄 LAZY LOADING: Caricamento embedder dinamico per tenant 'humanitas'
🎯 SimpleEmbeddingManager inizializzato
🎯 SIMPLE MANAGER: Usando oggetto Tenant Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
📥 Primo embedder - creazione per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🚀 CREATING FRESH EMBEDDER per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🎛️ Configurazioni AI saranno salvate su DATABASE MySQL
🎛️ AIConfigurationService inizializzato
   � Backend: DATABASE MySQL
   🔑 OpenAI API Key: ✅ Configurata
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔧 FORCE NO CACHE: Bypass cache per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔥 FORCE NO CACHE: Bypasso cache e leggo DIRETTAMENTE dal database per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Query eseguita per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Risultato database: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'embedding_config': None, 'llm_config': None, 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45)}
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 SIMPLE MANAGER: Engine da DB per 015007d9-d413-11ef-86a5-96000228e7fe = 'labse'
🎯 Engine configurato: labse
🔧 DIRECT CREATE: labse
🐳 Tentativo connessione a servizio LaBSE dockerizzato...
🔗 LaBSE Remote Client inizializzato
   📡 Service URL: http://localhost:8081
   ⏱️  Timeout: 300s
   🔄 Max retries: 3
   🛡️ Fallback locale: True
🔧 Inizializzazione client remoto LaBSE...
✅ Servizio embedding online e funzionante
✅ Client remoto LaBSE inizializzato con successo
✅ LaBSE Remote Client configurato con successo
✅ FRESH EMBEDDER creato: LaBSERemoteClient per tenant 015007d9-d413-11ef-86a5-96000228e7fe
✅ Embedder caricato per tenant Humanitas (015007d9-d413-11ef-86a5-96000228e7fe): LaBSERemoteClient
📡 Richiesta embedding remoto per 3509 testi...
✅ Embedding remoto completato in 7.171s
   📊 Shape: (3509, 768)
   ⚡ Tempo servizio: 3.505s
✅ [FASE 3: EMBEDDINGS] Completata in 7.29s
📈 [FASE 3: EMBEDDINGS] Shape: (3509, 768)
⚡ [FASE 3: EMBEDDINGS] Throughput: 481.6 testi/secondo

📊 FASE 2A: TRAINING BERTOPIC ANTICIPATO

🚀 TRAINING BERTOPIC ANTICIPATO (NUOVO FLUSSO OTTIMIZZATO):
   📊 Dataset completo: 3509 sessioni
   📊 Embeddings shape: (3509, 768)
   🎯 Addestramento su TUTTO il dataset per features ottimali
   🔥 Esecuzione bertopic_provider.fit() su dataset completo...
📊 BERTopic training su 3509 campioni
   🎯 Embedder configurato: LaBSERemoteClient
   🔧 STRATEGIA: BERTopic userà embedder personalizzato via wrapper
   ✅ Wrapper embedder creato per BERTopic
   🔧 BERTopic userà embedder personalizzato interno
✅ BERTopic FIT completato su 3509 campioni
   🔧 SVD Training: Usando embedder personalizzato interno
✅ SVD addestrato su full probas (k=20)
   ✅ BERTopic FIT completato in 37.18 secondi
   🔄 Esecuzione bertopic_provider.transform() per features extraction...
🔧 Transform: BERTopic userà embedder personalizzato interno
   ✅ BERTopic TRANSFORM completato in 3.89 secondi
   📊 Topic probabilities shape: (3509, 20)
   📊 One-hot shape: None
   ✅ BERTopic provider addestrato con successo su 3509 sessioni
   ✅ BERTopic provider disponibile per augmentation features
   🔗 BERTopic model assegnato al trainer per validazione ALTRO

📊 FASE 2B: CLUSTERING HDBSCAN
🧠 Usando clustering INTELLIGENTE (LLM + ML senza pattern)
🗂️  [DEBUG] Caricamento config tenant-specific: /home/ubuntu/classificatore/tenant_configs/015007d9-d413-11ef-86a5-96000228e7fe_clustering.yaml
🗂️  [DEBUG] Config tenant caricato: ['allow_single_cluster', 'alpha', 'cluster_selection_epsilon', 'cluster_selection_method', 'max_cluster_size', 'metric', 'min_cluster_size', 'min_samples', 'only_user', 'umap_metric', 'umap_min_dist', 'umap_n_components', 'umap_n_neighbors', 'umap_random_state', 'use_umap']
🗂️  [DEBUG] UMAP config finale: use_umap=True, n_components=17, min_dist=0
🧠 Clustering intelligente configurato:
   🎯 Categorie intent suggerite: 12
   🤖 LLM primario: True
   📊 Min confidence: 0.8
   📈 Min conversations per intent: 2
   👥 Rappresentanti diversificati: True
   🔢 Max rappresentanti per cluster: 5
   🤝 Strategia consenso: majority
🧠 Avvio clustering intelligente OTTIMIZZATO di 3509 conversazioni...
📊 Fase 1: Clustering semantico con HDBSCAN...
🔧 HDBSCANClusterer inizializzato:
   min_cluster_size: 13
   min_samples: 16
   metric: euclidean
   cluster_selection_epsilon: 0.28
   🗂️  UMAP enabled: True
     📏 n_neighbors: 30
     📐 min_dist: 0
     📊 n_components: 17
     🎯 metric: cosine
   🚀 GPU enabled: True
   💾 GPU memory limit: 80%
   🔄 CPU fallback: True
   ⚠️  [GPU MODE] Limitazioni cuML HDBSCAN:
     🚫 leaf_size=40 sarà IGNORATO su GPU
     ✅ Parametri supportati: cluster_selection_method, alpha, allow_single_cluster
🎯 [DEBUG REACT] Parametri configurati:
   cluster_selection_method: eom
   alpha: 1.0
   allow_single_cluster: False
🔍 Clustering HDBSCAN su 3509 embedding (20.6MB)...
⚙️  Parametri: min_cluster_size=13, min_samples=16, metric=euclidean
📊 [DEBUG FIT_PREDICT] Embedding input:
   📏 Shape: (3509, 768)
   🔢 Dtype: float64
   📈 Range: [-0.1284, 0.0954]
   💾 Memory: 20.6MB

🗂️  [DEBUG FIT_PREDICT] STEP 1: Controllo applicazione UMAP...
🔍 [DEBUG UMAP] Controllo condizioni applicazione UMAP...
   ✅ self.use_umap = True
   ✅ UMAP_AVAILABLE = True
� [DEBUG UMAP] UMAP ABILITATO - Iniziando riduzione dimensionale...
   📏 Dimensioni input: (3509, 768)
   🔢 Tipo dati input: float64
   📊 Range valori input: [-0.1284, 0.0954]
   🎯 Parametri UMAP configurati:
     📐 n_neighbors: 30
     📏 min_dist: 0
     🔢 n_components: 17
     📈 metric: cosine
     🎲 random_state: 42
🔧 [DEBUG UMAP] Inizializzazione riduttore UMAP...
🆕 [DEBUG UMAP] Modalità TRAINING - fit nuovo reducer
✅ [DEBUG UMAP] Riduttore UMAP inizializzato con successo
⏳ [DEBUG UMAP] Applicazione fit_transform agli embeddings...
UMAP(angular_rp_forest=True, metric='cosine', min_dist=0, n_components=17, n_jobs=1, n_neighbors=30, random_state=42, verbose=True)
Mon Sep  1 21:33:51 2025 Construct fuzzy simplicial set
Mon Sep  1 21:34:06 2025 Finding Nearest Neighbors
Mon Sep  1 21:34:07 2025 Finished Nearest Neighbor Search
Mon Sep  1 21:34:07 2025 Construct embedding
	completed  0  /  500 epochs
	completed  50  /  500 epochs
	completed  100  /  500 epochs
	completed  150  /  500 epochs
	completed  200  /  500 epochs
	completed  250  /  500 epochs
	completed  300  /  500 epochs
	completed  350  /  500 epochs
	completed  400  /  500 epochs
	completed  450  /  500 epochs
Mon Sep  1 21:34:15 2025 Finished embedding
✅ [DEBUG UMAP] UMAP COMPLETATO con SUCCESSO in 24.09s
   📐 Dimensioni output: (3509, 17)
   � Tipo dati output: float32
   �📊 Range valori output: [-1.0108, 11.1780]
   📈 Riduzione dimensionale: 768 → 17 dimensioni
   📉 Fattore riduzione: 45.2x
✅ [DEBUG UMAP] RIDUZIONE DIMENSIONALE CONFERMATA
✅ [DEBUG UMAP] Nessun NaN nel risultato UMAP
✅ [DEBUG UMAP] Nessun valore infinito nel risultato UMAP
📊 [DEBUG UMAP] Diversità embeddings ridotti: 3509/3509 righe uniche
✅ [DEBUG UMAP] Buona diversità negli embeddings ridotti
📋 [DEBUG UMAP] Info riduzione salvate nel clusterer
📋 [DEBUG FIT_PREDICT] Risultato UMAP:
   ✅ UMAP applicato: True
   📏 Shape post-UMAP: (3509, 17)
   📈 Range post-UMAP: [-1.0108, 11.1780]
   ⏱️  Tempo riduzione: 24.09s

🔧 [DEBUG FIT_PREDICT] STEP 2: Normalizzazione per metrica euclidean...
   🎯 Nessuna normalizzazione necessaria per metrica euclidean
   📏 Shape finale per clustering: (3509, 17)
   📈 Range finale: [-1.0108, 11.1780]
   🎯 Metrica effettiva clustering: euclidean
💾 Memoria GPU: 17.7GB disponibili, 0.1GB necessari
🚀 Utilizzo GPU per clustering accelerato

🚀 [DEBUG FIT_PREDICT] STEP 3: Avvio clustering...
   🖥️  Modalità: GPU
� [GPU CLUSTERING] Inizializzazione cuML HDBSCAN con parametri supportati...

✅ [DEBUG FIT_PREDICT] CLUSTERING COMPLETATO in 0.12s con 🚀 GPU!
📊 Risultati finali:
   🎯 Cluster trovati: 35
   🔍 Outlier: 624 (17.8%)
   📈 Silhouette score: 0.610

📋 [DEBUG FIT_PREDICT] RIEPILOGO TRASFORMAZIONI:
   🔤 Input originale: (3509, 768)
   🗂️  Dopo UMAP: (3509, 17)
   🔧 Dopo normalizzazione: (3509, 17)
   🎯 Utilizzato per clustering: (3509, 17) con metrica euclidean
   📈 Cluster HDBSCAN trovati: 35
   🔍 Outliers: 624
👥 Fase 2: Selezione rappresentanti per cluster...
   � Cluster 0: 38 sessioni, 4 rappresentanti selezionati
   � Cluster 1: 46 sessioni, 4 rappresentanti selezionati
   � Cluster 2: 19 sessioni, 4 rappresentanti selezionati
   � Cluster 3: 98 sessioni, 5 rappresentanti selezionati
   � Cluster 4: 97 sessioni, 5 rappresentanti selezionati
   � Cluster 5: 202 sessioni, 5 rappresentanti selezionati
   � Cluster 6: 302 sessioni, 5 rappresentanti selezionati
   � Cluster 7: 97 sessioni, 5 rappresentanti selezionati
   � Cluster 8: 152 sessioni, 5 rappresentanti selezionati
   � Cluster 9: 35 sessioni, 4 rappresentanti selezionati
   � Cluster 10: 52 sessioni, 5 rappresentanti selezionati
   � Cluster 11: 313 sessioni, 5 rappresentanti selezionati
   � Cluster 12: 34 sessioni, 4 rappresentanti selezionati
   � Cluster 13: 47 sessioni, 4 rappresentanti selezionati
   � Cluster 14: 17 sessioni, 4 rappresentanti selezionati
   � Cluster 15: 30 sessioni, 4 rappresentanti selezionati
   � Cluster 16: 24 sessioni, 4 rappresentanti selezionati
   � Cluster 17: 42 sessioni, 4 rappresentanti selezionati
   � Cluster 18: 241 sessioni, 5 rappresentanti selezionati
   � Cluster 19: 46 sessioni, 4 rappresentanti selezionati
   � Cluster 20: 19 sessioni, 4 rappresentanti selezionati
   � Cluster 21: 26 sessioni, 4 rappresentanti selezionati
   � Cluster 22: 74 sessioni, 5 rappresentanti selezionati
   � Cluster 23: 29 sessioni, 4 rappresentanti selezionati
   � Cluster 24: 50 sessioni, 4 rappresentanti selezionati
   � Cluster 25: 32 sessioni, 4 rappresentanti selezionati
   � Cluster 26: 51 sessioni, 5 rappresentanti selezionati
   � Cluster 27: 36 sessioni, 4 rappresentanti selezionati
   � Cluster 28: 200 sessioni, 5 rappresentanti selezionati
   � Cluster 29: 91 sessioni, 5 rappresentanti selezionati
   � Cluster 30: 164 sessioni, 5 rappresentanti selezionati
   � Cluster 31: 81 sessioni, 5 rappresentanti selezionati
   � Cluster 32: 36 sessioni, 4 rappresentanti selezionati
   � Cluster 33: 42 sessioni, 4 rappresentanti selezionati
   � Cluster 34: 22 sessioni, 4 rappresentanti selezionati
🤖 Fase 3: Analisi LLM di 155 rappresentanti...
🤖 Analisi LLM di 155 conversazioni...
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 67
   📊 Token totali: 515
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 515 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 67
   📊 Token conversazione finale: 67
   📊 Token totali: 515
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 215 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno vorrei sapere come posso disdire un appuntamento privato grazie  [ASSISTENTE] Ti chiedo scusa, adesso non posso risponderti perché impegnata in un aggiornamento.
Puoi riprovare più tardi? Grazie."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2883 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 67
   📊 Token totali stimati: 515
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno vorrei sapere come posso disdire un appuntamento privato grazie  [ASSISTENTE] Ti chiedo scusa, adesso non posso risponderti perché impegnata in un aggiornamento.
Puoi riprovare più tardi? Grazie."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Prenotazione",\n  "confidence": 0.95,\n  "m'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:18.961739
====================================================================================================
📋 Session ID: classify_1756762458
⏱️  Processing Time: 3.039s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (215 chars):
   [UTENTE] Buongiorno vorrei sapere come posso disdire un appuntamento privato grazie  [ASSISTENTE] Ti chiedo scusa, adesso non posso risponderti perché impegnata in un aggiornamento.
Puoi riprovare ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (197 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Prenotazione",\n  "confidence": 0.95,\n  "m'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Prenotazione",
  "confidence": 0.95,
  "m
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Prenotazione",
  "confidence": 0.95,
  "m
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

✅ Connesso a MongoDB database: classificazioni
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3af245d743af3e79f6470fcee5c41600 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 27
   📊 Token totali: 455
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 455 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 27
   📊 Token conversazione finale: 27
   📊 Token totali: 455
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 78 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] prova [ASSISTENTE] Eccomi qui! Dimmi pure come posso esserti utile. 😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2674 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 27
   📊 Token totali stimati: 455
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] prova [ASSISTENTE] Eccomi qui! Dimmi pure come posso esserti utile. 😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione non sembra riguardare specifici servizi o informazioni sull'ospedale Humanitas.", 'predicted_label': 'altro'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:20.699028
====================================================================================================
📋 Session ID: classify_1756762460
⏱️  Processing Time: 1.628s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (78 chars):
   [UTENTE] prova [ASSISTENTE] Eccomi qui! Dimmi pure come posso esserti utile. 😊

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (161 chars):
   {'confidence': 0.9, 'motivation': "La conversazione non sembra riguardare specifici servizi o informazioni sull'ospedale Humanitas.", 'predicted_label': 'altro'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.9
   motivation: La conversazione non sembra riguardare specifici servizi o informazioni sull'ospedale Humanitas.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione non sembra riguardare specifici servizi o informazioni sull'ospedale Humanitas.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 003a656b4ddfb85ecf1df5d3cdc1b4ce classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 47
   📊 Token totali: 475
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 475 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 47
   📊 Token conversazione finale: 47
   📊 Token totali: 475
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 151 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia non ho bisogno [ASSISTENTE] Va bene, se hai bisogno di informazioni o assistenza in futuro, sono qui per aiutarti. Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2747 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 47
   📊 Token totali stimati: 475
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia non ho bisogno [ASSISTENTE] Va bene, se hai bisogno di informazioni o assistenza in futuro, sono qui per aiutarti. Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione non richiede assistenza specifica e l'utente esprime solo un saluto di cortesia.", 'predicted_label': 'altro'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:22.218053
====================================================================================================
📋 Session ID: classify_1756762462
⏱️  Processing Time: 1.432s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (151 chars):
   [UTENTE] Ciao Giulia non ho bisogno [ASSISTENTE] Va bene, se hai bisogno di informazioni o assistenza in futuro, sono qui per aiutarti. Buona giornata!

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (163 chars):
   {'confidence': 0.95, 'motivation': "La conversazione non richiede assistenza specifica e l'utente esprime solo un saluto di cortesia.", 'predicted_label': 'altro'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.95
   motivation: La conversazione non richiede assistenza specifica e l'utente esprime solo un saluto di cortesia.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione non richiede assistenza specifica e l'utente esprime solo un saluto di cortesia.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione c4458a8fe3f675f0bf8a0af8f2045ef7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 47
   📊 Token totali: 495
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 495 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 47
   📊 Token conversazione finale: 47
   📊 Token totali: 495
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 143 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ok ho guardato non c'è nulla aspettiamo un attimo [ASSISTENTE] Va bene, resto a disposizione! Fammi sapere come posso esserti utile. 😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2811 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 47
   📊 Token totali stimati: 495
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ok ho guardato non c'è nulla aspettiamo un attimo [ASSISTENTE] Va bene, resto a disposizione! Fammi sapere come posso esserti utile. 😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.85, 'motivation': "La conversazione non riguarda esplicitamente un servizio o una richiesta di informazioni specifici sull'ospedale Humanitas.", 'predicted_label': 'altro'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:23.721121
====================================================================================================
📋 Session ID: classify_1756762463
⏱️  Processing Time: 1.414s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (143 chars):
   [UTENTE] Ok ho guardato non c'è nulla aspettiamo un attimo [ASSISTENTE] Va bene, resto a disposizione! Fammi sapere come posso esserti utile. 😊

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (189 chars):
   {'confidence': 0.85, 'motivation': "La conversazione non riguarda esplicitamente un servizio o una richiesta di informazioni specifici sull'ospedale Humanitas.", 'predicted_label': 'altro'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.85
   motivation: La conversazione non riguarda esplicitamente un servizio o una richiesta di informazioni specifici sull'ospedale Humanitas.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.850
   [█████████████████░░░] 85.0%

🧠 Reasoning/Motivation:
   La conversazione non riguarda esplicitamente un servizio o una richiesta di informazioni specifici sull'ospedale Humanitas.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 088e9aee65fad833aac6cb233db6480e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 338
   📊 Token totali: 786
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 786 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 338
   📊 Token conversazione finale: 338
   📊 Token totali: 786
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1089 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao, vorrei prenotare un intervento in regime privato, come devo fare? [ASSISTENTE] Per prenotare un ricovero privato presso Humanitas, puoi contattare l'Ufficio Ricoveri Privati chiamando il numero 02 82 24 62 50, attivo dal lunedì al venerdì dalle 8:00 alle 17:00, oppure inviare un'em..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 338
   📊 Token totali stimati: 786
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao, vorrei prenotare un intervento in regime privato, come devo fare? [ASSISTENTE] Per prenotare un ricovero privato presso Humanitas, puoi contattare l'Ufficio Ricoveri Privati chiamando il numero 02 82 24 62 50, attivo dal lunedì al venerdì dalle 8:00 alle 17:00, oppure inviare un'em..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of conversation:**\n\n```json\n{\n  "predicted_label": "Prenotazione",\n  "confidence": '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:26.852448
====================================================================================================
📋 Session ID: classify_1756762466
⏱️  Processing Time: 3.045s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1089 chars):
   [UTENTE] Ciao, vorrei prenotare un intervento in regime privato, come devo fare? [ASSISTENTE] Per prenotare un ricovero privato presso Humanitas, puoi contattare l'Ufficio Ricoveri Privati chiamand...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of conversation:**\n\n```json\n{\n  "predicted_label": "Prenotazione",\n  "confidence": '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Classification of conversation:**

```json
{
  "predicted_label": "Prenotazione",
  "confidence": 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Classification of conversation:**

```json
{
  "predicted_label": "Prenotazione",
  "confidence": 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 0c836bcfee3b0864307964656a0c29d1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 196
   📊 Token totali: 644
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 644 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 196
   📊 Token conversazione finale: 196
   📊 Token totali: 644
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 629 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Volevo sapere se nel Building 8 c'è una cappella e a che ora fanno la messa il sabato e la domenica  [ASSISTENTE] Nel Building 8 di Humanitas è presente una cappella dedicata al culto cattolico situata al piano terra. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2917 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 196
   📊 Token totali stimati: 644
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Volevo sapere se nel Building 8 c'è una cappella e a che ora fanno la messa il sabato e la domenica  [ASSISTENTE] Nel Building 8 di Humanitas è presente una cappella dedicata al culto cattolico situata al piano terra. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'esistenza di una cappella nel Building 8 e sugli orari delle funzioni religiose, il che indica chiaramente una richiesta relativa all'alloggio.", 'predicted_label': 'alloggio'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:28.696287
====================================================================================================
📋 Session ID: classify_1756762468
⏱️  Processing Time: 1.757s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (629 chars):
   [UTENTE] Volevo sapere se nel Building 8 c'è una cappella e a che ora fanno la messa il sabato e la domenica  [ASSISTENTE] Nel Building 8 di Humanitas è presente una cappella dedicata al culto catt...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (240 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'esistenza di una cappella nel Building 8 e sugli orari delle funzioni religiose, il che indica chiaramente una richiesta relativa all'alloggio.", 'predicted_label': 'alloggio'}

📊 Parsed Response:
   predicted_label: alloggio
   confidence: 0.95
   motivation: La conversazione verte sull'esistenza di una cappella nel Building 8 e sugli orari delle funzioni religiose, il che indica chiaramente una richiesta relativa all'alloggio.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'esistenza di una cappella nel Building 8 e sugli orari delle funzioni religiose, il che indica chiaramente una richiesta relativa all'alloggio.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 65cbbb0a09877a6665baa0cef6728a6f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'alloggio' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 363
   📊 Token totali: 811
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 811 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 363
   📊 Token conversazione finale: 363
   📊 Token totali: 811
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1144 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao il bar al Building 2 quali orari osserva [ASSISTENTE] Il bar situato al primo piano del Building 2, in fondo al corridoio centrale, è aperto tutti i giorni dalle 6:30 alle 21:00. [...] it/info/altri-servizi/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2890 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 363
   📊 Token totali stimati: 811
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao il bar al Building 2 quali orari osserva [ASSISTENTE] Il bar situato al primo piano del Building 2, in fondo al corridoio centrale, è aperto tutti i giorni dalle 6:30 alle 21:00. [...] it/info/altri-servizi/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** servizi aziendali\n\n**Confidence:** 0.9\n\n**Motivation:** La conversazione verte '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:30.389555
====================================================================================================
📋 Session ID: classify_1756762470
⏱️  Processing Time: 1.607s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1144 chars):
   [UTENTE] Ciao il bar al Building 2 quali orari osserva [ASSISTENTE] Il bar situato al primo piano del Building 2, in fondo al corridoio centrale, è aperto tutti i giorni dalle 6:30 alle 21:00. 

Pe...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** servizi aziendali\n\n**Confidence:** 0.9\n\n**Motivation:** La conversazione verte '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted label:** servizi aziendali

**Confidence:** 0.9

**Motivation:** La conversazione verte 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted label:** servizi aziendali

**Confidence:** 0.9

**Motivation:** La conversazione verte 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione ce30da963d55c61c4fb87d03c1d87b26 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 284
   📊 Token totali: 732
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 732 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 284
   📊 Token conversazione finale: 284
   📊 Token totali: 732
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 895 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Divrei prenotare per nedicazione [ASSISTENTE] Potresti chiarire meglio cosa intendi per "nedicazione"? Intendi dire "medicazione" o "indicazione"? Oppure hai bisogno di prenotare una visita o un esame? [UTENTE] Medicazione per ferita che non cicatrizza [ASSISTENTE] Per prenotare una medi..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 284
   📊 Token totali stimati: 732
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Divrei prenotare per nedicazione [ASSISTENTE] Potresti chiarire meglio cosa intendi per "nedicazione"? Intendi dire "medicazione" o "indicazione"? Oppure hai bisogno di prenotare una visita o un esame? [UTENTE] Medicazione per ferita che non cicatrizza [ASSISTENTE] Per prenotare una medi..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:31.968786
====================================================================================================
📋 Session ID: classify_1756762471
⏱️  Processing Time: 1.493s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (895 chars):
   [UTENTE] Divrei prenotare per nedicazione [ASSISTENTE] Potresti chiarire meglio cosa intendi per "nedicazione"? Intendi dire "medicazione" o "indicazione"? Oppure hai bisogno di prenotare una visit...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 1590f2b90c775b1196070cbde12392d1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 162
   📊 Token totali: 611
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 611 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 162
   📊 Token conversazione finale: 162
   📊 Token totali: 611
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 570 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo registrarmi  [ASSISTENTE] Per registrarti a [Humanitas con te](https://www. [...]  

Se hai altre domande, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2812 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 162
   📊 Token totali stimati: 611
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo registrarmi  [ASSISTENTE] Per registrarti a [Humanitas con te](https://www. [...]  

Se hai altre domande, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:33.687551
====================================================================================================
📋 Session ID: classify_1756762473
⏱️  Processing Time: 1.633s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (570 chars):
   [UTENTE] Devo registrarmi  [ASSISTENTE] Per registrarti a [Humanitas con te](https://www.humanitasconte.it), segui questi passaggi:

1. Accedi al sito [Humanitas con te](https://www.humanitasconte....

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 0138bb9019bb13d93381f26f058afe2e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 508
   📊 Token totali: 962
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 962 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 508
   📊 Token conversazione finale: 508
   📊 Token totali: 962
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1675 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] sono già registrato in Humanitas conte: devo scaricare referto OTP 814328 come devo procedere passo passo? [ASSISTENTE] Per scaricare il referto su [Humanitas con te](https://www. [...] it"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 508
   📊 Token totali stimati: 962
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] sono già registrato in Humanitas conte: devo scaricare referto OTP 814328 come devo procedere passo passo? [ASSISTENTE] Per scaricare il referto su [Humanitas con te](https://www. [...] it"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 [DEBUG] GET review cases per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ [DEBUG] Tenant risolto: Humanitas (humanitas)
🔍 [DEBUG] Ottieni mongo reader per tenant: humanitas
🔧 Creazione MongoClassificationReader per cliente: humanitas
🔍 Risoluzione tenant da slug: humanitas
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto da slug (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da slug: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
✅ MongoClassificationReader creato per tenant: Humanitas (humanitas)
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
✅ Connesso a MongoDB database: classificazioni
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🔍 Review Queue recuperate 0 sessioni (representatives: True, propagated: True, outliers: True)
🏷️ Recupero etichette per tenant: Humanitas
📊 Calcolo statistiche per tenant: Humanitas
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:35.613966
====================================================================================================
📋 Session ID: classify_1756762475
⏱️  Processing Time: 1.841s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1675 chars):
   [UTENTE] sono già registrato in Humanitas conte: devo scaricare referto OTP 814328 come devo procedere passo passo? [ASSISTENTE] Per scaricare il referto su [Humanitas con te](https://www.humanitas...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 205035e4b2c6cd1b270a4a452c2dae96 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 271
   📊 Token totali: 725
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 725 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 271
   📊 Token conversazione finale: 271
   📊 Token totali: 725
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 923 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buon pomeriggio,non riesco a prenotare una visita privata, online  [ASSISTENTE] Se hai difficoltà a prenotare una visita privata online, ti consiglio di seguire questi passaggi:

1. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2912 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 271
   📊 Token totali stimati: 725
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buon pomeriggio,non riesco a prenotare una visita privata, online  [ASSISTENTE] Se hai difficoltà a prenotare una visita privata online, ti consiglio di seguire questi passaggi:

1. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla prenotazione di una visita privata e sull'assistenza per effettuare la procedura online.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:37.243724
====================================================================================================
📋 Session ID: classify_1756762477
⏱️  Processing Time: 1.544s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (923 chars):
   [UTENTE] Buon pomeriggio,non riesco a prenotare una visita privata, online  [ASSISTENTE] Se hai difficoltà a prenotare una visita privata online, ti consiglio di seguire questi passaggi:

1. Accedi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (205 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla prenotazione di una visita privata e sull'assistenza per effettuare la procedura online.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte principalmente sulla prenotazione di una visita privata e sull'assistenza per effettuare la procedura online.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla prenotazione di una visita privata e sull'assistenza per effettuare la procedura online.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 26b1dfeca7e2339617cd1400dd2eb1c2 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 261
   📊 Token totali: 715
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 715 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 261
   📊 Token conversazione finale: 261
   📊 Token totali: 715
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 915 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] non riesco a registrami per scaricare i referti [ASSISTENTE] Per registrarti e scaricare i referti su [Humanitas con te](https://www. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2915 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 261
   📊 Token totali stimati: 715
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] non riesco a registrami per scaricare i referti [ASSISTENTE] Per registrarti e scaricare i referti su [Humanitas con te](https://www. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sulla difficoltà dell'utente nel registrarsi per scaricare i referti e l'assistente fornisce istruzioni dettagliate su come farlo attraverso il portale Humanitas con te.", 'predicted_label': 'Humanitas con te - Registrazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:39.471905
====================================================================================================
📋 Session ID: classify_1756762479
⏱️  Processing Time: 2.142s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (915 chars):
   [UTENTE] non riesco a registrami per scaricare i referti [ASSISTENTE] Per registrarti e scaricare i referti su [Humanitas con te](https://www.humanitasconte.it), è necessario seguire questi passagg...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (285 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sulla difficoltà dell'utente nel registrarsi per scaricare i referti e l'assistente fornisce istruzioni dettagliate su come farlo attraverso il portale Humanitas con te.", 'predicted_label': 'Humanitas con te - Registrazione'}

📊 Parsed Response:
   predicted_label: Humanitas con te - Registrazione
   confidence: 0.95
   motivation: La conversazione verte sulla difficoltà dell'utente nel registrarsi per scaricare i referti e l'assistente fornisce istruzioni dettagliate su come farlo attraverso il portale Humanitas con te.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla difficoltà dell'utente nel registrarsi per scaricare i referti e l'assistente fornisce istruzioni dettagliate su come farlo attraverso il portale Humanitas con te.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 2933a529d5b1a148965e5e36b7906a43 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Humanitas con te - Registrazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 447
   💬 Token conversazione: 221
   📊 Token totali: 668
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 668 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 447
   📊 Token conversazione originale: 221
   📊 Token conversazione finale: 221
   📊 Token totali: 668
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 771 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho bisogno di sapere il mio codice ID Humanitas con te [ASSISTENTE] Per recuperare l’ID di [Humanitas con te](https://www. [...]  

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2861 characters
🔢 Token Analysis:
   📊 Token prompt base: 447
   📊 Token conversazione: 221
   📊 Token totali stimati: 668
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho bisogno di sapere il mio codice ID Humanitas con te [ASSISTENTE] Per recuperare l’ID di [Humanitas con te](https://www. [...]  

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:42.292241
====================================================================================================
📋 Session ID: classify_1756762482
⏱️  Processing Time: 2.733s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (771 chars):
   [UTENTE] Ho bisogno di sapere il mio codice ID Humanitas con te [ASSISTENTE] Per recuperare l’ID di [Humanitas con te](https://www.humanitasconte.it), ti consiglio di controllare tra i documenti fo...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 45bcd32fa70a4784f3e8cb0354890c56 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 115
   📊 Token totali: 563
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 563 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 115
   📊 Token conversazione finale: 115
   📊 Token totali: 563
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 393 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mi è arrivato il messaggio che è pronto il referto ma cosa mi serve per ritirarlo? [ASSISTENTE] Per ritirare il referto, ti servirà il tagliando di promemoria ritiro referto rilasciato al momento dell’accettazione (sia al totem che allo sportello). Questo tagliando contiene l'ID necessar..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 115
   📊 Token totali stimati: 563
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mi è arrivato il messaggio che è pronto il referto ma cosa mi serve per ritirarlo? [ASSISTENTE] Per ritirare il referto, ti servirà il tagliando di promemoria ritiro referto rilasciato al momento dell’accettazione (sia al totem che allo sportello). Questo tagliando contiene l'ID necessar..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:44.084921
====================================================================================================
📋 Session ID: classify_1756762484
⏱️  Processing Time: 1.706s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (393 chars):
   [UTENTE] Mi è arrivato il messaggio che è pronto il referto ma cosa mi serve per ritirarlo? [ASSISTENTE] Per ritirare il referto, ti servirà il tagliando di promemoria ritiro referto rilasciato al ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 56b885eedbfd75ac74167169719d6d2f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 1063
   📊 Token totali: 1491
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1491 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 1063
   📊 Token conversazione finale: 1063
   📊 Token totali: 1491
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 3525 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno dovrei richiedere il referto di una TAC del 28 febbraio 2025 sono Pedroli Marisa ma non ho il messaggio con il querrecode sa come posso fare gay [ASSISTENTE] Per richiedere il referto della TAC, puoi accedere al portale [Humanitas con te](https://www.humanitasconte.it). Se non..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 1063
   📊 Token totali stimati: 1491
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno dovrei richiedere il referto di una TAC del 28 febbraio 2025 sono Pedroli Marisa ma non ho il messaggio con il querrecode sa come posso fare gay [ASSISTENTE] Per richiedere il referto della TAC, puoi accedere al portale [Humanitas con te](https://www.humanitasconte.it). Se non..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Referti e Cartelle Cliniche",\n  "confiden'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:46.497896
====================================================================================================
📋 Session ID: classify_1756762486
⏱️  Processing Time: 2.328s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (3525 chars):
   [UTENTE] Buongiorno dovrei richiedere il referto di una TAC del 28 febbraio 2025 sono Pedroli Marisa ma non ho il messaggio con il querrecode sa come posso fare gay [ASSISTENTE] Per richiedere il r...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Referti e Cartelle Cliniche",\n  "confiden'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Referti e Cartelle Cliniche",
  "confiden
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Referti e Cartelle Cliniche",
  "confiden
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 2183e6f1d7366f2c050ab6a42db9605e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 274
   📊 Token totali: 723
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 723 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 274
   📊 Token conversazione finale: 274
   📊 Token totali: 723
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 988 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho bisogno di recuperare il mio ID Huawei [ASSISTENTE] Non posso aiutarti con il recupero dell'ID Huawei, in quanto mi occupo esclusivamente di informazioni relative all'Istituto Clinico Humanitas. [...] it, indicando nome, cognome, codice fiscale e motivo della richiesta di assistenza"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2964 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 274
   📊 Token totali stimati: 723
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho bisogno di recuperare il mio ID Huawei [ASSISTENTE] Non posso aiutarti con il recupero dell'ID Huawei, in quanto mi occupo esclusivamente di informazioni relative all'Istituto Clinico Humanitas. [...] it, indicando nome, cognome, codice fiscale e motivo della richiesta di assistenza"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.95, "m'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:48.055583
====================================================================================================
📋 Session ID: classify_1756762488
⏱️  Processing Time: 1.471s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (988 chars):
   [UTENTE] ho bisogno di recuperare il mio ID Huawei [ASSISTENTE] Non posso aiutarti con il recupero dell'ID Huawei, in quanto mi occupo esclusivamente di informazioni relative all'Istituto Clinico H...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.95, "m'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.95, "m
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.95, "m
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a882748da2ffff4ad43859ace0c0b9f5 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 284
   📊 Token totali: 732
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 732 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 284
   📊 Token conversazione finale: 284
   📊 Token totali: 732
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 964 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Sono  Bove Marianna  devo scaricare cartelle cliniche ma quando inserisco il codice id mi dice il dato inserito non è corretto, prego ricontrollare. [...]  Se hai bisogno di ulteriore assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2886 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 284
   📊 Token totali stimati: 732
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Sono  Bove Marianna  devo scaricare cartelle cliniche ma quando inserisco il codice id mi dice il dato inserito non è corretto, prego ricontrollare. [...]  Se hai bisogno di ulteriore assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso alle cartelle cliniche dell'utente, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:49.932671
====================================================================================================
📋 Session ID: classify_1756762489
⏱️  Processing Time: 1.791s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (964 chars):
   [UTENTE] Sono  Bove Marianna  devo scaricare cartelle cliniche ma quando inserisco il codice id mi dice il dato inserito non è corretto, prego ricontrollare. Ma sul promemoria ritiro referti c'è il...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (224 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso alle cartelle cliniche dell'utente, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'accesso alle cartelle cliniche dell'utente, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso alle cartelle cliniche dell'utente, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 30c484f46b6c199ff78c00181bf8e94e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 180
   📊 Token totali: 628
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 628 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 180
   📊 Token conversazione finale: 180
   📊 Token totali: 628
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 551 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dove trovare informazioni per la preparazione di un ecoendoscopia pancreas [ASSISTENTE] Puoi trovare le norme di preparazione per l'ecoendoscopia del pancreas al seguente [link](https://www. [...]  😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2876 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 180
   📊 Token totali stimati: 628
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dove trovare informazioni per la preparazione di un ecoendoscopia pancreas [ASSISTENTE] Puoi trovare le norme di preparazione per l'ecoendoscopia del pancreas al seguente [link](https://www. [...]  😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'Analisi', 'confidence': 0.6, 'motivation': "La conversazione verte sull'ecoendoscopia del pancreas, che è una procedura diagnostica utilizzata per esaminare il pancreas e le vie biliari. Pertant"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:51.810043
====================================================================================================
📋 Session ID: classify_1756762491
⏱️  Processing Time: 1.790s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (551 chars):
   [UTENTE] Dove trovare informazioni per la preparazione di un ecoendoscopia pancreas [ASSISTENTE] Puoi trovare le norme di preparazione per l'ecoendoscopia del pancreas al seguente [link](https://ww...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (217 chars):
   {'predicted_label': 'Analisi', 'confidence': 0.6, 'motivation': "La conversazione verte sull'ecoendoscopia del pancreas, che è una procedura diagnostica utilizzata per esaminare il pancreas e le vie biliari. Pertant"}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.6
   motivation: La conversazione verte sull'ecoendoscopia del pancreas, che è una procedura diagnostica utilizzata per esaminare il pancreas e le vie biliari. Pertant
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.600
   [████████████░░░░░░░░] 60.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ecoendoscopia del pancreas, che è una procedura diagnostica utilizzata per esaminare il pancreas e le vie biliari. Pertant
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 456b76fc7425eae024c9d6cd0ea227de classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 180
   📊 Token totali: 628
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 628 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 180
   📊 Token conversazione finale: 180
   📊 Token totali: 628
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 604 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Volevo sapere se ci sono delle indicazioni da seguire dopo aver effettuato una PET globale corporea con Gallio [ASSISTENTE] Dopo aver effettuato una PET globale corporea con Gallio, è importante evitare stretto contatto con donne in gravidanza, in età fertile o con minorenni per motivi d..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 180
   📊 Token totali stimati: 628
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Volevo sapere se ci sono delle indicazioni da seguire dopo aver effettuato una PET globale corporea con Gallio [ASSISTENTE] Dopo aver effettuato una PET globale corporea con Gallio, è importante evitare stretto contatto con donne in gravidanza, in età fertile o con minorenni per motivi d..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'esecuzione di una PET globale corporea con Gallio e le precauzioni da seguire dopo l'esame.", 'predicted_label': 'Analisi'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:53.611651
====================================================================================================
📋 Session ID: classify_1756762493
⏱️  Processing Time: 1.714s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (604 chars):
   [UTENTE] Volevo sapere se ci sono delle indicazioni da seguire dopo aver effettuato una PET globale corporea con Gallio [ASSISTENTE] Dopo aver effettuato una PET globale corporea con Gallio, è impo...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (187 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'esecuzione di una PET globale corporea con Gallio e le precauzioni da seguire dopo l'esame.", 'predicted_label': 'Analisi'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.95
   motivation: La conversazione verte sull'esecuzione di una PET globale corporea con Gallio e le precauzioni da seguire dopo l'esame.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'esecuzione di una PET globale corporea con Gallio e le precauzioni da seguire dopo l'esame.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a57c3464e4de9d602167a02982755d4e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 94
   📊 Token totali: 522
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 522 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 94
   📊 Token conversazione finale: 94
   📊 Token totali: 522
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 321 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Preparazione per coronografia  [ASSISTENTE] Per la preparazione alla coronarografia, è necessario eseguire l'esame a digiuno e viene effettuato in regime di ricovero. [...] it/visite-ed-esami/coronarografia)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2812 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 94
   📊 Token totali stimati: 522
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Preparazione per coronografia  [ASSISTENTE] Per la preparazione alla coronarografia, è necessario eseguire l'esame a digiuno e viene effettuato in regime di ricovero. [...] it/visite-ed-esami/coronarografia)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'analisi', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:54.955064
====================================================================================================
📋 Session ID: classify_1756762494
⏱️  Processing Time: 1.256s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (321 chars):
   [UTENTE] Preparazione per coronografia  [ASSISTENTE] Per la preparazione alla coronarografia, è necessario eseguire l'esame a digiuno e viene effettuato in regime di ricovero. Per ulteriori dettagl...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (99 chars):
   {'predicted_label': 'analisi', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: analisi
   confidence: 0.6
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.600
   [████████████░░░░░░░░] 60.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione bc2d6f2612e1a90512971155136dcbe1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 196
   📊 Token totali: 645
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 645 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 196
   📊 Token conversazione finale: 196
   📊 Token totali: 645
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 618 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao, cosa devo fare per questo esame che faro domani pomeriggio alla Gavazzeni ,tc coronarica e tc di perfusione miocardica [ASSISTENTE] Per la preparazione alla tomografia computerizzata con mezzo di contrasto e studio per perfusione coronarica con stress farmacologico (adenosina o reg..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 196
   📊 Token totali stimati: 645
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao, cosa devo fare per questo esame che faro domani pomeriggio alla Gavazzeni ,tc coronarica e tc di perfusione miocardica [ASSISTENTE] Per la preparazione alla tomografia computerizzata con mezzo di contrasto e studio per perfusione coronarica con stress farmacologico (adenosina o reg..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'Analisi', 'confidence': 0.6, 'motivation': '| Etichetta predetta | Confidenza | Motivazione |'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:34:57.805771
====================================================================================================
📋 Session ID: classify_1756762497
⏱️  Processing Time: 2.763s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (618 chars):
   [UTENTE] ciao, cosa devo fare per questo esame che faro domani pomeriggio alla Gavazzeni ,tc coronarica e tc di perfusione miocardica [ASSISTENTE] Per la preparazione alla tomografia computerizzata...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (116 chars):
   {'predicted_label': 'Analisi', 'confidence': 0.6, 'motivation': '| Etichetta predetta | Confidenza | Motivazione |'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.6
   motivation: | Etichetta predetta | Confidenza | Motivazione |
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.600
   [████████████░░░░░░░░] 60.0%

🧠 Reasoning/Motivation:
   | Etichetta predetta | Confidenza | Motivazione |
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione bfbd0b3ec2d331dc3cd41694613448a9 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 708
   📊 Token totali: 1156
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1156 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 708
   📊 Token conversazione finale: 708
   📊 Token totali: 1156
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2173 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] devo fare la colonscopia mi dici come mi devo preparare ? hai le norme ? [ASSISTENTE] Certamente! Puoi trovare le norme di preparazione alla colonscopia a questo [link](https://www. [...] it)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2868 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 708
   📊 Token totali stimati: 1156
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] devo fare la colonscopia mi dici come mi devo preparare ? hai le norme ? [ASSISTENTE] Certamente! Puoi trovare le norme di preparazione alla colonscopia a questo [link](https://www. [...] it)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione inizia con una richiesta di informazioni sulla colonscopia e sulla sua preparazione. Successivamente, l'utente chiede come raggiun"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:01.174593
====================================================================================================
📋 Session ID: classify_1756762501
⏱️  Processing Time: 3.282s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2173 chars):
   [UTENTE] devo fare la colonscopia mi dici come mi devo preparare ? hai le norme ? [ASSISTENTE] Certamente! Puoi trovare le norme di preparazione alla colonscopia a questo [link](https://www.humanit...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione inizia con una richiesta di informazioni sulla colonscopia e sulla sua preparazione. Successivamente, l'utente chiede come raggiun"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione inizia con una richiesta di informazioni sulla colonscopia e sulla sua preparazione. Successivamente, l'utente chiede come raggiun
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione inizia con una richiesta di informazioni sulla colonscopia e sulla sua preparazione. Successivamente, l'utente chiede come raggiun
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 425160c10aa9703fa1a86f2db8d76bb1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 206
   📊 Token totali: 634
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 634 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 206
   📊 Token conversazione finale: 206
   📊 Token totali: 634
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 733 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco accedere a referto  [ASSISTENTE] Se non riesci ad accedere al tuo referto, ti consiglio di verificare di aver inserito correttamente l'ID Humanitas con te. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2840 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 206
   📊 Token totali stimati: 634
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco accedere a referto  [ASSISTENTE] Se non riesci ad accedere al tuo referto, ti consiglio di verificare di aver inserito correttamente l'ID Humanitas con te. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:02.816962
====================================================================================================
📋 Session ID: classify_1756762502
⏱️  Processing Time: 1.556s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (733 chars):
   [UTENTE] Non riesco accedere a referto  [ASSISTENTE] Se non riesci ad accedere al tuo referto, ti consiglio di verificare di aver inserito correttamente l'ID Humanitas con te. L'ID si trova sul tag...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 2855c5afbe98fec42680125ac325b00a classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 399
   📊 Token totali: 827
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 827 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 399
   📊 Token conversazione finale: 399
   📊 Token totali: 827
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1397 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mia figlia, Giovanna Barberis Canonico, ha fatto una risonanza sabato, il referto avrebbe dovuto essere disponibile oggi dalle 14:45, invece non c'è sul sito Humanitas con te. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2854 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 399
   📊 Token totali stimati: 827
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mia figlia, Giovanna Barberis Canonico, ha fatto una risonanza sabato, il referto avrebbe dovuto essere disponibile oggi dalle 14:45, invece non c'è sul sito Humanitas con te. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted Label:** Referti e Cartelle Cliniche\n**Confidence:** 0.95\n**Motivation:** La conversazio'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:05.997814
====================================================================================================
📋 Session ID: classify_1756762505
⏱️  Processing Time: 3.094s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1397 chars):
   [UTENTE] Mia figlia, Giovanna Barberis Canonico, ha fatto una risonanza sabato, il referto avrebbe dovuto essere disponibile oggi dalle 14:45, invece non c'è sul sito Humanitas con te. Come mai? [A...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (193 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted Label:** Referti e Cartelle Cliniche\n**Confidence:** 0.95\n**Motivation:** La conversazio'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted Label:** Referti e Cartelle Cliniche
**Confidence:** 0.95
**Motivation:** La conversazio
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted Label:** Referti e Cartelle Cliniche
**Confidence:** 0.95
**Motivation:** La conversazio
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 01d4ce00889d1966b513b08d3190f376 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 392
   📊 Token totali: 841
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 841 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 392
   📊 Token conversazione finale: 392
   📊 Token totali: 841
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1350 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho effettuato un esame in data 13 giugno l'indicazione era che l'esito sarebbe stato disponibile dal 20 giugno, ma ad oggi 26 giugno ancora non lo vedo nell'area referti, come mai? cosa posso fare? [ASSISTENTE] Se l'esito del tuo esame non è ancora visibile nell'area referti, ti consigli..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 392
   📊 Token totali stimati: 841
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho effettuato un esame in data 13 giugno l'indicazione era che l'esito sarebbe stato disponibile dal 20 giugno, ma ad oggi 26 giugno ancora non lo vedo nell'area referti, come mai? cosa posso fare? [ASSISTENTE] Se l'esito del tuo esame non è ancora visibile nell'area referti, ti consigli..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **predicted_label:** "Referti e Cartelle Cliniche"\n\n**confidence:** 0.9\n\n**motivation:** La conversa'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:08.679559
====================================================================================================
📋 Session ID: classify_1756762508
⏱️  Processing Time: 2.595s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1350 chars):
   [UTENTE] ho effettuato un esame in data 13 giugno l'indicazione era che l'esito sarebbe stato disponibile dal 20 giugno, ma ad oggi 26 giugno ancora non lo vedo nell'area referti, come mai? cosa po...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **predicted_label:** "Referti e Cartelle Cliniche"\n\n**confidence:** 0.9\n\n**motivation:** La conversa'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **predicted_label:** "Referti e Cartelle Cliniche"

**confidence:** 0.9

**motivation:** La conversa
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **predicted_label:** "Referti e Cartelle Cliniche"

**confidence:** 0.9

**motivation:** La conversa
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 8ed6d94314fdd444c42eec7d2ad901bc classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 289
   📊 Token totali: 743
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 743 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 289
   📊 Token conversazione finale: 289
   📊 Token totali: 743
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1056 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a visualizzare e scaricare una densitometria fatta il 20 agosto 2025 [ASSISTENTE] Per aiutarti con il problema della visualizzazione o del download del referto della densitometria, ti consiglio di verificare quanto segue:

1. Assicurati di essere registrato a [Humanitas con te..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2999 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 289
   📊 Token totali stimati: 743
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a visualizzare e scaricare una densitometria fatta il 20 agosto 2025 [ASSISTENTE] Per aiutarti con il problema della visualizzazione o del download del referto della densitometria, ti consiglio di verificare quanto segue:

1. Assicurati di essere registrato a [Humanitas con te..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:10.436579
====================================================================================================
📋 Session ID: classify_1756762510
⏱️  Processing Time: 1.671s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1056 chars):
   [UTENTE] Non riesco a visualizzare e scaricare una densitometria fatta il 20 agosto 2025 [ASSISTENTE] Per aiutarti con il problema della visualizzazione o del download del referto della densitometr...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 8ce797961bf23e374065f5fe28874df2 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 933
   📊 Token totali: 1387
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1387 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 933
   📊 Token conversazione finale: 933
   📊 Token totali: 1387
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 3220 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo scaricare degli esami di mio papà e devo registrarlo inserisco il codice fiscale ma me lo dà errato l'ho ripetuto più volte ma il codice fiscale corretto solo che mi dice che non va bene [ASSISTENTE] Se il codice fiscale è corretto ma il sistema lo segnala come errato, ti consiglio ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2999 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 933
   📊 Token totali stimati: 1387
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo scaricare degli esami di mio papà e devo registrarlo inserisco il codice fiscale ma me lo dà errato l'ho ripetuto più volte ma il codice fiscale corretto solo che mi dice che non va bene [ASSISTENTE] Se il codice fiscale è corretto ma il sistema lo segnala come errato, ti consiglio ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** "Humanitas con te - Registrazione"\n\n**Confidence:** 0.9\n\n**Motivation:** La con'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:12.809207
====================================================================================================
📋 Session ID: classify_1756762512
⏱️  Processing Time: 2.286s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (3220 chars):
   [UTENTE] Devo scaricare degli esami di mio papà e devo registrarlo inserisco il codice fiscale ma me lo dà errato l'ho ripetuto più volte ma il codice fiscale corretto solo che mi dice che non va b...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** "Humanitas con te - Registrazione"\n\n**Confidence:** 0.9\n\n**Motivation:** La con'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted label:** "Humanitas con te - Registrazione"

**Confidence:** 0.9

**Motivation:** La con
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted label:** "Humanitas con te - Registrazione"

**Confidence:** 0.9

**Motivation:** La con
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 5d95d7da569066146e63e9e1aebdf076 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 156
   📊 Token totali: 584
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 584 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 156
   📊 Token conversazione finale: 156
   📊 Token totali: 584
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 536 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei consultare i miei referti  [ASSISTENTE] Per consultare i tuoi referti, devi essere registrato a [Humanitas con te](https://www. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2813 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 156
   📊 Token totali stimati: 584
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei consultare i miei referti  [ASSISTENTE] Per consultare i tuoi referti, devi essere registrato a [Humanitas con te](https://www. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:14.572731
====================================================================================================
📋 Session ID: classify_1756762514
⏱️  Processing Time: 1.677s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (536 chars):
   [UTENTE] Vorrei consultare i miei referti  [ASSISTENTE] Per consultare i tuoi referti, devi essere registrato a [Humanitas con te](https://www.humanitasconte.it). Anche se hai già un ID, è necessar...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f1f67d4e23f29f7ae6a0fe42d3d427a8 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 388
   📊 Token totali: 816
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 816 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 388
   📊 Token conversazione finale: 388
   📊 Token totali: 816
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1330 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno mi è arrivata una mail con l'invito a leggere un allegato con la procedura comunicazionr sicura ma non riesco ad [ASSISTENTE] Potresti caricare l'allegato o fornirmi maggiori dettagli sulla procedura che stai cercando di seguire? Così posso aiutarti meglio! [UTENTE] Aprire l'a..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 388
   📊 Token totali stimati: 816
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno mi è arrivata una mail con l'invito a leggere un allegato con la procedura comunicazionr sicura ma non riesco ad [ASSISTENTE] Potresti caricare l'allegato o fornirmi maggiori dettagli sulla procedura che stai cercando di seguire? Così posso aiutarti meglio! [UTENTE] Aprire l'a..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.85, 'motivation': "La conversazione verte sull'accesso a un allegato inviato via email e sulle difficoltà riscontrate dall'utente nel farlo. L'assistenza fornita riguarda la procedura da seguire per risolvere il problema, pertanto la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:17.002164
====================================================================================================
📋 Session ID: classify_1756762517
⏱️  Processing Time: 2.343s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1330 chars):
   [UTENTE] Buongiorno mi è arrivata una mail con l'invito a leggere un allegato con la procedura comunicazionr sicura ma non riesco ad [ASSISTENTE] Potresti caricare l'allegato o fornirmi maggiori de...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (337 chars):
   {'confidence': 0.85, 'motivation': "La conversazione verte sull'accesso a un allegato inviato via email e sulle difficoltà riscontrate dall'utente nel farlo. L'assistenza fornita riguarda la procedura da seguire per risolvere il problema, pertanto la categoria 'Servizi aziendali' è appropriata.",...

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.85
   motivation: La conversazione verte sull'accesso a un allegato inviato via email e sulle difficoltà riscontrate dall'utente nel farlo. L'assistenza fornita riguarda la procedura da seguire per risolvere il problema, pertanto la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.850
   [█████████████████░░░] 85.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso a un allegato inviato via email e sulle difficoltà riscontrate dall'utente nel farlo. L'assistenza fornita riguarda la procedura da seguire per risolvere il problema, pertanto la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a9b321cacf305ffba61b3650fa1af275 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 231
   📊 Token totali: 679
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 679 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 231
   📊 Token conversazione finale: 231
   📊 Token totali: 679
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 787 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Sto aspettando che qualcuno mi contatti con URGENZA per poter scaricare gli esami di laboratorio fatti a Torino in Humaniyas Cellini pet Luciana Sanna e Leandro Difino. [...]  Sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2875 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 231
   📊 Token totali stimati: 679
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Sto aspettando che qualcuno mi contatti con URGENZA per poter scaricare gli esami di laboratorio fatti a Torino in Humaniyas Cellini pet Luciana Sanna e Leandro Difino. [...]  Sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla necessità dell'utente di scaricare gli esami di laboratorio effettuati a Torino presso Humanitas Cellin"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:20.073311
====================================================================================================
📋 Session ID: classify_1756762520
⏱️  Processing Time: 2.985s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (787 chars):
   [UTENTE] Sto aspettando che qualcuno mi contatti con URGENZA per poter scaricare gli esami di laboratorio fatti a Torino in Humaniyas Cellini pet Luciana Sanna e Leandro Difino. Sono urgentissimo e...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla necessità dell'utente di scaricare gli esami di laboratorio effettuati a Torino presso Humanitas Cellin"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla necessità dell'utente di scaricare gli esami di laboratorio effettuati a Torino presso Humanitas Cellin
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla necessità dell'utente di scaricare gli esami di laboratorio effettuati a Torino presso Humanitas Cellin
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b181d34c1ef8d2595682031297f829e2 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 121
   📊 Token totali: 569
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 569 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 121
   📊 Token conversazione finale: 121
   📊 Token totali: 569
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 410 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Giulia, avrei bisogno della copia della cartella clinica di mia figlia minorenne  [ASSISTENTE] Per richiedere la copia della cartella clinica di un minore, è necessario seguire una procedura specifica. [...]  

Se hai bisogno di ulteriori dettagli o assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2952 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 121
   📊 Token totali stimati: 569
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Giulia, avrei bisogno della copia della cartella clinica di mia figlia minorenne  [ASSISTENTE] Per richiedere la copia della cartella clinica di un minore, è necessario seguire una procedura specifica. [...]  

Se hai bisogno di ulteriori dettagli o assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:21.502105
====================================================================================================
📋 Session ID: classify_1756762521
⏱️  Processing Time: 1.343s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (410 chars):
   [UTENTE] Giulia, avrei bisogno della copia della cartella clinica di mia figlia minorenne  [ASSISTENTE] Per richiedere la copia della cartella clinica di un minore, è necessario seguire una procedu...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione eb7bb108299d8cc701def26ef7d7e7c3 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 357
   📊 Token totali: 805
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 805 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 357
   📊 Token conversazione finale: 357
   📊 Token totali: 805
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1266 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] come si sporge un reclamo? [ASSISTENTE] Puoi sporgere un reclamo o inviare una segnalazione tramite il form dedicato disponibile alla pagina [Invia un ticket](https://urp. [...]  Se c'è qualcosa di specifico su cui posso esserti utile, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2926 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 357
   📊 Token totali stimati: 805
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] come si sporge un reclamo? [ASSISTENTE] Puoi sporgere un reclamo o inviare una segnalazione tramite il form dedicato disponibile alla pagina [Invia un ticket](https://urp. [...]  Se c'è qualcosa di specifico su cui posso esserti utile, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla difficoltà dell'utente nel comunicare con un medico dopo il ricovero del padre in pronto soccorso e sul"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:24.631130
====================================================================================================
📋 Session ID: classify_1756762524
⏱️  Processing Time: 3.042s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1266 chars):
   [UTENTE] come si sporge un reclamo? [ASSISTENTE] Puoi sporgere un reclamo o inviare una segnalazione tramite il form dedicato disponibile alla pagina [Invia un ticket](https://urp.humanitas.it/supp...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla difficoltà dell'utente nel comunicare con un medico dopo il ricovero del padre in pronto soccorso e sul"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla difficoltà dell'utente nel comunicare con un medico dopo il ricovero del padre in pronto soccorso e sul
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla difficoltà dell'utente nel comunicare con un medico dopo il ricovero del padre in pronto soccorso e sul
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b4c4f5abcaed61e24734d8cfe00e2476 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 268
   📊 Token totali: 717
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 717 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 268
   📊 Token conversazione finale: 268
   📊 Token totali: 717
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 778 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] devo prenotare in humanitas con ssn. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2743 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 268
   📊 Token totali stimati: 717
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] devo prenotare in humanitas con ssn. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:26.189437
====================================================================================================
📋 Session ID: classify_1756762526
⏱️  Processing Time: 1.473s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (778 chars):
   [UTENTE] devo prenotare in humanitas con ssn. come faccio ? [ASSISTENTE] Per prenotare una visita o un esame tramite il Servizio Sanitario Nazionale (SSN) presso Humanitas, puoi utilizzare i seguen...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 63b8ba66590a4a7f6ed84eca098e07b6 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 209
   📊 Token totali: 637
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 637 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 209
   📊 Token conversazione finale: 209
   📊 Token totali: 637
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 595 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] quali sedi ci sono in provincia di varese? [ASSISTENTE] In provincia di Varese, le sedi Humanitas sono:

1. [...] 

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2785 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 209
   📊 Token totali stimati: 637
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] quali sedi ci sono in provincia di varese? [ASSISTENTE] In provincia di Varese, le sedi Humanitas sono:

1. [...] 

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:27.927967
====================================================================================================
📋 Session ID: classify_1756762527
⏱️  Processing Time: 1.652s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (595 chars):
   [UTENTE] quali sedi ci sono in provincia di varese? [ASSISTENTE] In provincia di Varese, le sedi Humanitas sono:

1. **Humanitas Mater Domini**:
   - Edificio 1: Via Gerenzano, 2, 21053 - Castellan...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [76 more lines] ...
     Line 80: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione ce24377acf6fc9177cfdd50a49b26534 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 311
   📊 Token totali: 759
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 759 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 311
   📊 Token conversazione finale: 311
   📊 Token totali: 759
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 945 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buonasera, avrei bisogno di sapere per mia mamma se possibile fare una RM addome sup senza e con MDC per gennaio, in convenzione ssn grazie  [ASSISTENTE] Per prenotare una Risonanza Magnetica (RM) dell'addome superiore senza e con mezzo di contrasto (MDC) in convenzione con il Servizio S..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 311
   📊 Token totali stimati: 759
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buonasera, avrei bisogno di sapere per mia mamma se possibile fare una RM addome sup senza e con MDC per gennaio, in convenzione ssn grazie  [ASSISTENTE] Per prenotare una Risonanza Magnetica (RM) dell'addome superiore senza e con mezzo di contrasto (MDC) in convenzione con il Servizio S..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione riguarda la prenotazione di una Risonanza Magnetica (RM) dell'addome superiore senza e con mezzo di contrasto (MDC).", 'predicted_label': 'Risonanza magnetica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:29.776496
====================================================================================================
📋 Session ID: classify_1756762529
⏱️  Processing Time: 1.762s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (945 chars):
   [UTENTE] Buonasera, avrei bisogno di sapere per mia mamma se possibile fare una RM addome sup senza e con MDC per gennaio, in convenzione ssn grazie  [ASSISTENTE] Per prenotare una Risonanza Magnet...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (213 chars):
   {'confidence': 0.95, 'motivation': "La conversazione riguarda la prenotazione di una Risonanza Magnetica (RM) dell'addome superiore senza e con mezzo di contrasto (MDC).", 'predicted_label': 'Risonanza magnetica'}

📊 Parsed Response:
   predicted_label: Risonanza magnetica
   confidence: 0.95
   motivation: La conversazione riguarda la prenotazione di una Risonanza Magnetica (RM) dell'addome superiore senza e con mezzo di contrasto (MDC).
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda la prenotazione di una Risonanza Magnetica (RM) dell'addome superiore senza e con mezzo di contrasto (MDC).
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione bbb1c7813f4e90e6e11f1d5eff4d5134 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Risonanza magnetica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 124
   📊 Token totali: 573
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 573 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 124
   📊 Token conversazione finale: 124
   📊 Token totali: 573
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 434 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] è possibile eseguire una visita dermatologica in ssn a Castellanza? [ASSISTENTE] Sì, è possibile eseguire una visita dermatologica tramite il Servizio Sanitario Nazionale (SSN) presso Humanitas Mater Domini a Castellanza. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2928 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 124
   📊 Token totali stimati: 573
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] è possibile eseguire una visita dermatologica in ssn a Castellanza? [ASSISTENTE] Sì, è possibile eseguire una visita dermatologica tramite il Servizio Sanitario Nazionale (SSN) presso Humanitas Mater Domini a Castellanza. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '** La conversazione verte sulla possibilità di eseguire una visita dermatologica tramite il Servizio Sanitario Nazionale (SSN) presso Humanitas Mater '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:32.208134
====================================================================================================
📋 Session ID: classify_1756762532
⏱️  Processing Time: 2.345s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (434 chars):
   [UTENTE] è possibile eseguire una visita dermatologica in ssn a Castellanza? [ASSISTENTE] Sì, è possibile eseguire una visita dermatologica tramite il Servizio Sanitario Nazionale (SSN) presso Huma...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '** La conversazione verte sulla possibilità di eseguire una visita dermatologica tramite il Servizio Sanitario Nazionale (SSN) presso Humanitas Mater '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte sulla possibilità di eseguire una visita dermatologica tramite il Servizio Sanitario Nazionale (SSN) presso Humanitas Mater 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte sulla possibilità di eseguire una visita dermatologica tramite il Servizio Sanitario Nazionale (SSN) presso Humanitas Mater 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f6c1bb7b058236e910a55c2b844602f7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 1502
   📊 Token totali: 1950
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1950 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 1502
   📊 Token conversazione finale: 1502
   📊 Token totali: 1950
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 4728 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao giulia [ASSISTENTE] Ciao! Come posso esserti utile oggi? 😊 [UTENTE] vorrei prenotare una colonscopia ma l'attesa telefonica è troppo lunga e non ci sono posti [ASSISTENTE] Capisco la tua situazione. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2903 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 1502
   📊 Token totali stimati: 1950
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao giulia [ASSISTENTE] Ciao! Come posso esserti utile oggi? 😊 [UTENTE] vorrei prenotare una colonscopia ma l'attesa telefonica è troppo lunga e non ci sono posti [ASSISTENTE] Capisco la tua situazione. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: La conversazione è incentrata principalmente sulla prenotazione di visite mediche e la ricerca di in'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:35.096774
====================================================================================================
📋 Session ID: classify_1756762535
⏱️  Processing Time: 2.801s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (4728 chars):
   [UTENTE] ciao giulia [ASSISTENTE] Ciao! Come posso esserti utile oggi? 😊 [UTENTE] vorrei prenotare una colonscopia ma l'attesa telefonica è troppo lunga e non ci sono posti [ASSISTENTE] Capisco la ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: La conversazione è incentrata principalmente sulla prenotazione di visite mediche e la ricerca di in'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: La conversazione è incentrata principalmente sulla prenotazione di visite mediche e la ricerca di in
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: La conversazione è incentrata principalmente sulla prenotazione di visite mediche e la ricerca di in
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 09aba1b9dc0e9ed3da7fd4b2a21b7ffa classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 247
   📊 Token totali: 695
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 695 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 247
   📊 Token conversazione finale: 247
   📊 Token totali: 695
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 844 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ritiro referti  [ASSISTENTE] Puoi dirmi di quale tipo di referto hai bisogno? Ad esempio, se si tratta di un test HIV, esami istologici, citologici, tamponi, esami genetici o altro. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2932 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 247
   📊 Token totali stimati: 695
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ritiro referti  [ASSISTENTE] Puoi dirmi di quale tipo di referto hai bisogno? Ad esempio, se si tratta di un test HIV, esami istologici, citologici, tamponi, esami genetici o altro. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "La conversazione ruota attorno al ritiro dei referti medici. L'assistente fornisce informazioni su come ottenere i risultati degli esami del sangue tr"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:37.157954
====================================================================================================
📋 Session ID: classify_1756762537
⏱️  Processing Time: 1.975s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (844 chars):
   [UTENTE] Ritiro referti  [ASSISTENTE] Puoi dirmi di quale tipo di referto hai bisogno? Ad esempio, se si tratta di un test HIV, esami istologici, citologici, tamponi, esami genetici o altro. Alcuni...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "La conversazione ruota attorno al ritiro dei referti medici. L'assistente fornisce informazioni su come ottenere i risultati degli esami del sangue tr"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: La conversazione ruota attorno al ritiro dei referti medici. L'assistente fornisce informazioni su come ottenere i risultati degli esami del sangue tr
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   La conversazione ruota attorno al ritiro dei referti medici. L'assistente fornisce informazioni su come ottenere i risultati degli esami del sangue tr
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 38d48d19ed827556b8fcd1a993130d22 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 877
   📊 Token totali: 1325
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1325 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 877
   📊 Token conversazione finale: 877
   📊 Token totali: 1325
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2780 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno

vorrei maggiori informazioni riguardo delle analisi fecali. [...]  Se hai bisogno di altro, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2803 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 877
   📊 Token totali stimati: 1325
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno

vorrei maggiori informazioni riguardo delle analisi fecali. [...]  Se hai bisogno di altro, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: #### Classificazione conversazione\n\nLa conversazione fornisce informazioni su diverse analisi medich'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:40.590432
====================================================================================================
📋 Session ID: classify_1756762540
⏱️  Processing Time: 3.347s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2780 chars):
   [UTENTE] Buongiorno

vorrei maggiori informazioni riguardo delle analisi fecali.

In particolare, vorrei sapere se fate le seguenti analisi:
- Test metagenomico per lo studio funzionale
- Sequenzia...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (193 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: #### Classificazione conversazione\n\nLa conversazione fornisce informazioni su diverse analisi medich'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: #### Classificazione conversazione

La conversazione fornisce informazioni su diverse analisi medich
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: #### Classificazione conversazione

La conversazione fornisce informazioni su diverse analisi medich
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 93c2d6a612b1a6243ede6b4886b609ca classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 440
   📊 Token totali: 888
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 888 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 440
   📊 Token conversazione finale: 440
   📊 Token totali: 888
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1584 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao, mi chiamo Ditjon, sonno dal Albania, ho un problema che dopo gli esami che ho fatto mi hanno detto hai, prostatite chrono non bacteriale, penso che le cause, perche non ho nessune bacterie in urina, in spermocultura, in af genital, e in swab test,le cause sonno, per prima Ibs soffr..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 440
   📊 Token totali stimati: 888
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao, mi chiamo Ditjon, sonno dal Albania, ho un problema che dopo gli esami che ho fatto mi hanno detto hai, prostatite chrono non bacteriale, penso che le cause, perche non ho nessune bacterie in urina, in spermocultura, in af genital, e in swab test,le cause sonno, per prima Ibs soffr..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla necessità dell'utente di prenotare una visita con un medico specializzato in chronic pelvic pain e sui costi associati.", 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:42.485154
====================================================================================================
📋 Session ID: classify_1756762542
⏱️  Processing Time: 1.808s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1584 chars):
   [UTENTE] Ciao, mi chiamo Ditjon, sonno dal Albania, ho un problema che dopo gli esami che ho fatto mi hanno detto hai, prostatite chrono non bacteriale, penso che le cause, perche non ho nessune ba...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (244 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla necessità dell'utente di prenotare una visita con un medico specializzato in chronic pelvic pain e sui costi associati.", 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.95
   motivation: La conversazione verte principalmente sulla necessità dell'utente di prenotare una visita con un medico specializzato in chronic pelvic pain e sui costi associati.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla necessità dell'utente di prenotare una visita con un medico specializzato in chronic pelvic pain e sui costi associati.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 4023e96926f73d35c8803f2cba09ed7e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 49
   📊 Token totali: 477
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 477 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 49
   📊 Token conversazione finale: 49
   📊 Token totali: 477
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 155 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Risultato? [ASSISTENTE] Potresti specificare meglio la tua richiesta? Intendi il risultato di un esame, un referto o altro? Sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2751 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 49
   📊 Token totali stimati: 477
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Risultato? [ASSISTENTE] Potresti specificare meglio la tua richiesta? Intendi il risultato di un esame, un referto o altro? Sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.85, 'motivation': "L'utente chiede informazioni sul risultato di un esame o referto.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:43.921437
====================================================================================================
📋 Session ID: classify_1756762543
⏱️  Processing Time: 1.350s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (155 chars):
   [UTENTE] Risultato? [ASSISTENTE] Potresti specificare meglio la tua richiesta? Intendi il risultato di un esame, un referto o altro? Sono qui per aiutarti!

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (153 chars):
   {'confidence': 0.85, 'motivation': "L'utente chiede informazioni sul risultato di un esame o referto.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.85
   motivation: L'utente chiede informazioni sul risultato di un esame o referto.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.850
   [█████████████████░░░] 85.0%

🧠 Reasoning/Motivation:
   L'utente chiede informazioni sul risultato di un esame o referto.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 013ac967909ceef03b67cb47b23121ed classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 303
   📊 Token totali: 751
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 751 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 303
   📊 Token conversazione finale: 303
   📊 Token totali: 751
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1011 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] Sono la Sig. [...] 

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2837 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 303
   📊 Token totali stimati: 751
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] Sono la Sig. [...] 

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Referti e Cartelle Cliniche",\n  "confiden'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:45.750934
====================================================================================================
📋 Session ID: classify_1756762545
⏱️  Processing Time: 1.743s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1011 chars):
   [UTENTE] Buongiorno, [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] Sono la Sig.ra Mazzucco Gabriella, io ho fatto una colonscopia il 15.04.2025 con esame istologico. Mi avevano d...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Referti e Cartelle Cliniche",\n  "confiden'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Referti e Cartelle Cliniche",
  "confiden
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Referti e Cartelle Cliniche",
  "confiden
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione be215c590f7919675c95444e504dceec classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Utente confuso - semplifica classificazione verso problemi tecnici

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 452
   💬 Token conversazione: 305
   📊 Token totali: 757
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 757 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 452
   📊 Token conversazione originale: 305
   📊 Token conversazione finale: 305
   📊 Token totali: 757
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1026 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a registrarmi. [...] it**, indicando:
   - Nome e cognome
   - Codice fiscale
   - Motivo della richiesta di assistenza

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2884 characters
🔢 Token Analysis:
   📊 Token prompt base: 452
   📊 Token conversazione: 305
   📊 Token totali stimati: 757
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Utente confuso - semplifica classificazione verso problemi tecnici

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a registrarmi. [...] it**, indicando:
   - Nome e cognome
   - Codice fiscale
   - Motivo della richiesta di assistenza

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:47.612590
====================================================================================================
📋 Session ID: classify_1756762547
⏱️  Processing Time: 1.775s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1026 chars):
   [UTENTE] Non riesco a registrarmi. [ASSISTENTE] Mi dispiace che stai riscontrando difficoltà con la registrazione. Potresti dirmi se stai cercando di registrarti su [Humanitas con te](https://www.h...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [78 more lines] ...
     Line 82: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f7ce3b3a0e99caab64801ccea299f6d7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 443
   📊 Token totali: 897
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 897 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 443
   📊 Token conversazione finale: 443
   📊 Token totali: 897
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1567 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco ad accedere al sito [ASSISTENTE] Se hai problemi ad accedere al sito di Humanitas o al portale [Humanitas con te](https://www. [...]  Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2913 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 443
   📊 Token totali stimati: 897
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco ad accedere al sito [ASSISTENTE] Se hai problemi ad accedere al sito di Humanitas o al portale [Humanitas con te](https://www. [...]  Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso al sito di Humanitas e sui problemi riscontrati dall'utente nell'inserire il proprio codice fiscale. Entrambi questi argomenti rientrano nella categoria dei servizi aziendali.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:49.857598
====================================================================================================
📋 Session ID: classify_1756762549
⏱️  Processing Time: 2.158s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1567 chars):
   [UTENTE] Non riesco ad accedere al sito [ASSISTENTE] Se hai problemi ad accedere al sito di Humanitas o al portale [Humanitas con te](https://www.humanitasconte.it), ti consiglio di verificare quan...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (289 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso al sito di Humanitas e sui problemi riscontrati dall'utente nell'inserire il proprio codice fiscale. Entrambi questi argomenti rientrano nella categoria dei servizi aziendali.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'accesso al sito di Humanitas e sui problemi riscontrati dall'utente nell'inserire il proprio codice fiscale. Entrambi questi argomenti rientrano nella categoria dei servizi aziendali.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso al sito di Humanitas e sui problemi riscontrati dall'utente nell'inserire il proprio codice fiscale. Entrambi questi argomenti rientrano nella categoria dei servizi aziendali.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 05f4db5cb60513aff2eeaf88a25ad272 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 210
   📊 Token totali: 658
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 658 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 210
   📊 Token conversazione finale: 210
   📊 Token totali: 658
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 731 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Inserire numero impegnative con già appuntamento  [ASSISTENTE] Potresti chiarire meglio la tua richiesta? Intendi dire che desideri sapere come inserire il numero di un'impegnativa per un appuntamento già prenotato? [UTENTE] Si [ASSISTENTE] Per inserire il numero di un'impegnativa per un..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 210
   📊 Token totali stimati: 658
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Inserire numero impegnative con già appuntamento  [ASSISTENTE] Potresti chiarire meglio la tua richiesta? Intendi dire che desideri sapere come inserire il numero di un'impegnativa per un appuntamento già prenotato? [UTENTE] Si [ASSISTENTE] Per inserire il numero di un'impegnativa per un..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:51.837958
====================================================================================================
📋 Session ID: classify_1756762551
⏱️  Processing Time: 1.894s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (731 chars):
   [UTENTE] Inserire numero impegnative con già appuntamento  [ASSISTENTE] Potresti chiarire meglio la tua richiesta? Intendi dire che desideri sapere come inserire il numero di un'impegnativa per un ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Humanitas con te - Registrazio
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 102ed97e47a18b14f6fa41fea25b8482 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 259
   📊 Token totali: 713
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 713 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 259
   📊 Token conversazione finale: 259
   📊 Token totali: 713
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 954 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, non riesco a completare la registrazione a nome di Chorna Valentina ( mi dice che è già registrata. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2888 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 259
   📊 Token totali stimati: 713
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, non riesco a completare la registrazione a nome di Chorna Valentina ( mi dice che è già registrata. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'assistenza per la registrazione su Humanitas con te, quindi la categoria 'Humanitas con te - Registrazione' è appropriata.", 'predicted_label': 'Humanitas con te - Registrazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:53.670826
====================================================================================================
📋 Session ID: classify_1756762553
⏱️  Processing Time: 1.745s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (954 chars):
   [UTENTE] Buongiorno, non riesco a completare la registrazione a nome di Chorna Valentina ( mi dice che è già registrata...come posso modificare? [ASSISTENTE] Se il sistema segnala che il nome è già...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (243 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'assistenza per la registrazione su Humanitas con te, quindi la categoria 'Humanitas con te - Registrazione' è appropriata.", 'predicted_label': 'Humanitas con te - Registrazione'}

📊 Parsed Response:
   predicted_label: Humanitas con te - Registrazione
   confidence: 0.95
   motivation: La conversazione verte sull'assistenza per la registrazione su Humanitas con te, quindi la categoria 'Humanitas con te - Registrazione' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'assistenza per la registrazione su Humanitas con te, quindi la categoria 'Humanitas con te - Registrazione' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 14e3c62b334211a16f2051ecfc1e5606 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Humanitas con te - Registrazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 513
   📊 Token totali: 961
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 961 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 513
   📊 Token conversazione finale: 513
   📊 Token totali: 961
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1694 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo fare prelievo di sangue presso Humanitas Via Sardegna. [...] it/info/esami-di-laboratorio/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2773 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 513
   📊 Token totali stimati: 961
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo fare prelievo di sangue presso Humanitas Via Sardegna. [...] it/info/esami-di-laboratorio/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': 'La conversazione verte principalmente sulla necessità di prenotare per un prelievo di sangue presso Humanitas Via Sardegna, anche in caso di gravidanza.', 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:55.616958
====================================================================================================
📋 Session ID: classify_1756762555
⏱️  Processing Time: 1.860s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1694 chars):
   [UTENTE] Devo fare prelievo di sangue presso Humanitas Via Sardegna. Sono incinta, devo prenotare? [ASSISTENTE] Sì, è necessario prenotare per effettuare un prelievo di sangue presso Humanitas. Puo...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (225 chars):
   {'confidence': 0.95, 'motivation': 'La conversazione verte principalmente sulla necessità di prenotare per un prelievo di sangue presso Humanitas Via Sardegna, anche in caso di gravidanza.', 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte principalmente sulla necessità di prenotare per un prelievo di sangue presso Humanitas Via Sardegna, anche in caso di gravidanza.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla necessità di prenotare per un prelievo di sangue presso Humanitas Via Sardegna, anche in caso di gravidanza.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 9926c3158b56418fa03c6daa26a86879 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 186
   📊 Token totali: 635
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 635 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 186
   📊 Token conversazione finale: 186
   📊 Token totali: 635
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 567 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Il punto prelievi di viale sardegna è aperto in estate?  [ASSISTENTE] Il punto prelievi di Via Sardegna 5, Fizzonasco di Pieve Emanuele, è aperto durante l'estate con i seguenti orari: da lunedì a venerdì dalle 7:00 alle 13:00. [...] it/info/esami-di-laboratorio/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2942 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 186
   📊 Token totali stimati: 635
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Il punto prelievi di viale sardegna è aperto in estate?  [ASSISTENTE] Il punto prelievi di Via Sardegna 5, Fizzonasco di Pieve Emanuele, è aperto durante l'estate con i seguenti orari: da lunedì a venerdì dalle 7:00 alle 13:00. [...] it/info/esami-di-laboratorio/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:57.452981
====================================================================================================
📋 Session ID: classify_1756762557
⏱️  Processing Time: 1.749s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (567 chars):
   [UTENTE] Il punto prelievi di viale sardegna è aperto in estate?  [ASSISTENTE] Il punto prelievi di Via Sardegna 5, Fizzonasco di Pieve Emanuele, è aperto durante l'estate con i seguenti orari: da ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 596f9d96544cccbb7a427fd69ce4fc0f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 474
   📊 Token totali: 922
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 922 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 474
   📊 Token conversazione finale: 474
   📊 Token totali: 922
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1553 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere se sabato 30 settembre 2025 è possibile fare gli esami del sangue Humanitas fiordaliso? [ASSISTENTE] Presso Humanitas Medical Care Rozzano-Fiordaliso, il sabato è possibile effettuare prelievi del sangue dalle 7:30 alle 10:00 solo su prenotazione, e dalle 10:00 alle 11:00 c..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 474
   📊 Token totali stimati: 922
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere se sabato 30 settembre 2025 è possibile fare gli esami del sangue Humanitas fiordaliso? [ASSISTENTE] Presso Humanitas Medical Care Rozzano-Fiordaliso, il sabato è possibile effettuare prelievi del sangue dalle 7:30 alle 10:00 solo su prenotazione, e dalle 10:00 alle 11:00 c..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': 'La conversazione verte principalmente sulla prenotazione per gli esami del sangue e sulle modalità di accesso per persone con invalidità.', 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:35:59.276169
====================================================================================================
📋 Session ID: classify_1756762559
⏱️  Processing Time: 1.736s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1553 chars):
   [UTENTE] Vorrei sapere se sabato 30 settembre 2025 è possibile fare gli esami del sangue Humanitas fiordaliso? [ASSISTENTE] Presso Humanitas Medical Care Rozzano-Fiordaliso, il sabato è possibile e...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (210 chars):
   {'confidence': 0.95, 'motivation': 'La conversazione verte principalmente sulla prenotazione per gli esami del sangue e sulle modalità di accesso per persone con invalidità.', 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte principalmente sulla prenotazione per gli esami del sangue e sulle modalità di accesso per persone con invalidità.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla prenotazione per gli esami del sangue e sulle modalità di accesso per persone con invalidità.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3070f2d301d2fa6d7286ec7bd80d8440 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 203
   📊 Token totali: 631
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 631 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 203
   📊 Token conversazione finale: 203
   📊 Token totali: 631
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 614 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Orari farmacia per ritiro puntura [ASSISTENTE] La Farmacia dell’Istituto Clinico Humanitas è aperta dal lunedì al venerdì (esclusi i festivi) con i seguenti orari:  
- Mattina: dalle 8:30 alle 13:00;  
- Pomeriggio: dalle 14:00 alle 17:30. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2856 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 203
   📊 Token totali stimati: 631
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Orari farmacia per ritiro puntura [ASSISTENTE] La Farmacia dell’Istituto Clinico Humanitas è aperta dal lunedì al venerdì (esclusi i festivi) con i seguenti orari:  
- Mattina: dalle 8:30 alle 13:00;  
- Pomeriggio: dalle 14:00 alle 17:30. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:00.952045
====================================================================================================
📋 Session ID: classify_1756762560
⏱️  Processing Time: 1.589s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (614 chars):
   [UTENTE] Orari farmacia per ritiro puntura [ASSISTENTE] La Farmacia dell’Istituto Clinico Humanitas è aperta dal lunedì al venerdì (esclusi i festivi) con i seguenti orari:  
- Mattina: dalle 8:30 ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f68801e969c03682810e8ae393459e2c classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
   📈 Progresso LLM: 50/155
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 695
   📊 Token totali: 1143
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1143 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 695
   📊 Token conversazione finale: 695
   📊 Token totali: 1143
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2214 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Voglio sapere si posso fare domani, sabato, i seguenti esami de sangue: omocisteina, fattore di necrose tumorale, interleuchina 6 si 8 [ASSISTENTE] Puoi effettuare gli esami del sangue richiesti (omocisteina, fattore di necrosi tumorale, interleuchina 6 e 8) il sabato presso l'Istituto C..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 695
   📊 Token totali stimati: 1143
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Voglio sapere si posso fare domani, sabato, i seguenti esami de sangue: omocisteina, fattore di necrose tumorale, interleuchina 6 si 8 [ASSISTENTE] Puoi effettuare gli esami del sangue richiesti (omocisteina, fattore di necrosi tumorale, interleuchina 6 e 8) il sabato presso l'Istituto C..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of conversation:**\n\n- predicted_label: "Analisi"\n- confidence: 0.9\n- motivation: La'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:02.739577
====================================================================================================
📋 Session ID: classify_1756762562
⏱️  Processing Time: 1.702s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2214 chars):
   [UTENTE] Voglio sapere si posso fare domani, sabato, i seguenti esami de sangue: omocisteina, fattore di necrose tumorale, interleuchina 6 si 8 [ASSISTENTE] Puoi effettuare gli esami del sangue ric...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of conversation:**\n\n- predicted_label: "Analisi"\n- confidence: 0.9\n- motivation: La'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Classification of conversation:**

- predicted_label: "Analisi"
- confidence: 0.9
- motivation: La
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Classification of conversation:**

- predicted_label: "Analisi"
- confidence: 0.9
- motivation: La
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 03ec2500e7bb3a5c3cba6cc8f8c833e7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 381
   📊 Token totali: 830
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 830 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 381
   📊 Token conversazione finale: 381
   📊 Token totali: 830
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1128 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei prenotare una visita urologica [ASSISTENTE] Per prenotare una visita urologica presso l'Istituto Clinico Humanitas, puoi utilizzare i seguenti canali di prenotazione:

1. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2884 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 381
   📊 Token totali stimati: 830
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei prenotare una visita urologica [ASSISTENTE] Per prenotare una visita urologica presso l'Istituto Clinico Humanitas, puoi utilizzare i seguenti canali di prenotazione:

1. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:03.696681
====================================================================================================
📋 Session ID: classify_1756762563
⏱️  Processing Time: 0.871s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1128 chars):
   [UTENTE] Vorrei prenotare una visita urologica [ASSISTENTE] Per prenotare una visita urologica presso l'Istituto Clinico Humanitas, puoi utilizzare i seguenti canali di prenotazione:

1. **Privatam...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (184 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f9444c0df80a7e19c67b464617643c1a classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 208
   📊 Token totali: 636
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 636 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 208
   📊 Token conversazione finale: 208
   📊 Token totali: 636
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 671 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] HO PRENOTATO UNA TELEVISITA. [...] docx】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2645 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 208
   📊 Token totali stimati: 636
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] HO PRENOTATO UNA TELEVISITA. [...] docx】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sulla procedura di una televisita con uno specialista dell'ospedale Humanitas.", 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:05.259797
====================================================================================================
📋 Session ID: classify_1756762565
⏱️  Processing Time: 1.477s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (671 chars):
   [UTENTE] HO PRENOTATO UNA TELEVISITA. COME FUNZIONA? [ASSISTENTE] La televisita si svolge in questo modo:

1. All'orario fissato, accedi alla piattaforma cliccando sul link ricevuto via email.
2. V...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (182 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sulla procedura di una televisita con uno specialista dell'ospedale Humanitas.", 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.95
   motivation: La conversazione verte sulla procedura di una televisita con uno specialista dell'ospedale Humanitas.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla procedura di una televisita con uno specialista dell'ospedale Humanitas.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 533225af92535905192c288476ab3877 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 319
   📊 Token totali: 747
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 747 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 319
   📊 Token conversazione finale: 319
   📊 Token totali: 747
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1078 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao  [ASSISTENTE] Ciao! Come posso esserti utile? 😊 [UTENTE] Si  [ASSISTENTE] Perfetto! Dimmi pure, come posso aiutarti? 😊 [UTENTE] ho prenotato per il 15 settembre con il Dr. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2810 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 319
   📊 Token totali stimati: 747
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao  [ASSISTENTE] Ciao! Come posso esserti utile? 😊 [UTENTE] Si  [ASSISTENTE] Perfetto! Dimmi pure, come posso aiutarti? 😊 [UTENTE] ho prenotato per il 15 settembre con il Dr. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla conferma dell'utilizzo di un sistema specifico durante una prestazione medica prenotata e la disponibil"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:07.825709
====================================================================================================
📋 Session ID: classify_1756762567
⏱️  Processing Time: 2.479s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1078 chars):
   [UTENTE] Ciao  [ASSISTENTE] Ciao! Come posso esserti utile? 😊 [UTENTE] Si  [ASSISTENTE] Perfetto! Dimmi pure, come posso aiutarti? 😊 [UTENTE] ho prenotato per il 15 settembre con il Dr. Lamberto Zo...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla conferma dell'utilizzo di un sistema specifico durante una prestazione medica prenotata e la disponibil"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla conferma dell'utilizzo di un sistema specifico durante una prestazione medica prenotata e la disponibil
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla conferma dell'utilizzo di un sistema specifico durante una prestazione medica prenotata e la disponibil
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 77d5065d35a033ca622b2aeb437ddc75 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 195
   📊 Token totali: 623
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 623 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 195
   📊 Token conversazione finale: 195
   📊 Token totali: 623
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 661 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dovrei effettuare una enteroscopia con biopsia Humatis effettua questo tipo di prestazione  e il costo in regime privato [ASSISTENTE] Humanitas effettua l'enteroscopia con biopsia, una procedura che consente di esaminare il piccolo intestino e prelevare campioni di tessuto per analisi is..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 195
   📊 Token totali stimati: 623
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dovrei effettuare una enteroscopia con biopsia Humatis effettua questo tipo di prestazione  e il costo in regime privato [ASSISTENTE] Humanitas effettua l'enteroscopia con biopsia, una procedura che consente di esaminare il piccolo intestino e prelevare campioni di tessuto per analisi is..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:08.670027
====================================================================================================
📋 Session ID: classify_1756762568
⏱️  Processing Time: 0.758s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (661 chars):
   [UTENTE] Dovrei effettuare una enteroscopia con biopsia Humatis effettua questo tipo di prestazione  e il costo in regime privato [ASSISTENTE] Humanitas effettua l'enteroscopia con biopsia, una pro...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (184 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 4812ae45d0a43331e661a7f47b82fc1d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 407
   📊 Token totali: 856
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 856 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 407
   📊 Token conversazione finale: 407
   📊 Token totali: 856
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1204 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, sono Fava Piera (05/07/48) paziente del cardiologo dr Carlo Ceriotti che mi ha visitata ila Rozzano il 25/06/25 prescrivendo ECOCARDIO di controllo da fare entro 6 mesi x importante patologia. [...] 

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2953 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 407
   📊 Token totali stimati: 856
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, sono Fava Piera (05/07/48) paziente del cardiologo dr Carlo Ceriotti che mi ha visitata ila Rozzano il 25/06/25 prescrivendo ECOCARDIO di controllo da fare entro 6 mesi x importante patologia. [...] 

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Prenotazione",\n  "confidence": 0.85,\n  "m'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:10.696408
====================================================================================================
📋 Session ID: classify_1756762570
⏱️  Processing Time: 1.939s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1204 chars):
   [UTENTE] Buongiorno, sono Fava Piera (05/07/48) paziente del cardiologo dr Carlo Ceriotti che mi ha visitata ila Rozzano il 25/06/25 prescrivendo ECOCARDIO di controllo da fare entro 6 mesi x impor...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (197 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Prenotazione",\n  "confidence": 0.85,\n  "m'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Prenotazione",
  "confidence": 0.85,
  "m
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Prenotazione",
  "confidence": 0.85,
  "m
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 35ae94791c2a1703e15b2da159f5a8bb classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 150
   📊 Token totali: 598
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 598 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 150
   📊 Token conversazione finale: 150
   📊 Token totali: 598
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 487 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere gli orari di visita ai pazienti nel reparto ortopedia [ASSISTENTE] Per visitare i pazienti ricoverati in Humanitas, gli orari di visita possono variare a seconda del reparto. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2937 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 150
   📊 Token totali stimati: 598
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere gli orari di visita ai pazienti nel reparto ortopedia [ASSISTENTE] Per visitare i pazienti ricoverati in Humanitas, gli orari di visita possono variare a seconda del reparto. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Servizi aziendali",\n  "confidence": 0.95,'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:12.431508
====================================================================================================
📋 Session ID: classify_1756762572
⏱️  Processing Time: 1.649s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (487 chars):
   [UTENTE] Vorrei sapere gli orari di visita ai pazienti nel reparto ortopedia [ASSISTENTE] Per visitare i pazienti ricoverati in Humanitas, gli orari di visita possono variare a seconda del reparto....

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Servizi aziendali",\n  "confidence": 0.95,'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Servizi aziendali",
  "confidence": 0.95,
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Servizi aziendali",
  "confidence": 0.95,
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 43927d21cf26ba716367049ee01bdaa1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 276
   📊 Token totali: 724
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 724 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 276
   📊 Token conversazione finale: 276
   📊 Token totali: 724
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 841 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia, vorrei mettermi in contatto con la ginecologia del pio x [ASSISTENTE] Per contattare la ginecologia presso Humanitas San Pio X, puoi fare riferimento al Punto Nascita. [...]  Se hai bisogno di ulteriori dettagli, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2916 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 276
   📊 Token totali stimati: 724
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia, vorrei mettermi in contatto con la ginecologia del pio x [ASSISTENTE] Per contattare la ginecologia presso Humanitas San Pio X, puoi fare riferimento al Punto Nascita. [...]  Se hai bisogno di ulteriori dettagli, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:15.533438
====================================================================================================
📋 Session ID: classify_1756762575
⏱️  Processing Time: 3.016s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (841 chars):
   [UTENTE] Ciao Giulia, vorrei mettermi in contatto con la ginecologia del pio x [ASSISTENTE] Per contattare la ginecologia presso Humanitas San Pio X, puoi fare riferimento al Punto Nascita. È attiv...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 4026fc304cb11a0a5396a688e11fb8ad classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 87
   📊 Token totali: 515
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 515 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 87
   📊 Token conversazione finale: 87
   📊 Token totali: 515
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 279 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] a che ore siete aperti? [ASSISTENTE] Gli orari di apertura possono variare a seconda del servizio o del reparto che desideri visitare. Potresti specificare a quale servizio o reparto ti riferisci? Ad esempio, pronto soccorso, ufficio ritiro referti, punti prelievo, ecc."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2875 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 87
   📊 Token totali stimati: 515
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] a che ore siete aperti? [ASSISTENTE] Gli orari di apertura possono variare a seconda del servizio o del reparto che desideri visitare. Potresti specificare a quale servizio o reparto ti riferisci? Ad esempio, pronto soccorso, ufficio ritiro referti, punti prelievo, ecc."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'orario di apertura dei servizi dell'ospedale, pertanto la categoria più adatta è 'Servizi aziendali'.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:17.269009
====================================================================================================
📋 Session ID: classify_1756762577
⏱️  Processing Time: 1.649s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (279 chars):
   [UTENTE] a che ore siete aperti? [ASSISTENTE] Gli orari di apertura possono variare a seconda del servizio o del reparto che desideri visitare. Potresti specificare a quale servizio o reparto ti ri...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (207 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'orario di apertura dei servizi dell'ospedale, pertanto la categoria più adatta è 'Servizi aziendali'.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'orario di apertura dei servizi dell'ospedale, pertanto la categoria più adatta è 'Servizi aziendali'.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'orario di apertura dei servizi dell'ospedale, pertanto la categoria più adatta è 'Servizi aziendali'.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione e4bb731e7e10f0cc4a92df05f0e40ec1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 188
   📊 Token totali: 636
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 636 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 188
   📊 Token conversazione finale: 188
   📊 Token totali: 636
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 663 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] La struttura è convenzionata ma alcuni medici non lo sono Unisalute [ASSISTENTE] Se ti riferisci alla possibilità di prenotare visite o esami con Unisalute, è importante sapere che alcune prestazioni potrebbero essere coperte dalla convenzione, mentre altre no. Inoltre, non tutti i medic..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 188
   📊 Token totali stimati: 636
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] La struttura è convenzionata ma alcuni medici non lo sono Unisalute [ASSISTENTE] Se ti riferisci alla possibilità di prenotare visite o esami con Unisalute, è importante sapere che alcune prestazioni potrebbero essere coperte dalla convenzione, mentre altre no. Inoltre, non tutti i medic..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'prenotazione', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:20.044760
====================================================================================================
📋 Session ID: classify_1756762580
⏱️  Processing Time: 2.688s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (663 chars):
   [UTENTE] La struttura è convenzionata ma alcuni medici non lo sono Unisalute [ASSISTENTE] Se ti riferisci alla possibilità di prenotare visite o esami con Unisalute, è importante sapere che alcune ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (104 chars):
   {'predicted_label': 'prenotazione', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: prenotazione
   confidence: 0.6
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.600
   [████████████░░░░░░░░] 60.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione ae96a6e07793fe268c5fa208380808c3 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 129
   📊 Token totali: 578
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 578 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 129
   📊 Token conversazione finale: 129
   📊 Token totali: 578
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 457 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] come prenotare albergo convenzionato [ASSISTENTE] Per prenotare una struttura alberghiera convenzionata con Humanitas, puoi consultare l'elenco delle strutture disponibili alla pagina dedicata sul sito di Humanitas. [...] 

Se hai necessità di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 129
   📊 Token totali stimati: 578
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] come prenotare albergo convenzionato [ASSISTENTE] Per prenotare una struttura alberghiera convenzionata con Humanitas, puoi consultare l'elenco delle strutture disponibili alla pagina dedicata sul sito di Humanitas. [...] 

Se hai necessità di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.95,'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:21.522425
====================================================================================================
📋 Session ID: classify_1756762581
⏱️  Processing Time: 1.390s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (457 chars):
   [UTENTE] come prenotare albergo convenzionato [ASSISTENTE] Per prenotare una struttura alberghiera convenzionata con Humanitas, puoi consultare l'elenco delle strutture disponibili alla pagina dedi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.95,'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.95,
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.95,
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b7f210973519ed8ef2fc5c5b98395523 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 169
   📊 Token totali: 618
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 618 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 169
   📊 Token conversazione finale: 169
   📊 Token totali: 618
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 557 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ci sono navette da Milano Linate per l'ospedale? [ASSISTENTE] Non ci sono informazioni specifiche sulla presenza di navette dirette da Milano Linate all'Istituto Clinico Humanitas. [...] it/info/viaggi)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2880 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 169
   📊 Token totali stimati: 618
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ci sono navette da Milano Linate per l'ospedale? [ASSISTENTE] Non ci sono informazioni specifiche sulla presenza di navette dirette da Milano Linate all'Istituto Clinico Humanitas. [...] it/info/viaggi)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:23.192395
====================================================================================================
📋 Session ID: classify_1756762583
⏱️  Processing Time: 1.575s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (557 chars):
   [UTENTE] Ci sono navette da Milano Linate per l'ospedale? [ASSISTENTE] Non ci sono informazioni specifiche sulla presenza di navette dirette da Milano Linate all'Istituto Clinico Humanitas. Tuttavi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f7ba3d5a54ba3bf7c169fa060090785e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 447
   💬 Token conversazione: 731
   📊 Token totali: 1178
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1178 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 447
   📊 Token conversazione originale: 731
   📊 Token conversazione finale: 731
   📊 Token totali: 1178
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2360 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao sono Giada, ho bisogno di aiuto per l'aereo  [ASSISTENTE] Ciao Giada! Potresti spiegarmi meglio di cosa hai bisogno riguardo l'aereo? Ad esempio, hai bisogno di indicazioni per raggiungere un aeroporto, informazioni sui voli o altro? Sono qui per aiutarti! [UTENTE] Informazioni sui ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2960 characters
🔢 Token Analysis:
   📊 Token prompt base: 447
   📊 Token conversazione: 731
   📊 Token totali stimati: 1178
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao sono Giada, ho bisogno di aiuto per l'aereo  [ASSISTENTE] Ciao Giada! Potresti spiegarmi meglio di cosa hai bisogno riguardo l'aereo? Ad esempio, hai bisogno di indicazioni per raggiungere un aeroporto, informazioni sui voli o altro? Sono qui per aiutarti! [UTENTE] Informazioni sui ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: Ecco i risultati della classificazione automatica della conversazione:\n\n| predicted_label       | co'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:26.524837
====================================================================================================
📋 Session ID: classify_1756762586
⏱️  Processing Time: 3.246s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2360 chars):
   [UTENTE] Ciao sono Giada, ho bisogno di aiuto per l'aereo  [ASSISTENTE] Ciao Giada! Potresti spiegarmi meglio di cosa hai bisogno riguardo l'aereo? Ad esempio, hai bisogno di indicazioni per raggiu...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (193 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: Ecco i risultati della classificazione automatica della conversazione:\n\n| predicted_label       | co'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: Ecco i risultati della classificazione automatica della conversazione:

| predicted_label       | co
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: Ecco i risultati della classificazione automatica della conversazione:

| predicted_label       | co
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione bee5254d49937851ad262f5604b6953e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 382
   📊 Token totali: 810
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 810 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 382
   📊 Token conversazione finale: 382
   📊 Token totali: 810
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1280 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Salve Giulia, se prenoto un volo, tramite le vostre convenzioni viaggiare insieme, è  prevista l'assistenza medica o solo una scontistica del prezzo del biglietto aereo? [ASSISTENTE] La convenzione "Viaggia insieme a noi" di Humanitas offre sconti sui biglietti aerei (50%-55% sulle tarif..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 382
   📊 Token totali stimati: 810
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Salve Giulia, se prenoto un volo, tramite le vostre convenzioni viaggiare insieme, è  prevista l'assistenza medica o solo una scontistica del prezzo del biglietto aereo? [ASSISTENTE] La convenzione "Viaggia insieme a noi" di Humanitas offre sconti sui biglietti aerei (50%-55% sulle tarif..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted Label:** Prenotazione\n\n**Confidence:** 0.95\n\n**Motivation:** La conversazione verte prin'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:28.152621
====================================================================================================
📋 Session ID: classify_1756762588
⏱️  Processing Time: 1.540s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1280 chars):
   [UTENTE] Salve Giulia, se prenoto un volo, tramite le vostre convenzioni viaggiare insieme, è  prevista l'assistenza medica o solo una scontistica del prezzo del biglietto aereo? [ASSISTENTE] La co...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted Label:** Prenotazione\n\n**Confidence:** 0.95\n\n**Motivation:** La conversazione verte prin'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted Label:** Prenotazione

**Confidence:** 0.95

**Motivation:** La conversazione verte prin
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted Label:** Prenotazione

**Confidence:** 0.95

**Motivation:** La conversazione verte prin
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 862cbc707fa27a720eaf210b5785e8c0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 127
   📊 Token totali: 575
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 575 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 127
   📊 Token conversazione finale: 127
   📊 Token totali: 575
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 439 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Desidero sapere il costo di una prima visita proctologica  [ASSISTENTE] Non ho trovato informazioni specifiche sul costo di una prima visita proctologica nei documenti forniti. [...] it/visite-ed-esami/visita-proctologica)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2899 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 127
   📊 Token totali stimati: 575
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Desidero sapere il costo di una prima visita proctologica  [ASSISTENTE] Non ho trovato informazioni specifiche sul costo di una prima visita proctologica nei documenti forniti. [...] it/visite-ed-esami/visita-proctologica)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:30.161438
====================================================================================================
📋 Session ID: classify_1756762590
⏱️  Processing Time: 1.923s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (439 chars):
   [UTENTE] Desidero sapere il costo di una prima visita proctologica  [ASSISTENTE] Non ho trovato informazioni specifiche sul costo di una prima visita proctologica nei documenti forniti. Ti consigli...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 2d9dea84af5815172145692f24da4d9f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 201
   📊 Token totali: 649
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 649 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 201
   📊 Token conversazione finale: 201
   📊 Token totali: 649
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 693 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei fare vaccino anti epatite A [ASSISTENTE] Per sapere se è possibile effettuare il vaccino contro l'epatite A presso Humanitas, ti consiglio di contattare direttamente il centralino al numero 02 82241. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2955 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 201
   📊 Token totali stimati: 649
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei fare vaccino anti epatite A [ASSISTENTE] Per sapere se è possibile effettuare il vaccino contro l'epatite A presso Humanitas, ti consiglio di contattare direttamente il centralino al numero 02 82241. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': 'La conversazione verte sulla prenotazione del vaccino anti epatite A e sul metodo di prenotazione.', 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:31.751006
====================================================================================================
📋 Session ID: classify_1756762591
⏱️  Processing Time: 1.503s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (693 chars):
   [UTENTE] Vorrei fare vaccino anti epatite A [ASSISTENTE] Per sapere se è possibile effettuare il vaccino contro l'epatite A presso Humanitas, ti consiglio di contattare direttamente il centralino a...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (171 chars):
   {'confidence': 0.95, 'motivation': 'La conversazione verte sulla prenotazione del vaccino anti epatite A e sul metodo di prenotazione.', 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte sulla prenotazione del vaccino anti epatite A e sul metodo di prenotazione.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla prenotazione del vaccino anti epatite A e sul metodo di prenotazione.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 02e11e22451ecbcf17ab24b847f35c84 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 358
   📊 Token totali: 806
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 806 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 358
   📊 Token conversazione finale: 358
   📊 Token totali: 806
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1220 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao, devo fare il rinnovo del certificato DSA, volevo sapere cosa devo fare e quanto mi viene a costare e poi volevo chiedere se potevo farlo a pagamento?  [ASSISTENTE] Non ho trovato informazioni specifiche sul rinnovo del certificato DSA nei documenti caricati. Ti consiglio di contatt..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 358
   📊 Token totali stimati: 806
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao, devo fare il rinnovo del certificato DSA, volevo sapere cosa devo fare e quanto mi viene a costare e poi volevo chiedere se potevo farlo a pagamento?  [ASSISTENTE] Non ho trovato informazioni specifiche sul rinnovo del certificato DSA nei documenti caricati. Ti consiglio di contatt..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla richiesta di informazioni sul rinnovo del certificato DSA e sulle email fornite dall'utente. Non ci son"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:34.433904
====================================================================================================
📋 Session ID: classify_1756762594
⏱️  Processing Time: 2.598s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1220 chars):
   [UTENTE] ciao, devo fare il rinnovo del certificato DSA, volevo sapere cosa devo fare e quanto mi viene a costare e poi volevo chiedere se potevo farlo a pagamento?  [ASSISTENTE] Non ho trovato inf...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla richiesta di informazioni sul rinnovo del certificato DSA e sulle email fornite dall'utente. Non ci son"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla richiesta di informazioni sul rinnovo del certificato DSA e sulle email fornite dall'utente. Non ci son
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla richiesta di informazioni sul rinnovo del certificato DSA e sulle email fornite dall'utente. Non ci son
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 73a8f5b60475b3bf2d598a246fc03d8f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 142
   📊 Token totali: 570
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 570 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 142
   📊 Token conversazione finale: 142
   📊 Token totali: 570
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 531 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei acquistare tramite welfare un checkup uomo personalizzato del valore di 1000euro, in cosa consiste il checkup personalizzato del valore di 1000euro?  [ASSISTENTE] Non ho trovato informazioni specifiche sul checkup uomo personalizzato del valore di 1000 euro nei documenti caricati...."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 142
   📊 Token totali stimati: 570
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei acquistare tramite welfare un checkup uomo personalizzato del valore di 1000euro, in cosa consiste il checkup personalizzato del valore di 1000euro?  [ASSISTENTE] Non ho trovato informazioni specifiche sul checkup uomo personalizzato del valore di 1000 euro nei documenti caricati...."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 [DEBUG] GET review cases per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ [DEBUG] Tenant risolto: Humanitas (humanitas)
🔍 [DEBUG] Ottieni mongo reader per tenant: humanitas
🔧 Creazione MongoClassificationReader per cliente: humanitas
🔍 Risoluzione tenant da slug: humanitas
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto da slug (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da slug: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
✅ MongoClassificationReader creato per tenant: Humanitas (humanitas)
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
✅ Connesso a MongoDB database: classificazioni
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🔍 Review Queue recuperate 0 sessioni (representatives: True, propagated: True, outliers: True)
🏷️ Recupero etichette per tenant: Humanitas
📊 Calcolo statistiche per tenant: Humanitas
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:35.872848
====================================================================================================
📋 Session ID: classify_1756762595
⏱️  Processing Time: 1.352s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (531 chars):
   [UTENTE] Vorrei acquistare tramite welfare un checkup uomo personalizzato del valore di 1000euro, in cosa consiste il checkup personalizzato del valore di 1000euro?  [ASSISTENTE] Non ho trovato inf...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 6a6b57073ece1a8ab3753fabc21f1e07 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 178
   📊 Token totali: 626
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 626 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 178
   📊 Token conversazione finale: 178
   📊 Token totali: 626
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 543 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia, io devo venire in Humanitas domani. [...] )

Fammi sapere così posso darti indicazioni precise! [UTENTE] Rozzano, mezzi pubblici [ASSISTENTE] Perfetto! Vuoi utilizzare l'autobus, la metro, il tram o il treno per raggiungere Humanitas Rozzano da Porta Venezia?"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2949 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 178
   📊 Token totali stimati: 626
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia, io devo venire in Humanitas domani. [...] )

Fammi sapere così posso darti indicazioni precise! [UTENTE] Rozzano, mezzi pubblici [ASSISTENTE] Perfetto! Vuoi utilizzare l'autobus, la metro, il tram o il treno per raggiungere Humanitas Rozzano da Porta Venezia?"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:37.523861
====================================================================================================
📋 Session ID: classify_1756762597
⏱️  Processing Time: 1.565s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (543 chars):
   [UTENTE] Ciao Giulia, io devo venire in Humanitas domani. Come posso arrivarci da Porta Venezia? [ASSISTENTE] Per aiutarti al meglio, ho bisogno di sapere:

1. In quale sede di Humanitas devi andar...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 9747f54127f9236d8274a4b7ea4303f0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 85
   📊 Token totali: 513
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 513 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 85
   📊 Token conversazione finale: 85
   📊 Token totali: 513
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 267 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] La linea 220 è extraurbana? [ASSISTENTE] Sì, la linea 220 è una linea extraurbana che collega Humanitas con Pieve Emanuele, Opera e Locate, partendo da Rozzano, via della Solidarietà【6:0†scraped_https___www.humanitas.it_info_come-raggiungere-humanitas.json】."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2863 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 85
   📊 Token totali stimati: 513
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] La linea 220 è extraurbana? [ASSISTENTE] Sì, la linea 220 è una linea extraurbana che collega Humanitas con Pieve Emanuele, Opera e Locate, partendo da Rozzano, via della Solidarietà【6:0†scraped_https___www.humanitas.it_info_come-raggiungere-humanitas.json】."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🎯 [CLUSTERING CONFIG] Caricando parametri personalizzati per tenant 015007d9-d413-11ef-86a5-96000228e7fe
   allow_single_cluster: non_definito -> False
   alpha: non_definito -> 0.4
   cluster_selection_epsilon: non_definito -> 0.28
   cluster_selection_method: non_definito -> leaf
   max_cluster_size: non_definito -> 0
   metric: non_definito -> euclidean
   min_cluster_size: 5 -> 13
   min_samples: 3 -> 16
   only_user: non_definito -> False
   umap_metric: non_definito -> cosine
   umap_min_dist: non_definito -> 0
   umap_n_components: non_definito -> 17
   umap_n_neighbors: non_definito -> 30
   umap_random_state: non_definito -> 42
   use_umap: non_definito -> True
📈 [API] Recuperato storico clustering: 41 versioni per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🎯 [CLUSTERING CONFIG] Caricando parametri personalizzati per tenant 015007d9-d413-11ef-86a5-96000228e7fe
   allow_single_cluster: non_definito -> False
   alpha: non_definito -> 0.4
   cluster_selection_epsilon: non_definito -> 0.28
   cluster_selection_method: non_definito -> leaf
   max_cluster_size: non_definito -> 0
   metric: non_definito -> euclidean
   min_cluster_size: 5 -> 13
   min_samples: 3 -> 16
   only_user: non_definito -> False
   umap_metric: non_definito -> cosine
   umap_min_dist: non_definito -> 0
   umap_n_components: non_definito -> 17
   umap_n_neighbors: non_definito -> 30
   umap_random_state: non_definito -> 42
   use_umap: non_definito -> True
📈 [API] Recuperato storico clustering: 41 versioni per tenant 015007d9-d413-11ef-86a5-96000228e7fe
📊 [API] Recuperata versione 41 per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '| predicted_label         | confidenza | motivazione                      |'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:40.160339
====================================================================================================
📋 Session ID: classify_1756762600
⏱️  Processing Time: 2.550s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (267 chars):
   [UTENTE] La linea 220 è extraurbana? [ASSISTENTE] Sì, la linea 220 è una linea extraurbana che collega Humanitas con Pieve Emanuele, Opera e Locate, partendo da Rozzano, via della Solidarietà【6:0†s...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (140 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '| predicted_label         | confidenza | motivazione                      |'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: | predicted_label         | confidenza | motivazione                      |
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   | predicted_label         | confidenza | motivazione                      |
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 71e43c5465a693dafba71ffe1bc1c9ac classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 303
   📊 Token totali: 731
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 731 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 303
   📊 Token conversazione finale: 303
   📊 Token totali: 731
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 903 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao giulia abito a lesmo come raggiungo la sede di rozzano in auto [ASSISTENTE] Per aiutarti a raggiungere la sede di Rozzano in auto da Lesmo, calcolo il percorso. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2842 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 303
   📊 Token totali stimati: 731
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao giulia abito a lesmo come raggiungo la sede di rozzano in auto [ASSISTENTE] Per aiutarti a raggiungere la sede di Rozzano in auto da Lesmo, calcolo il percorso. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🎛️ Configurazioni AI saranno salvate su DATABASE MySQL
🔧 API: Recupero tools per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 API: Recupero prompt per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
🎛️ AIConfigurationService inizializzato
   � Backend: DATABASE MySQL
   🔑 OpenAI API Key: ✅ Configurata
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Query eseguita per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Risultato database: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'embedding_config': None, 'llm_config': None, 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45)}
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Recuperati 1 tools per tenant 015007d9-d413-11ef-86a5-96000228e7fe
✅ Recuperati 5 prompt per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
🔧 API: Recupero tools per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
✅ Recuperati 1 tools per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔍 API: Recupero prompt per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
✅ Recuperati 5 prompt per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔧 API: Recupero tools per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
✅ Recuperati 1 tools per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔧 API: Recupero tools per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
✅ Recuperati 1 tools per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:42.074300
====================================================================================================
📋 Session ID: classify_1756762602
⏱️  Processing Time: 1.829s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (903 chars):
   [UTENTE] ciao giulia abito a lesmo come raggiungo la sede di rozzano in auto [ASSISTENTE] Per aiutarti a raggiungere la sede di Rozzano in auto da Lesmo, calcolo il percorso. Un attimo di pazienza....

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 427bce9101bac0b034ee5e42d93afb85 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 85
   📊 Token totali: 533
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 533 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 85
   📊 Token conversazione finale: 85
   📊 Token totali: 533
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 277 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, vorrei capire come arrivare dall’autostrada al centro di P Ricovero via Building 4 [ASSISTENTE] Per aiutarti al meglio, potresti specificare da quale autostrada stai arrivando? Inoltre, desideri sapere il percorso in auto o con un altro mezzo di trasporto?"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2945 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 85
   📊 Token totali stimati: 533
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, vorrei capire come arrivare dall’autostrada al centro di P Ricovero via Building 4 [ASSISTENTE] Per aiutarti al meglio, potresti specificare da quale autostrada stai arrivando? Inoltre, desideri sapere il percorso in auto o con un altro mezzo di trasporto?"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🎛️ Configurazioni AI saranno salvate su DATABASE MySQL
🎛️ AIConfigurationService inizializzato
   � Backend: DATABASE MySQL
   🔑 OpenAI API Key: ✅ Configurata
🏭 EmbeddingEngineFactory inizializzata
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
📋 Caricamento parametri LLM globali per tenant: 015007d9-d413-11ef-86a5-96000228e7fe
🎯 Config LLM caricata per 015007d9-d413-11ef-86a5-96000228e7fe (fonte: global)
   📝 Max output tokens: 150
   📊 Max input tokens: 8000
   🌡️  Temperature: 0.1
   🔢 Top K: 40, Top P: 0.9
🎛️ Configurazioni AI saranno salvate su DATABASE MySQL
🎛️ AIConfigurationService inizializzato
   � Backend: DATABASE MySQL
   🔑 OpenAI API Key: ✅ Configurata
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔧 FORCE NO CACHE: Bypass cache per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔥 FORCE NO CACHE: Bypasso cache e leggo DIRETTAMENTE dal database per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Query eseguita per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Risultato database: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'embedding_config': None, 'llm_config': None, 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45)}
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🎲 DATABASE: Modello trovato per 015007d9-d413-11ef-86a5-96000228e7fe: mistral-nemo:latest
🎯 Uso modello dal DATABASE per 015007d9-d413-11ef-86a5-96000228e7fe: mistral-nemo:latest
🔍 LLM Debugger inizializzato e ATTIVO
   📝 Debug file: ./debug_logs/llm_debug.log
   🎨 Visual formatting: True
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
🗄️ MongoClassificationReader inizializzato per tenant: Humanitas
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
Connessione al database TAG stabilita con successo
📋 Recuperati 29 tag dal database TAGS per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
⚠️  Fallback a config LEGACY per embedding
🔧 TokenizationManager inizializzato:
   📊 Modello tokenizer: cl100k_base
   🔢 Limite massimo token: 8000
   ✂️  Strategia troncamento: start
📋 Caricamento parametri LLM globali per tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📋 [API] Parametri LLM per tenant 015007d9-d413-11ef-86a5-96000228e7fe (fonte: global)
🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso alle strutture dell'ospedale e non riguarda specificamente un servizio clinico o di assistenza medica.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:43.802182
====================================================================================================
📋 Session ID: classify_1756762603
⏱️  Processing Time: 1.626s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (277 chars):
   [UTENTE] Buongiorno, vorrei capire come arrivare dall’autostrada al centro di P Ricovero via Building 4 [ASSISTENTE] Per aiutarti al meglio, potresti specificare da quale autostrada stai arrivando?...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (216 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso alle strutture dell'ospedale e non riguarda specificamente un servizio clinico o di assistenza medica.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'accesso alle strutture dell'ospedale e non riguarda specificamente un servizio clinico o di assistenza medica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso alle strutture dell'ospedale e non riguarda specificamente un servizio clinico o di assistenza medica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
📋 [LLMConfigService] Modelli ricaricati e cached: 4
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
📋 [API] Info modello mistral-nemo:latest recuperate
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 85e71c3a117e15f731fc13721e6016f0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
📋 Caricamento parametri LLM globali per tenant: 015007d9-d413-11ef-86a5-96000228e7fe
🎯 Config LLM caricata per 015007d9-d413-11ef-86a5-96000228e7fe (fonte: global)
   📝 Max output tokens: 150
   📊 Max input tokens: 8000
   🌡️  Temperature: 0.1
   🔢 Top K: 40, Top P: 0.9
Connessione al database TAG stabilita con successo
🎛️ Configurazioni AI saranno salvate su DATABASE MySQL
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🎛️ AIConfigurationService inizializzato
   � Backend: DATABASE MySQL
   🔑 OpenAI API Key: ✅ Configurata
Connessione al database TAG chiusa
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔧 FORCE NO CACHE: Bypass cache per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔥 FORCE NO CACHE: Bypasso cache e leggo DIRETTAMENTE dal database per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Query eseguita per tenant_id: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] Risultato database: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'embedding_config': None, 'llm_config': None, 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45)}
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🎲 DATABASE: Modello trovato per 015007d9-d413-11ef-86a5-96000228e7fe: mistral-nemo:latest
🎯 Uso modello dal DATABASE per 015007d9-d413-11ef-86a5-96000228e7fe: mistral-nemo:latest
🔍 LLM Debugger inizializzato e ATTIVO
   📝 Debug file: ./debug_logs/llm_debug.log
   🎨 Visual formatting: True
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
✅ MongoClassificationReader inizializzato per tenant: Humanitas
   📊 Collection: humanitas_015007d9-d413-11ef-86a5-96000228e7fe
   🏢 Database: classificazioni
🗄️ MongoClassificationReader inizializzato per tenant: Humanitas
📋 [LLMConfigService] Modelli ricaricati e cached: 4
📋 [API] Modelli disponibili per tenant 015007d9-d413-11ef-86a5-96000228e7fe: 4
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 0s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
Connessione al database TAG stabilita con successo
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 0s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 181
   📊 Token totali: 629
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 629 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 181
   📊 Token conversazione finale: 181
   📊 Token totali: 629
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 692 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao,vorrei sapere se ci sono degli incontri gratuiti dove spiegano tutto il percorso di inseminazione assistita,con ginecologi,psicologi [ASSISTENTE] Per quanto riguarda il percorso di inseminazione assistita, Humanitas offre un Fertility Center specializzato in procreazione medicalment..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 181
   📊 Token totali stimati: 629
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao,vorrei sapere se ci sono degli incontri gratuiti dove spiegano tutto il percorso di inseminazione assistita,con ginecologi,psicologi [ASSISTENTE] Per quanto riguarda il percorso di inseminazione assistita, Humanitas offre un Fertility Center specializzato in procreazione medicalment..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

Connessione al database TAG stabilita con successo
📋 Recuperati 29 tag dal database TAGS per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
⚠️  Fallback a config LEGACY per embedding
🔧 TokenizationManager inizializzato:
   📊 Modello tokenizer: cl100k_base
   🔢 Limite massimo token: 8000
   ✂️  Strategia troncamento: start
📋 Caricamento parametri LLM globali per tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📋 [API] Parametri LLM per tenant 015007d9-d413-11ef-86a5-96000228e7fe (fonte: global)
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
training:
  extraction:
    full_clustering_required: true
    ignore_session_limits: true
    use_full_dataset: true
  human_review:
    confidence_threshold_priority: 0.7
    max_representatives_per_cluster: 5
    max_total_sessions: 500
    min_cluster_size_♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 0s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 0s)
📋 [API] Modelli disponibili per tenant 015007d9-d413-11ef-86a5-96000228e7fe: 4
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 0s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
📋 [API] Info modello mistral-nemo:latest recuperate
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 0s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 0s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Visita Specialistica",\n  "confidence": 0.'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:45.907887
====================================================================================================
📋 Session ID: classify_1756762605
⏱️  Processing Time: 1.945s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (692 chars):
   [UTENTE] Ciao,vorrei sapere se ci sono degli incontri gratuiti dove spiegano tutto il percorso di inseminazione assistita,con ginecologi,psicologi [ASSISTENTE] Per quanto riguarda il percorso di in...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Visita Specialistica",\n  "confidence": 0.'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Visita Specialistica",
  "confidence": 0.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Visita Specialistica",
  "confidence": 0.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 55f3a35575bf4120300c03e1868aaaad classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 697
   📊 Token totali: 1145
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1145 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 697
   📊 Token conversazione finale: 697
   📊 Token totali: 1145
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2276 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao! ho bisogno di informazioni sulla crioconservazione degli ovociti [ASSISTENTE] La crioconservazione degli ovociti è una tecnica che consente di preservare la fertilità congelando gli ovociti in azoto liquido. [...] 

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2963 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 697
   📊 Token totali stimati: 1145
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao! ho bisogno di informazioni sulla crioconservazione degli ovociti [ASSISTENTE] La crioconservazione degli ovociti è una tecnica che consente di preservare la fertilità congelando gli ovociti in azoto liquido. [...] 

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: Ecco i risultati della classificazione:\n\n- predicted_label: "Analisi"\n- confidence: 0.9\n- motivation'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:47.706639
====================================================================================================
📋 Session ID: classify_1756762607
⏱️  Processing Time: 1.712s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2276 chars):
   [UTENTE] ciao! ho bisogno di informazioni sulla crioconservazione degli ovociti [ASSISTENTE] La crioconservazione degli ovociti è una tecnica che consente di preservare la fertilità congelando gli ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: Ecco i risultati della classificazione:\n\n- predicted_label: "Analisi"\n- confidence: 0.9\n- motivation'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: Ecco i risultati della classificazione:

- predicted_label: "Analisi"
- confidence: 0.9
- motivation
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: Ecco i risultati della classificazione:

- predicted_label: "Analisi"
- confidence: 0.9
- motivation
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 49c4a8458c94cccbd226757980bda359 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 419
   📊 Token totali: 868
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 868 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 419
   📊 Token conversazione finale: 419
   📊 Token totali: 868
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1470 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei avere informazioni su come accedere alla PMA [ASSISTENTE] Per accedere alla Procreazione Medicalmente Assistita (PMA) presso Humanitas, puoi seguire un percorso dedicato che include diverse tecniche, come l'inseminazione intrauterina (IUI) e la fecondazione in vitro (FIVET/ICSI). ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 419
   📊 Token totali stimati: 868
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei avere informazioni su come accedere alla PMA [ASSISTENTE] Per accedere alla Procreazione Medicalmente Assistita (PMA) presso Humanitas, puoi seguire un percorso dedicato che include diverse tecniche, come l'inseminazione intrauterina (IUI) e la fecondazione in vitro (FIVET/ICSI). ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 6s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte sull'accesso alla Procreazione Medicalmente Assistita (PMA) presso Humanitas e sui requisiti per l'accesso tramite il Serviz"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:50.918929
====================================================================================================
📋 Session ID: classify_1756762610
⏱️  Processing Time: 3.126s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1470 chars):
   [UTENTE] Vorrei avere informazioni su come accedere alla PMA [ASSISTENTE] Per accedere alla Procreazione Medicalmente Assistita (PMA) presso Humanitas, puoi seguire un percorso dedicato che include...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte sull'accesso alla Procreazione Medicalmente Assistita (PMA) presso Humanitas e sui requisiti per l'accesso tramite il Serviz"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte sull'accesso alla Procreazione Medicalmente Assistita (PMA) presso Humanitas e sui requisiti per l'accesso tramite il Serviz
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte sull'accesso alla Procreazione Medicalmente Assistita (PMA) presso Humanitas e sui requisiti per l'accesso tramite il Serviz
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 5e376c8c57668ea4d2f41572a8ab8066 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 927
   📊 Token totali: 1375
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1375 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 927
   📊 Token conversazione finale: 927
   📊 Token totali: 1375
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 3113 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] informazioni su p,a omologa [ASSISTENTE] Non ho trovato informazioni specifiche sulla "P. [...]  Se desideri ulteriori informazioni sui percorsi di PMA eterologa presso Humanitas, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2870 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 927
   📊 Token totali stimati: 1375
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] informazioni su p,a omologa [ASSISTENTE] Non ho trovato informazioni specifiche sulla "P. [...]  Se desideri ulteriori informazioni sui percorsi di PMA eterologa presso Humanitas, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 7s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 8s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted Label:** PMA\n\n**Confidence:** 0.75\n\n**Motivation:** La conversazione verte principalment'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:53.247422
====================================================================================================
📋 Session ID: classify_1756762613
⏱️  Processing Time: 2.242s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (3113 chars):
   [UTENTE] informazioni su p,a omologa [ASSISTENTE] Non ho trovato informazioni specifiche sulla "P.A. omologa" nei documenti caricati. Potresti fornire ulteriori dettagli o chiarire la tua richiesta...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted Label:** PMA\n\n**Confidence:** 0.75\n\n**Motivation:** La conversazione verte principalment'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted Label:** PMA

**Confidence:** 0.75

**Motivation:** La conversazione verte principalment
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted Label:** PMA

**Confidence:** 0.75

**Motivation:** La conversazione verte principalment
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione fafd6e5d206ab18a697f88af3710780a classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 209
   📊 Token totali: 657
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 657 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 209
   📊 Token conversazione finale: 209
   📊 Token totali: 657
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 642 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dove parcheggiare  [ASSISTENTE] In quale building o sede Humanitas devi andare? Così posso indicarti il parcheggio più vicino. [...] it/info/come-raggiungere-humanitas/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2846 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 209
   📊 Token totali stimati: 657
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dove parcheggiare  [ASSISTENTE] In quale building o sede Humanitas devi andare? Così posso indicarti il parcheggio più vicino. [...] it/info/come-raggiungere-humanitas/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 10s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Visita Specialistica Oncologica",\n  "conf'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:54.988908
====================================================================================================
📋 Session ID: classify_1756762614
⏱️  Processing Time: 1.656s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (642 chars):
   [UTENTE] Dove parcheggiare  [ASSISTENTE] In quale building o sede Humanitas devi andare? Così posso indicarti il parcheggio più vicino. [UTENTE] Devo fare visita oncologica  [ASSISTENTE] Per una vi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Visita Specialistica Oncologica",\n  "conf'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Visita Specialistica Oncologica",
  "conf
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Visita Specialistica Oncologica",
  "conf
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 8be704f169205e85923d0fad4d1263f5 classificata tramite LLM diretto (classificazione=unknown)
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Utente confuso - semplifica classificazione verso problemi tecnici

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 452
   💬 Token conversazione: 191
   📊 Token totali: 643
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 643 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 452
   📊 Token conversazione originale: 191
   📊 Token conversazione finale: 191
   📊 Token totali: 643
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 614 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] il parcheggio per 2 ore e 35 minuti mi è stato fatto pagare 9,50 quando la tariffa massima risulta 8 euro [ASSISTENTE] Il costo massimo giornaliero per i parcheggi Humanitas (eccetto il Parcheggio 3) è di 8 euro. [...]  Se hai bisogno di ulteriori dettagli, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2972 characters
🔢 Token Analysis:
   📊 Token prompt base: 452
   📊 Token conversazione: 191
   📊 Token totali stimati: 643
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Utente confuso - semplifica classificazione verso problemi tecnici

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] il parcheggio per 2 ore e 35 minuti mi è stato fatto pagare 9,50 quando la tariffa massima risulta 8 euro [ASSISTENTE] Il costo massimo giornaliero per i parcheggi Humanitas (eccetto il Parcheggio 3) è di 8 euro. [...]  Se hai bisogno di ulteriori dettagli, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 [DEBUG] get_model_info cercando: mistral-nemo:latest
♻️  [LLMConfigService] Uso cache modelli: 4 modelli (età: 12s)
🔍 [DEBUG] Modelli configurati: ['mistral:7b', 'mistral-nemo:latest', 'llama3.3:70b-instruct-q2_K', 'gpt-oss:20b']
✅ [DEBUG] Modello mistral-nemo:latest trovato nei configurati
💾 [LLMConfigService] Backup creato: /home/ubuntu/classificatore/backup/config_20250901_213656.yaml
💾 [LLMConfigService] Parametri aggiornati per tenant 015007d9-d413-11ef-86a5-96000228e7fe
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:56.668502
====================================================================================================
📋 Session ID: classify_1756762616
⏱️  Processing Time: 1.594s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (614 chars):
   [UTENTE] il parcheggio per 2 ore e 35 minuti mi è stato fatto pagare 9,50 quando la tariffa massima risulta 8 euro [ASSISTENTE] Il costo massimo giornaliero per i parcheggi Humanitas (eccetto il Pa...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b288794dc81ad664cd5f1b21b8d998d8 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 244
   📊 Token totali: 672
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 672 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 244
   📊 Token conversazione finale: 244
   📊 Token totali: 672
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 788 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] penso di avere perso il bancomat e la patente al Humanitas a Rozzano come posso fare [ASSISTENTE] Se hai perso il bancomat e la patente presso Humanitas a Rozzano, ti consiglio di recarti alla guardiania dell'ospedale...."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 244
   📊 Token totali stimati: 672
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] penso di avere perso il bancomat e la patente al Humanitas a Rozzano come posso fare [ASSISTENTE] Se hai perso il bancomat e la patente presso Humanitas a Rozzano, ti consiglio di recarti alla guardiania dell'ospedale...."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Servizi aziendali",\n    "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:36:58.464365
====================================================================================================
📋 Session ID: classify_1756762618
⏱️  Processing Time: 1.709s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (788 chars):
   [UTENTE] Ciao [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] penso di avere perso il bancomat e la patente al Humanitas a Rozzano come posso fare [ASSISTENTE] Se hai perso il banc...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Servizi aziendali",\n    "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Servizi aziendali",
    "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Servizi aziendali",
    "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a077f3a9f62e4fd34493e745ca3e17b3 classificata tramite LLM diretto (classificazione=unknown)
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 252
   📊 Token totali: 700
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 700 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 252
   📊 Token conversazione finale: 252
   📊 Token totali: 700
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 826 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] P18 coperto [ASSISTENTE] Il parcheggio P18 è parzialmente coperto. [...]  Se hai bisogno di ulteriori informazioni sui parcheggi o su come raggiungere la struttura, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2864 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 252
   📊 Token totali stimati: 700
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] P18 coperto [ASSISTENTE] Il parcheggio P18 è parzialmente coperto. [...]  Se hai bisogno di ulteriori informazioni sui parcheggi o su come raggiungere la struttura, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte sull'accesso e disponibilità dei parcheggi dell'ospedale, quindi è correttamente classificata come 'Servizi aziendali'.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:00.377818
====================================================================================================
📋 Session ID: classify_1756762620
⏱️  Processing Time: 1.824s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (826 chars):
   [UTENTE] P18 coperto [ASSISTENTE] Il parcheggio P18 è parzialmente coperto. Se hai bisogno di ulteriori informazioni sui parcheggi, puoi visitare la pagina [Indicazioni e Parcheggi](https://www.hum...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (220 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte sull'accesso e disponibilità dei parcheggi dell'ospedale, quindi è correttamente classificata come 'Servizi aziendali'.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.75
   motivation: La conversazione verte sull'accesso e disponibilità dei parcheggi dell'ospedale, quindi è correttamente classificata come 'Servizi aziendali'.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso e disponibilità dei parcheggi dell'ospedale, quindi è correttamente classificata come 'Servizi aziendali'.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 8f1544b92f14e847d55664ce25028df7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 165
   📊 Token totali: 593
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 593 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 165
   📊 Token conversazione finale: 165
   📊 Token totali: 593
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 595 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a registrarmi tramite codice fiscale [ASSISTENTE] Se hai difficoltà a registrarti utilizzando il codice fiscale, ti consiglio di verificare che i dati inseriti siano corretti. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2860 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 165
   📊 Token totali stimati: 593
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a registrarmi tramite codice fiscale [ASSISTENTE] Se hai difficoltà a registrarti utilizzando il codice fiscale, ti consiglio di verificare che i dati inseriti siano corretti. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔄 DatabaseAI: Modalità legacy - risolvo tenant_id 015007d9-d413-11ef-86a5-96000228e7fe
🔍 [DEBUG AIConfig] db_config ricevuto: {'tenant_id': '015007d9-d413-11ef-86a5-96000228e7fe', 'tenant_name': 'Humanitas', 'tenant_slug': 'humanitas', 'embedding_engine': 'labse', 'llm_engine': 'mistral-nemo:latest', 'is_active': 1, 'updated_at': datetime.datetime(2025, 9, 1, 20, 31, 45), 'embedding_config': {}, 'llm_config': {}}
🔍 [DEBUG AIConfig] llm_engine nel db_config: mistral-nemo:latest
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:02.050829
====================================================================================================
📋 Session ID: classify_1756762622
⏱️  Processing Time: 1.585s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (595 chars):
   [UTENTE] Non riesco a registrarmi tramite codice fiscale [ASSISTENTE] Se hai difficoltà a registrarti utilizzando il codice fiscale, ti consiglio di verificare che i dati inseriti siano corretti. S...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 5c5da039860425c088801ac063f2012c classificata tramite LLM diretto (classificazione=unknown)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 98
   📊 Token totali: 546
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 546 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 98
   📊 Token conversazione finale: 98
   📊 Token totali: 546
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 336 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] La mail non è ancora arrivata può essere normale? [ASSISTENTE] Potrebbe essere normale che una mail impieghi un po' di tempo per arrivare, a seconda del sistema di posta elettronica utilizzato. [...]  Se hai bisogno di ulteriore assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2931 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 98
   📊 Token totali stimati: 546
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] La mail non è ancora arrivata può essere normale? [ASSISTENTE] Potrebbe essere normale che una mail impieghi un po' di tempo per arrivare, a seconda del sistema di posta elettronica utilizzato. [...]  Se hai bisogno di ulteriore assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'La conversazione riguarda una richiesta di informazioni su una mail che non è stata ricevuta. Non vi sono riferimenti a problemi medici o a servizi sp'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:03.573286
====================================================================================================
📋 Session ID: classify_1756762623
⏱️  Processing Time: 1.434s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (336 chars):
   [UTENTE] La mail non è ancora arrivata può essere normale? [ASSISTENTE] Potrebbe essere normale che una mail impieghi un po' di tempo per arrivare, a seconda del sistema di posta elettronica utiliz...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'La conversazione riguarda una richiesta di informazioni su una mail che non è stata ricevuta. Non vi sono riferimenti a problemi medici o a servizi sp'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: La conversazione riguarda una richiesta di informazioni su una mail che non è stata ricevuta. Non vi sono riferimenti a problemi medici o a servizi sp
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda una richiesta di informazioni su una mail che non è stata ricevuta. Non vi sono riferimenti a problemi medici o a servizi sp
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 718f418665c5d70dca86439a5105ddf5 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 316
   📊 Token totali: 765
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 765 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 316
   📊 Token conversazione finale: 316
   📊 Token totali: 765
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1118 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buona sera Giulia  [ASSISTENTE] Buona sera! Come posso esserti utile? 😊 [UTENTE] Allora, devo entrare nella sezione referti, però non posso più entrare, perché non ho più il vecchio numero e non posso neppure cambiare il numero ti telefono dal vecchio a quello nuovo, perché giustamente m..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 316
   📊 Token totali stimati: 765
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buona sera Giulia  [ASSISTENTE] Buona sera! Come posso esserti utile? 😊 [UTENTE] Allora, devo entrare nella sezione referti, però non posso più entrare, perché non ho più il vecchio numero e non posso neppure cambiare il numero ti telefono dal vecchio a quello nuovo, perché giustamente m..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla difficoltà dell'utente nel cambiare il proprio numero di telefono associato all'account di Humanitas co"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:06.724498
====================================================================================================
📋 Session ID: classify_1756762626
⏱️  Processing Time: 3.063s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1118 chars):
   [UTENTE] Buona sera Giulia  [ASSISTENTE] Buona sera! Come posso esserti utile? 😊 [UTENTE] Allora, devo entrare nella sezione referti, però non posso più entrare, perché non ho più il vecchio numero...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla difficoltà dell'utente nel cambiare il proprio numero di telefono associato all'account di Humanitas co"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla difficoltà dell'utente nel cambiare il proprio numero di telefono associato all'account di Humanitas co
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla difficoltà dell'utente nel cambiare il proprio numero di telefono associato all'account di Humanitas co
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b22a99e98060e6bf0c13425201558065 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 278
   📊 Token totali: 726
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 726 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 278
   📊 Token conversazione finale: 278
   📊 Token totali: 726
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 919 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] VENGONO INVIATE EMAIL PER CONFERMA INTERVENTO [ASSISTENTE] Puoi fornirmi maggiori dettagli? Intendi sapere se Humanitas invia email per confermare un intervento chirurgico? [UTENTE] si [ASSISTENTE] Sì, Humanitas invia email per confermare gli interventi chirurgici. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2965 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 278
   📊 Token totali stimati: 726
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] VENGONO INVIATE EMAIL PER CONFERMA INTERVENTO [ASSISTENTE] Puoi fornirmi maggiori dettagli? Intendi sapere se Humanitas invia email per confermare un intervento chirurgico? [UTENTE] si [ASSISTENTE] Sì, Humanitas invia email per confermare gli interventi chirurgici. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted Label:** Prenotazione\n\n**Confidence:** 0.95\n\n**Motivation:** La conversazione verte prin'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:08.633487
====================================================================================================
📋 Session ID: classify_1756762628
⏱️  Processing Time: 1.823s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (919 chars):
   [UTENTE] VENGONO INVIATE EMAIL PER CONFERMA INTERVENTO [ASSISTENTE] Puoi fornirmi maggiori dettagli? Intendi sapere se Humanitas invia email per confermare un intervento chirurgico? [UTENTE] si [AS...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted Label:** Prenotazione\n\n**Confidence:** 0.95\n\n**Motivation:** La conversazione verte prin'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted Label:** Prenotazione

**Confidence:** 0.95

**Motivation:** La conversazione verte prin
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted Label:** Prenotazione

**Confidence:** 0.95

**Motivation:** La conversazione verte prin
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione eaccaf93db29cd246ac9381a1205837f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 447
   💬 Token conversazione: 264
   📊 Token totali: 711
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 711 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 447
   📊 Token conversazione originale: 264
   📊 Token conversazione finale: 264
   📊 Token totali: 711
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 895 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, per errore ho cancellato una mail newletter ricevuta il 01/08/2025 che, fra gli altri link,  conteneva il link CARENZA DI VITAMINE: quali sono i sintomi ? Cortesemente posso riceverla di nuovo ? Grazie [ASSISTENTE] Non ho accesso diretto alle email o alle newsletter inviate d..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2960 characters
🔢 Token Analysis:
   📊 Token prompt base: 447
   📊 Token conversazione: 264
   📊 Token totali stimati: 711
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, per errore ho cancellato una mail newletter ricevuta il 01/08/2025 che, fra gli altri link,  conteneva il link CARENZA DI VITAMINE: quali sono i sintomi ? Cortesemente posso riceverla di nuovo ? Grazie [ASSISTENTE] Non ho accesso diretto alle email o alle newsletter inviate d..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted Label:** altro\n\n**Confidence:** 0.95\n\n**Motivation:** La conversazione verte principalme'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:11.734122
====================================================================================================
📋 Session ID: classify_1756762631
⏱️  Processing Time: 3.014s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (895 chars):
   [UTENTE] Buongiorno, per errore ho cancellato una mail newletter ricevuta il 01/08/2025 che, fra gli altri link,  conteneva il link CARENZA DI VITAMINE: quali sono i sintomi ? Cortesemente posso ri...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted Label:** altro\n\n**Confidence:** 0.95\n\n**Motivation:** La conversazione verte principalme'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted Label:** altro

**Confidence:** 0.95

**Motivation:** La conversazione verte principalme
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted Label:** altro

**Confidence:** 0.95

**Motivation:** La conversazione verte principalme
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d4643250e4b98b4e693e793560142d63 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 608
   📊 Token totali: 1057
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1057 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 608
   📊 Token conversazione finale: 608
   📊 Token totali: 1057
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2063 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho mal di pancia e sto cercando cosa fare [ASSISTENTE] Come assistente digitale di Humanitas, il mio scopo è fornire informazioni di carattere generale e notizie inerenti l’ospedale. Per il tuo mal di pancia, ti consiglio di rivolgerti al tuo medico di fiducia o al tuo medico di Medicina..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 608
   📊 Token totali stimati: 1057
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho mal di pancia e sto cercando cosa fare [ASSISTENTE] Come assistente digitale di Humanitas, il mio scopo è fornire informazioni di carattere generale e notizie inerenti l’ospedale. Per il tuo mal di pancia, ti consiglio di rivolgerti al tuo medico di fiducia o al tuo medico di Medicina..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:13.785507
====================================================================================================
📋 Session ID: classify_1756762633
⏱️  Processing Time: 1.964s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2063 chars):
   [UTENTE] Ho mal di pancia e sto cercando cosa fare [ASSISTENTE] Come assistente digitale di Humanitas, il mio scopo è fornire informazioni di carattere generale e notizie inerenti l’ospedale. Per i...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 9d277ad5d440ec8a541a2ef7d607846b classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 475
   📊 Token totali: 903
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 903 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 475
   📊 Token conversazione finale: 475
   📊 Token totali: 903
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2111 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] hello [ASSISTENTE] Hello! How can I assist you today? [UTENTE] Do you provide alcoholism treatment? [ASSISTENTE] To determine if Humanitas provides treatment for alcoholism, I will need to check the available information. Please give me a moment.Humanitas provides treatment for condition..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 475
   📊 Token totali stimati: 903
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] hello [ASSISTENTE] Hello! How can I assist you today? [UTENTE] Do you provide alcoholism treatment? [ASSISTENTE] To determine if Humanitas provides treatment for alcoholism, I will need to check the available information. Please give me a moment.Humanitas provides treatment for condition..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: #### Classificazione conversazione\n\nLa conversazione verte principalmente sulla prenotazione di un a'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:24.188595
====================================================================================================
📋 Session ID: classify_1756762644
⏱️  Processing Time: 10.315s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2111 chars):
   [UTENTE] hello [ASSISTENTE] Hello! How can I assist you today? [UTENTE] Do you provide alcoholism treatment? [ASSISTENTE] To determine if Humanitas provides treatment for alcoholism, I will need to...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (193 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: #### Classificazione conversazione\n\nLa conversazione verte principalmente sulla prenotazione di un a'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: #### Classificazione conversazione

La conversazione verte principalmente sulla prenotazione di un a
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: #### Classificazione conversazione

La conversazione verte principalmente sulla prenotazione di un a
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

🔍 Risoluzione tenant da UUID: 015007d9-d413-11ef-86a5-96000228e7fe
📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 46d4af0cf0bfd3c5b646797c96992b55 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa
✅ Tenant risolto (DB TAG locale): Humanitas (humanitas) UUID=015007d9-d413-11ef-86a5-96000228e7fe
✅ Tenant risolto da UUID: Humanitas (015007d9-d413-11ef-86a5-96000228e7fe)
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 447
   💬 Token conversazione: 115
   📊 Token totali: 562
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 562 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 447
   📊 Token conversazione originale: 115
   📊 Token conversazione finale: 115
   📊 Token totali: 562
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 385 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia, cosa vuol dire ICE? [ASSISTENTE] "ICE" è l'acronimo di "In Case of Emergency" (in caso di emergenza). [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2857 characters
🔢 Token Analysis:
   📊 Token prompt base: 447
   📊 Token conversazione: 115
   📊 Token totali stimati: 562
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia, cosa vuol dire ICE? [ASSISTENTE] "ICE" è l'acronimo di "In Case of Emergency" (in caso di emergenza). [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:26.445190
====================================================================================================
📋 Session ID: classify_1756762646
⏱️  Processing Time: 2.150s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (385 chars):
   [UTENTE] Ciao Giulia, cosa vuol dire ICE? [ASSISTENTE] "ICE" è l'acronimo di "In Case of Emergency" (in caso di emergenza). Viene spesso utilizzato per indicare un contatto da chiamare in caso di e...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 068fcc4b039b0805227863134d255d81 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 980
   📊 Token totali: 1428
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1428 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 980
   📊 Token conversazione finale: 980
   📊 Token totali: 1428
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 3337 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Che bello iniziare un percorso equilibrato di benessere e stile di vita [ASSISTENTE] Sono felice che tu voglia intraprendere un percorso di benessere e stile di vita equilibrato! Se hai bisogno di informazioni su servizi, visite o percorsi specifici offerti da Humanitas, sono qui per aiu..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 980
   📊 Token totali stimati: 1428
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Che bello iniziare un percorso equilibrato di benessere e stile di vita [ASSISTENTE] Sono felice che tu voglia intraprendere un percorso di benessere e stile di vita equilibrato! Se hai bisogno di informazioni su servizi, visite o percorsi specifici offerti da Humanitas, sono qui per aiu..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'benessere', 'confidence': 0.75, 'motivation': "La conversazione verte principalmente sull'obiettivo di raggiungere uno stile di vita equilibrato e sano, con domande specifiche su obiettivi quotidiani e consigli per il benessere personale."}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:28.648728
====================================================================================================
📋 Session ID: classify_1756762648
⏱️  Processing Time: 2.118s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (3337 chars):
   [UTENTE] Che bello iniziare un percorso equilibrato di benessere e stile di vita [ASSISTENTE] Sono felice che tu voglia intraprendere un percorso di benessere e stile di vita equilibrato! Se hai bi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (261 chars):
   {'predicted_label': 'benessere', 'confidence': 0.75, 'motivation': "La conversazione verte principalmente sull'obiettivo di raggiungere uno stile di vita equilibrato e sano, con domande specifiche su obiettivi quotidiani e consigli per il benessere personale."}

📊 Parsed Response:
   predicted_label: benessere
   confidence: 0.75
   motivation: La conversazione verte principalmente sull'obiettivo di raggiungere uno stile di vita equilibrato e sano, con domande specifiche su obiettivi quotidiani e consigli per il benessere personale.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sull'obiettivo di raggiungere uno stile di vita equilibrato e sano, con domande specifiche su obiettivi quotidiani e consigli per il benessere personale.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 4a47c0d59d3c1eb836614b7cef7014f2 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ✅ Nuovo tag 'benessere' aggiunto per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 124
   📊 Token totali: 572
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 572 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 124
   📊 Token conversazione finale: 124
   📊 Token totali: 572
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 388 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno vorrei sapere se fate l'esame ANTICORPI ANTI PIASTRINE TEST DIRETTO [ASSISTENTE] Non ho trovato informazioni specifiche sull'esame "ANTICORPI ANTI PIASTRINE TEST DIRETTO" nei documenti forniti. [...]  Se hai bisogno di ulteriori dettagli o assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2953 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 124
   📊 Token totali stimati: 572
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno vorrei sapere se fate l'esame ANTICORPI ANTI PIASTRINE TEST DIRETTO [ASSISTENTE] Non ho trovato informazioni specifiche sull'esame "ANTICORPI ANTI PIASTRINE TEST DIRETTO" nei documenti forniti. [...]  Se hai bisogno di ulteriori dettagli o assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.85, 'motivation': "La conversazione verte sull'esame ANTICORPI ANTI PIASTRINE TEST DIRETTO, che è un'analisi medica.", 'predicted_label': 'Analisi'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:30.496163
====================================================================================================
📋 Session ID: classify_1756762650
⏱️  Processing Time: 1.751s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (388 chars):
   [UTENTE] Buongiorno vorrei sapere se fate l'esame ANTICORPI ANTI PIASTRINE TEST DIRETTO [ASSISTENTE] Non ho trovato informazioni specifiche sull'esame "ANTICORPI ANTI PIASTRINE TEST DIRETTO" nei do...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (165 chars):
   {'confidence': 0.85, 'motivation': "La conversazione verte sull'esame ANTICORPI ANTI PIASTRINE TEST DIRETTO, che è un'analisi medica.", 'predicted_label': 'Analisi'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.85
   motivation: La conversazione verte sull'esame ANTICORPI ANTI PIASTRINE TEST DIRETTO, che è un'analisi medica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.850
   [█████████████████░░░] 85.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'esame ANTICORPI ANTI PIASTRINE TEST DIRETTO, che è un'analisi medica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3de313896771b6c6c601096d159d2f29 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 332
   📊 Token totali: 760
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 760 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 332
   📊 Token conversazione finale: 332
   📊 Token totali: 760
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1136 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno eseguite esame del sangue per allergia nickel? [ASSISTENTE] Non ho trovato informazioni specifiche sull'esecuzione di un esame del sangue per l'allergia al nichel presso Humanitas. [...] it/malattie/allergia-al-nichel)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2834 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 332
   📊 Token totali stimati: 760
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno eseguite esame del sangue per allergia nickel? [ASSISTENTE] Non ho trovato informazioni specifiche sull'esecuzione di un esame del sangue per l'allergia al nichel presso Humanitas. [...] it/malattie/allergia-al-nichel)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte sull'esecuzione di un esame del sangue per l'allergia al nichel presso Humanitas. Tuttavia, l'assistente non ha trovato info"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:33.622231
====================================================================================================
📋 Session ID: classify_1756762653
⏱️  Processing Time: 3.039s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1136 chars):
   [UTENTE] Buongiorno eseguite esame del sangue per allergia nickel? [ASSISTENTE] Non ho trovato informazioni specifiche sull'esecuzione di un esame del sangue per l'allergia al nichel presso Humanit...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte sull'esecuzione di un esame del sangue per l'allergia al nichel presso Humanitas. Tuttavia, l'assistente non ha trovato info"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte sull'esecuzione di un esame del sangue per l'allergia al nichel presso Humanitas. Tuttavia, l'assistente non ha trovato info
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte sull'esecuzione di un esame del sangue per l'allergia al nichel presso Humanitas. Tuttavia, l'assistente non ha trovato info
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 20687302bd052509933722acba343fe0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 197
   📊 Token totali: 645
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 645 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 197
   📊 Token conversazione finale: 197
   📊 Token totali: 645
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 608 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] cistiscopia [ASSISTENTE] Puoi chiarire meglio la tua richiesta? Intendi sapere:

1. [...]  

Se hai bisogno di ulteriori informazioni o assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2847 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 197
   📊 Token totali stimati: 645
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] cistiscopia [ASSISTENTE] Puoi chiarire meglio la tua richiesta? Intendi sapere:

1. [...]  

Se hai bisogno di ulteriori informazioni o assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte sull'esecuzione di una cistoscopia e sulle informazioni relative ai medici che la eseguono, il che indica una richiesta di visita specialistica.", 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:35.451822
====================================================================================================
📋 Session ID: classify_1756762655
⏱️  Processing Time: 1.743s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (608 chars):
   [UTENTE] cistiscopia [ASSISTENTE] Puoi chiarire meglio la tua richiesta? Intendi sapere:

1. Se eseguiamo la cistoscopia presso Humanitas?
2. Come prepararti per una cistoscopia?
3. Altro?

Fammi s...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [77 more lines] ...
     Line 81: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (248 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte sull'esecuzione di una cistoscopia e sulle informazioni relative ai medici che la eseguono, il che indica una richiesta di visita specialistica.", 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.75
   motivation: La conversazione verte sull'esecuzione di una cistoscopia e sulle informazioni relative ai medici che la eseguono, il che indica una richiesta di visita specialistica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'esecuzione di una cistoscopia e sulle informazioni relative ai medici che la eseguono, il che indica una richiesta di visita specialistica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 72d2dd9215e7000983bd8e9f38aa3a0d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 138
   📊 Token totali: 566
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 566 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 138
   📊 Token conversazione finale: 138
   📊 Token totali: 566
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 430 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] humanitas effettua l'holter cardiaco di 20 giorni? [ASSISTENTE] Non ho trovato informazioni specifiche sull'Holter cardiaco di 20 giorni presso Humanitas. [...] it/pazienti/diagnosi/esami-del-cuore-e-vascolari/7952-elettrocardiogramma)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2840 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 138
   📊 Token totali stimati: 566
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] humanitas effettua l'holter cardiaco di 20 giorni? [ASSISTENTE] Non ho trovato informazioni specifiche sull'Holter cardiaco di 20 giorni presso Humanitas. [...] it/pazienti/diagnosi/esami-del-cuore-e-vascolari/7952-elettrocardiogramma)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.8, 'motivation': "La conversazione riguarda un esame diagnostico specifico, l'Holter cardiaco di 20 giorni.", 'predicted_label': 'Analisi'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:36.959702
====================================================================================================
📋 Session ID: classify_1756762656
⏱️  Processing Time: 1.422s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (430 chars):
   [UTENTE] humanitas effettua l'holter cardiaco di 20 giorni? [ASSISTENTE] Non ho trovato informazioni specifiche sull'Holter cardiaco di 20 giorni presso Humanitas. Ti consiglio di contattare dirett...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (156 chars):
   {'confidence': 0.8, 'motivation': "La conversazione riguarda un esame diagnostico specifico, l'Holter cardiaco di 20 giorni.", 'predicted_label': 'Analisi'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.8
   motivation: La conversazione riguarda un esame diagnostico specifico, l'Holter cardiaco di 20 giorni.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.800
   [████████████████░░░░] 80.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda un esame diagnostico specifico, l'Holter cardiaco di 20 giorni.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 05a1984cee2b4cc64f5eae1d3e0c6fff classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 137
   📊 Token totali: 585
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 585 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 137
   📊 Token conversazione finale: 137
   📊 Token totali: 585
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 466 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Oggi si possono fare esami del sangue all' Humanitas di Rozzano? [ASSISTENTE] Per sapere se oggi è possibile effettuare esami del sangue presso l'Humanitas di Rozzano, ti consiglio di contattare direttamente il punto prelievi. Puoi trovare tutte le informazioni sui punti prelievi e gli o..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 137
   📊 Token totali stimati: 585
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Oggi si possono fare esami del sangue all' Humanitas di Rozzano? [ASSISTENTE] Per sapere se oggi è possibile effettuare esami del sangue presso l'Humanitas di Rozzano, ti consiglio di contattare direttamente il punto prelievi. Puoi trovare tutte le informazioni sui punti prelievi e gli o..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione riguarda la disponibilità di esami del sangue all'ospedale Humanitas di Rozzano.", 'predicted_label': 'Analisi'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:38.474156
====================================================================================================
📋 Session ID: classify_1756762658
⏱️  Processing Time: 1.426s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (466 chars):
   [UTENTE] Oggi si possono fare esami del sangue all' Humanitas di Rozzano? [ASSISTENTE] Per sapere se oggi è possibile effettuare esami del sangue presso l'Humanitas di Rozzano, ti consiglio di cont...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (165 chars):
   {'confidence': 0.95, 'motivation': "La conversazione riguarda la disponibilità di esami del sangue all'ospedale Humanitas di Rozzano.", 'predicted_label': 'Analisi'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.95
   motivation: La conversazione riguarda la disponibilità di esami del sangue all'ospedale Humanitas di Rozzano.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda la disponibilità di esami del sangue all'ospedale Humanitas di Rozzano.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 45d84637ecd854d453ce730a106e7829 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 750
   📊 Token totali: 1199
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1199 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 750
   📊 Token conversazione finale: 750
   📊 Token totali: 1199
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2396 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] quali esami di laboratorio fate? [ASSISTENTE] Il Laboratorio Analisi dell’IRCCS Istituto Clinico Humanitas offre una vasta gamma di esami di laboratorio, tra cui esami di base e specialistici per la promozione della salute, prevenzione, diagnosi e monitoraggio terapeutico. Gli esami incl..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 750
   📊 Token totali stimati: 1199
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] quali esami di laboratorio fate? [ASSISTENTE] Il Laboratorio Analisi dell’IRCCS Istituto Clinico Humanitas offre una vasta gamma di esami di laboratorio, tra cui esami di base e specialistici per la promozione della salute, prevenzione, diagnosi e monitoraggio terapeutico. Gli esami incl..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** Analisi\n\n**Confidence:** 0.85\n\n**Motivation:** La conversazione verte principal'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:41.466059
====================================================================================================
📋 Session ID: classify_1756762661
⏱️  Processing Time: 2.906s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2396 chars):
   [UTENTE] quali esami di laboratorio fate? [ASSISTENTE] Il Laboratorio Analisi dell’IRCCS Istituto Clinico Humanitas offre una vasta gamma di esami di laboratorio, tra cui esami di base e specialist...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** Analisi\n\n**Confidence:** 0.85\n\n**Motivation:** La conversazione verte principal'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted label:** Analisi

**Confidence:** 0.85

**Motivation:** La conversazione verte principal
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted label:** Analisi

**Confidence:** 0.85

**Motivation:** La conversazione verte principal
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 6f887efb3b602d3e97c45dbe2178947d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 211
   📊 Token totali: 659
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 659 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 211
   📊 Token conversazione finale: 211
   📊 Token totali: 659
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 637 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno volevo sapere se eseguire il seguente esame  anticorpi anti cardiolipina (IGG,IGM,IGN) Grazie  [ASSISTENTE] Sì, presso Humanitas è possibile eseguire il test per gli anticorpi anti-cardiolipina (IgG, IgM, IgA). [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2910 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 211
   📊 Token totali stimati: 659
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno volevo sapere se eseguire il seguente esame  anticorpi anti cardiolipina (IGG,IGM,IGN) Grazie  [ASSISTENTE] Sì, presso Humanitas è possibile eseguire il test per gli anticorpi anti-cardiolipina (IgG, IgM, IgA). [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '| predicted_label       | confidenza | motivazione                                                                 |'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:44.533910
====================================================================================================
📋 Session ID: classify_1756762664
⏱️  Processing Time: 2.981s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (637 chars):
   [UTENTE] Buongiorno volevo sapere se eseguire il seguente esame  anticorpi anti cardiolipina (IGG,IGM,IGN) Grazie  [ASSISTENTE] Sì, presso Humanitas è possibile eseguire il test per gli anticorpi a...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (181 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '| predicted_label       | confidenza | motivazione                                                                 |'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: | predicted_label       | confidenza | motivazione                                                                 |
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   | predicted_label       | confidenza | motivazione                                                                 |
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7cfa00c1f68fd377129f5257270f972b classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 240
   📊 Token totali: 689
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 689 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 240
   📊 Token conversazione finale: 240
   📊 Token totali: 689
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 728 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, vorrei prenotare un esame per la frammentazione del DNA spermatico [ASSISTENTE] Per prenotare un esame per la frammentazione del DNA spermatico, ti consiglio di contattare direttamente il Fertility Center di Humanitas. Questo esame, come il TUNEL, SCSA o HALO, è utilizzato pe..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 240
   📊 Token totali stimati: 689
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, vorrei prenotare un esame per la frammentazione del DNA spermatico [ASSISTENTE] Per prenotare un esame per la frammentazione del DNA spermatico, ti consiglio di contattare direttamente il Fertility Center di Humanitas. Questo esame, come il TUNEL, SCSA o HALO, è utilizzato pe..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sull'esecuzione di un esame specifico per la frammentazione del DNA spermatico, che rientra nella categoria delle analisi.", 'predicted_label': 'Analisi'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:46.282387
====================================================================================================
📋 Session ID: classify_1756762666
⏱️  Processing Time: 1.661s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (728 chars):
   [UTENTE] Buongiorno, vorrei prenotare un esame per la frammentazione del DNA spermatico [ASSISTENTE] Per prenotare un esame per la frammentazione del DNA spermatico, ti consiglio di contattare dire...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (212 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sull'esecuzione di un esame specifico per la frammentazione del DNA spermatico, che rientra nella categoria delle analisi.", 'predicted_label': 'Analisi'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.9
   motivation: La conversazione verte sull'esecuzione di un esame specifico per la frammentazione del DNA spermatico, che rientra nella categoria delle analisi.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'esecuzione di un esame specifico per la frammentazione del DNA spermatico, che rientra nella categoria delle analisi.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 90c97c1546b791d02ded4c50a7678bcd classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 218
   📊 Token totali: 646
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 646 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 218
   📊 Token conversazione finale: 218
   📊 Token totali: 646
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 739 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buonasera, ho un'intervento prenotato ma vorrei maggiori informazioni [ASSISTENTE] Buonasera! Potresti specificare se il tuo intervento è stato prenotato tramite il Servizio Sanitario Nazionale (SSN) o in regime privato? In questo modo potrò fornirti le informazioni più appropriate. [UTE..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 218
   📊 Token totali stimati: 646
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buonasera, ho un'intervento prenotato ma vorrei maggiori informazioni [ASSISTENTE] Buonasera! Potresti specificare se il tuo intervento è stato prenotato tramite il Servizio Sanitario Nazionale (SSN) o in regime privato? In questo modo potrò fornirti le informazioni più appropriate. [UTE..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:48.055706
====================================================================================================
📋 Session ID: classify_1756762668
⏱️  Processing Time: 1.687s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (739 chars):
   [UTENTE] buonasera, ho un'intervento prenotato ma vorrei maggiori informazioni [ASSISTENTE] Buonasera! Potresti specificare se il tuo intervento è stato prenotato tramite il Servizio Sanitario Nazi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione ab28dfb1183e910c1701b9c56ad9b080 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 103
   📊 Token totali: 552
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 552 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 103
   📊 Token conversazione finale: 103
   📊 Token totali: 552
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 333 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] è obbligatorio portare la prescrizione del medico di base per effettuare i raggi x alla mano sinistra ? [ASSISTENTE] Sì, è obbligatorio avere la prescrizione del medico di base per effettuare i raggi X, sia per prenotare che per eseguire l'esame. Se hai bisogno di ulteriori informazioni o a..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2972 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 103
   📊 Token totali stimati: 552
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] è obbligatorio portare la prescrizione del medico di base per effettuare i raggi x alla mano sinistra ? [ASSISTENTE] Sì, è obbligatorio avere la prescrizione del medico di base per effettuare i raggi X, sia per prenotare che per eseguire l'esame. Se hai bisogno di ulteriori informazioni o a..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': 'La conversazione riguarda la necessità della prescrizione del medico di base per effettuare un esame a raggi X, che è una procedura prenotabile.', 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:49.764116
====================================================================================================
📋 Session ID: classify_1756762669
⏱️  Processing Time: 1.622s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (333 chars):
   [UTENTE] è obbligatorio portare la prescrizione del medico di base per effettuare i raggi x alla mano sinistra ? [ASSISTENTE] Sì, è obbligatorio avere la prescrizione del medico di base per effettu...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (217 chars):
   {'confidence': 0.95, 'motivation': 'La conversazione riguarda la necessità della prescrizione del medico di base per effettuare un esame a raggi X, che è una procedura prenotabile.', 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione riguarda la necessità della prescrizione del medico di base per effettuare un esame a raggi X, che è una procedura prenotabile.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda la necessità della prescrizione del medico di base per effettuare un esame a raggi X, che è una procedura prenotabile.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione ba7bcd308cfce6a26883fa5ce35530fb classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 276
   📊 Token totali: 724
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 724 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 276
   📊 Token conversazione finale: 276
   📊 Token totali: 724
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 987 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Salve,

attraverso la mia assicurazione "Generali" ho inserito la pratica "Valutazione nutrizionistica/dietista (con relazione finale)" in prestazione diretta presso Medical Care De Angeli (Nr. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2940 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 276
   📊 Token totali stimati: 724
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Salve,

attraverso la mia assicurazione "Generali" ho inserito la pratica "Valutazione nutrizionistica/dietista (con relazione finale)" in prestazione diretta presso Medical Care De Angeli (Nr. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione riguarda la prenotazione di una visita nutrizionistica/dietista con la dottoressa Martina Francia attraverso l'assicurazione Gener"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:52.856636
====================================================================================================
📋 Session ID: classify_1756762672
⏱️  Processing Time: 2.999s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (987 chars):
   [UTENTE] Salve,

attraverso la mia assicurazione "Generali" ho inserito la pratica "Valutazione nutrizionistica/dietista (con relazione finale)" in prestazione diretta presso Medical Care De Angeli...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione riguarda la prenotazione di una visita nutrizionistica/dietista con la dottoressa Martina Francia attraverso l'assicurazione Gener"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione riguarda la prenotazione di una visita nutrizionistica/dietista con la dottoressa Martina Francia attraverso l'assicurazione Gener
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione riguarda la prenotazione di una visita nutrizionistica/dietista con la dottoressa Martina Francia attraverso l'assicurazione Gener
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 34ed90e4d2748f327756b223074254fd classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
   📈 Progresso LLM: 100/155
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 2755
   📊 Token totali: 3203
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 3203 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 2755
   📊 Token conversazione finale: 2755
   📊 Token totali: 3203
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 9659 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Chiamando questo numero: 0282248224 come funziona la prenotazione di una visita per una rinosettoplastica? In una mail in cui ho scritto se fosse possibile aggiungere alla rinoplastica (A pagamento) anche la settoplastica (coprendola con ssn) mi  è stato detto che prima di tutto devo far..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 2755
   📊 Token totali stimati: 3203
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Chiamando questo numero: 0282248224 come funziona la prenotazione di una visita per una rinosettoplastica? In una mail in cui ho scritto se fosse possibile aggiungere alla rinoplastica (A pagamento) anche la settoplastica (coprendola con ssn) mi  è stato detto che prima di tutto devo far..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: La conversazione è incentrata sulla prenotazione di una visita per una rinosettoplastica e sulle rel'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:57.303485
====================================================================================================
📋 Session ID: classify_1756762677
⏱️  Processing Time: 4.361s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (9659 chars):
   [UTENTE] Chiamando questo numero: 0282248224 come funziona la prenotazione di una visita per una rinosettoplastica? In una mail in cui ho scritto se fosse possibile aggiungere alla rinoplastica (A ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: La conversazione è incentrata sulla prenotazione di una visita per una rinosettoplastica e sulle rel'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: La conversazione è incentrata sulla prenotazione di una visita per una rinosettoplastica e sulle rel
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: La conversazione è incentrata sulla prenotazione di una visita per una rinosettoplastica e sulle rel
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7ecde53cad00653c1176c0e3d724d446 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 158
   📊 Token totali: 586
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 586 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 158
   📊 Token conversazione finale: 158
   📊 Token totali: 586
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 547 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] perchè per il prericovero è richiesta l'impegnativa per il ricovero? [ASSISTENTE] L'impegnativa per il ricovero è necessaria per il prericovero in quanto rappresenta la prescrizione medica che autorizza e giustifica l'accesso alle prestazioni sanitarie previste dal Servizio Sanitario Naz..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 158
   📊 Token totali stimati: 586
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] perchè per il prericovero è richiesta l'impegnativa per il ricovero? [ASSISTENTE] L'impegnativa per il ricovero è necessaria per il prericovero in quanto rappresenta la prescrizione medica che autorizza e giustifica l'accesso alle prestazioni sanitarie previste dal Servizio Sanitario Naz..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.85, 'motivation': "La conversazione verte sull'impegnativa richiesta per il ricovero, che rientra nei servizi offerti dall'azienda.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:37:58.981026
====================================================================================================
📋 Session ID: classify_1756762678
⏱️  Processing Time: 1.590s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (547 chars):
   [UTENTE] perchè per il prericovero è richiesta l'impegnativa per il ricovero? [ASSISTENTE] L'impegnativa per il ricovero è necessaria per il prericovero in quanto rappresenta la prescrizione medica...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (190 chars):
   {'confidence': 0.85, 'motivation': "La conversazione verte sull'impegnativa richiesta per il ricovero, che rientra nei servizi offerti dall'azienda.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.85
   motivation: La conversazione verte sull'impegnativa richiesta per il ricovero, che rientra nei servizi offerti dall'azienda.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.850
   [█████████████████░░░] 85.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'impegnativa richiesta per il ricovero, che rientra nei servizi offerti dall'azienda.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 413956829dedb1f2fdeaaa0160a30ce8 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 326
   📊 Token totali: 774
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 774 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 326
   📊 Token conversazione finale: 326
   📊 Token totali: 774
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1023 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, volevo sapere che esami devo fare per prepararmi all' angio tac coronaricaù [ASSISTENTE] Per sapere quali esami o preparazioni sono necessari per un'angio TAC coronarica, ti consiglio di consultare il tuo medico di fiducia o il medico che ti ha prescritto l'esame. Non posso f..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 326
   📊 Token totali stimati: 774
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, volevo sapere che esami devo fare per prepararmi all' angio tac coronaricaù [ASSISTENTE] Per sapere quali esami o preparazioni sono necessari per un'angio TAC coronarica, ti consiglio di consultare il tuo medico di fiducia o il medico che ti ha prescritto l'esame. Non posso f..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'angio TAC coronarica e sugli esami da fare per prepararsi ad esso. L'assistente fornisce informazioni su"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:01.853054
====================================================================================================
📋 Session ID: classify_1756762681
⏱️  Processing Time: 2.779s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1023 chars):
   [UTENTE] Buongiorno, volevo sapere che esami devo fare per prepararmi all' angio tac coronaricaù [ASSISTENTE] Per sapere quali esami o preparazioni sono necessari per un'angio TAC coronarica, ti co...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'angio TAC coronarica e sugli esami da fare per prepararsi ad esso. L'assistente fornisce informazioni su"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sull'angio TAC coronarica e sugli esami da fare per prepararsi ad esso. L'assistente fornisce informazioni su
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sull'angio TAC coronarica e sugli esami da fare per prepararsi ad esso. L'assistente fornisce informazioni su
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7ee9cb6a2ece9beeacf740bd28963269 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 85
   📊 Token totali: 513
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 513 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 85
   📊 Token conversazione finale: 85
   📊 Token totali: 513
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 278 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] zyclara [ASSISTENTE] Non ho trovato informazioni specifiche su "Zyclara" nei documenti forniti. Se hai bisogno di dettagli su un farmaco o un trattamento, ti consiglio di consultare il tuo medico o farmacista di fiducia. Se hai ulteriori domande, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2874 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 85
   📊 Token totali stimati: 513
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] zyclara [ASSISTENTE] Non ho trovato informazioni specifiche su "Zyclara" nei documenti forniti. Se hai bisogno di dettagli su un farmaco o un trattamento, ti consiglio di consultare il tuo medico o farmacista di fiducia. Se hai ulteriori domande, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.75, "m'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:03.445419
====================================================================================================
📋 Session ID: classify_1756762683
⏱️  Processing Time: 1.500s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (278 chars):
   [UTENTE] zyclara [ASSISTENTE] Non ho trovato informazioni specifiche su "Zyclara" nei documenti forniti. Se hai bisogno di dettagli su un farmaco o un trattamento, ti consiglio di consultare il tuo...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.75, "m'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.75, "m
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.75, "m
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 4197958f03dfab27c10e27c233c347dd classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 101
   📊 Token totali: 549
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 549 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 101
   📊 Token conversazione finale: 101
   📊 Token totali: 549
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 339 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Nervo pudendo  [ASSISTENTE] Non ho trovato informazioni specifiche sul nervo pudendo nei documenti caricati. [...]  Se posso esserti utile in altro, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2839 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 101
   📊 Token totali stimati: 549
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Nervo pudendo  [ASSISTENTE] Non ho trovato informazioni specifiche sul nervo pudendo nei documenti caricati. [...]  Se posso esserti utile in altro, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': 'La conversazione riguarda una richiesta di informazioni su un nervo specifico e potrebbe richiedere una visita specializzata per essere approfondita.', 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:05.073828
====================================================================================================
📋 Session ID: classify_1756762685
⏱️  Processing Time: 1.542s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (339 chars):
   [UTENTE] Nervo pudendo  [ASSISTENTE] Non ho trovato informazioni specifiche sul nervo pudendo nei documenti caricati. Tuttavia, se hai bisogno di dettagli specifici o di un approfondimento, ti cons...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (230 chars):
   {'confidence': 0.75, 'motivation': 'La conversazione riguarda una richiesta di informazioni su un nervo specifico e potrebbe richiedere una visita specializzata per essere approfondita.', 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.75
   motivation: La conversazione riguarda una richiesta di informazioni su un nervo specifico e potrebbe richiedere una visita specializzata per essere approfondita.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda una richiesta di informazioni su un nervo specifico e potrebbe richiedere una visita specializzata per essere approfondita.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 79c68a302af726b72b69040fa9321fc9 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 126
   📊 Token totali: 574
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 574 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 126
   📊 Token conversazione finale: 126
   📊 Token totali: 574
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 423 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] per l'impegnativa per per il prericovero Cosa bisogna scrivere come dicitura [ASSISTENTE] Per sapere cosa scrivere come dicitura sull'impegnativa per il prericovero, ti consiglio di consultare il tuo medico di base o lo specialista che ti ha prescritto il ricovero. Saranno loro a indicar..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 126
   📊 Token totali stimati: 574
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] per l'impegnativa per per il prericovero Cosa bisogna scrivere come dicitura [ASSISTENTE] Per sapere cosa scrivere come dicitura sull'impegnativa per il prericovero, ti consiglio di consultare il tuo medico di base o lo specialista che ti ha prescritto il ricovero. Saranno loro a indicar..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': 'La conversazione riguarda la richiesta di informazioni su una dicitura da utilizzare in un documento per il ricovero.', 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:06.648570
====================================================================================================
📋 Session ID: classify_1756762686
⏱️  Processing Time: 1.487s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (423 chars):
   [UTENTE] per l'impegnativa per per il prericovero Cosa bisogna scrivere come dicitura [ASSISTENTE] Per sapere cosa scrivere come dicitura sull'impegnativa per il prericovero, ti consiglio di consul...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'confidence': 0.95, 'motivation': 'La conversazione riguarda la richiesta di informazioni su una dicitura da utilizzare in un documento per il ricovero.', 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione riguarda la richiesta di informazioni su una dicitura da utilizzare in un documento per il ricovero.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda la richiesta di informazioni su una dicitura da utilizzare in un documento per il ricovero.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 08c34af5c43793a03fe535267e0474a1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 82
   📊 Token totali: 510
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 510 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 82
   📊 Token conversazione finale: 82
   📊 Token totali: 510
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 279 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho bisogno di un oncologo [ASSISTENTE] Per avere informazioni specifiche sui medici oncologi di Humanitas, ti consiglio di visitare la pagina dedicata alla [Ricerca Medici](https://www.humanitas.it/medici/). Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2875 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 82
   📊 Token totali stimati: 510
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho bisogno di un oncologo [ASSISTENTE] Per avere informazioni specifiche sui medici oncologi di Humanitas, ti consiglio di visitare la pagina dedicata alla [Ricerca Medici](https://www.humanitas.it/medici/). Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica Oncologic'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:07.977333
====================================================================================================
📋 Session ID: classify_1756762687
⏱️  Processing Time: 1.243s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (279 chars):
   [UTENTE] Ho bisogno di un oncologo [ASSISTENTE] Per avere informazioni specifiche sui medici oncologi di Humanitas, ti consiglio di visitare la pagina dedicata alla [Ricerca Medici](https://www.hum...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica Oncologic'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica Oncologic
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica Oncologic
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 735dca331ea8fad5f21471dfe333e1c5 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 217
   📊 Token totali: 645
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 645 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 217
   📊 Token conversazione finale: 217
   📊 Token totali: 645
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 722 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Nicolò Maria buffi chi è? [ASSISTENTE] Il Professor Nicolò Maria Buffi è un medico specializzato in Urologia presso l'Unità Operativa di Urologia dell'Istituto Clinico Humanitas. [...] it/unita-operative/urologia)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2818 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 217
   📊 Token totali stimati: 645
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Nicolò Maria buffi chi è? [ASSISTENTE] Il Professor Nicolò Maria Buffi è un medico specializzato in Urologia presso l'Unità Operativa di Urologia dell'Istituto Clinico Humanitas. [...] it/unita-operative/urologia)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione si concentra sul Professor Nicolò Maria Buffi e sulle sue specializzazioni in urologia presso l'Istituto Clinico Humanitas. L'assi"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:11.042304
====================================================================================================
📋 Session ID: classify_1756762691
⏱️  Processing Time: 2.979s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (722 chars):
   [UTENTE] Nicolò Maria buffi chi è? [ASSISTENTE] Il Professor Nicolò Maria Buffi è un medico specializzato in Urologia presso l'Unità Operativa di Urologia dell'Istituto Clinico Humanitas. Fa parte ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione si concentra sul Professor Nicolò Maria Buffi e sulle sue specializzazioni in urologia presso l'Istituto Clinico Humanitas. L'assi"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione si concentra sul Professor Nicolò Maria Buffi e sulle sue specializzazioni in urologia presso l'Istituto Clinico Humanitas. L'assi
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione si concentra sul Professor Nicolò Maria Buffi e sulle sue specializzazioni in urologia presso l'Istituto Clinico Humanitas. L'assi
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b4e37a0daa63173343112528e82792ad classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 254
   📊 Token totali: 702
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 702 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 254
   📊 Token conversazione finale: 254
   📊 Token totali: 702
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 773 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] vorrei sapere i nmi dei chirurghi di ortopedia traumatologica [ASSISTENTE] I chirurghi dell'Unità Operativa di Ortopedia Traumatologica di Humanitas includono:

- **Dottor Lorenzo Di Mento** (Responsabile);
- **Dottor Matteo Cavanna**;
- **Dottor Lorenzo Giordano**;
- **Dottor Paolo Gozz..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 254
   📊 Token totali stimati: 702
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] vorrei sapere i nmi dei chirurghi di ortopedia traumatologica [ASSISTENTE] I chirurghi dell'Unità Operativa di Ortopedia Traumatologica di Humanitas includono:

- **Dottor Lorenzo Di Mento** (Responsabile);
- **Dottor Matteo Cavanna**;
- **Dottor Lorenzo Giordano**;
- **Dottor Paolo Gozz..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': 'La conversazione riguarda la ricerca di informazioni su chirurghi specializzati in una specifica area medica.', 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:12.623058
====================================================================================================
📋 Session ID: classify_1756762692
⏱️  Processing Time: 1.491s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (773 chars):
   [UTENTE] vorrei sapere i nmi dei chirurghi di ortopedia traumatologica [ASSISTENTE] I chirurghi dell'Unità Operativa di Ortopedia Traumatologica di Humanitas includono:

- **Dottor Lorenzo Di Mento...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [78 more lines] ...
     Line 82: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (190 chars):
   {'confidence': 0.95, 'motivation': 'La conversazione riguarda la ricerca di informazioni su chirurghi specializzati in una specifica area medica.', 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.95
   motivation: La conversazione riguarda la ricerca di informazioni su chirurghi specializzati in una specifica area medica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda la ricerca di informazioni su chirurghi specializzati in una specifica area medica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione bc8d4282e8d2b5c5702a14e88d309fd0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 105
   📊 Token totali: 533
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 533 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 105
   📊 Token conversazione finale: 105
   📊 Token totali: 533
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 371 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] come posso contattare la struttura del Dottor Carlo Castoro per la conferma di un appuntamento ? [ASSISTENTE] Per ottenere informazioni specifiche sul Dottor Carlo Castoro e sulla struttura in cui opera, ti consiglio di consultare la pagina [Ricerca Medici](https://www.humanitas.it/medic..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 105
   📊 Token totali stimati: 533
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] come posso contattare la struttura del Dottor Carlo Castoro per la conferma di un appuntamento ? [ASSISTENTE] Per ottenere informazioni specifiche sul Dottor Carlo Castoro e sulla struttura in cui opera, ti consiglio di consultare la pagina [Ricerca Medici](https://www.humanitas.it/medic..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.7, 'motivation': "La conversazione verte sull'appuntamento con uno specialista, il Dottor Carlo Castoro.", 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:14.089073
====================================================================================================
📋 Session ID: classify_1756762694
⏱️  Processing Time: 1.380s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (371 chars):
   [UTENTE] come posso contattare la struttura del Dottor Carlo Castoro per la conferma di un appuntamento ? [ASSISTENTE] Per ottenere informazioni specifiche sul Dottor Carlo Castoro e sulla struttur...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (166 chars):
   {'confidence': 0.7, 'motivation': "La conversazione verte sull'appuntamento con uno specialista, il Dottor Carlo Castoro.", 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.7
   motivation: La conversazione verte sull'appuntamento con uno specialista, il Dottor Carlo Castoro.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.700
   [██████████████░░░░░░] 70.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'appuntamento con uno specialista, il Dottor Carlo Castoro.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3e589f798f61ef04aa7eae1d85ca4b6e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 168
   📊 Token totali: 616
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 616 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 168
   📊 Token conversazione finale: 168
   📊 Token totali: 616
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 557 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Volevo sapere se a Rozzano effettuano la brachiterapia [ASSISTENTE] Sì, presso l'Istituto Clinico Humanitas di Rozzano è possibile effettuare trattamenti di radioterapia e radiochirurgia, che includono tecniche avanzate come la brachiterapia per specifiche patologie. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2956 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 168
   📊 Token totali stimati: 616
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Volevo sapere se a Rozzano effettuano la brachiterapia [ASSISTENTE] Sì, presso l'Istituto Clinico Humanitas di Rozzano è possibile effettuare trattamenti di radioterapia e radiochirurgia, che includono tecniche avanzate come la brachiterapia per specifiche patologie. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.7, 'motivation': "La conversazione verte sull'accesso a una specifica tecnica di trattamento per patologie oncologiche, quindi la categoria più adatta è Visita Specialistica Oncologica.", 'predicted_label': 'Visita Specialistica Oncologica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:15.895179
====================================================================================================
📋 Session ID: classify_1756762695
⏱️  Processing Time: 1.720s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (557 chars):
   [UTENTE] Volevo sapere se a Rozzano effettuano la brachiterapia [ASSISTENTE] Sì, presso l'Istituto Clinico Humanitas di Rozzano è possibile effettuare trattamenti di radioterapia e radiochirurgia, ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (258 chars):
   {'confidence': 0.7, 'motivation': "La conversazione verte sull'accesso a una specifica tecnica di trattamento per patologie oncologiche, quindi la categoria più adatta è Visita Specialistica Oncologica.", 'predicted_label': 'Visita Specialistica Oncologica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica Oncologica
   confidence: 0.7
   motivation: La conversazione verte sull'accesso a una specifica tecnica di trattamento per patologie oncologiche, quindi la categoria più adatta è Visita Specialistica Oncologica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.700
   [██████████████░░░░░░] 70.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso a una specifica tecnica di trattamento per patologie oncologiche, quindi la categoria più adatta è Visita Specialistica Oncologica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 8d93820b4dcb276507961808e3a6363d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica Oncologica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 295
   📊 Token totali: 743
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 743 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 295
   📊 Token conversazione finale: 295
   📊 Token totali: 743
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1024 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Catarata  [ASSISTENTE] La cataratta è una patologia oculare caratterizzata dall'opacizzazione del cristallino, la lente naturale dell'occhio, che porta a una progressiva riduzione della vista. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2898 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 295
   📊 Token totali stimati: 743
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Catarata  [ASSISTENTE] La cataratta è una patologia oculare caratterizzata dall'opacizzazione del cristallino, la lente naturale dell'occhio, che porta a una progressiva riduzione della vista. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': 'La conversazione verte sulla prenotazione di un intervento in regime SSN.', 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:17.386157
====================================================================================================
📋 Session ID: classify_1756762697
⏱️  Processing Time: 1.402s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1024 chars):
   [UTENTE] Catarata  [ASSISTENTE] La cataratta è una patologia oculare caratterizzata dall'opacizzazione del cristallino, la lente naturale dell'occhio, che porta a una progressiva riduzione della vi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (146 chars):
   {'confidence': 0.95, 'motivation': 'La conversazione verte sulla prenotazione di un intervento in regime SSN.', 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte sulla prenotazione di un intervento in regime SSN.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla prenotazione di un intervento in regime SSN.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 38399035ec99246a4430d40403a85a81 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 375
   📊 Token totali: 803
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 803 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 375
   📊 Token conversazione finale: 375
   📊 Token totali: 803
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1248 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] termoablazione a radiofrequenza [ASSISTENTE] La termoablazione a radiofrequenza è una tecnica utilizzata per trattare tumori in fase precoce o di piccole dimensioni, come quelli al fegato o ai reni. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2873 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 375
   📊 Token totali stimati: 803
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] termoablazione a radiofrequenza [ASSISTENTE] La termoablazione a radiofrequenza è una tecnica utilizzata per trattare tumori in fase precoce o di piccole dimensioni, come quelli al fegato o ai reni. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sulla termoablazione a radiofrequenza come trattamento per tumori, il che la rende pertinente alla categoria 'Visita Specialistica Oncologica'. La confidenza è alta poiché l'argomento di discussione è specifico e chiaramente definito.", 'predicted_label': 'Visita Specialistica Oncologica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:19.739529
====================================================================================================
📋 Session ID: classify_1756762699
⏱️  Processing Time: 2.266s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1248 chars):
   [UTENTE] termoablazione a radiofrequenza [ASSISTENTE] La termoablazione a radiofrequenza è una tecnica utilizzata per trattare tumori in fase precoce o di piccole dimensioni, come quelli al fegato ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (349 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sulla termoablazione a radiofrequenza come trattamento per tumori, il che la rende pertinente alla categoria 'Visita Specialistica Oncologica'. La confidenza è alta poiché l'argomento di discussione è specifico e chiaramente definito.", '...

📊 Parsed Response:
   predicted_label: Visita Specialistica Oncologica
   confidence: 0.95
   motivation: La conversazione verte sulla termoablazione a radiofrequenza come trattamento per tumori, il che la rende pertinente alla categoria 'Visita Specialistica Oncologica'. La confidenza è alta poiché l'argomento di discussione è specifico e chiaramente definito.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla termoablazione a radiofrequenza come trattamento per tumori, il che la rende pertinente alla categoria 'Visita Specialistica Oncologica'. La confidenza è alta poiché l'argomento di discussione è specifico e chiaramente definito.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 24869a87a3dd6c751cfa9bbdb82ed6c8 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica Oncologica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 213
   📊 Token totali: 641
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 641 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 213
   📊 Token conversazione finale: 213
   📊 Token totali: 641
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 777 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Screening tumore pancreas [ASSISTENTE] In Humanitas, il tumore del pancreas viene diagnosticato attraverso tecnologie avanzate come ecotomografia, TAC con mezzo di contrasto, risonanza magnetica e ecoendoscopia. Questi strumenti permettono una diagnosi accurata e una stadiazione dettagli..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 213
   📊 Token totali stimati: 641
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Screening tumore pancreas [ASSISTENTE] In Humanitas, il tumore del pancreas viene diagnosticato attraverso tecnologie avanzate come ecotomografia, TAC con mezzo di contrasto, risonanza magnetica e ecoendoscopia. Questi strumenti permettono una diagnosi accurata e una stadiazione dettagli..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '| predicted_label       | confidenza | motivazione                                                                 |'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:22.819189
====================================================================================================
📋 Session ID: classify_1756762702
⏱️  Processing Time: 2.990s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (777 chars):
   [UTENTE] Screening tumore pancreas [ASSISTENTE] In Humanitas, il tumore del pancreas viene diagnosticato attraverso tecnologie avanzate come ecotomografia, TAC con mezzo di contrasto, risonanza mag...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (181 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '| predicted_label       | confidenza | motivazione                                                                 |'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: | predicted_label       | confidenza | motivazione                                                                 |
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   | predicted_label       | confidenza | motivazione                                                                 |
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7e06b0c0cdef54e9ab92f58ac92d91c7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 210
   📊 Token totali: 658
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 658 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 210
   📊 Token conversazione finale: 210
   📊 Token totali: 658
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 723 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere quando vengo operato  [ASSISTENTE] Non ho accesso diretto alle informazioni personali o alle tempistiche specifiche per gli interventi. [...]  Se hai bisogno di ulteriori dettagli o assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2907 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 210
   📊 Token totali stimati: 658
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere quando vengo operato  [ASSISTENTE] Non ho accesso diretto alle informazioni personali o alle tempistiche specifiche per gli interventi. [...]  Se hai bisogno di ulteriori dettagli o assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte sull'operazione dell'utente e sulla Neurochirurgia, quindi la categoria più adatta sembra essere Visita Specialistica Oncologica.", 'predicted_label': 'Visita Specialistica Oncologica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:24.607434
====================================================================================================
📋 Session ID: classify_1756762704
⏱️  Processing Time: 1.701s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (723 chars):
   [UTENTE] Vorrei sapere quando vengo operato  [ASSISTENTE] Non ho accesso diretto alle informazioni personali o alle tempistiche specifiche per gli interventi. Ti consiglio di contattare direttament...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (244 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte sull'operazione dell'utente e sulla Neurochirurgia, quindi la categoria più adatta sembra essere Visita Specialistica Oncologica.", 'predicted_label': 'Visita Specialistica Oncologica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica Oncologica
   confidence: 0.75
   motivation: La conversazione verte sull'operazione dell'utente e sulla Neurochirurgia, quindi la categoria più adatta sembra essere Visita Specialistica Oncologica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'operazione dell'utente e sulla Neurochirurgia, quindi la categoria più adatta sembra essere Visita Specialistica Oncologica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 34f64c5c8a80677afa6322362400b4b5 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica Oncologica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 240
   📊 Token totali: 668
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 668 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 240
   📊 Token conversazione finale: 240
   📊 Token totali: 668
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 809 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia noi a noi è stato dato con le dimissioni protette di mio padre Fanara Giulio è stato consegnato un letto con materasso antidecubito sedia a rotelle e un deambulatore non sappiamo a chi rivolgersi per poterli riconsegnare adesso che mio papà è s [ASSISTENTE] Mi dispiace per la..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 240
   📊 Token totali stimati: 668
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia noi a noi è stato dato con le dimissioni protette di mio padre Fanara Giulio è stato consegnato un letto con materasso antidecubito sedia a rotelle e un deambulatore non sappiamo a chi rivolgersi per poterli riconsegnare adesso che mio papà è s [ASSISTENTE] Mi dispiace per la..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte sulla restituzione delle attrezzature mediche fornite dall'ospedale, quindi la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:26.445341
====================================================================================================
📋 Session ID: classify_1756762706
⏱️  Processing Time: 1.751s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (809 chars):
   [UTENTE] Ciao Giulia noi a noi è stato dato con le dimissioni protette di mio padre Fanara Giulio è stato consegnato un letto con materasso antidecubito sedia a rotelle e un deambulatore non sappia...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (224 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte sulla restituzione delle attrezzature mediche fornite dall'ospedale, quindi la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.75
   motivation: La conversazione verte sulla restituzione delle attrezzature mediche fornite dall'ospedale, quindi la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla restituzione delle attrezzature mediche fornite dall'ospedale, quindi la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7c7aa2df9c52d64493180571ca5fecf6 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 310
   📊 Token totali: 758
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 758 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 310
   📊 Token conversazione finale: 310
   📊 Token totali: 758
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1069 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, sono Barbara Capone di Napoli la nipote di un paziente ricoverato d'urgenza Giuseppe Capone, ora spostato nel reparto di Pneumologia in stato di elevata gravità. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2920 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 310
   📊 Token totali stimati: 758
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, sono Barbara Capone di Napoli la nipote di un paziente ricoverato d'urgenza Giuseppe Capone, ora spostato nel reparto di Pneumologia in stato di elevata gravità. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Pneumologia",\n  "confidence": 0.9,\n  "mot'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:28.601414
====================================================================================================
📋 Session ID: classify_1756762708
⏱️  Processing Time: 2.070s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1069 chars):
   [UTENTE] Buongiorno, sono Barbara Capone di Napoli la nipote di un paziente ricoverato d'urgenza Giuseppe Capone, ora spostato nel reparto di Pneumologia in stato di elevata gravità. Mi potrebbe co...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (197 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Pneumologia",\n  "confidence": 0.9,\n  "mot'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Pneumologia",
  "confidence": 0.9,
  "mot
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Pneumologia",
  "confidence": 0.9,
  "mot
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7276e2fca5dc57243c3f825d158f4134 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 360
   📊 Token totali: 808
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 808 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 360
   📊 Token conversazione finale: 360
   📊 Token totali: 808
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1182 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno Giulia mio padre ha fatto pre ricovero ieri e domani deve essere operato, quando ci contatteranno x convocazione? [ASSISTENTE] Se tuo padre ha già effettuato il prericovero e l'intervento è programmato per domani, Humanitas vi contatterà in tempi utili per confermare la convoc..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 360
   📊 Token totali stimati: 808
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno Giulia mio padre ha fatto pre ricovero ieri e domani deve essere operato, quando ci contatteranno x convocazione? [ASSISTENTE] Se tuo padre ha già effettuato il prericovero e l'intervento è programmato per domani, Humanitas vi contatterà in tempi utili per confermare la convoc..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Prenotazione",\n  "confidence": 0.9,\n  "mo'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:30.375759
====================================================================================================
📋 Session ID: classify_1756762710
⏱️  Processing Time: 1.687s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1182 chars):
   [UTENTE] Buongiorno Giulia mio padre ha fatto pre ricovero ieri e domani deve essere operato, quando ci contatteranno x convocazione? [ASSISTENTE] Se tuo padre ha già effettuato il prericovero e l'...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (197 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Prenotazione",\n  "confidence": 0.9,\n  "mo'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Prenotazione",
  "confidence": 0.9,
  "mo
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Prenotazione",
  "confidence": 0.9,
  "mo
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a8bc6a9330e4ad53183cb36fab8c92ba classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 254
   📊 Token totali: 702
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 702 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 254
   📊 Token conversazione finale: 254
   📊 Token totali: 702
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 836 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia Ho saputo che ha l'umanità praticamente danno via Delle parrucche avete a disposizione delle parrucche Siccome io sto facendo la Ennio proprio lì da voi e sto proprio perdendo i capelli Volevo alcune informazioni Se è vero Oppure se se non è ve [ASSISTENTE] In Humanitas è dis..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 254
   📊 Token totali stimati: 702
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia Ho saputo che ha l'umanità praticamente danno via Delle parrucche avete a disposizione delle parrucche Siccome io sto facendo la Ennio proprio lì da voi e sto proprio perdendo i capelli Volevo alcune informazioni Se è vero Oppure se se non è ve [ASSISTENTE] In Humanitas è dis..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sull'accesso e la disponibilità di servizi di parrucchiere all'interno dell'ospedale Humanitas, inclusa l'offerta di parrucche per pazienti che stanno perdendo i capelli a causa della chemio.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:32.530850
====================================================================================================
📋 Session ID: classify_1756762712
⏱️  Processing Time: 2.069s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (836 chars):
   [UTENTE] Ciao Giulia Ho saputo che ha l'umanità praticamente danno via Delle parrucche avete a disposizione delle parrucche Siccome io sto facendo la Ennio proprio lì da voi e sto proprio perdendo ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (307 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sull'accesso e la disponibilità di servizi di parrucchiere all'interno dell'ospedale Humanitas, inclusa l'offerta di parrucche per pazienti che stanno perdendo i capelli a causa della chemio.", 'predicted_label': 'Servizi a...

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte principalmente sull'accesso e la disponibilità di servizi di parrucchiere all'interno dell'ospedale Humanitas, inclusa l'offerta di parrucche per pazienti che stanno perdendo i capelli a causa della chemio.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sull'accesso e la disponibilità di servizi di parrucchiere all'interno dell'ospedale Humanitas, inclusa l'offerta di parrucche per pazienti che stanno perdendo i capelli a causa della chemio.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 4a3ed44d6635dc04538709c05f424129 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 146
   📊 Token totali: 574
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 574 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 146
   📊 Token conversazione finale: 146
   📊 Token totali: 574
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 515 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, ho ricevuto la comunicazione che avrei ricevuto una chiamata per comunicazioni relative al mio appuntamento di domattina ma non ho ricevuto alcuna chiamata [ASSISTENTE] Mi dispiace per l'inconveniente. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2890 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 146
   📊 Token totali stimati: 574
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, ho ricevuto la comunicazione che avrei ricevuto una chiamata per comunicazioni relative al mio appuntamento di domattina ma non ho ricevuto alcuna chiamata [ASSISTENTE] Mi dispiace per l'inconveniente. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:34.358844
====================================================================================================
📋 Session ID: classify_1756762714
⏱️  Processing Time: 1.742s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (515 chars):
   [UTENTE] Buongiorno, ho ricevuto la comunicazione che avrei ricevuto una chiamata per comunicazioni relative al mio appuntamento di domattina ma non ho ricevuto alcuna chiamata [ASSISTENTE] Mi disp...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 78d484c4aa242e1a29e48783182ff949 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 284
   📊 Token totali: 712
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 712 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 284
   📊 Token conversazione finale: 284
   📊 Token totali: 712
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 988 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao ho fatto una prenotazione ma non ho pagato niente, se non mi presento mi in tale data mi viene la multa? [ASSISTENTE] Se hai effettuato una prenotazione tramite il Servizio Sanitario Nazionale (SSN) e non ti presenti senza aver disdetto l'appuntamento almeno 48 ore prima, potresti i..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 284
   📊 Token totali stimati: 712
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao ho fatto una prenotazione ma non ho pagato niente, se non mi presento mi in tale data mi viene la multa? [ASSISTENTE] Se hai effettuato una prenotazione tramite il Servizio Sanitario Nazionale (SSN) e non ti presenti senza aver disdetto l'appuntamento almeno 48 ore prima, potresti i..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'assenza a un appuntamento prenotato in precedenza e sulle possibili conseguenze economiche.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:36.032269
====================================================================================================
📋 Session ID: classify_1756762716
⏱️  Processing Time: 1.585s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (988 chars):
   [UTENTE] ciao ho fatto una prenotazione ma non ho pagato niente, se non mi presento mi in tale data mi viene la multa? [ASSISTENTE] Se hai effettuato una prenotazione tramite il Servizio Sanitario ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (192 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'assenza a un appuntamento prenotato in precedenza e sulle possibili conseguenze economiche.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte sull'assenza a un appuntamento prenotato in precedenza e sulle possibili conseguenze economiche.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'assenza a un appuntamento prenotato in precedenza e sulle possibili conseguenze economiche.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d316b6e35928fbfc44a664e990e599f2 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 185
   📊 Token totali: 613
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 613 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 185
   📊 Token conversazione finale: 185
   📊 Token totali: 613
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 636 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho prenotato una risonanza magnetica senza contrasto per il 20 corrente presso humanitas rozzano ma dalla app vedo che l appuntamento è stato segnalato per il 27 corrente perché ?  [ASSISTENTE] Non ho accesso diretto ai dettagli degli appuntamenti personali. Ti consiglio di contattare il..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 185
   📊 Token totali stimati: 613
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho prenotato una risonanza magnetica senza contrasto per il 20 corrente presso humanitas rozzano ma dalla app vedo che l appuntamento è stato segnalato per il 27 corrente perché ?  [ASSISTENTE] Non ho accesso diretto ai dettagli degli appuntamenti personali. Ti consiglio di contattare il..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'appuntamento prenotato per una risonanza magnetica presso Humanitas Rozzano e sul bisogno di chiarire la data dell'appuntamento.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:37.856484
====================================================================================================
📋 Session ID: classify_1756762717
⏱️  Processing Time: 1.738s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (636 chars):
   [UTENTE] ho prenotato una risonanza magnetica senza contrasto per il 20 corrente presso humanitas rozzano ma dalla app vedo che l appuntamento è stato segnalato per il 27 corrente perché ?  [ASSIST...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (229 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'appuntamento prenotato per una risonanza magnetica presso Humanitas Rozzano e sul bisogno di chiarire la data dell'appuntamento.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte sull'appuntamento prenotato per una risonanza magnetica presso Humanitas Rozzano e sul bisogno di chiarire la data dell'appuntamento.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'appuntamento prenotato per una risonanza magnetica presso Humanitas Rozzano e sul bisogno di chiarire la data dell'appuntamento.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f7ab26643fb5d4177649be94ec39a65d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 152
   📊 Token totali: 580
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 580 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 152
   📊 Token conversazione finale: 152
   📊 Token totali: 580
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 509 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno Giulia, ho un appuntamento con il prof. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2678 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 152
   📊 Token totali stimati: 580
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno Giulia, ho un appuntamento con il prof. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:39.640432
====================================================================================================
📋 Session ID: classify_1756762719
⏱️  Processing Time: 1.697s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (509 chars):
   [UTENTE] Buongiorno Giulia, ho un appuntamento con il prof.Tinteri il giorno 1settembre alle ore 12.30 [ASSISTENTE] Per informazioni o conferme relative al tuo appuntamento con il Professore Tinter...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 85a2223257029bdce39115167a1dc9b2 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 147
   📊 Token totali: 575
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 575 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 147
   📊 Token conversazione finale: 147
   📊 Token totali: 575
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 462 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mi serve il numero dello sportello pre ricoveri Humanitas orto center  [ASSISTENTE] Per il prericovero presso l'Ortho Center di Humanitas, ti consiglio di contattare il centralino al numero 02 82241. Il personale potrà indirizzarti al reparto o allo sportello corretto. Se hai bisogno di ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 147
   📊 Token totali stimati: 575
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mi serve il numero dello sportello pre ricoveri Humanitas orto center  [ASSISTENTE] Per il prericovero presso l'Ortho Center di Humanitas, ti consiglio di contattare il centralino al numero 02 82241. Il personale potrà indirizzarti al reparto o allo sportello corretto. Se hai bisogno di ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla richiesta di informazioni relative ai pre-ricoveri presso l'Ortho Center dell'ospedale Humanitas. L'ass"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:42.688041
====================================================================================================
📋 Session ID: classify_1756762722
⏱️  Processing Time: 2.959s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (462 chars):
   [UTENTE] Mi serve il numero dello sportello pre ricoveri Humanitas orto center  [ASSISTENTE] Per il prericovero presso l'Ortho Center di Humanitas, ti consiglio di contattare il centralino al numer...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla richiesta di informazioni relative ai pre-ricoveri presso l'Ortho Center dell'ospedale Humanitas. L'ass"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla richiesta di informazioni relative ai pre-ricoveri presso l'Ortho Center dell'ospedale Humanitas. L'ass
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla richiesta di informazioni relative ai pre-ricoveri presso l'Ortho Center dell'ospedale Humanitas. L'ass
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 6ccb555acc97e6fd5245612ea9630ee6 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 119
   📊 Token totali: 547
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 547 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 119
   📊 Token conversazione finale: 119
   📊 Token totali: 547
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 378 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Cerco una mail del reparto urologia [ASSISTENTE] Non ho trovato un indirizzo email specifico per il reparto di Urologia. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2737 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 119
   📊 Token totali stimati: 547
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Cerco una mail del reparto urologia [ASSISTENTE] Non ho trovato un indirizzo email specifico per il reparto di Urologia. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.8, 'motivation': "La conversazione riguarda la ricerca di informazioni su un reparto specifico dell'ospedale.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:44.159553
====================================================================================================
📋 Session ID: classify_1756762724
⏱️  Processing Time: 1.384s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (378 chars):
   [UTENTE] Cerco una mail del reparto urologia [ASSISTENTE] Non ho trovato un indirizzo email specifico per il reparto di Urologia. Ti consiglio di consultare la pagina dedicata all'Unità Operativa d...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (168 chars):
   {'confidence': 0.8, 'motivation': "La conversazione riguarda la ricerca di informazioni su un reparto specifico dell'ospedale.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.8
   motivation: La conversazione riguarda la ricerca di informazioni su un reparto specifico dell'ospedale.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.800
   [████████████████░░░░] 80.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda la ricerca di informazioni su un reparto specifico dell'ospedale.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione efaf452920a142169d8154dd1c7bd28c classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 348
   📊 Token totali: 796
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 796 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 348
   📊 Token conversazione finale: 348
   📊 Token totali: 796
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1120 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] salvo, ho mandato diverse mail alla mail di segreteria perchè ho bisogno di un nuovo piano terapeutico visto che il mio è scaduto [ASSISTENTE] Capisco la tua necessità. [...] docx】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2857 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 348
   📊 Token totali stimati: 796
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] salvo, ho mandato diverse mail alla mail di segreteria perchè ho bisogno di un nuovo piano terapeutico visto che il mio è scaduto [ASSISTENTE] Capisco la tua necessità. [...] docx】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:45.921893
====================================================================================================
📋 Session ID: classify_1756762725
⏱️  Processing Time: 1.676s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1120 chars):
   [UTENTE] salvo, ho mandato diverse mail alla mail di segreteria perchè ho bisogno di un nuovo piano terapeutico visto che il mio è scaduto [ASSISTENTE] Capisco la tua necessità. Potresti indicarmi ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 52dbd5ef955213bd0bc1e8b86baec644 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 130
   📊 Token totali: 578
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 578 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 130
   📊 Token conversazione finale: 130
   📊 Token totali: 578
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 416 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno vorrei sapere i tempi di attesa x intervento TURP alla prostata [ASSISTENTE] I tempi di attesa per un intervento TURP alla prostata possono variare. [...] docx】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2848 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 130
   📊 Token totali stimati: 578
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno vorrei sapere i tempi di attesa x intervento TURP alla prostata [ASSISTENTE] I tempi di attesa per un intervento TURP alla prostata possono variare. [...] docx】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.7, 'motivation': "La conversazione verte sull'intervento TURP alla prostata, che è un tipo di visita specialistica.", 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:47.452650
====================================================================================================
📋 Session ID: classify_1756762727
⏱️  Processing Time: 1.443s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (416 chars):
   [UTENTE] Buongiorno vorrei sapere i tempi di attesa x intervento TURP alla prostata [ASSISTENTE] I tempi di attesa per un intervento TURP alla prostata possono variare. Ti consiglio di contattare d...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (177 chars):
   {'confidence': 0.7, 'motivation': "La conversazione verte sull'intervento TURP alla prostata, che è un tipo di visita specialistica.", 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.7
   motivation: La conversazione verte sull'intervento TURP alla prostata, che è un tipo di visita specialistica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.700
   [██████████████░░░░░░] 70.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'intervento TURP alla prostata, che è un tipo di visita specialistica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione adefc297745c050475f472fcbeb8d63e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 206
   📊 Token totali: 634
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 634 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 206
   📊 Token conversazione finale: 206
   📊 Token totali: 634
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 719 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mi hanno contattato per eseguire una TAC con e senza mezzo di contrasto total body e encefalo e mi hanno detto di portare impegnativa del medico curante,ma essendo in Piemonte cambiano i codici delle prestazioni dell' Humanitas di Rozzano perché in Lombardia. A chi mi posso rivolgere per..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 206
   📊 Token totali stimati: 634
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mi hanno contattato per eseguire una TAC con e senza mezzo di contrasto total body e encefalo e mi hanno detto di portare impegnativa del medico curante,ma essendo in Piemonte cambiano i codici delle prestazioni dell' Humanitas di Rozzano perché in Lombardia. A chi mi posso rivolgere per..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'Prenotazione', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:49.711293
====================================================================================================
📋 Session ID: classify_1756762729
⏱️  Processing Time: 2.172s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (719 chars):
   [UTENTE] Mi hanno contattato per eseguire una TAC con e senza mezzo di contrasto total body e encefalo e mi hanno detto di portare impegnativa del medico curante,ma essendo in Piemonte cambiano i c...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (104 chars):
   {'predicted_label': 'Prenotazione', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.6
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.600
   [████████████░░░░░░░░] 60.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 1c9aa26f3b410c7654f467ce3e6013bf classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 261
   📊 Token totali: 710
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 710 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 261
   📊 Token conversazione finale: 261
   📊 Token totali: 710
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 895 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo richiedere la mia cartella clinica  [ASSISTENTE] Puoi richiedere la tua cartella clinica in diversi modi:

1. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2862 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 261
   📊 Token totali stimati: 710
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo richiedere la mia cartella clinica  [ASSISTENTE] Puoi richiedere la tua cartella clinica in diversi modi:

1. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Referti e Cartelle Cliniche","conf'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:51.367724
====================================================================================================
📋 Session ID: classify_1756762731
⏱️  Processing Time: 1.570s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (895 chars):
   [UTENTE] Devo richiedere la mia cartella clinica  [ASSISTENTE] Puoi richiedere la tua cartella clinica in diversi modi:

1. **Online**: Puoi accedere all'area referti di [Humanitas con te](https://...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Referti e Cartelle Cliniche","conf'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Referti e Cartelle Cliniche","conf
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Referti e Cartelle Cliniche","conf
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione c5f3a12638b54b4140e5ba2920888db7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 509
   📊 Token totali: 957
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 957 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 509
   📊 Token conversazione finale: 509
   📊 Token totali: 957
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1771 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Franco Dal Pont oporato anca destra con protesi nel febbraio 2016. [...]  Se hai bisogno di ulteriori informazioni, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2806 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 509
   📊 Token totali stimati: 957
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Franco Dal Pont oporato anca destra con protesi nel febbraio 2016. [...]  Se hai bisogno di ulteriori informazioni, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'ottenimento di un documento che attesti la presenza della protesi per facilitare i controlli aeroportuali. La categoria 'Referti e Cartelle Cliniche' è pertinente poiché l'utente sta cercando informazioni su come ottenere una documentazione ufficiale riguardo alla sua condizione medica.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:53.989164
====================================================================================================
📋 Session ID: classify_1756762733
⏱️  Processing Time: 2.533s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1771 chars):
   [UTENTE] Franco Dal Pont oporato anca destra con protesi nel febbraio 2016. Recentemente il metaldetcor dell'aeroporto segnala la protesi ma non ho nulla per dimostrare che a cuasa di intervento or...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (403 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'ottenimento di un documento che attesti la presenza della protesi per facilitare i controlli aeroportuali. La categoria 'Referti e Cartelle Cliniche' è pertinente poiché l'utente sta cercando informazioni su come ottenere una documen...

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'ottenimento di un documento che attesti la presenza della protesi per facilitare i controlli aeroportuali. La categoria 'Referti e Cartelle Cliniche' è pertinente poiché l'utente sta cercando informazioni su come ottenere una documentazione ufficiale riguardo alla sua condizione medica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ottenimento di un documento che attesti la presenza della protesi per facilitare i controlli aeroportuali. La categoria 'Referti e Cartelle Cliniche' è pertinente poiché l'utente sta cercando informazioni su come ottenere una documentazione ufficiale riguardo alla sua condizione medica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3892e75b27ac020c74338253e2e33983 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 764
   📊 Token totali: 1212
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1212 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 764
   📊 Token conversazione finale: 764
   📊 Token totali: 1212
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2559 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mi è arrivato questo sms: La documentazione che ha richiesto è pronta: gli autorizzati possono ritirarla presso l'Area Ricoveri SSN (lun-ven 10-16), portando i documenti necessari. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2880 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 764
   📊 Token totali stimati: 1212
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mi è arrivato questo sms: La documentazione che ha richiesto è pronta: gli autorizzati possono ritirarla presso l'Area Ricoveri SSN (lun-ven 10-16), portando i documenti necessari. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Referti e Cartelle Cliniche",\n    "conf'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:56.110879
====================================================================================================
📋 Session ID: classify_1756762736
⏱️  Processing Time: 2.033s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2559 chars):
   [UTENTE] Mi è arrivato questo sms: La documentazione che ha richiesto è pronta: gli autorizzati possono ritirarla presso l'Area Ricoveri SSN (lun-ven 10-16), portando i documenti necessari. Info: b...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Referti e Cartelle Cliniche",\n    "conf'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Referti e Cartelle Cliniche",
    "conf
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Referti e Cartelle Cliniche",
    "conf
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 1a98dbf428fe09e21abf2f87c7a3eac8 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 375
   📊 Token totali: 824
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 824 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 375
   📊 Token conversazione finale: 375
   📊 Token totali: 824
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1296 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Come ritirare il referto di mia figlia minorenne? [ASSISTENTE] Per ritirare il referto di tua figlia minorenne, è necessario seguire queste indicazioni:

1. [...]  

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2906 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 375
   📊 Token totali stimati: 824
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Come ritirare il referto di mia figlia minorenne? [ASSISTENTE] Per ritirare il referto di tua figlia minorenne, è necessario seguire queste indicazioni:

1. [...]  

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:38:57.918842
====================================================================================================
📋 Session ID: classify_1756762737
⏱️  Processing Time: 1.721s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1296 chars):
   [UTENTE] Come ritirare il referto di mia figlia minorenne? [ASSISTENTE] Per ritirare il referto di tua figlia minorenne, è necessario seguire queste indicazioni:

1. **Ritiro da parte del genitore ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [77 more lines] ...
     Line 81: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 302276153f8be33cc5587281b1fe7376 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 262
   📊 Token totali: 710
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 710 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 262
   📊 Token conversazione finale: 262
   📊 Token totali: 710
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 926 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Sono stata ricoverata dal 29 06 al 02 07 2025 ma la cartella clinica non è ancora disponibile . [...] it/info/referti-cartelle-cliniche/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2814 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 262
   📊 Token totali stimati: 710
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Sono stata ricoverata dal 29 06 al 02 07 2025 ma la cartella clinica non è ancora disponibile . [...] it/info/referti-cartelle-cliniche/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:00.405587
====================================================================================================
📋 Session ID: classify_1756762740
⏱️  Processing Time: 2.398s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (926 chars):
   [UTENTE] Sono stata ricoverata dal 29 06 al 02 07 2025 ma la cartella clinica non è ancora disponibile . Come.posso sapere quando potrò scaricarla? [ASSISTENTE] La copia digitale della cartella cli...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 8325a056e6970ccfdf6575d83e79e87c classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 204
   📊 Token totali: 632
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 632 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 204
   📊 Token conversazione finale: 204
   📊 Token totali: 632
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 646 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] vorrei disdire un appuntamento [ASSISTENTE] Per disdire un appuntamento presso Humanitas, puoi seguire queste indicazioni:

1. [...] 

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2802 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 204
   📊 Token totali stimati: 632
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] vorrei disdire un appuntamento [ASSISTENTE] Per disdire un appuntamento presso Humanitas, puoi seguire queste indicazioni:

1. [...] 

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.8, 'motivation': "La conversazione verte sull'annullamento di un appuntamento, quindi la categoria 'Prenotazione' è appropriata.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:02.033926
====================================================================================================
📋 Session ID: classify_1756762742
⏱️  Processing Time: 1.541s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (646 chars):
   [UTENTE] vorrei disdire un appuntamento [ASSISTENTE] Per disdire un appuntamento presso Humanitas, puoi seguire queste indicazioni:

1. **Prenotazioni private**: Puoi annullare tramite il portale [...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [76 more lines] ...
     Line 80: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (182 chars):
   {'confidence': 0.8, 'motivation': "La conversazione verte sull'annullamento di un appuntamento, quindi la categoria 'Prenotazione' è appropriata.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.8
   motivation: La conversazione verte sull'annullamento di un appuntamento, quindi la categoria 'Prenotazione' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.800
   [████████████████░░░░] 80.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'annullamento di un appuntamento, quindi la categoria 'Prenotazione' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 8e88a9b6a973de964a1525f8fcb93464 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 283
   📊 Token totali: 711
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 711 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 283
   📊 Token conversazione finale: 283
   📊 Token totali: 711
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 916 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno Giulia Mi chiamo Valentina 120 Ho prenotato una visita e il breath test al glucosio per mercoledì in viale Premuda ma mi sono accorta Mi sono ricordata che ho mangiato yogurt Quindi vorrei spostarla a settembre mi può aiutare e possibilmente del [ASSISTENTE] Per spostare la tu..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 283
   📊 Token totali stimati: 711
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno Giulia Mi chiamo Valentina 120 Ho prenotato una visita e il breath test al glucosio per mercoledì in viale Premuda ma mi sono accorta Mi sono ricordata che ho mangiato yogurt Quindi vorrei spostarla a settembre mi può aiutare e possibilmente del [ASSISTENTE] Per spostare la tu..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione"}}**'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:02.935764
====================================================================================================
📋 Session ID: classify_1756762742
⏱️  Processing Time: 0.816s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (916 chars):
   [UTENTE] Buongiorno Giulia Mi chiamo Valentina 120 Ho prenotato una visita e il breath test al glucosio per mercoledì in viale Premuda ma mi sono accorta Mi sono ricordata che ho mangiato yogurt Qu...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (178 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione"}}**'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione"}}**
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione"}}**
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f754a72a0518c1bd91d33d6d1010f5a4 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 166
   📊 Token totali: 594
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 594 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 166
   📊 Token conversazione finale: 166
   📊 Token totali: 594
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 557 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno ho fatto una prenotazione di visita oncologica con prof Santoro, ma siccome al sito mi sono iscritta a mio nome risulta a mio nome la prenr, ma sarebbe per mio babbo [ASSISTENTE] Per modificare i dati della prenotazione e associarla al nome corretto, ti consiglio di contattare..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 166
   📊 Token totali stimati: 594
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno ho fatto una prenotazione di visita oncologica con prof Santoro, ma siccome al sito mi sono iscritta a mio nome risulta a mio nome la prenr, ma sarebbe per mio babbo [ASSISTENTE] Per modificare i dati della prenotazione e associarla al nome corretto, ti consiglio di contattare..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'prenotazione', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:05.972047
====================================================================================================
📋 Session ID: classify_1756762745
⏱️  Processing Time: 2.948s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (557 chars):
   [UTENTE] buongiorno ho fatto una prenotazione di visita oncologica con prof Santoro, ma siccome al sito mi sono iscritta a mio nome risulta a mio nome la prenr, ma sarebbe per mio babbo [ASSISTENTE...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (104 chars):
   {'predicted_label': 'prenotazione', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: prenotazione
   confidence: 0.6
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.600
   [████████████░░░░░░░░] 60.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 6eefc00ca8c879e040e10481d4c0fb44 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 425
   📊 Token totali: 853
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 853 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 425
   📊 Token conversazione finale: 425
   📊 Token totali: 853
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1383 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho prenotato un prelievo venoso tramite assicurazione per una data ma dovrei spostare l'appuntamento. [...]  Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2774 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 425
   📊 Token totali stimati: 853
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho prenotato un prelievo venoso tramite assicurazione per una data ma dovrei spostare l'appuntamento. [...]  Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'utente che desidera spostare un appuntamento di prelievo venoso precedentemente prenotato tramite assicurazione. L'assistente fornisce istruzioni su come modificare l'appuntamento e conferma che è possibile farlo all'interno del periodo di validità dell'autorizzazione dell'assicurazione.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:08.568053
====================================================================================================
📋 Session ID: classify_1756762748
⏱️  Processing Time: 2.511s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1383 chars):
   [UTENTE] Ho prenotato un prelievo venoso tramite assicurazione per una data ma dovrei spostare l'appuntamento. E' possibile farlo visto che l'autorizzazione dell'assicurazione ha un determinato per...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (389 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'utente che desidera spostare un appuntamento di prelievo venoso precedentemente prenotato tramite assicurazione. L'assistente fornisce istruzioni su come modificare l'appuntamento e conferma che è possibile farlo all'interno del peri...

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte sull'utente che desidera spostare un appuntamento di prelievo venoso precedentemente prenotato tramite assicurazione. L'assistente fornisce istruzioni su come modificare l'appuntamento e conferma che è possibile farlo all'interno del periodo di validità dell'autorizzazione dell'assicurazione.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'utente che desidera spostare un appuntamento di prelievo venoso precedentemente prenotato tramite assicurazione. L'assistente fornisce istruzioni su come modificare l'appuntamento e conferma che è possibile farlo all'interno del periodo di validità dell'autorizzazione dell'assicurazione.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 0afaca2ea462f837e7fab04c066d82a4 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 276
   📊 Token totali: 724
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 724 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 276
   📊 Token conversazione finale: 276
   📊 Token totali: 724
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 889 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile? [UTENTE] Volevo sapere se l’appuntamento che mi avete dato per 14 agosto posso farlo il 13 agosto alle 15 [ASSISTENTE] Non ho accesso alle informazioni personali o agli appuntamenti specifici. Per modificare un appuntamento, ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 276
   📊 Token totali stimati: 724
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile? [UTENTE] Volevo sapere se l’appuntamento che mi avete dato per 14 agosto posso farlo il 13 agosto alle 15 [ASSISTENTE] Non ho accesso alle informazioni personali o agli appuntamenti specifici. Per modificare un appuntamento, ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione ruota attorno alla modifica di un appuntamento precedentemente prenotato. L'utente chiede se è possibile anticipare l'appuntamento"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:11.678996
====================================================================================================
📋 Session ID: classify_1756762751
⏱️  Processing Time: 3.025s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (889 chars):
   [UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile? [UTENTE] Volevo sapere se l’appuntamento che mi avete dato per 14 agosto posso farlo il 13 agosto alle 15 [ASSISTENTE] Non ho...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione ruota attorno alla modifica di un appuntamento precedentemente prenotato. L'utente chiede se è possibile anticipare l'appuntamento"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione ruota attorno alla modifica di un appuntamento precedentemente prenotato. L'utente chiede se è possibile anticipare l'appuntamento
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione ruota attorno alla modifica di un appuntamento precedentemente prenotato. L'utente chiede se è possibile anticipare l'appuntamento
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione e1acf69ed1fd63d67b4cfb4dbf8cff6e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 343
   📊 Token totali: 792
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 792 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 343
   📊 Token conversazione finale: 343
   📊 Token totali: 792
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1170 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo richiedere la cartella clinica  [ASSISTENTE] Puoi richiedere il rilascio delle cartelle cliniche dei ricoveri svolti presso l'Istituto Clinico Humanitas online dall’area referti di [Humanitas con te](https://www.humanitasconte.it). Se sei in struttura, puoi rivolgerti all'Ufficio Ri..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 343
   📊 Token totali stimati: 792
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo richiedere la cartella clinica  [ASSISTENTE] Puoi richiedere il rilascio delle cartelle cliniche dei ricoveri svolti presso l'Istituto Clinico Humanitas online dall’area referti di [Humanitas con te](https://www.humanitasconte.it). Se sei in struttura, puoi rivolgerti all'Ufficio Ri..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sul recupero delle cartelle cliniche dell'utente presso l'Istituto Clinico Humanitas.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:13.429808
====================================================================================================
📋 Session ID: classify_1756762753
⏱️  Processing Time: 1.653s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1170 chars):
   [UTENTE] Devo richiedere la cartella clinica  [ASSISTENTE] Puoi richiedere il rilascio delle cartelle cliniche dei ricoveri svolti presso l'Istituto Clinico Humanitas online dall’area referti di [H...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sul recupero delle cartelle cliniche dell'utente presso l'Istituto Clinico Humanitas.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sul recupero delle cartelle cliniche dell'utente presso l'Istituto Clinico Humanitas.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sul recupero delle cartelle cliniche dell'utente presso l'Istituto Clinico Humanitas.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione fdfe5346d217d2fea90071bce745ed2c classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 453
   📊 Token totali: 901
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 901 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 453
   📊 Token conversazione finale: 453
   📊 Token totali: 901
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1507 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buon giorno Giulia. [...]  Buona giornata! 🌟"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2721 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 453
   📊 Token totali stimati: 901
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buon giorno Giulia. [...]  Buona giornata! 🌟"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla richiesta dell'utente di ricevere la cartella clinica del suo intervento presso l'Humanitas San Pio X d"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:16.228496
====================================================================================================
📋 Session ID: classify_1756762756
⏱️  Processing Time: 2.712s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1507 chars):
   [UTENTE] Buon giorno Giulia. [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? 😊 [UTENTE] Buon giorno vorrei ricevere a casa x via posta la cartella clinica del mio. Intervento eseguito il 19...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla richiesta dell'utente di ricevere la cartella clinica del suo intervento presso l'Humanitas San Pio X d"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla richiesta dell'utente di ricevere la cartella clinica del suo intervento presso l'Humanitas San Pio X d
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla richiesta dell'utente di ricevere la cartella clinica del suo intervento presso l'Humanitas San Pio X d
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione c0c714fbbc58870c1caa166fcedac14b classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 176
   📊 Token totali: 604
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 604 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 176
   📊 Token conversazione finale: 176
   📊 Token totali: 604
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 610 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] quali sono i tempi per ritiro del cd e referto in caso di rx eos? [ASSISTENTE] Il referto e il CD relativi all'RX EOS possono essere ritirati a partire dalla prima data utile indicata sul tagliando di promemoria rilasciato al momento dell'accettazione. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2869 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 176
   📊 Token totali stimati: 604
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] quali sono i tempi per ritiro del cd e referto in caso di rx eos? [ASSISTENTE] Il referto e il CD relativi all'RX EOS possono essere ritirati a partire dalla prima data utile indicata sul tagliando di promemoria rilasciato al momento dell'accettazione. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sul ritiro del referto e del CD dell'esame RX EOS, pertanto la categoria 'Referti e Cartelle Cliniche' è appropriata.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:18.054961
====================================================================================================
📋 Session ID: classify_1756762758
⏱️  Processing Time: 1.740s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (610 chars):
   [UTENTE] quali sono i tempi per ritiro del cd e referto in caso di rx eos? [ASSISTENTE] Il referto e il CD relativi all'RX EOS possono essere ritirati a partire dalla prima data utile indicata sul ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (227 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sul ritiro del referto e del CD dell'esame RX EOS, pertanto la categoria 'Referti e Cartelle Cliniche' è appropriata.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.9
   motivation: La conversazione verte sul ritiro del referto e del CD dell'esame RX EOS, pertanto la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sul ritiro del referto e del CD dell'esame RX EOS, pertanto la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 6a8c6d2e99eae81948634919cef4ef3e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 447
   💬 Token conversazione: 257
   📊 Token totali: 704
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 704 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 447
   📊 Token conversazione originale: 257
   📊 Token conversazione finale: 257
   📊 Token totali: 704
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 910 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho subito un intervento il 23/7 ENON Vedo ancora la cartella clinica. [...]  Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2806 characters
🔢 Token Analysis:
   📊 Token prompt base: 447
   📊 Token conversazione: 257
   📊 Token totali stimati: 704
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho subito un intervento il 23/7 ENON Vedo ancora la cartella clinica. [...]  Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:19.818411
====================================================================================================
📋 Session ID: classify_1756762759
⏱️  Processing Time: 1.678s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (910 chars):
   [UTENTE] ho subito un intervento il 23/7 ENON Vedo ancora la cartella clinica. e' possibile che non sia ancora prnta? [ASSISTENTE] La cartella clinica digitale è generalmente disponibile per la con...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 182ed227bea236c2ff50d2d46a08ce3d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 327
   📊 Token totali: 776
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 776 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 327
   📊 Token conversazione finale: 327
   📊 Token totali: 776
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1087 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] devo fare richiesta di una cartella clinica di un paziente che è deceduto Lino Humanitas [ASSISTENTE] Per richiedere la cartella clinica di un paziente deceduto, è necessario seguire le normative sulla privacy. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2957 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 327
   📊 Token totali stimati: 776
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] devo fare richiesta di una cartella clinica di un paziente che è deceduto Lino Humanitas [ASSISTENTE] Per richiedere la cartella clinica di un paziente deceduto, è necessario seguire le normative sulla privacy. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:21.721903
====================================================================================================
📋 Session ID: classify_1756762761
⏱️  Processing Time: 1.812s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1087 chars):
   [UTENTE] devo fare richiesta di una cartella clinica di un paziente che è deceduto Lino Humanitas [ASSISTENTE] Per richiedere la cartella clinica di un paziente deceduto, è necessario seguire le no...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 845105cb3506c744c100f07be3e3efac classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 176
   📊 Token totali: 625
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 625 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 176
   📊 Token conversazione finale: 176
   📊 Token totali: 625
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 644 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo modificare il numero di cellulare  [ASSISTENTE] Per modificare il numero di cellulare associato al tuo account o ai tuoi dati presso Humanitas, ti consiglio di accedere al portale [Humanitas con te](https://www. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 176
   📊 Token totali stimati: 625
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo modificare il numero di cellulare  [ASSISTENTE] Per modificare il numero di cellulare associato al tuo account o ai tuoi dati presso Humanitas, ti consiglio di accedere al portale [Humanitas con te](https://www. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sulla modifica del numero di cellulare associato all'account dell'utente su Humanitas con te.", 'predicted_label': 'Humanitas con te - Registrazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:23.388431
====================================================================================================
📋 Session ID: classify_1756762763
⏱️  Processing Time: 1.581s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (644 chars):
   [UTENTE] Devo modificare il numero di cellulare  [ASSISTENTE] Per modificare il numero di cellulare associato al tuo account o ai tuoi dati presso Humanitas, ti consiglio di accedere al portale [Hu...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (209 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sulla modifica del numero di cellulare associato all'account dell'utente su Humanitas con te.", 'predicted_label': 'Humanitas con te - Registrazione'}

📊 Parsed Response:
   predicted_label: Humanitas con te - Registrazione
   confidence: 0.95
   motivation: La conversazione verte sulla modifica del numero di cellulare associato all'account dell'utente su Humanitas con te.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla modifica del numero di cellulare associato all'account dell'utente su Humanitas con te.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione e5561797c1f19fec35e2c85552d57da6 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Humanitas con te - Registrazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 384
   📊 Token totali: 838
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 838 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 384
   📊 Token conversazione finale: 384
   📊 Token totali: 838
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1305 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a impostare la ricezione di notifiche sull’area referti  [ASSISTENTE] Per impostare la ricezione di notifiche sull’area referti di [Humanitas con te](https://www. [...]  

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2951 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 384
   📊 Token totali stimati: 838
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a impostare la ricezione di notifiche sull’area referti  [ASSISTENTE] Per impostare la ricezione di notifiche sull’area referti di [Humanitas con te](https://www. [...]  

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of conversation:**\n\n- predicted_label: "Humanitas con te - Registrazione"\n- confide'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:25.293291
====================================================================================================
📋 Session ID: classify_1756762765
⏱️  Processing Time: 1.818s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1305 chars):
   [UTENTE] Non riesco a impostare la ricezione di notifiche sull’area referti  [ASSISTENTE] Per impostare la ricezione di notifiche sull’area referti di [Humanitas con te](https://www.humanitasconte....

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (194 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of conversation:**\n\n- predicted_label: "Humanitas con te - Registrazione"\n- confide'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Classification of conversation:**

- predicted_label: "Humanitas con te - Registrazione"
- confide
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Classification of conversation:**

- predicted_label: "Humanitas con te - Registrazione"
- confide
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 20199d190fa2a7f6ae57f1b304b594dc classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Utente confuso - semplifica classificazione verso problemi tecnici

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 452
   💬 Token conversazione: 93
   📊 Token totali: 545
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 545 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 452
   📊 Token conversazione originale: 93
   📊 Token conversazione finale: 93
   📊 Token totali: 545
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 322 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Hanno sbagliato il mio numero di telefono  [ASSISTENTE] Se il tuo numero di telefono è stato registrato in modo errato, ti consiglio di contattare direttamente il servizio di assistenza o il reparto con cui hai avuto contatti per correggere l'errore. Se hai bisogno di ulteriori dettagli o s..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2986 characters
🔢 Token Analysis:
   📊 Token prompt base: 452
   📊 Token conversazione: 93
   📊 Token totali stimati: 545
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Utente confuso - semplifica classificazione verso problemi tecnici

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Hanno sbagliato il mio numero di telefono  [ASSISTENTE] Se il tuo numero di telefono è stato registrato in modo errato, ti consiglio di contattare direttamente il servizio di assistenza o il reparto con cui hai avuto contatti per correggere l'errore. Se hai bisogno di ulteriori dettagli o s..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'errore nel numero di telefono dell'utente e sul suggerimento di contattare il servizio di assistenza per correggerlo.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:27.054832
====================================================================================================
📋 Session ID: classify_1756762767
⏱️  Processing Time: 1.673s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (322 chars):
   [UTENTE] Hanno sbagliato il mio numero di telefono  [ASSISTENTE] Se il tuo numero di telefono è stato registrato in modo errato, ti consiglio di contattare direttamente il servizio di assistenza o ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (223 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'errore nel numero di telefono dell'utente e sul suggerimento di contattare il servizio di assistenza per correggerlo.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'errore nel numero di telefono dell'utente e sul suggerimento di contattare il servizio di assistenza per correggerlo.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'errore nel numero di telefono dell'utente e sul suggerimento di contattare il servizio di assistenza per correggerlo.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a7bd13ed44a98dcdc7e1806cebbe1e50 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 149
   📊 Token totali: 577
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 577 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 149
   📊 Token conversazione finale: 149
   📊 Token totali: 577
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 530 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Come faccio a modificare il mio numero di cellulare sul App area personale  [ASSISTENTE] Per modificare il numero di cellulare nell'App "Humanitas con te", accedi alla tua area personale. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2804 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 149
   📊 Token totali stimati: 577
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Come faccio a modificare il mio numero di cellulare sul App area personale  [ASSISTENTE] Per modificare il numero di cellulare nell'App "Humanitas con te", accedi alla tua area personale. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sull'accesso e la modifica delle informazioni personali nell'app Humanitas con te.", 'predicted_label': 'Humanitas con te - Registrazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:28.622079
====================================================================================================
📋 Session ID: classify_1756762768
⏱️  Processing Time: 1.481s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (530 chars):
   [UTENTE] Come faccio a modificare il mio numero di cellulare sul App area personale  [ASSISTENTE] Per modificare il numero di cellulare nell'App "Humanitas con te", accedi alla tua area personale. ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (197 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sull'accesso e la modifica delle informazioni personali nell'app Humanitas con te.", 'predicted_label': 'Humanitas con te - Registrazione'}

📊 Parsed Response:
   predicted_label: Humanitas con te - Registrazione
   confidence: 0.9
   motivation: La conversazione verte sull'accesso e la modifica delle informazioni personali nell'app Humanitas con te.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso e la modifica delle informazioni personali nell'app Humanitas con te.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione e225b9c55a9f51d3276cd0e78133d5b5 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Humanitas con te - Registrazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 260
   📊 Token totali: 714
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 714 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 260
   📊 Token conversazione finale: 260
   📊 Token totali: 714
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 824 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a registrami su Humanitas con te [ASSISTENTE] Per registrarti su [Humanitas con te](https://www. [...] docx】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2827 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 260
   📊 Token totali stimati: 714
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a registrami su Humanitas con te [ASSISTENTE] Per registrarti su [Humanitas con te](https://www. [...] docx】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sulla difficoltà dell'utente nel registrarsi su Humanitas con te e l'assistenza fornisce istruzioni dettagliate per completare la procedura di registrazione.", 'predicted_label': 'Humanitas con te - Registrazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:30.622419
====================================================================================================
📋 Session ID: classify_1756762770
⏱️  Processing Time: 1.912s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (824 chars):
   [UTENTE] Non riesco a registrami su Humanitas con te [ASSISTENTE] Per registrarti su [Humanitas con te](https://www.humanitasconte.it), segui questi passaggi:

1. Collegati al sito [Humanitas con t...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (272 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sulla difficoltà dell'utente nel registrarsi su Humanitas con te e l'assistenza fornisce istruzioni dettagliate per completare la procedura di registrazione.", 'predicted_label': 'Humanitas con te - Registrazione'}

📊 Parsed Response:
   predicted_label: Humanitas con te - Registrazione
   confidence: 0.9
   motivation: La conversazione verte sulla difficoltà dell'utente nel registrarsi su Humanitas con te e l'assistenza fornisce istruzioni dettagliate per completare la procedura di registrazione.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla difficoltà dell'utente nel registrarsi su Humanitas con te e l'assistenza fornisce istruzioni dettagliate per completare la procedura di registrazione.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 2b2cbfdcb43401d084b6cedce71d6d46 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Humanitas con te - Registrazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 430
   📊 Token totali: 878
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 878 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 430
   📊 Token conversazione finale: 430
   📊 Token totali: 878
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1423 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia, come posso registrarmi al vostro portale? [ASSISTENTE] Per registrarti al portale [Humanitas con te](https://www. [...]  Buona giornata! 😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2828 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 430
   📊 Token totali stimati: 878
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia, come posso registrarmi al vostro portale? [ASSISTENTE] Per registrarti al portale [Humanitas con te](https://www. [...]  Buona giornata! 😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione inizia con l'utente che chiede come registrarsi al portale Humanitas con te e l'assistente fornisce le istruzioni necessarie. Succ"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:33.428160
====================================================================================================
📋 Session ID: classify_1756762773
⏱️  Processing Time: 2.720s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1423 chars):
   [UTENTE] Ciao Giulia, come posso registrarmi al vostro portale? [ASSISTENTE] Per registrarti al portale [Humanitas con te](https://www.humanitasconte.it), devi essere maggiorenne e avere a disposiz...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione inizia con l'utente che chiede come registrarsi al portale Humanitas con te e l'assistente fornisce le istruzioni necessarie. Succ"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione inizia con l'utente che chiede come registrarsi al portale Humanitas con te e l'assistente fornisce le istruzioni necessarie. Succ
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione inizia con l'utente che chiede come registrarsi al portale Humanitas con te e l'assistente fornisce le istruzioni necessarie. Succ
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 372b6105e5fbbba3c32ce5493b5db0c1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 368
   📊 Token totali: 822
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 822 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 368
   📊 Token conversazione finale: 368
   📊 Token totali: 822
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1178 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco ad accedere ne registrarmi al servizio  [ASSISTENTE] Se riscontri problemi con la registrazione o l'accesso al portale [Humanitas con te](https://www. [...] it/info/humanitas-con-te)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2901 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 368
   📊 Token totali stimati: 822
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco ad accedere ne registrarmi al servizio  [ASSISTENTE] Se riscontri problemi con la registrazione o l'accesso al portale [Humanitas con te](https://www. [...] it/info/humanitas-con-te)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Humanitas con te - Registrazione",\n  "con'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:35.401427
====================================================================================================
📋 Session ID: classify_1756762775
⏱️  Processing Time: 1.886s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1178 chars):
   [UTENTE] Non riesco ad accedere ne registrarmi al servizio  [ASSISTENTE] Se riscontri problemi con la registrazione o l'accesso al portale [Humanitas con te](https://www.humanitasconte.it), ti cons...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Humanitas con te - Registrazione",\n  "con'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Humanitas con te - Registrazione",
  "con
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Humanitas con te - Registrazione",
  "con
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 0c5778e466178615ba13e8f0bea44f4e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
   📈 Progresso LLM: 150/155
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 231
   📊 Token totali: 680
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 680 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 231
   📊 Token conversazione finale: 231
   📊 Token totali: 680
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 775 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao dovrei fare la registrazione per poi scaricare i referti delle visite che ho fatto come devo fare [ASSISTENTE] Per registrarti al portale [Humanitas con te](https://www. [...] docx】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2864 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 231
   📊 Token totali stimati: 680
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao dovrei fare la registrazione per poi scaricare i referti delle visite che ho fatto come devo fare [ASSISTENTE] Per registrarti al portale [Humanitas con te](https://www. [...] docx】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sulla registrazione all'area riservata del portale Humanitas con te per scaricare i referti delle visite mediche.", 'predicted_label': 'Humanitas con te - Registrazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:37.156827
====================================================================================================
📋 Session ID: classify_1756762777
⏱️  Processing Time: 1.667s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (775 chars):
   [UTENTE] Ciao dovrei fare la registrazione per poi scaricare i referti delle visite che ho fatto come devo fare [ASSISTENTE] Per registrarti al portale [Humanitas con te](https://www.humanitasconte...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (228 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sulla registrazione all'area riservata del portale Humanitas con te per scaricare i referti delle visite mediche.", 'predicted_label': 'Humanitas con te - Registrazione'}

📊 Parsed Response:
   predicted_label: Humanitas con te - Registrazione
   confidence: 0.9
   motivation: La conversazione verte sulla registrazione all'area riservata del portale Humanitas con te per scaricare i referti delle visite mediche.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla registrazione all'area riservata del portale Humanitas con te per scaricare i referti delle visite mediche.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 36358ea4a8088d57dfb6c88727d3bb81 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Humanitas con te - Registrazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 243
   📊 Token totali: 691
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 691 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 243
   📊 Token conversazione finale: 243
   📊 Token totali: 691
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 877 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao, volevo sapere dopo quanti giorni è pronto il referto di una risonanza magnetica addome inferiore [ASSISTENTE] Il referto della risonanza magnetica sarà disponibile a partire dalla data e dall'orario specificati sul promemoria di ritiro del referto o sul ticket di accettazione rilas..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 243
   📊 Token totali stimati: 691
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao, volevo sapere dopo quanti giorni è pronto il referto di una risonanza magnetica addome inferiore [ASSISTENTE] Il referto della risonanza magnetica sarà disponibile a partire dalla data e dall'orario specificati sul promemoria di ritiro del referto o sul ticket di accettazione rilas..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:39.021945
====================================================================================================
📋 Session ID: classify_1756762779
⏱️  Processing Time: 1.776s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (877 chars):
   [UTENTE] Ciao, volevo sapere dopo quanti giorni è pronto il referto di una risonanza magnetica addome inferiore [ASSISTENTE] Il referto della risonanza magnetica sarà disponibile a partire dalla da...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 74b85f308de5becd01e60dfa9ef67f1b classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 219
   📊 Token totali: 647
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 647 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 219
   📊 Token conversazione finale: 219
   📊 Token totali: 647
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 789 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho fatto una risonanza magnetica venerdì 11 luglio e sul foglio dell'accettazione c'era scritto che il referto sarebbe arrivato oggi ma ancora non ho ricevuto niente. [...] it/Help)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2786 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 219
   📊 Token totali stimati: 647
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho fatto una risonanza magnetica venerdì 11 luglio e sul foglio dell'accettazione c'era scritto che il referto sarebbe arrivato oggi ma ancora non ho ricevuto niente. [...] it/Help)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'assenza del referto di una risonanza magnetica eseguita dall'utente e l'assistente spiega quando il referto sarà disponibile.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:40.944791
====================================================================================================
📋 Session ID: classify_1756762780
⏱️  Processing Time: 1.837s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (789 chars):
   [UTENTE] Ho fatto una risonanza magnetica venerdì 11 luglio e sul foglio dell'accettazione c'era scritto che il referto sarebbe arrivato oggi ma ancora non ho ricevuto niente. E' possibile che arri...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (241 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'assenza del referto di una risonanza magnetica eseguita dall'utente e l'assistente spiega quando il referto sarà disponibile.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'assenza del referto di una risonanza magnetica eseguita dall'utente e l'assistente spiega quando il referto sarà disponibile.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'assenza del referto di una risonanza magnetica eseguita dall'utente e l'assistente spiega quando il referto sarà disponibile.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione c85e550cd477497cf0b91a80518b6075 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 322
   📊 Token totali: 770
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 770 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 322
   📊 Token conversazione finale: 322
   📊 Token totali: 770
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1067 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, 

Ieri ho fatto le analisi del sangue per la GONADOTROPINA CORIONICA (SUBUNITA' BETA, FRAZIONE LIBERA). [...]  Se posso aiutarti in altro, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2841 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 322
   📊 Token totali stimati: 770
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, 

Ieri ho fatto le analisi del sangue per la GONADOTROPINA CORIONICA (SUBUNITA' BETA, FRAZIONE LIBERA). [...]  Se posso aiutarti in altro, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of medical conversation**\n\n- predicted_label: "Analisi"\n- confidence: 0.9\n- motivat'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:42.701241
====================================================================================================
📋 Session ID: classify_1756762782
⏱️  Processing Time: 1.670s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1067 chars):
   [UTENTE] Buongiorno, 

Ieri ho fatto le analisi del sangue per la GONADOTROPINA CORIONICA (SUBUNITA' BETA, FRAZIONE LIBERA). 

È un esame che tutti i centri analisi effettuano e refertano in giorna...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of medical conversation**\n\n- predicted_label: "Analisi"\n- confidence: 0.9\n- motivat'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Classification of medical conversation**

- predicted_label: "Analisi"
- confidence: 0.9
- motivat
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Classification of medical conversation**

- predicted_label: "Analisi"
- confidence: 0.9
- motivat
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f2531d5ac34b6a6de71a890ec26ba542 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 163
   📊 Token totali: 591
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 591 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 163
   📊 Token conversazione finale: 163
   📊 Token totali: 591
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 579 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buon Giorno Giulia ho effettuato una radiografia in data 1/8 ed il referto doveva essere disponibile il 4/8 ma non è ancora presente [ASSISTENTE] Il referto dovrebbe essere disponibile a partire dalla data e dall'orario specificati sul promemoria di ritiro del referto o sul ticket di acc..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 163
   📊 Token totali stimati: 591
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buon Giorno Giulia ho effettuato una radiografia in data 1/8 ed il referto doveva essere disponibile il 4/8 ma non è ancora presente [ASSISTENTE] Il referto dovrebbe essere disponibile a partire dalla data e dall'orario specificati sul promemoria di ritiro del referto o sul ticket di acc..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione ruota attorno alla richiesta di informazioni sul referto di una radiografia effettuata dall'utente. L'assistente fornisce istruzio"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:45.753582
====================================================================================================
📋 Session ID: classify_1756762785
⏱️  Processing Time: 2.964s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (579 chars):
   [UTENTE] Buon Giorno Giulia ho effettuato una radiografia in data 1/8 ed il referto doveva essere disponibile il 4/8 ma non è ancora presente [ASSISTENTE] Il referto dovrebbe essere disponibile a p...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione ruota attorno alla richiesta di informazioni sul referto di una radiografia effettuata dall'utente. L'assistente fornisce istruzio"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione ruota attorno alla richiesta di informazioni sul referto di una radiografia effettuata dall'utente. L'assistente fornisce istruzio
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione ruota attorno alla richiesta di informazioni sul referto di una radiografia effettuata dall'utente. L'assistente fornisce istruzio
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 5aa576fac40c7144910aaf7f408de055 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
   📈 Progresso LLM: 155/155
🔄 Fase 4: Analisi consenso e propagazione etichette...
   ✅ Cluster 0: 'altro' (38 sessioni, 4 reps, conf: 0.825, consenso: 1.00)
   ✅ Cluster 1: 'altro' (46 sessioni, 4 reps, conf: 0.300, consenso: 0.75)
   ✅ Cluster 2: 'Prenotazione' (19 sessioni, 4 reps, conf: 0.760, consenso: 0.50)
   ✅ Cluster 3: 'altro' (98 sessioni, 5 reps, conf: 0.300, consenso: 0.80)
   ✅ Cluster 4: 'Analisi' (97 sessioni, 5 reps, conf: 0.717, consenso: 0.60)
   ✅ Cluster 5: 'altro' (202 sessioni, 5 reps, conf: 0.300, consenso: 1.00)
   ✅ Cluster 6: 'altro' (302 sessioni, 5 reps, conf: 0.300, consenso: 0.80)
   ✅ Cluster 7: 'altro' (97 sessioni, 5 reps, conf: 0.300, consenso: 0.80)
   ✅ Cluster 8: 'altro' (152 sessioni, 5 reps, conf: 0.300, consenso: 0.60)
   ✅ Cluster 9: 'Servizi aziendali' (35 sessioni, 4 reps, conf: 0.760, consenso: 0.50)
   ✅ Cluster 10: 'altro' (52 sessioni, 5 reps, conf: 0.300, consenso: 0.60)
   ✅ Cluster 11: 'altro' (313 sessioni, 5 reps, conf: 0.300, consenso: 0.80)
   ✅ Cluster 12: 'Servizi aziendali' (34 sessioni, 4 reps, conf: 0.760, consenso: 0.50)
   ✅ Cluster 13: 'altro' (47 sessioni, 4 reps, conf: 0.300, consenso: 1.00)
   ✅ Cluster 14: 'altro' (17 sessioni, 4 reps, conf: 0.338, consenso: 0.75)
   ✅ Cluster 15: 'altro' (30 sessioni, 4 reps, conf: 0.300, consenso: 0.75)
   ✅ Cluster 16: 'altro' (24 sessioni, 4 reps, conf: 0.325, consenso: 1.00)
   ✅ Cluster 17: 'altro' (42 sessioni, 4 reps, conf: 0.300, consenso: 0.75)
   ✅ Cluster 18: 'altro' (241 sessioni, 5 reps, conf: 0.340, consenso: 1.00)
   ✅ Cluster 19: 'altro' (46 sessioni, 4 reps, conf: 0.300, consenso: 0.75)
   ✅ Cluster 20: 'Analisi' (19 sessioni, 4 reps, conf: 0.680, consenso: 0.50)
   ✅ Cluster 21: 'Analisi' (26 sessioni, 4 reps, conf: 0.760, consenso: 0.50)
   ✅ Cluster 22: 'altro' (74 sessioni, 5 reps, conf: 0.300, consenso: 0.60)
   ✅ Cluster 23: 'Servizi aziendali' (29 sessioni, 4 reps, conf: 0.760, consenso: 0.50)
   ✅ Cluster 24: 'Visita Specialistica' (50 sessioni, 4 reps, conf: 0.760, consenso: 0.50)
   ✅ Cluster 25: 'Prenotazione' (32 sessioni, 4 reps, conf: 0.760, consenso: 0.50)
   ✅ Cluster 26: 'Servizi aziendali' (51 sessioni, 5 reps, conf: 0.760, consenso: 0.40)
   ✅ Cluster 27: 'Prenotazione' (36 sessioni, 4 reps, conf: 0.760, consenso: 0.50)
   ✅ Cluster 28: 'Servizi aziendali' (200 sessioni, 5 reps, conf: 0.640, consenso: 0.40)
   ✅ Cluster 29: 'altro' (91 sessioni, 5 reps, conf: 0.300, consenso: 0.80)
   ✅ Cluster 30: 'Prenotazione' (164 sessioni, 5 reps, conf: 0.760, consenso: 0.40)
   ✅ Cluster 31: 'altro' (81 sessioni, 5 reps, conf: 0.300, consenso: 0.60)
   ✅ Cluster 32: 'Humanitas con te - Registrazione' (36 sessioni, 4 reps, conf: 0.760, consenso: 0.50)
   ✅ Cluster 33: 'Humanitas con te - Registrazione' (42 sessioni, 4 reps, conf: 0.720, consenso: 0.50)
   ✅ Cluster 34: 'altro' (22 sessioni, 4 reps, conf: 0.300, consenso: 0.75)
🔍 Fase 5: Analisi individuale di 624 outliers...
🤖 Analisi LLM di 624 conversazioni...
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 344
   📊 Token totali: 792
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 792 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 344
   📊 Token conversazione finale: 344
   📊 Token totali: 792
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1133 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho bisogno degli esITI di esami ESEGUITi IN fase di prericovero come ottenerli ? [ASSISTENTE] Per ottenere i risultati degli esami eseguiti in fase di prericovero, puoi accedere alla pagina [Referti e Cartelle Cliniche - Humanitas](https://www.humanitas.it/info/referti-cartelle-cliniche/..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 344
   📊 Token totali stimati: 792
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho bisogno degli esITI di esami ESEGUITi IN fase di prericovero come ottenerli ? [ASSISTENTE] Per ottenere i risultati degli esami eseguiti in fase di prericovero, puoi accedere alla pagina [Referti e Cartelle Cliniche - Humanitas](https://www.humanitas.it/info/referti-cartelle-cliniche/..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'ottenimento dei risultati degli esami eseguiti in fase di prericovero, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:47.772893
====================================================================================================
📋 Session ID: classify_1756762787
⏱️  Processing Time: 1.918s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1133 chars):
   [UTENTE] ho bisogno degli esITI di esami ESEGUITi IN fase di prericovero come ottenerli ? [ASSISTENTE] Per ottenere i risultati degli esami eseguiti in fase di prericovero, puoi accedere alla pagin...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (251 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'ottenimento dei risultati degli esami eseguiti in fase di prericovero, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'ottenimento dei risultati degli esami eseguiti in fase di prericovero, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ottenimento dei risultati degli esami eseguiti in fase di prericovero, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 37fbb553dbc13049ebd4c4aa5aff320f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 145
   📊 Token totali: 594
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 594 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 145
   📊 Token conversazione finale: 145
   📊 Token totali: 594
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 517 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Voglio cancella l account  [ASSISTENTE] Per cancellare il tuo account e richiedere la rimozione dei tuoi dati personali, puoi utilizzare il modulo dedicato disponibile alla pagina [Form per l’esercizio dei diritti in materia di protezione dei dati personali - Humanitas](https://www.human..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 145
   📊 Token totali stimati: 594
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Voglio cancella l account  [ASSISTENTE] Per cancellare il tuo account e richiedere la rimozione dei tuoi dati personali, puoi utilizzare il modulo dedicato disponibile alla pagina [Form per l’esercizio dei diritti in materia di protezione dei dati personali - Humanitas](https://www.human..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.8, 'motivation': "La conversazione riguarda la cancellazione dell'account e la richiesta di rimozione dei dati personali, che sono entrambi servizi offerti dall'azienda.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:49.513837
====================================================================================================
📋 Session ID: classify_1756762789
⏱️  Processing Time: 1.655s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (517 chars):
   [UTENTE] Voglio cancella l account  [ASSISTENTE] Per cancellare il tuo account e richiedere la rimozione dei tuoi dati personali, puoi utilizzare il modulo dedicato disponibile alla pagina [Form pe...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (228 chars):
   {'confidence': 0.8, 'motivation': "La conversazione riguarda la cancellazione dell'account e la richiesta di rimozione dei dati personali, che sono entrambi servizi offerti dall'azienda.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.8
   motivation: La conversazione riguarda la cancellazione dell'account e la richiesta di rimozione dei dati personali, che sono entrambi servizi offerti dall'azienda.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.800
   [████████████████░░░░] 80.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda la cancellazione dell'account e la richiesta di rimozione dei dati personali, che sono entrambi servizi offerti dall'azienda.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 00289078e4bdce068dd3599fc7a66e08 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 374
   📊 Token totali: 823
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 823 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 374
   📊 Token conversazione finale: 374
   📊 Token totali: 823
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1237 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao [ASSISTENTE] Ciao! Come posso esserti utile? 😊 [UTENTE] Ho prenotato una visita dermatologica presso Medical care di Lainate con forma indiretta Metasalute, che documenti devo presentare? [ASSISTENTE] Per la visita dermatologica presso Humanitas Medical Care di Lainate con forma ind..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 374
   📊 Token totali stimati: 823
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao [ASSISTENTE] Ciao! Come posso esserti utile? 😊 [UTENTE] Ho prenotato una visita dermatologica presso Medical care di Lainate con forma indiretta Metasalute, che documenti devo presentare? [ASSISTENTE] Per la visita dermatologica presso Humanitas Medical Care di Lainate con forma ind..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:50.449233
====================================================================================================
📋 Session ID: classify_1756762790
⏱️  Processing Time: 0.849s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1237 chars):
   [UTENTE] Ciao [ASSISTENTE] Ciao! Come posso esserti utile? 😊 [UTENTE] Ho prenotato una visita dermatologica presso Medical care di Lainate con forma indiretta Metasalute, che documenti devo present...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (184 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 9dbdae042767b6e0fc6fc01eb56e92c7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 221
   📊 Token totali: 649
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 649 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 221
   📊 Token conversazione finale: 221
   📊 Token totali: 649
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 710 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] la risonanza magnetica di rozzano è una rispnanza aperta? [ASSISTENTE] Sì, presso Humanitas Rozzano è disponibile una risonanza magnetica aperta, particolarmente indicata per pazienti claustrofobici, bambini, anziani e persone in sovrappeso. Questo tipo di apparecchiatura offre maggiore ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 221
   📊 Token totali stimati: 649
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] la risonanza magnetica di rozzano è una rispnanza aperta? [ASSISTENTE] Sì, presso Humanitas Rozzano è disponibile una risonanza magnetica aperta, particolarmente indicata per pazienti claustrofobici, bambini, anziani e persone in sovrappeso. Questo tipo di apparecchiatura offre maggiore ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.1, 'motivation': "Errore API: Function call incompleta: mancano campi richiesti ['confidence', 'motivation'] in {'predicted_label'"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:51.391757
====================================================================================================
📋 Session ID: classify_1756762791
⏱️  Processing Time: 0.850s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (710 chars):
   [UTENTE] la risonanza magnetica di rozzano è una rispnanza aperta? [ASSISTENTE] Sì, presso Humanitas Rozzano è disponibile una risonanza magnetica aperta, particolarmente indicata per pazienti clau...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (177 chars):
   {'predicted_label': 'altro', 'confidence': 0.1, 'motivation': "Errore API: Function call incompleta: mancano campi richiesti ['confidence', 'motivation'] in {'predicted_label'"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.1
   motivation: Errore API: Function call incompleta: mancano campi richiesti ['confidence', 'motivation'] in {'predicted_label'
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.100
   [██░░░░░░░░░░░░░░░░░░] 10.0%

🧠 Reasoning/Motivation:
   Errore API: Function call incompleta: mancano campi richiesti ['confidence', 'motivation'] in {'predicted_label'
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 36f3cfe68a0138ca77646420f4466bb0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 346
   📊 Token totali: 794
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 794 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 346
   📊 Token conversazione finale: 346
   📊 Token totali: 794
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1130 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] help [ASSISTENTE] Posso aiutarti con informazioni relative all’Istituto Clinico Humanitas, come:

- Prenotazioni di visite ed esami;
- Norme di preparazione per esami;
- Indicazioni stradali per raggiungere le sedi Humanitas;
- Informazioni su referti, cartelle cliniche e ricoveri;
- Det..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 346
   📊 Token totali stimati: 794
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] help [ASSISTENTE] Posso aiutarti con informazioni relative all’Istituto Clinico Humanitas, come:

- Prenotazioni di visite ed esami;
- Norme di preparazione per esami;
- Indicazioni stradali per raggiungere le sedi Humanitas;
- Informazioni su referti, cartelle cliniche e ricoveri;
- Det..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai servizi online dell'ospedale Humanitas, che rientra nella categoria dei Servizi aziendali.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:53.231046
====================================================================================================
📋 Session ID: classify_1756762793
⏱️  Processing Time: 1.754s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1130 chars):
   [UTENTE] help [ASSISTENTE] Posso aiutarti con informazioni relative all’Istituto Clinico Humanitas, come:

- Prenotazioni di visite ed esami;
- Norme di preparazione per esami;
- Indicazioni strada...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [79 more lines] ...
     Line 83: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (207 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai servizi online dell'ospedale Humanitas, che rientra nella categoria dei Servizi aziendali.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'accesso ai servizi online dell'ospedale Humanitas, che rientra nella categoria dei Servizi aziendali.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso ai servizi online dell'ospedale Humanitas, che rientra nella categoria dei Servizi aziendali.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a77dafafd9ff2a36a6c0ba434c60a6bc classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 145
   📊 Token totali: 593
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 593 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 145
   📊 Token conversazione finale: 145
   📊 Token totali: 593
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 452 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno volevo sapere se facevate amniocentesi in regime privato? [ASSISTENTE] Sì, Humanitas offre l'amniocentesi in regime privato. [...]  Se hai bisogno di ulteriori dettagli, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2880 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 145
   📊 Token totali stimati: 593
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno volevo sapere se facevate amniocentesi in regime privato? [ASSISTENTE] Sì, Humanitas offre l'amniocentesi in regime privato. [...]  Se hai bisogno di ulteriori dettagli, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Analisi",\n  "confidence": 0.95,\n  "motiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:54.710645
====================================================================================================
📋 Session ID: classify_1756762794
⏱️  Processing Time: 1.391s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (452 chars):
   [UTENTE] Buongiorno volevo sapere se facevate amniocentesi in regime privato? [ASSISTENTE] Sì, Humanitas offre l'amniocentesi in regime privato. Per maggiori informazioni, puoi consultare le norme ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (197 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Analisi",\n  "confidence": 0.95,\n  "motiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Analisi",
  "confidence": 0.95,
  "motiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Analisi",
  "confidence": 0.95,
  "motiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 88552c59f7184164210f42063bff4aad classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 83
   📊 Token totali: 511
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 511 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 83
   📊 Token conversazione finale: 83
   📊 Token totali: 511
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 275 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Il pronto soccorso Humanitas, una volta aperta la pratica di infortuni  [ASSISTENTE] Puoi spiegarmi meglio cosa intendi? Ti riferisci a come funziona l'apertura di una pratica di infortunio al Pronto Soccorso Humanitas o hai bisogno di altre informazioni specifiche?"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2871 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 83
   📊 Token totali stimati: 511
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Il pronto soccorso Humanitas, una volta aperta la pratica di infortuni  [ASSISTENTE] Puoi spiegarmi meglio cosa intendi? Ti riferisci a come funziona l'apertura di una pratica di infortunio al Pronto Soccorso Humanitas o hai bisogno di altre informazioni specifiche?"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sull'apertura di una pratica di infortunio al Pronto Soccorso Humanitas.", 'predicted_label': 'Pronto Soccorso'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:56.245287
====================================================================================================
📋 Session ID: classify_1756762796
⏱️  Processing Time: 1.448s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (275 chars):
   [UTENTE] Il pronto soccorso Humanitas, una volta aperta la pratica di infortuni  [ASSISTENTE] Puoi spiegarmi meglio cosa intendi? Ti riferisci a come funziona l'apertura di una pratica di infortuni...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (170 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sull'apertura di una pratica di infortunio al Pronto Soccorso Humanitas.", 'predicted_label': 'Pronto Soccorso'}

📊 Parsed Response:
   predicted_label: Pronto Soccorso
   confidence: 0.9
   motivation: La conversazione verte sull'apertura di una pratica di infortunio al Pronto Soccorso Humanitas.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'apertura di una pratica di infortunio al Pronto Soccorso Humanitas.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 6965077a8a2cd31ee1d3fcb383ab9eb8 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Pronto Soccorso' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 243
   📊 Token totali: 691
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 691 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 243
   📊 Token conversazione finale: 243
   📊 Token totali: 691
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 850 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao, quanto è possibile fare ritardo all appuntamento al fertility ? [ASSISTENTE] Non ho informazioni specifiche sui tempi di tolleranza per il ritardo agli appuntamenti presso il Fertility Center. Ti consiglio di contattare direttamente il Fertility Center per ottenere indicazioni prec..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 243
   📊 Token totali stimati: 691
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao, quanto è possibile fare ritardo all appuntamento al fertility ? [ASSISTENTE] Non ho informazioni specifiche sui tempi di tolleranza per il ritardo agli appuntamenti presso il Fertility Center. Ti consiglio di contattare direttamente il Fertility Center per ottenere indicazioni prec..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sull'appuntamento al Fertility Center e sul numero di telefono dello stesso.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:57.742816
====================================================================================================
📋 Session ID: classify_1756762797
⏱️  Processing Time: 1.410s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (850 chars):
   [UTENTE] Ciao, quanto è possibile fare ritardo all appuntamento al fertility ? [ASSISTENTE] Non ho informazioni specifiche sui tempi di tolleranza per il ritardo agli appuntamenti presso il Fertili...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (171 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sull'appuntamento al Fertility Center e sul numero di telefono dello stesso.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.9
   motivation: La conversazione verte sull'appuntamento al Fertility Center e sul numero di telefono dello stesso.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'appuntamento al Fertility Center e sul numero di telefono dello stesso.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 507e9cdd46325b5717abbda777233294 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 230
   📊 Token totali: 679
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 679 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 230
   📊 Token conversazione finale: 230
   📊 Token totali: 679
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 768 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho bisogno del numero di ricovero del paziente Di Giulio Felice Antonio che dovrà subire un intervento all anca il 10 /09/2025 questo numero serve per la scontista per il treno come si fa? [ASSISTENTE] Non ho accesso a informazioni personali o specifiche sui pazienti. Ti consiglio di con..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 230
   📊 Token totali stimati: 679
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho bisogno del numero di ricovero del paziente Di Giulio Felice Antonio che dovrà subire un intervento all anca il 10 /09/2025 questo numero serve per la scontista per il treno come si fa? [ASSISTENTE] Non ho accesso a informazioni personali o specifiche sui pazienti. Ti consiglio di con..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte sull'ottenere il numero di ricovero per un paziente e informazioni su come ottenere sconti per i viaggi in treno, quindi è classificata come 'Servizi aziendali'.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:39:59.750275
====================================================================================================
📋 Session ID: classify_1756762799
⏱️  Processing Time: 1.920s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (768 chars):
   [UTENTE] Ho bisogno del numero di ricovero del paziente Di Giulio Felice Antonio che dovrà subire un intervento all anca il 10 /09/2025 questo numero serve per la scontista per il treno come si fa?...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (262 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte sull'ottenere il numero di ricovero per un paziente e informazioni su come ottenere sconti per i viaggi in treno, quindi è classificata come 'Servizi aziendali'.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.75
   motivation: La conversazione verte sull'ottenere il numero di ricovero per un paziente e informazioni su come ottenere sconti per i viaggi in treno, quindi è classificata come 'Servizi aziendali'.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ottenere il numero di ricovero per un paziente e informazioni su come ottenere sconti per i viaggi in treno, quindi è classificata come 'Servizi aziendali'.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 6874e36c5623db4008047427f8fe6f5b classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 756
   📊 Token totali: 1184
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1184 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 756
   📊 Token conversazione finale: 756
   📊 Token totali: 1184
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 3282 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Parli inglese? [ASSISTENTE] Yes, I can assist you in English. [...] 

If you do not receive a response from the email you used, I suggest resending your inquiry to one of the official addresses mentioned above"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2814 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 756
   📊 Token totali stimati: 1184
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Parli inglese? [ASSISTENTE] Yes, I can assist you in English. [...] 

If you do not receive a response from the email you used, I suggest resending your inquiry to one of the official addresses mentioned above"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: #### Classificazione conversazione\n\nEcco la classificazione della conversazione:\n\n- predicted_label:'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:02.180556
====================================================================================================
📋 Session ID: classify_1756762802
⏱️  Processing Time: 2.343s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (3282 chars):
   [UTENTE] Parli inglese? [ASSISTENTE] Yes, I can assist you in English. How can I help you today? [UTENTE] My father's case was transferred to Humanitas from the doctors at ICS Maugeri Pavia last mo...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: #### Classificazione conversazione\n\nEcco la classificazione della conversazione:\n\n- predicted_label:'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: #### Classificazione conversazione

Ecco la classificazione della conversazione:

- predicted_label:
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: #### Classificazione conversazione

Ecco la classificazione della conversazione:

- predicted_label:
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 0f1ff5d443c11cd5a3eb63a9d70e82d9 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 113
   📊 Token totali: 561
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 561 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 113
   📊 Token conversazione finale: 113
   📊 Token totali: 561
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 375 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno solo una paziente del professor Aloisio Potrei sapere se è rientrato dalle ferie [ASSISTENTE] Per informazioni specifiche sul rientro del Professore Aloisio, ti consiglio di contattare direttamente il centralino di Humanitas al numero 02 822 41. [...] it/medici/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2951 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 113
   📊 Token totali stimati: 561
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno solo una paziente del professor Aloisio Potrei sapere se è rientrato dalle ferie [ASSISTENTE] Per informazioni specifiche sul rientro del Professore Aloisio, ti consiglio di contattare direttamente il centralino di Humanitas al numero 02 822 41. [...] it/medici/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Visita Specialistica",\n    "confidence"'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:03.523459
====================================================================================================
📋 Session ID: classify_1756762803
⏱️  Processing Time: 1.257s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (375 chars):
   [UTENTE] Buongiorno solo una paziente del professor Aloisio Potrei sapere se è rientrato dalle ferie [ASSISTENTE] Per informazioni specifiche sul rientro del Professore Aloisio, ti consiglio di con...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Visita Specialistica",\n    "confidence"'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Visita Specialistica",
    "confidence"
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Visita Specialistica",
    "confidence"
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 31c829f2129edaf3e819bae78f46f8d0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 380
   📊 Token totali: 808
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 808 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 380
   📊 Token conversazione finale: 380
   📊 Token totali: 808
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 976 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Elenco strutture convenzionate per dormire [ASSISTENTE] Ecco un elenco di strutture convenzionate per il soggiorno vicino all'ospedale Humanitas:

1. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2766 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 380
   📊 Token totali stimati: 808
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Elenco strutture convenzionate per dormire [ASSISTENTE] Ecco un elenco di strutture convenzionate per il soggiorno vicino all'ospedale Humanitas:

1. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': "Risposta non strutturata: **predicted_label:** alloggio\n\n**confidence:** 1.0\n\n**motivation:** La conversazione verte sull'elen"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:05.163424
====================================================================================================
📋 Session ID: classify_1756762805
⏱️  Processing Time: 1.552s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (976 chars):
   [UTENTE] Elenco strutture convenzionate per dormire [ASSISTENTE] Ecco un elenco di strutture convenzionate per il soggiorno vicino all'ospedale Humanitas:

1. **Hotel Ely’s Group** - Via Liguria, 5...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': "Risposta non strutturata: **predicted_label:** alloggio\n\n**confidence:** 1.0\n\n**motivation:** La conversazione verte sull'elen"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **predicted_label:** alloggio

**confidence:** 1.0

**motivation:** La conversazione verte sull'elen
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **predicted_label:** alloggio

**confidence:** 1.0

**motivation:** La conversazione verte sull'elen
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 44b7662fc2e623e97e37085126a0b7c1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 348
   📊 Token totali: 796
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 796 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 348
   📊 Token conversazione finale: 348
   📊 Token totali: 796
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1176 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] indirizzo email  [ASSISTENTE] Potresti specificare per quale reparto, servizio o area desideri l'indirizzo email? Così posso aiutarti meglio! [UTENTE] servizio clienti [ASSISTENTE] Per contattare il servizio clienti di Humanitas, puoi utilizzare i seguenti canali:

- **Email**: humanitas..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 348
   📊 Token totali stimati: 796
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] indirizzo email  [ASSISTENTE] Potresti specificare per quale reparto, servizio o area desideri l'indirizzo email? Così posso aiutarti meglio! [UTENTE] servizio clienti [ASSISTENTE] Per contattare il servizio clienti di Humanitas, puoi utilizzare i seguenti canali:

- **Email**: humanitas..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Servizi aziendali",\n    "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:06.957448
====================================================================================================
📋 Session ID: classify_1756762806
⏱️  Processing Time: 1.707s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1176 chars):
   [UTENTE] indirizzo email  [ASSISTENTE] Potresti specificare per quale reparto, servizio o area desideri l'indirizzo email? Così posso aiutarti meglio! [UTENTE] servizio clienti [ASSISTENTE] Per con...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Servizi aziendali",\n    "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Servizi aziendali",
    "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Servizi aziendali",
    "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b83b9b668ebb67685ed24b65343c072f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 234
   📊 Token totali: 662
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 662 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 234
   📊 Token conversazione finale: 234
   📊 Token totali: 662
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 778 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Come richiedere il dischetto della Tac eseguita in pronto soccorso? [ASSISTENTE] Non ho trovato informazioni specifiche su come richiedere il dischetto della TAC eseguita in pronto soccorso. [...]  Da lì, potranno indirizzarti al reparto o servizio specifico di cui hai bisogno"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2882 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 234
   📊 Token totali stimati: 662
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Come richiedere il dischetto della Tac eseguita in pronto soccorso? [ASSISTENTE] Non ho trovato informazioni specifiche su come richiedere il dischetto della TAC eseguita in pronto soccorso. [...]  Da lì, potranno indirizzarti al reparto o servizio specifico di cui hai bisogno"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'ottenimento del dischetto della TAC eseguita in pronto soccorso, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:08.883614
====================================================================================================
📋 Session ID: classify_1756762808
⏱️  Processing Time: 1.839s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (778 chars):
   [UTENTE] Come richiedere il dischetto della Tac eseguita in pronto soccorso? [ASSISTENTE] Non ho trovato informazioni specifiche su come richiedere il dischetto della TAC eseguita in pronto soccors...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (245 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'ottenimento del dischetto della TAC eseguita in pronto soccorso, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'ottenimento del dischetto della TAC eseguita in pronto soccorso, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ottenimento del dischetto della TAC eseguita in pronto soccorso, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a1e94fa1d719e80114827287bd4c1d14 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 598
   📊 Token totali: 1052
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1052 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 598
   📊 Token conversazione finale: 598
   📊 Token totali: 1052
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2158 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] non scarico l'allegato della mail inviatami per [ASSISTENTE] Potresti fornirmi maggiori dettagli? Ad esempio, l'allegato riguarda un referto, una cartella clinica o altro? Inoltre, hai riscontrato un errore specifico durante il download? Sono qui per aiutarti! [UTENTE] non ho il programm..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2999 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 598
   📊 Token totali stimati: 1052
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] non scarico l'allegato della mail inviatami per [ASSISTENTE] Potresti fornirmi maggiori dettagli? Ad esempio, l'allegato riguarda un referto, una cartella clinica o altro? Inoltre, hai riscontrato un errore specifico durante il download? Sono qui per aiutarti! [UTENTE] non ho il programm..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai referti e alle cartelle cliniche tramite mail o portale online.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:10.739491
====================================================================================================
📋 Session ID: classify_1756762810
⏱️  Processing Time: 1.767s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2158 chars):
   [UTENTE] non scarico l'allegato della mail inviatami per [ASSISTENTE] Potresti fornirmi maggiori dettagli? Ad esempio, l'allegato riguarda un referto, una cartella clinica o altro? Inoltre, hai ris...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (190 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai referti e alle cartelle cliniche tramite mail o portale online.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'accesso ai referti e alle cartelle cliniche tramite mail o portale online.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso ai referti e alle cartelle cliniche tramite mail o portale online.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b3b7c636e6013b2c3b136f47c688acab classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 396
   📊 Token totali: 824
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 824 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 396
   📊 Token conversazione finale: 396
   📊 Token totali: 824
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1212 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] PMA quali prestazioni? [ASSISTENTE] Le prestazioni di Procreazione Medicalmente Assistita (PMA) offerte presso Humanitas includono:

1. [...] it/centri/fertility-center)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2774 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 396
   📊 Token totali stimati: 824
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] PMA quali prestazioni? [ASSISTENTE] Le prestazioni di Procreazione Medicalmente Assistita (PMA) offerte presso Humanitas includono:

1. [...] it/centri/fertility-center)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **predicted_label**: "Analisi"\n**confidence**: 0.9\n**motivation**: La conversazione verte sulle dive'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:12.124068
====================================================================================================
📋 Session ID: classify_1756762812
⏱️  Processing Time: 1.297s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1212 chars):
   [UTENTE] PMA quali prestazioni? [ASSISTENTE] Le prestazioni di Procreazione Medicalmente Assistita (PMA) offerte presso Humanitas includono:

1. **Tecniche di primo livello**: Inseminazione intraut...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (193 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **predicted_label**: "Analisi"\n**confidence**: 0.9\n**motivation**: La conversazione verte sulle dive'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **predicted_label**: "Analisi"
**confidence**: 0.9
**motivation**: La conversazione verte sulle dive
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **predicted_label**: "Analisi"
**confidence**: 0.9
**motivation**: La conversazione verte sulle dive
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 1da2c05234a56858c6581d50c6fd7d99 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 205
   📊 Token totali: 633
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 633 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 205
   📊 Token conversazione finale: 205
   📊 Token totali: 633
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 716 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, ho eseguito un prelievo il 21 luglio 2025 per due diversi esami. [...] it/Help)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2696 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 205
   📊 Token totali stimati: 633
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, ho eseguito un prelievo il 21 luglio 2025 per due diversi esami. [...] it/Help)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:13.945138
====================================================================================================
📋 Session ID: classify_1756762813
⏱️  Processing Time: 1.734s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (716 chars):
   [UTENTE] Buongiorno, ho eseguito un prelievo il 21 luglio 2025 per due diversi esami. Al momento vedo il referto legato ad un solo esame nella mia pagina. E' corretto che arrivino separati? [ASSIST...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione eeb359950d6a65c1fac342f0fa36ce86 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 130
   📊 Token totali: 579
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 579 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 130
   📊 Token conversazione finale: 130
   📊 Token totali: 579
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 473 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] voglio un contatto telefonico per assistenza on line al portale Humanitas. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2822 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 130
   📊 Token totali stimati: 579
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] voglio un contatto telefonico per assistenza on line al portale Humanitas. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:15.723009
====================================================================================================
📋 Session ID: classify_1756762815
⏱️  Processing Time: 1.690s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (473 chars):
   [UTENTE] voglio un contatto telefonico per assistenza on line al portale Humanitas. [ASSISTENTE] Non esiste un canale telefonico di assistenza dedicato al portale [Humanitas con te](https://www.hum...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d82c4b0147855fcba637b44e188a71f2 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Utente confuso - semplifica classificazione verso problemi tecnici

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 452
   💬 Token conversazione: 333
   📊 Token totali: 785
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 785 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 452
   📊 Token conversazione originale: 333
   📊 Token conversazione finale: 333
   📊 Token totali: 785
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1088 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mi serve un oculista che cura la preferite da problemi di Kendall samobor [ASSISTENTE] Non ho trovato informazioni specifiche su "Kendall Samobor" o su una condizione correlata. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2943 characters
🔢 Token Analysis:
   📊 Token prompt base: 452
   📊 Token conversazione: 333
   📊 Token totali stimati: 785
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Utente confuso - semplifica classificazione verso problemi tecnici

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Mi serve un oculista che cura la preferite da problemi di Kendall samobor [ASSISTENTE] Non ho trovato informazioni specifiche su "Kendall Samobor" o su una condizione correlata. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Prenotazione",\n    "confidence": 0.7,\n '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:17.686145
====================================================================================================
📋 Session ID: classify_1756762817
⏱️  Processing Time: 1.875s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1088 chars):
   [UTENTE] Mi serve un oculista che cura la preferite da problemi di Kendall samobor [ASSISTENTE] Non ho trovato informazioni specifiche su "Kendall Samobor" o su una condizione correlata. Potresti v...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (197 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Prenotazione",\n    "confidence": 0.7,\n '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Prenotazione",
    "confidence": 0.7,
 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Prenotazione",
    "confidence": 0.7,
 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a3c639261fc1aca4f530b1d4d1fab396 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 832
   📊 Token totali: 1280
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1280 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 832
   📊 Token conversazione finale: 832
   📊 Token totali: 1280
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2799 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Cosa siete [ASSISTENTE] Humanitas è un gruppo di ospedali e centri medici che offre servizi sanitari di alta qualità. [...] it) e, in caso di selezione, potrai discutere i dettagli contrattuali direttamente con il team delle risorse umane"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2915 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 832
   📊 Token totali stimati: 1280
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Cosa siete [ASSISTENTE] Humanitas è un gruppo di ospedali e centri medici che offre servizi sanitari di alta qualità. [...] it) e, in caso di selezione, potrai discutere i dettagli contrattuali direttamente con il team delle risorse umane"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted_label**: "altro"\n**Confidence**: 0.7\n**Motivation**: La conversazione verte principalmen'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:20.009450
====================================================================================================
📋 Session ID: classify_1756762820
⏱️  Processing Time: 2.236s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2799 chars):
   [UTENTE] Cosa siete [ASSISTENTE] Humanitas è un gruppo di ospedali e centri medici che offre servizi sanitari di alta qualità. Comprende diverse strutture in Italia, tra cui ospedali, centri di ric...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (193 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted_label**: "altro"\n**Confidence**: 0.7\n**Motivation**: La conversazione verte principalmen'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted_label**: "altro"
**Confidence**: 0.7
**Motivation**: La conversazione verte principalmen
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted_label**: "altro"
**Confidence**: 0.7
**Motivation**: La conversazione verte principalmen
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b5884ab5b238a98ad2d6849b9f1fcc31 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 155
   📊 Token totali: 583
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 583 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 155
   📊 Token conversazione finale: 155
   📊 Token totali: 583
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 540 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Indirizzo e-mail webmaster sito web www. [...] it/info/ufficio-relazioni-pubblico)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2687 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 155
   📊 Token totali stimati: 583
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Indirizzo e-mail webmaster sito web www. [...] it/info/ufficio-relazioni-pubblico)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:21.719846
====================================================================================================
📋 Session ID: classify_1756762821
⏱️  Processing Time: 1.625s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (540 chars):
   [UTENTE] Indirizzo e-mail webmaster sito web www.humanitas.it [ASSISTENTE] Non ho trovato informazioni specifiche sull'indirizzo email del webmaster del sito www.humanitas.it nei documenti forniti....

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 73a87238529661eeedbbee5add3e903b classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 563
   📊 Token totali: 1011
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1011 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 563
   📊 Token conversazione finale: 563
   📊 Token totali: 1011
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1943 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] come richiedo una copia di una cartella clinica di un intervento chirurgico del 2015? [ASSISTENTE] Per richiedere una copia della cartella clinica di un intervento chirurgico del 2015, è necessario sapere che:

1. [...]  Se hai bisogno di ulteriore supporto, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2949 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 563
   📊 Token totali stimati: 1011
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] come richiedo una copia di una cartella clinica di un intervento chirurgico del 2015? [ASSISTENTE] Per richiedere una copia della cartella clinica di un intervento chirurgico del 2015, è necessario sapere che:

1. [...]  Se hai bisogno di ulteriore supporto, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'Referti e Cartelle Cliniche', 'confidence': 0.95, 'motivation': "La conversazione verte sulla richiesta di una copia cartacea della cartella clinica di un intervento chirurgico del 2015, quindi la categoria più adatta è 'Referti e Cartelle Cliniche'."}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:23.919195
====================================================================================================
📋 Session ID: classify_1756762823
⏱️  Processing Time: 2.111s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1943 chars):
   [UTENTE] come richiedo una copia di una cartella clinica di un intervento chirurgico del 2015? [ASSISTENTE] Per richiedere una copia della cartella clinica di un intervento chirurgico del 2015, è n...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (273 chars):
   {'predicted_label': 'Referti e Cartelle Cliniche', 'confidence': 0.95, 'motivation': "La conversazione verte sulla richiesta di una copia cartacea della cartella clinica di un intervento chirurgico del 2015, quindi la categoria più adatta è 'Referti e Cartelle Cliniche'."}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sulla richiesta di una copia cartacea della cartella clinica di un intervento chirurgico del 2015, quindi la categoria più adatta è 'Referti e Cartelle Cliniche'.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla richiesta di una copia cartacea della cartella clinica di un intervento chirurgico del 2015, quindi la categoria più adatta è 'Referti e Cartelle Cliniche'.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a5535b7deb627771503d036bb1d540aa classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 255
   📊 Token totali: 703
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 703 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 255
   📊 Token conversazione finale: 255
   📊 Token totali: 703
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 894 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia Volevo sapere se all' Humanitas di Rozzano fanno e il certificato di interruzione volontaria di gravidanza perché facendo il test è risultato che sono incinta però io voglio appunto a fare il trattamento farmacologico perché ho un lavoro a temp [ASSISTENTE] Per quanto riguard..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 255
   📊 Token totali stimati: 703
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia Volevo sapere se all' Humanitas di Rozzano fanno e il certificato di interruzione volontaria di gravidanza perché facendo il test è risultato che sono incinta però io voglio appunto a fare il trattamento farmacologico perché ho un lavoro a temp [ASSISTENTE] Per quanto riguard..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte sull'IVG e il trattamento farmacologico, quindi la categoria più adatta è Prenotazione.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:25.579946
====================================================================================================
📋 Session ID: classify_1756762825
⏱️  Processing Time: 1.573s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (894 chars):
   [UTENTE] Ciao Giulia Volevo sapere se all' Humanitas di Rozzano fanno e il certificato di interruzione volontaria di gravidanza perché facendo il test è risultato che sono incinta però io voglio ap...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (183 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte sull'IVG e il trattamento farmacologico, quindi la categoria più adatta è Prenotazione.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.75
   motivation: La conversazione verte sull'IVG e il trattamento farmacologico, quindi la categoria più adatta è Prenotazione.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'IVG e il trattamento farmacologico, quindi la categoria più adatta è Prenotazione.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 730228dd023230221504d33665ce42b9 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 271
   📊 Token totali: 719
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 719 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 271
   📊 Token conversazione finale: 271
   📊 Token totali: 719
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 924 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Annullare appuntamento  [ASSISTENTE] Per annullare un appuntamento presso Humanitas, ti consiglio di contattare direttamente il numero di prenotazione che hai utilizzato per fissare l'appuntamento. [...]  

Fammi sapere se hai bisogno di ulteriore supporto!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2934 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 271
   📊 Token totali stimati: 719
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Annullare appuntamento  [ASSISTENTE] Per annullare un appuntamento presso Humanitas, ti consiglio di contattare direttamente il numero di prenotazione che hai utilizzato per fissare l'appuntamento. [...]  

Fammi sapere se hai bisogno di ulteriore supporto!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'annullamento di un appuntamento, quindi la categoria 'Prenotazione' è appropriata.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:27.260908
====================================================================================================
📋 Session ID: classify_1756762827
⏱️  Processing Time: 1.595s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (924 chars):
   [UTENTE] Annullare appuntamento  [ASSISTENTE] Per annullare un appuntamento presso Humanitas, ti consiglio di contattare direttamente il numero di prenotazione che hai utilizzato per fissare l'appu...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (183 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'annullamento di un appuntamento, quindi la categoria 'Prenotazione' è appropriata.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte sull'annullamento di un appuntamento, quindi la categoria 'Prenotazione' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'annullamento di un appuntamento, quindi la categoria 'Prenotazione' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione ea231d43f2a8010e7409a09b59f63b39 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 769
   📊 Token totali: 1197
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1197 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 769
   📊 Token conversazione finale: 769
   📊 Token totali: 1197
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 3499 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dear 

I hope this message finds you well. [...]  [UTENTE] Then [ASSISTENTE] If you need further assistance or have additional questions, feel free to ask! I'm here to help"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2777 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 769
   📊 Token totali stimati: 1197
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dear 

I hope this message finds you well. [...]  [UTENTE] Then [ASSISTENTE] If you need further assistance or have additional questions, feel free to ask! I'm here to help"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': "Risposta non strutturata: #### Classificazione conversazione\n\nLa conversazione fornita verte principalmente sull'ottenere una "}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:30.697976
====================================================================================================
📋 Session ID: classify_1756762830
⏱️  Processing Time: 3.348s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (3499 chars):
   [UTENTE] Dear 

I hope this message finds you well.

My name is AKTER HOSEN APEL , and I am a resident of Bangladesh. I have been experiencing significant vision problems for some time and currentl...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (193 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': "Risposta non strutturata: #### Classificazione conversazione\n\nLa conversazione fornita verte principalmente sull'ottenere una "}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: #### Classificazione conversazione

La conversazione fornita verte principalmente sull'ottenere una 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: #### Classificazione conversazione

La conversazione fornita verte principalmente sull'ottenere una 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione c1a29f9587164b711318f67ef47950e8 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 159
   📊 Token totali: 607
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 607 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 159
   📊 Token conversazione finale: 159
   📊 Token totali: 607
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 520 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Chiedo contatto mail dottor Filippo confalonieri  [ASSISTENTE] Per informazioni sui medici, ti consiglio di consultare la pagina [Ricerca Medici](https://www. [...]  Il personale potrà indirizzarti verso il reparto o il medico richiesto"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2913 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 159
   📊 Token totali stimati: 607
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Chiedo contatto mail dottor Filippo confalonieri  [ASSISTENTE] Per informazioni sui medici, ti consiglio di consultare la pagina [Ricerca Medici](https://www. [...]  Il personale potrà indirizzarti verso il reparto o il medico richiesto"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'ottenere informazioni su un medico specifico e contattarlo, il che si riferisce ai servizi aziendali dell'ospedale.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:32.481378
====================================================================================================
📋 Session ID: classify_1756762832
⏱️  Processing Time: 1.695s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (520 chars):
   [UTENTE] Chiedo contatto mail dottor Filippo confalonieri  [ASSISTENTE] Per informazioni sui medici, ti consiglio di consultare la pagina [Ricerca Medici](https://www.humanitas.it/medici/). Se hai ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (221 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'ottenere informazioni su un medico specifico e contattarlo, il che si riferisce ai servizi aziendali dell'ospedale.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'ottenere informazioni su un medico specifico e contattarlo, il che si riferisce ai servizi aziendali dell'ospedale.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ottenere informazioni su un medico specifico e contattarlo, il che si riferisce ai servizi aziendali dell'ospedale.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3f66dc18aa04cd63737cc89cb85d9a36 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 447
   💬 Token conversazione: 547
   📊 Token totali: 994
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 994 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 447
   📊 Token conversazione originale: 547
   📊 Token conversazione finale: 547
   📊 Token totali: 994
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1842 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buon giorno. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2755 characters
🔢 Token Analysis:
   📊 Token prompt base: 447
   📊 Token conversazione: 547
   📊 Token totali stimati: 994
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buon giorno. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla richiesta del referto della TAC eseguita presso la struttura Humanitas e sul problema riscontrato dall'"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:35.732099
====================================================================================================
📋 Session ID: classify_1756762835
⏱️  Processing Time: 3.163s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1842 chars):
   [UTENTE] Buon giorno. Ho effettuato presso di voi privatamente una TAC il10.06.2025 e il referto avrebbe dovuto essermi inviato online il 17.06.2025. Ad oggi non ho ancora ricevuto nulla e domani h...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla richiesta del referto della TAC eseguita presso la struttura Humanitas e sul problema riscontrato dall'"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla richiesta del referto della TAC eseguita presso la struttura Humanitas e sul problema riscontrato dall'
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla richiesta del referto della TAC eseguita presso la struttura Humanitas e sul problema riscontrato dall'
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione caf451b22dfa03a2542a2a11f0901e8d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 173
   📊 Token totali: 621
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 621 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 173
   📊 Token conversazione finale: 173
   📊 Token totali: 621
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 572 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno , posso sapere costo TAC addome completo con mdc utilizzando polizza Unisalute indiretta? [ASSISTENTE] Per conoscere il costo di una TAC all'addome completo con mezzo di contrasto utilizzando una polizza Unisalute indiretta, ti consiglio di contattare direttamente il numero di..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 173
   📊 Token totali stimati: 621
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno , posso sapere costo TAC addome completo con mdc utilizzando polizza Unisalute indiretta? [ASSISTENTE] Per conoscere il costo di una TAC all'addome completo con mezzo di contrasto utilizzando una polizza Unisalute indiretta, ti consiglio di contattare direttamente il numero di..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Prenotazione","confidence":0.95,"m'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:38.118687
====================================================================================================
📋 Session ID: classify_1756762838
⏱️  Processing Time: 2.300s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (572 chars):
   [UTENTE] Buongiorno , posso sapere costo TAC addome completo con mdc utilizzando polizza Unisalute indiretta? [ASSISTENTE] Per conoscere il costo di una TAC all'addome completo con mezzo di contras...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Prenotazione","confidence":0.95,"m'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Prenotazione","confidence":0.95,"m
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Prenotazione","confidence":0.95,"m
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 98cafc62f85367df2291e3fc0ff1e1dc classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 177
   📊 Token totali: 625
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 625 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 177
   📊 Token conversazione finale: 177
   📊 Token totali: 625
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 593 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno avrei bisogno di sapere se nella Vs sede di Rozzano o di Castellanza effettuate qs esame [ASSISTENTE] Per verificare se l'esame richiesto è disponibile presso le sedi di Rozzano o Castellanza, ti consiglio di contattare direttamente le strutture. Puoi trovare informazioni sui ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 177
   📊 Token totali stimati: 625
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno avrei bisogno di sapere se nella Vs sede di Rozzano o di Castellanza effettuate qs esame [ASSISTENTE] Per verificare se l'esame richiesto è disponibile presso le sedi di Rozzano o Castellanza, ti consiglio di contattare direttamente le strutture. Puoi trovare informazioni sui ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:40.049019
====================================================================================================
📋 Session ID: classify_1756762840
⏱️  Processing Time: 1.843s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (593 chars):
   [UTENTE] Buongiorno avrei bisogno di sapere se nella Vs sede di Rozzano o di Castellanza effettuate qs esame [ASSISTENTE] Per verificare se l'esame richiesto è disponibile presso le sedi di Rozzano...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b909eba5f3bd2127adf542042a8ebe5c classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 132
   📊 Token totali: 560
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 560 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 132
   📊 Token conversazione finale: 132
   📊 Token totali: 560
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 388 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] a che ore è aperto urp? [ASSISTENTE] L'Ufficio Relazioni con il Pubblico (URP) di Humanitas è attivo dal lunedì al venerdì, dalle 9:00 alle 12:00. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2763 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 132
   📊 Token totali stimati: 560
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] a che ore è aperto urp? [ASSISTENTE] L'Ufficio Relazioni con il Pubblico (URP) di Humanitas è attivo dal lunedì al venerdì, dalle 9:00 alle 12:00. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.8, 'motivation': "La conversazione riguarda l'orario di apertura dell'Ufficio Relazioni con il Pubblico (URP), che è un servizio aziendale.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:41.806365
====================================================================================================
📋 Session ID: classify_1756762841
⏱️  Processing Time: 1.669s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (388 chars):
   [UTENTE] a che ore è aperto urp? [ASSISTENTE] L'Ufficio Relazioni con il Pubblico (URP) di Humanitas è attivo dal lunedì al venerdì, dalle 9:00 alle 12:00. Per maggiori informazioni, puoi visitare ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (198 chars):
   {'confidence': 0.8, 'motivation': "La conversazione riguarda l'orario di apertura dell'Ufficio Relazioni con il Pubblico (URP), che è un servizio aziendale.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.8
   motivation: La conversazione riguarda l'orario di apertura dell'Ufficio Relazioni con il Pubblico (URP), che è un servizio aziendale.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.800
   [████████████████░░░░] 80.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda l'orario di apertura dell'Ufficio Relazioni con il Pubblico (URP), che è un servizio aziendale.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d7b85fb88a8eb80271ba164999d203b8 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 191
   📊 Token totali: 639
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 639 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 191
   📊 Token conversazione finale: 191
   📊 Token totali: 639
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 615 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Come faccio a raggiungere la palazzina8 passando dalla 4 [ASSISTENTE] Puoi trovare le informazioni necessarie per orientarti all'interno della struttura Humanitas consultando questa [MAPPA](https://www. [...]  Buona giornata! 😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2904 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 191
   📊 Token totali stimati: 639
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Come faccio a raggiungere la palazzina8 passando dalla 4 [ASSISTENTE] Puoi trovare le informazioni necessarie per orientarti all'interno della struttura Humanitas consultando questa [MAPPA](https://www. [...]  Buona giornata! 😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'orientamento all'interno della struttura dell'ospedale e su come raggiungere una specifica palazzina, il che indica chiaramente la categoria 'Servizi aziendali'. La confidenza è alta poiché l'intento dell'utente è chiaro e la risposta dell'assistente si adatta perfettamente alla domanda.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:44.295138
====================================================================================================
📋 Session ID: classify_1756762844
⏱️  Processing Time: 2.402s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (615 chars):
   [UTENTE] Come faccio a raggiungere la palazzina8 passando dalla 4 [ASSISTENTE] Puoi trovare le informazioni necessarie per orientarti all'interno della struttura Humanitas consultando questa [MAPPA...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (394 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'orientamento all'interno della struttura dell'ospedale e su come raggiungere una specifica palazzina, il che indica chiaramente la categoria 'Servizi aziendali'. La confidenza è alta poiché l'intento dell'utente è chiaro e la rispost...

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'orientamento all'interno della struttura dell'ospedale e su come raggiungere una specifica palazzina, il che indica chiaramente la categoria 'Servizi aziendali'. La confidenza è alta poiché l'intento dell'utente è chiaro e la risposta dell'assistente si adatta perfettamente alla domanda.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'orientamento all'interno della struttura dell'ospedale e su come raggiungere una specifica palazzina, il che indica chiaramente la categoria 'Servizi aziendali'. La confidenza è alta poiché l'intento dell'utente è chiaro e la risposta dell'assistente si adatta perfettamente alla domanda.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3cc8448367dadc6452705a344e11d7d4 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 362
   📊 Token totali: 810
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 810 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 362
   📊 Token conversazione finale: 362
   📊 Token totali: 810
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1240 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao, dove si trova gastroenterologia? Come la si raggiunge? [ASSISTENTE] Per raggiungere il reparto di gastroenterologia, ti consiglio di consultare la [MAPPA](https://www. [...]  

Se hai bisogno di ulteriori informazioni su come raggiungere il reparto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2955 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 362
   📊 Token totali stimati: 810
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao, dove si trova gastroenterologia? Come la si raggiunge? [ASSISTENTE] Per raggiungere il reparto di gastroenterologia, ti consiglio di consultare la [MAPPA](https://www. [...]  

Se hai bisogno di ulteriori informazioni su come raggiungere il reparto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:46.162801
====================================================================================================
📋 Session ID: classify_1756762846
⏱️  Processing Time: 1.779s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1240 chars):
   [UTENTE] Ciao, dove si trova gastroenterologia? Come la si raggiunge? [ASSISTENTE] Per raggiungere il reparto di gastroenterologia, ti consiglio di consultare la [MAPPA](https://www.humanitas.it/wp...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 278c042be32152fc562a0c3e171c1ca1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 215
   📊 Token totali: 643
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 643 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 215
   📊 Token conversazione finale: 215
   📊 Token totali: 643
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 684 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Posso richiedere il duplicato di un CD della risonanza magnetica fatta 2 mesi fa? [ASSISTENTE] Sì, è possibile richiedere un duplicato del CD della risonanza magnetica. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2843 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 215
   📊 Token totali stimati: 643
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Posso richiedere il duplicato di un CD della risonanza magnetica fatta 2 mesi fa? [ASSISTENTE] Sì, è possibile richiedere un duplicato del CD della risonanza magnetica. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione riguarda la richiesta di un duplicato del CD della risonanza magnetica eseguita due mesi fa. L'assistente fornisce informazioni su"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:48.421066
====================================================================================================
📋 Session ID: classify_1756762848
⏱️  Processing Time: 2.168s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (684 chars):
   [UTENTE] Posso richiedere il duplicato di un CD della risonanza magnetica fatta 2 mesi fa? [ASSISTENTE] Sì, è possibile richiedere un duplicato del CD della risonanza magnetica. Ti consiglio di con...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione riguarda la richiesta di un duplicato del CD della risonanza magnetica eseguita due mesi fa. L'assistente fornisce informazioni su"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione riguarda la richiesta di un duplicato del CD della risonanza magnetica eseguita due mesi fa. L'assistente fornisce informazioni su
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione riguarda la richiesta di un duplicato del CD della risonanza magnetica eseguita due mesi fa. L'assistente fornisce informazioni su
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 55aaf474273f0b81e2b46119386923f8 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 292
   📊 Token totali: 746
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 746 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 292
   📊 Token conversazione finale: 292
   📊 Token totali: 746
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1014 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno Giulia  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? 😊 [UTENTE] Mi chiamo Lega Filiberto e non riesco ad avere nel Vs. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2917 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 292
   📊 Token totali stimati: 746
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno Giulia  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? 😊 [UTENTE] Mi chiamo Lega Filiberto e non riesco ad avere nel Vs. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte sull'accesso alla cartella clinica tramite il sito o l'app dell'ospedale. L'assistente fornisce istruzioni su come accedere "}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:51.548755
====================================================================================================
📋 Session ID: classify_1756762851
⏱️  Processing Time: 3.041s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1014 chars):
   [UTENTE] Buongiorno Giulia  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? 😊 [UTENTE] Mi chiamo Lega Filiberto e non riesco ad avere nel Vs. Sito e app la mia cartella clinica  [ASSISTENTE...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte sull'accesso alla cartella clinica tramite il sito o l'app dell'ospedale. L'assistente fornisce istruzioni su come accedere "}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte sull'accesso alla cartella clinica tramite il sito o l'app dell'ospedale. L'assistente fornisce istruzioni su come accedere 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte sull'accesso alla cartella clinica tramite il sito o l'app dell'ospedale. L'assistente fornisce istruzioni su come accedere 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3a7dba33b2f4fdd2ac8effab058a0b8c classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 331
   📊 Token totali: 780
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 780 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 331
   📊 Token conversazione finale: 331
   📊 Token totali: 780
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1176 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non mo arriva ancora il referto della tac [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www. [...] it, indicando nome, cognome, codice fiscale e motivo della richiesta di assistenza"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2931 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 331
   📊 Token totali stimati: 780
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non mo arriva ancora il referto della tac [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www. [...] it, indicando nome, cognome, codice fiscale e motivo della richiesta di assistenza"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'accesso ai referti online e sui tempi di disponibilità del referto della TAC. L'assistente fornisce info"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:53.844513
====================================================================================================
📋 Session ID: classify_1756762853
⏱️  Processing Time: 2.206s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1176 chars):
   [UTENTE] Non mo arriva ancora il referto della tac [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www.humanitas.it/info/refert...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'accesso ai referti online e sui tempi di disponibilità del referto della TAC. L'assistente fornisce info"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sull'accesso ai referti online e sui tempi di disponibilità del referto della TAC. L'assistente fornisce info
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sull'accesso ai referti online e sui tempi di disponibilità del referto della TAC. L'assistente fornisce info
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 5544f032108bba6c3e3b79504840cb51 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 324
   📊 Token totali: 772
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 772 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 324
   📊 Token conversazione finale: 324
   📊 Token totali: 772
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1014 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Salve servirebbe un foglio giustificativo per lavoro [ASSISTENTE] Per quale motivo ti serve il giustificativo del lavoro? È per una visita, un esame ambulatoriale o per un ricovero? [UTENTE] Una visita effettuata il 27 e il 28 agosto [ASSISTENTE] Sei in Humanitas o sei a casa? [UTENTE] A..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 324
   📊 Token totali stimati: 772
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Salve servirebbe un foglio giustificativo per lavoro [ASSISTENTE] Per quale motivo ti serve il giustificativo del lavoro? È per una visita, un esame ambulatoriale o per un ricovero? [UTENTE] Una visita effettuata il 27 e il 28 agosto [ASSISTENTE] Sei in Humanitas o sei a casa? [UTENTE] A..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte sull'ottenimento di un giustificativo per il lavoro e sul supporto fornito dal centralino e dall'Ufficio Relazioni con il Pubblico (URP) dell'ospedale.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:55.939423
====================================================================================================
📋 Session ID: classify_1756762855
⏱️  Processing Time: 2.008s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1014 chars):
   [UTENTE] Salve servirebbe un foglio giustificativo per lavoro [ASSISTENTE] Per quale motivo ti serve il giustificativo del lavoro? È per una visita, un esame ambulatoriale o per un ricovero? [UTENT...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (252 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte sull'ottenimento di un giustificativo per il lavoro e sul supporto fornito dal centralino e dall'Ufficio Relazioni con il Pubblico (URP) dell'ospedale.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.75
   motivation: La conversazione verte sull'ottenimento di un giustificativo per il lavoro e sul supporto fornito dal centralino e dall'Ufficio Relazioni con il Pubblico (URP) dell'ospedale.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ottenimento di un giustificativo per il lavoro e sul supporto fornito dal centralino e dall'Ufficio Relazioni con il Pubblico (URP) dell'ospedale.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 528cea117a2830649b6521ba8beafac0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 169
   📊 Token totali: 597
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 597 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 169
   📊 Token conversazione finale: 169
   📊 Token totali: 597
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 615 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesci ad entrare nell app [ASSISTENTE] Se hai difficoltà ad accedere all'app [Humanitas con te](https://www. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2787 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 169
   📊 Token totali stimati: 597
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesci ad entrare nell app [ASSISTENTE] Se hai difficoltà ad accedere all'app [Humanitas con te](https://www. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:57.364455
====================================================================================================
📋 Session ID: classify_1756762857
⏱️  Processing Time: 1.339s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (615 chars):
   [UTENTE] Non riesci ad entrare nell app [ASSISTENTE] Se hai difficoltà ad accedere all'app [Humanitas con te](https://www.humanitasconte.it), ti consiglio di verificare di aver inserito correttamen...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f4802a7b4b400e9b0344552bb2222a0f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 248
   📊 Token totali: 676
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 676 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 248
   📊 Token conversazione finale: 248
   📊 Token totali: 676
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 835 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buingiorno sono Ceccarelli Angela, [ASSISTENTE] Buongiorno Angela Ceccarelli, come posso esserti utile oggi? [UTENTE] CCCNGL75H52F592C, ho fatto un esame di densiometria ossea il 21 luglio,ma non riesco a vederlo on line [ASSISTENTE] Per visualizzare i referti online, è necessario essere..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 248
   📊 Token totali stimati: 676
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buingiorno sono Ceccarelli Angela, [ASSISTENTE] Buongiorno Angela Ceccarelli, come posso esserti utile oggi? [UTENTE] CCCNGL75H52F592C, ho fatto un esame di densiometria ossea il 21 luglio,ma non riesco a vederlo on line [ASSISTENTE] Per visualizzare i referti online, è necessario essere..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Referti e Cartelle Cliniche",\n    "conf'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:40:59.413426
====================================================================================================
📋 Session ID: classify_1756762859
⏱️  Processing Time: 1.962s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (835 chars):
   [UTENTE] Buingiorno sono Ceccarelli Angela, [ASSISTENTE] Buongiorno Angela Ceccarelli, come posso esserti utile oggi? [UTENTE] CCCNGL75H52F592C, ho fatto un esame di densiometria ossea il 21 luglio...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Referti e Cartelle Cliniche",\n    "conf'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Referti e Cartelle Cliniche",
    "conf
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Referti e Cartelle Cliniche",
    "conf
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 38242fc56f18057275c4919af1b90241 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 179
   📊 Token totali: 627
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 627 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 179
   📊 Token conversazione finale: 179
   📊 Token totali: 627
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 606 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2760 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 179
   📊 Token totali stimati: 627
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Servizi aziendali",\n    "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:01.286033
====================================================================================================
📋 Session ID: classify_1756762861
⏱️  Processing Time: 1.785s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (606 chars):
   [UTENTE] Buongiorno. Stiamo facendo una PMA ma non abbiamo ancora ricevuto la fattura. Può verificare? [ASSISTENTE] Non ho accesso ai dati personali o alle fatture dei pazienti. Ti consiglio di con...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Servizi aziendali",\n    "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Servizi aziendali",
    "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Servizi aziendali",
    "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 6022d9c4aa7d69d5b3b1761f384aba41 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 189
   📊 Token totali: 638
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 638 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 189
   📊 Token conversazione finale: 189
   📊 Token totali: 638
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 565 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao giulia [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] Puoi dirmi se oggi pomeriggio è possibile ritirare un referto [ASSISTENTE] L'ufficio ritiro referti di Humanitas è situato in Via Sardegna 5, Fizzonasco di Pieve Emanuele. È aperto dal lunedì al venerdì, dalle 1..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 189
   📊 Token totali stimati: 638
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao giulia [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] Puoi dirmi se oggi pomeriggio è possibile ritirare un referto [ASSISTENTE] L'ufficio ritiro referti di Humanitas è situato in Via Sardegna 5, Fizzonasco di Pieve Emanuele. È aperto dal lunedì al venerdì, dalle 1..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:02.968315
====================================================================================================
📋 Session ID: classify_1756762862
⏱️  Processing Time: 1.596s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (565 chars):
   [UTENTE] Ciao giulia [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] Puoi dirmi se oggi pomeriggio è possibile ritirare un referto [ASSISTENTE] L'ufficio ritiro referti di Humanita...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d3009d030cd54e810e38626ffea5b011 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 255
   📊 Token totali: 703
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 703 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 255
   📊 Token conversazione finale: 255
   📊 Token totali: 703
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 882 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Oggi alle 14 devo essere in ospedale per operazione di ablazione. [...]  

Se hai bisogno di ulteriore assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2805 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 255
   📊 Token totali stimati: 703
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Oggi alle 14 devo essere in ospedale per operazione di ablazione. [...]  

Se hai bisogno di ulteriore assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'operazione di ablazione e sul fatto che l'utente non sa se deve presentarsi a digiuno o meno. L'assistente consiglia all'utente di fare riferimento alle istruzioni fornite durante la prenotazione o il prericovero, suggerendo anche di contattare direttamente il reparto competente per ulteriori informazioni.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:05.523749
====================================================================================================
📋 Session ID: classify_1756762865
⏱️  Processing Time: 2.466s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (882 chars):
   [UTENTE] Oggi alle 14 devo essere in ospedale per operazione di ablazione. Volevo capire se devo venire a digiuno o cosa [ASSISTENTE] Per sapere se devi essere a digiuno o seguire altre indicazioni...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (408 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'operazione di ablazione e sul fatto che l'utente non sa se deve presentarsi a digiuno o meno. L'assistente consiglia all'utente di fare riferimento alle istruzioni fornite durante la prenotazione o il prericovero, suggerendo anche di...

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte sull'operazione di ablazione e sul fatto che l'utente non sa se deve presentarsi a digiuno o meno. L'assistente consiglia all'utente di fare riferimento alle istruzioni fornite durante la prenotazione o il prericovero, suggerendo anche di contattare direttamente il reparto competente per ulteriori informazioni.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'operazione di ablazione e sul fatto che l'utente non sa se deve presentarsi a digiuno o meno. L'assistente consiglia all'utente di fare riferimento alle istruzioni fornite durante la prenotazione o il prericovero, suggerendo anche di contattare direttamente il reparto competente per ulteriori informazioni.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a132ff17e4b9fe84f9b524179714dd3e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 129
   📊 Token totali: 578
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 578 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 129
   📊 Token conversazione finale: 129
   📊 Token totali: 578
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 373 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Voglio contattare reparto BARIATRICO  [ASSISTENTE] Puoi contattare il Centro Obesità, che include l'Unità Operativa di Chirurgia Bariatrica, al numero 02 8224 6970. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2854 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 129
   📊 Token totali stimati: 578
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Voglio contattare reparto BARIATRICO  [ASSISTENTE] Puoi contattare il Centro Obesità, che include l'Unità Operativa di Chirurgia Bariatrica, al numero 02 8224 6970. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione riguarda il reparto bariatrico, che è parte del Centro Obesità. Pertanto, la categoria più adatta è 'Centro Malattie del Metbolismo e della Nutrizione'.", 'predicted_label': 'Centro Malattie del Metabolismo e della Nutrizione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:07.580646
====================================================================================================
📋 Session ID: classify_1756762867
⏱️  Processing Time: 1.969s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (373 chars):
   [UTENTE] Voglio contattare reparto BARIATRICO  [ASSISTENTE] Puoi contattare il Centro Obesità, che include l'Unità Operativa di Chirurgia Bariatrica, al numero 02 8224 6970. Per maggiori dettagli, ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (280 chars):
   {'confidence': 0.95, 'motivation': "La conversazione riguarda il reparto bariatrico, che è parte del Centro Obesità. Pertanto, la categoria più adatta è 'Centro Malattie del Metbolismo e della Nutrizione'.", 'predicted_label': 'Centro Malattie del Metabolismo e della Nutrizione'}

📊 Parsed Response:
   predicted_label: Centro Malattie del Metabolismo e della Nutrizione
   confidence: 0.95
   motivation: La conversazione riguarda il reparto bariatrico, che è parte del Centro Obesità. Pertanto, la categoria più adatta è 'Centro Malattie del Metbolismo e della Nutrizione'.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda il reparto bariatrico, che è parte del Centro Obesità. Pertanto, la categoria più adatta è 'Centro Malattie del Metbolismo e della Nutrizione'.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f94112222739ebab7d376e00633aaf01 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Centro Malattie del Metabolismo e della Nutrizione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 496
   📊 Token totali: 944
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 944 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 496
   📊 Token conversazione finale: 496
   📊 Token totali: 944
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1474 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ECOGRAFIA MUSCOLOTENDINEA ECO ARTICOLARE MANI POLSI SPALLE CON DETERMINAZIONE POWER DOPPLER [ASSISTENTE] Per l'ecografia muscolotendinea eco articolare mani, polsi, spalle con determinazione Power Doppler, ti consiglio di verificare se è necessaria una preparazione specifica. Se hai biso..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 496
   📊 Token totali stimati: 944
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ECOGRAFIA MUSCOLOTENDINEA ECO ARTICOLARE MANI POLSI SPALLE CON DETERMINAZIONE POWER DOPPLER [ASSISTENTE] Per l'ecografia muscolotendinea eco articolare mani, polsi, spalle con determinazione Power Doppler, ti consiglio di verificare se è necessaria una preparazione specifica. Se hai biso..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla prenotazione di un esame ecografico presso l'Istituto Clinico Humanitas.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:09.354493
====================================================================================================
📋 Session ID: classify_1756762869
⏱️  Processing Time: 1.686s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1474 chars):
   [UTENTE] ECOGRAFIA MUSCOLOTENDINEA ECO ARTICOLARE MANI POLSI SPALLE CON DETERMINAZIONE POWER DOPPLER [ASSISTENTE] Per l'ecografia muscolotendinea eco articolare mani, polsi, spalle con determinazio...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (189 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla prenotazione di un esame ecografico presso l'Istituto Clinico Humanitas.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte principalmente sulla prenotazione di un esame ecografico presso l'Istituto Clinico Humanitas.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla prenotazione di un esame ecografico presso l'Istituto Clinico Humanitas.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 53f617542d76fc465db0acd0f9d4a583 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 172
   📊 Token totali: 620
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 620 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 172
   📊 Token conversazione finale: 172
   📊 Token totali: 620
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 583 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno,  vorrei sapere se fate la mammografia in 3d [ASSISTENTE] Sì, presso Humanitas è possibile effettuare la mammografia in Tomosintesi, una tecnica avanzata che consente una valutazione più accurata della mammella scomponendone lo spessore in multipli strati. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2956 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 172
   📊 Token totali stimati: 620
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno,  vorrei sapere se fate la mammografia in 3d [ASSISTENTE] Sì, presso Humanitas è possibile effettuare la mammografia in Tomosintesi, una tecnica avanzata che consente una valutazione più accurata della mammella scomponendone lo spessore in multipli strati. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sull'esecuzione di una mammografia in Humanitas, che rientra nella categoria 'Analisi'. La conversazione è chiara e specifica.", 'predicted_label': 'Analisi'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:11.093862
====================================================================================================
📋 Session ID: classify_1756762871
⏱️  Processing Time: 1.652s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (583 chars):
   [UTENTE] Buongiorno,  vorrei sapere se fate la mammografia in 3d [ASSISTENTE] Sì, presso Humanitas è possibile effettuare la mammografia in Tomosintesi, una tecnica avanzata che consente una valuta...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (216 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sull'esecuzione di una mammografia in Humanitas, che rientra nella categoria 'Analisi'. La conversazione è chiara e specifica.", 'predicted_label': 'Analisi'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.9
   motivation: La conversazione verte sull'esecuzione di una mammografia in Humanitas, che rientra nella categoria 'Analisi'. La conversazione è chiara e specifica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'esecuzione di una mammografia in Humanitas, che rientra nella categoria 'Analisi'. La conversazione è chiara e specifica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 1c9c2a1f5de1f3c1d4cb154fb285e755 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 77
   📊 Token totali: 505
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 505 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 77
   📊 Token conversazione finale: 77
   📊 Token totali: 505
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 256 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei consegnare domani un campione di urine  [ASSISTENTE] Per consegnare un campione di urine, ti consiglio di contattare il numero 0282248230 per ottenere informazioni dettagliate. Se hai bisogno di ulteriori indicazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2852 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 77
   📊 Token totali stimati: 505
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei consegnare domani un campione di urine  [ASSISTENTE] Per consegnare un campione di urine, ti consiglio di contattare il numero 0282248230 per ottenere informazioni dettagliate. Se hai bisogno di ulteriori indicazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'analisi delle urine dell'utente.", 'predicted_label': 'Analisi'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:12.446585
====================================================================================================
📋 Session ID: classify_1756762872
⏱️  Processing Time: 1.266s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (256 chars):
   [UTENTE] Vorrei consegnare domani un campione di urine  [ASSISTENTE] Per consegnare un campione di urine, ti consiglio di contattare il numero 0282248230 per ottenere informazioni dettagliate. Se h...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (128 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'analisi delle urine dell'utente.", 'predicted_label': 'Analisi'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.95
   motivation: La conversazione verte sull'analisi delle urine dell'utente.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'analisi delle urine dell'utente.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 1004de257329e860884fbe701cbc1676 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 97
   📊 Token totali: 525
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 525 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 97
   📊 Token conversazione finale: 97
   📊 Token totali: 525
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 354 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Per inviare un curriculum? [ASSISTENTE] Puoi consultare le posizioni aperte per tutte le strutture del gruppo Humanitas e candidarti collegandoti alla pagina [jobs. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2843 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 97
   📊 Token totali stimati: 525
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Per inviare un curriculum? [ASSISTENTE] Puoi consultare le posizioni aperte per tutte le strutture del gruppo Humanitas e candidarti collegandoti alla pagina [jobs. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'invio di un curriculum e sulle posizioni aperte presso Humanitas, pertanto la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:14.250361
====================================================================================================
📋 Session ID: classify_1756762874
⏱️  Processing Time: 1.717s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (354 chars):
   [UTENTE] Per inviare un curriculum? [ASSISTENTE] Puoi consultare le posizioni aperte per tutte le strutture del gruppo Humanitas e candidarti collegandoti alla pagina [jobs.humanitas.it](https://jo...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (228 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'invio di un curriculum e sulle posizioni aperte presso Humanitas, pertanto la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'invio di un curriculum e sulle posizioni aperte presso Humanitas, pertanto la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'invio di un curriculum e sulle posizioni aperte presso Humanitas, pertanto la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 582ab044c6b489492e9dd3d9563db080 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 874
   📊 Token totali: 1322
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1322 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 874
   📊 Token conversazione finale: 874
   📊 Token totali: 1322
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2981 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao, ho fatto pre ricovero martedì, però ho deciso di non operarmi, mi è stato detto che dovrei pagare un ticket; come devo fare ? [ASSISTENTE] Se hai deciso di non procedere con l'intervento dopo il prericovero, è possibile che tu debba pagare un ticket. Ti consiglio di contattare dire..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 874
   📊 Token totali stimati: 1322
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao, ho fatto pre ricovero martedì, però ho deciso di non operarmi, mi è stato detto che dovrei pagare un ticket; come devo fare ? [ASSISTENTE] Se hai deciso di non procedere con l'intervento dopo il prericovero, è possibile che tu debba pagare un ticket. Ti consiglio di contattare dire..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte principalmente sull'assistenza per il pagamento di un ticket dopo il prericovero e la difficoltà dell'utente nel trovare informazioni chiare su come procedere. L'etichetta 'Servizi aziendali' è appropriata poiché l'utente cerca supporto per una questione amministrativa relativa all'ospedale.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:17.109740
====================================================================================================
📋 Session ID: classify_1756762877
⏱️  Processing Time: 2.771s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2981 chars):
   [UTENTE] ciao, ho fatto pre ricovero martedì, però ho deciso di non operarmi, mi è stato detto che dovrei pagare un ticket; come devo fare ? [ASSISTENTE] Se hai deciso di non procedere con l'interv...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (393 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte principalmente sull'assistenza per il pagamento di un ticket dopo il prericovero e la difficoltà dell'utente nel trovare informazioni chiare su come procedere. L'etichetta 'Servizi aziendali' è appropriata poiché l'utente cerca supporto p...

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.75
   motivation: La conversazione verte principalmente sull'assistenza per il pagamento di un ticket dopo il prericovero e la difficoltà dell'utente nel trovare informazioni chiare su come procedere. L'etichetta 'Servizi aziendali' è appropriata poiché l'utente cerca supporto per una questione amministrativa relativa all'ospedale.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sull'assistenza per il pagamento di un ticket dopo il prericovero e la difficoltà dell'utente nel trovare informazioni chiare su come procedere. L'etichetta 'Servizi aziendali' è appropriata poiché l'utente cerca supporto per una questione amministrativa relativa all'ospedale.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione cfc2176354ef6eccc188b2e2e56e612d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 165
   📊 Token totali: 613
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 613 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 165
   📊 Token conversazione finale: 165
   📊 Token totali: 613
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 547 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Come posso contattare il dottor Massimo Tritto che mi ha visitato ieri sera a Rozzano? [ASSISTENTE] Per motivi di privacy, non posso fornire informazioni specifiche sui medici o sui loro contatti. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 165
   📊 Token totali stimati: 613
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Come posso contattare il dottor Massimo Tritto che mi ha visitato ieri sera a Rozzano? [ASSISTENTE] Per motivi di privacy, non posso fornire informazioni specifiche sui medici o sui loro contatti. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte sull'ottenere informazioni su un medico specifico e contattarlo, quindi rientra nella categoria 'Servizi aziendali'. La confidenza è del 75% poiché la conversazione è chiara ma non fornisce molte informazioni specifiche sul motivo per cui l'utente vuole contattare il medico.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:19.574702
====================================================================================================
📋 Session ID: classify_1756762879
⏱️  Processing Time: 2.379s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (547 chars):
   [UTENTE] Come posso contattare il dottor Massimo Tritto che mi ha visitato ieri sera a Rozzano? [ASSISTENTE] Per motivi di privacy, non posso fornire informazioni specifiche sui medici o sui loro c...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (376 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte sull'ottenere informazioni su un medico specifico e contattarlo, quindi rientra nella categoria 'Servizi aziendali'. La confidenza è del 75% poiché la conversazione è chiara ma non fornisce molte informazioni specifiche sul motivo per cui...

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.75
   motivation: La conversazione verte sull'ottenere informazioni su un medico specifico e contattarlo, quindi rientra nella categoria 'Servizi aziendali'. La confidenza è del 75% poiché la conversazione è chiara ma non fornisce molte informazioni specifiche sul motivo per cui l'utente vuole contattare il medico.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ottenere informazioni su un medico specifico e contattarlo, quindi rientra nella categoria 'Servizi aziendali'. La confidenza è del 75% poiché la conversazione è chiara ma non fornisce molte informazioni specifiche sul motivo per cui l'utente vuole contattare il medico.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 978479b0b0fd3d728cce296930fde631 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 303
   📊 Token totali: 751
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 751 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 303
   📊 Token conversazione finale: 303
   📊 Token totali: 751
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 914 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao Vorrei sapere se l'ufficio ritiro referti di via sardegna è aperto il 14 agosto nel pomeriggio  [UTENTE] riesci a rispondere ?  [ASSISTENTE] Ciao! Sono Giulia, l’assistente digitale dell’Istituto Clinico Humanitas. [...] 
Puoi riprovare più tardi? Grazie"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2936 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 303
   📊 Token totali stimati: 751
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao Vorrei sapere se l'ufficio ritiro referti di via sardegna è aperto il 14 agosto nel pomeriggio  [UTENTE] riesci a rispondere ?  [ASSISTENTE] Ciao! Sono Giulia, l’assistente digitale dell’Istituto Clinico Humanitas. [...] 
Puoi riprovare più tardi? Grazie"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sul ritiro dei referti e l'orario di apertura dell'ufficio competente.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:21.259374
====================================================================================================
📋 Session ID: classify_1756762881
⏱️  Processing Time: 1.597s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (914 chars):
   [UTENTE] ciao Vorrei sapere se l'ufficio ritiro referti di via sardegna è aperto il 14 agosto nel pomeriggio  [UTENTE] riesci a rispondere ?  [ASSISTENTE] Ciao! Sono Giulia, l’assistente digitale d...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (181 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sul ritiro dei referti e l'orario di apertura dell'ufficio competente.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sul ritiro dei referti e l'orario di apertura dell'ufficio competente.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sul ritiro dei referti e l'orario di apertura dell'ufficio competente.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione e0d7701bd37c7d56e784570667dc62a1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 286
   📊 Token totali: 734
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 734 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 286
   📊 Token conversazione finale: 286
   📊 Token totali: 734
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 925 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] CIAI  [ASSISTENTE] Se hai bisogno di assistenza o informazioni, sono qui per aiutarti. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2786 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 286
   📊 Token totali stimati: 734
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] CIAI  [ASSISTENTE] Se hai bisogno di assistenza o informazioni, sono qui per aiutarti. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla necessità dell'utente di contattare il professor Della Rocca per avere informazioni sulla sua visita. Questa è una richiesta tipica di assistenza per una visita specialistica.", 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:23.229523
====================================================================================================
📋 Session ID: classify_1756762883
⏱️  Processing Time: 1.883s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (925 chars):
   [UTENTE] CIAI  [ASSISTENTE] Se hai bisogno di assistenza o informazioni, sono qui per aiutarti. Puoi spiegarmi meglio la tua richiesta? [UTENTE] Ciao Giulia Ho fatto una visita ho effettuato una vi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (300 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla necessità dell'utente di contattare il professor Della Rocca per avere informazioni sulla sua visita. Questa è una richiesta tipica di assistenza per una visita specialistica.", 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.95
   motivation: La conversazione verte principalmente sulla necessità dell'utente di contattare il professor Della Rocca per avere informazioni sulla sua visita. Questa è una richiesta tipica di assistenza per una visita specialistica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla necessità dell'utente di contattare il professor Della Rocca per avere informazioni sulla sua visita. Questa è una richiesta tipica di assistenza per una visita specialistica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7420b90a5fd17f5ee55f1d42a5f21cb9 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
   📈 Progresso LLM: 50/624
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 157
   📊 Token totali: 605
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 605 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 157
   📊 Token conversazione finale: 157
   📊 Token totali: 605
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 476 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Avrei bisogno dell'indirizzo PEC vostro della clinica Humanitas di Rozzano Grazie [ASSISTENTE] L'indirizzo PEC dell'Istituto Clinico Humanitas di Rozzano è: **privacy. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2916 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 157
   📊 Token totali stimati: 605
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Avrei bisogno dell'indirizzo PEC vostro della clinica Humanitas di Rozzano Grazie [ASSISTENTE] L'indirizzo PEC dell'Istituto Clinico Humanitas di Rozzano è: **privacy. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Servizi aziendali","confidence":0.'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:25.054335
====================================================================================================
📋 Session ID: classify_1756762885
⏱️  Processing Time: 1.737s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (476 chars):
   [UTENTE] Avrei bisogno dell'indirizzo PEC vostro della clinica Humanitas di Rozzano Grazie [ASSISTENTE] L'indirizzo PEC dell'Istituto Clinico Humanitas di Rozzano è: **privacy.humanitas@pec.it**【6:...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Servizi aziendali","confidence":0.'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Servizi aziendali","confidence":0.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name":"classify_conversation","arguments":{"predicted_label":"Servizi aziendali","confidence":0.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione dc271d225ffe4e1383423835e6ff472a classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 366
   📊 Token totali: 815
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 815 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 366
   📊 Token conversazione finale: 366
   📊 Token totali: 815
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1198 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buonasera Giulia sono la signora peracchia e chiamo da fuori regione io Volevo avere informazioni per fare una prenotazione per una linfoscintigrafia se viene fatta lì da voi [ASSISTENTE] Sì, presso Humanitas è possibile effettuare la linfoscintigrafia, un esame diagnostico non invasivo ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 366
   📊 Token totali stimati: 815
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buonasera Giulia sono la signora peracchia e chiamo da fuori regione io Volevo avere informazioni per fare una prenotazione per una linfoscintigrafia se viene fatta lì da voi [ASSISTENTE] Sì, presso Humanitas è possibile effettuare la linfoscintigrafia, un esame diagnostico non invasivo ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'esame della linfoscintigrafia e sulle modalità per effettuarlo presso la struttura. L'utente chiede info"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:27.174986
====================================================================================================
📋 Session ID: classify_1756762887
⏱️  Processing Time: 2.032s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1198 chars):
   [UTENTE] Buonasera Giulia sono la signora peracchia e chiamo da fuori regione io Volevo avere informazioni per fare una prenotazione per una linfoscintigrafia se viene fatta lì da voi [ASSISTENTE] ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'esame della linfoscintigrafia e sulle modalità per effettuarlo presso la struttura. L'utente chiede info"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sull'esame della linfoscintigrafia e sulle modalità per effettuarlo presso la struttura. L'utente chiede info
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sull'esame della linfoscintigrafia e sulle modalità per effettuarlo presso la struttura. L'utente chiede info
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d14f7e5ac405521623043f73007bef54 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 123
   📊 Token totali: 551
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 551 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 123
   📊 Token conversazione finale: 123
   📊 Token totali: 551
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 404 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno ho bisogno di verificare dove ho appuntamento con il dott Sacrini alle 1015 di venerdì 25 luglio 2025 [ASSISTENTE] Non ho accesso a informazioni personali o agli appuntamenti specifici dei pazienti. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2886 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 123
   📊 Token totali stimati: 551
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno ho bisogno di verificare dove ho appuntamento con il dott Sacrini alle 1015 di venerdì 25 luglio 2025 [ASSISTENTE] Non ho accesso a informazioni personali o agli appuntamenti specifici dei pazienti. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione riguarda una richiesta di informazioni su un appuntamento con uno specialista presso l'ospedale Humanitas. L'intenzione dell'utent"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:29.791155
====================================================================================================
📋 Session ID: classify_1756762889
⏱️  Processing Time: 2.528s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (404 chars):
   [UTENTE] Buongiorno ho bisogno di verificare dove ho appuntamento con il dott Sacrini alle 1015 di venerdì 25 luglio 2025 [ASSISTENTE] Non ho accesso a informazioni personali o agli appuntamenti sp...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione riguarda una richiesta di informazioni su un appuntamento con uno specialista presso l'ospedale Humanitas. L'intenzione dell'utent"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione riguarda una richiesta di informazioni su un appuntamento con uno specialista presso l'ospedale Humanitas. L'intenzione dell'utent
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione riguarda una richiesta di informazioni su un appuntamento con uno specialista presso l'ospedale Humanitas. L'intenzione dell'utent
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione cf03fb050666919136bbcf16dd80a539 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 340
   📊 Token totali: 788
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 788 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 340
   📊 Token conversazione finale: 340
   📊 Token totali: 788
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1124 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dovrei fare una tac, che documentazione mi serve? [ASSISTENTE] Per effettuare una TAC, è necessario avere con sé la seguente documentazione:

1. [...] 

Se hai bisogno di ulteriori dettagli o assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2903 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 340
   📊 Token totali stimati: 788
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dovrei fare una tac, che documentazione mi serve? [ASSISTENTE] Per effettuare una TAC, è necessario avere con sé la seguente documentazione:

1. [...] 

Se hai bisogno di ulteriori dettagli o assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Risonanza magnetica"}}'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:30.720528
====================================================================================================
📋 Session ID: classify_1756762890
⏱️  Processing Time: 0.843s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1124 chars):
   [UTENTE] Dovrei fare una tac, che documentazione mi serve? [ASSISTENTE] Per effettuare una TAC, è necessario avere con sé la seguente documentazione:

1. **Impegnativa del medico curante** (se la p...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [77 more lines] ...
     Line 81: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (183 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Risonanza magnetica"}}'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Risonanza magnetica"}}
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Risonanza magnetica"}}
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 01008efcf4439427f40ab1ba6018767f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 605
   📊 Token totali: 1053
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1053 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 605
   📊 Token conversazione finale: 605
   📊 Token totali: 1053
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1978 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere se è possibile fare RM addome inferiore con studio dinamico del pavimento pelvico  [ASSISTENTE] Non ho trovato informazioni specifiche sulla possibilità di effettuare una Risonanza Magnetica (RM) dell'addome inferiore con studio dinamico del pavimento pelvico nei documenti ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 605
   📊 Token totali stimati: 1053
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere se è possibile fare RM addome inferiore con studio dinamico del pavimento pelvico  [ASSISTENTE] Non ho trovato informazioni specifiche sulla possibilità di effettuare una Risonanza Magnetica (RM) dell'addome inferiore con studio dinamico del pavimento pelvico nei documenti ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** "Risonanza magnetica"\n\n**Confidence:** 0.7\n\n**Motivation:** La conversazione ve'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:33.234048
====================================================================================================
📋 Session ID: classify_1756762893
⏱️  Processing Time: 2.427s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1978 chars):
   [UTENTE] Vorrei sapere se è possibile fare RM addome inferiore con studio dinamico del pavimento pelvico  [ASSISTENTE] Non ho trovato informazioni specifiche sulla possibilità di effettuare una Ris...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** "Risonanza magnetica"\n\n**Confidence:** 0.7\n\n**Motivation:** La conversazione ve'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted label:** "Risonanza magnetica"

**Confidence:** 0.7

**Motivation:** La conversazione ve
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted label:** "Risonanza magnetica"

**Confidence:** 0.7

**Motivation:** La conversazione ve
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3dcf98d243ab6f8ea9aed0b56631df81 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 447
   💬 Token conversazione: 257
   📊 Token totali: 704
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 704 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 447
   📊 Token conversazione originale: 257
   📊 Token conversazione finale: 257
   📊 Token totali: 704
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 868 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] che operazioni puoi fare? [ASSISTENTE] Posso fornire informazioni di carattere generale relative all’ospedale Humanitas. [...]  

Se hai bisogno di aiuto con le modalità di prenotazione, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2869 characters
🔢 Token Analysis:
   📊 Token prompt base: 447
   📊 Token conversazione: 257
   📊 Token totali stimati: 704
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta urgente - valuta priorità massima

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] che operazioni puoi fare? [ASSISTENTE] Posso fornire informazioni di carattere generale relative all’ospedale Humanitas. [...]  

Se hai bisogno di aiuto con le modalità di prenotazione, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:36.188443
====================================================================================================
📋 Session ID: classify_1756762896
⏱️  Processing Time: 2.866s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (868 chars):
   [UTENTE] che operazioni puoi fare? [ASSISTENTE] Posso fornire informazioni di carattere generale relative all’ospedale Humanitas. Ad esempio, posso aiutarti con:

- Informazioni sui medici e sulle ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7763f65f7893ecea14ebeb07aadea979 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 358
   📊 Token totali: 806
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 806 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 358
   📊 Token conversazione finale: 358
   📊 Token totali: 806
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1162 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno mi puo' dare un recapito telefonico dove poter avere info riguardo il test di aggregazione piastrinica attivatore adp [ASSISTENTE] Per informazioni riguardo il test di aggregazione piastrinica con attivatore ADP, ti consiglio di contattare il Centro Trombosi di Humanitas. Puoi..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 358
   📊 Token totali stimati: 806
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno mi puo' dare un recapito telefonico dove poter avere info riguardo il test di aggregazione piastrinica attivatore adp [ASSISTENTE] Per informazioni riguardo il test di aggregazione piastrinica con attivatore ADP, ti consiglio di contattare il Centro Trombosi di Humanitas. Puoi..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla prenotazione di un test di aggregazione piastrinica con attivatore ADP e sul tentativo dell'utente di ottenere informazioni su come effettuare la prenotazione.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:38.190400
====================================================================================================
📋 Session ID: classify_1756762898
⏱️  Processing Time: 1.916s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1162 chars):
   [UTENTE] buongiorno mi puo' dare un recapito telefonico dove poter avere info riguardo il test di aggregazione piastrinica attivatore adp [ASSISTENTE] Per informazioni riguardo il test di aggregazi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (276 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla prenotazione di un test di aggregazione piastrinica con attivatore ADP e sul tentativo dell'utente di ottenere informazioni su come effettuare la prenotazione.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte principalmente sulla prenotazione di un test di aggregazione piastrinica con attivatore ADP e sul tentativo dell'utente di ottenere informazioni su come effettuare la prenotazione.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla prenotazione di un test di aggregazione piastrinica con attivatore ADP e sul tentativo dell'utente di ottenere informazioni su come effettuare la prenotazione.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 08d529b8410ab5fb0b4a0ed943b0448e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 313
   📊 Token totali: 761
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 761 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 313
   📊 Token conversazione finale: 313
   📊 Token totali: 761
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1090 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, sono Davide Surano e in data 30/05 ho effettuato una visita con la Dott. [...]  Se hai bisogno di ulteriori dettagli, fammi sapere e cercherò di aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2843 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 313
   📊 Token totali stimati: 761
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, sono Davide Surano e in data 30/05 ho effettuato una visita con la Dott. [...]  Se hai bisogno di ulteriori dettagli, fammi sapere e cercherò di aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of conversation:**\n\n- predicted_label: "Referti e Cartelle Cliniche"\n- confidence: '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:39.982818
====================================================================================================
📋 Session ID: classify_1756762899
⏱️  Processing Time: 1.704s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1090 chars):
   [UTENTE] Buongiorno, sono Davide Surano e in data 30/05 ho effettuato una visita con la Dott.ssa Vanessa Rossi nel centro Humanitas di Rozzano. In accordo con la dottoressa dovrei inviare i referti...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (194 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of conversation:**\n\n- predicted_label: "Referti e Cartelle Cliniche"\n- confidence: '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Classification of conversation:**

- predicted_label: "Referti e Cartelle Cliniche"
- confidence: 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Classification of conversation:**

- predicted_label: "Referti e Cartelle Cliniche"
- confidence: 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 5a1e4a97e58e7324945179a972b87fcc classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 210
   📊 Token totali: 659
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 659 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 210
   📊 Token conversazione finale: 210
   📊 Token totali: 659
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 721 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei parlare con un operatore per le prenotazioni  [ASSISTENTE] Puoi contattare il servizio centralino di Humanitas al numero 02 822 41 per parlare con un operatore. [...]  

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2917 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 210
   📊 Token totali stimati: 659
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei parlare con un operatore per le prenotazioni  [ASSISTENTE] Puoi contattare il servizio centralino di Humanitas al numero 02 822 41 per parlare con un operatore. [...]  

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'prenotazione', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:43.038628
====================================================================================================
📋 Session ID: classify_1756762903
⏱️  Processing Time: 2.967s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (721 chars):
   [UTENTE] Vorrei parlare con un operatore per le prenotazioni  [ASSISTENTE] Puoi contattare il servizio centralino di Humanitas al numero 02 822 41 per parlare con un operatore. Se hai bisogno di ul...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (104 chars):
   {'predicted_label': 'prenotazione', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: prenotazione
   confidence: 0.6
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.600
   [████████████░░░░░░░░] 60.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 62c9b6929ac6bb9f52740ce063fde598 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 232
   📊 Token totali: 660
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 660 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 232
   📊 Token conversazione finale: 232
   📊 Token totali: 660
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 801 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] codice prestazione isteroscopia [ASSISTENTE] Non ho trovato informazioni specifiche sul codice della prestazione per l'isteroscopia nei documenti forniti. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2829 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 232
   📊 Token totali stimati: 660
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] codice prestazione isteroscopia [ASSISTENTE] Non ho trovato informazioni specifiche sul codice della prestazione per l'isteroscopia nei documenti forniti. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Prenotazione",\n    "confidence": 0.9,\n '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:44.681560
====================================================================================================
📋 Session ID: classify_1756762904
⏱️  Processing Time: 1.557s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (801 chars):
   [UTENTE] codice prestazione isteroscopia [ASSISTENTE] Non ho trovato informazioni specifiche sul codice della prestazione per l'isteroscopia nei documenti forniti. Ti consiglio di contattare dirett...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (197 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Prenotazione",\n    "confidence": 0.9,\n '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Prenotazione",
    "confidence": 0.9,
 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Prenotazione",
    "confidence": 0.9,
 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 66fa8a1e04debe2b807406f42aaebd8c classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 377
   📊 Token totali: 825
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 825 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 377
   📊 Token conversazione finale: 377
   📊 Token totali: 825
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1202 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Salve , sono Blasi Claudio, devo effettuare un prericovero per un intervento all’orecchio il 18 c. [...]  

Fammi sapere se hai bisogno di ulteriore supporto!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2835 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 377
   📊 Token totali stimati: 825
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Salve , sono Blasi Claudio, devo effettuare un prericovero per un intervento all’orecchio il 18 c. [...]  

Fammi sapere se hai bisogno di ulteriore supporto!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'interruzione della prenotazione per un ricovero in ospedale.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:46.270589
====================================================================================================
📋 Session ID: classify_1756762906
⏱️  Processing Time: 1.502s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1202 chars):
   [UTENTE] Salve , sono Blasi Claudio, devo effettuare un prericovero per un intervento all’orecchio il 18 c.m., devo disdire, non riesco a contattare nessuno per poter disdire, cosa posso e? [ASSIST...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (161 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'interruzione della prenotazione per un ricovero in ospedale.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte sull'interruzione della prenotazione per un ricovero in ospedale.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'interruzione della prenotazione per un ricovero in ospedale.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione c37a04182da7793aec200bf44a7785cd classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 4383
   📊 Token totali: 4831
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 4831 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 4383
   📊 Token conversazione finale: 4383
   📊 Token totali: 4831
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 15143 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] mi servirebbero informazioni di come funziona un percorso di riabilitazione post ricostruzione lca [ASSISTENTE] Per quanto riguarda i percorsi di riabilitazione post ricostruzione del legamento crociato anteriore (LCA), ti consiglio di consultare il tuo medico curante o il fisioterapista..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 4383
   📊 Token totali stimati: 4831
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] mi servirebbero informazioni di come funziona un percorso di riabilitazione post ricostruzione lca [ASSISTENTE] Per quanto riguarda i percorsi di riabilitazione post ricostruzione del legamento crociato anteriore (LCA), ti consiglio di consultare il tuo medico curante o il fisioterapista..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': "Risposta non strutturata: Questa conversazione verte principalmente sull'assistenza fornita da Humanitas per il recupero funzi"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:50.903659
====================================================================================================
📋 Session ID: classify_1756762910
⏱️  Processing Time: 4.545s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (15143 chars):
   [UTENTE] mi servirebbero informazioni di come funziona un percorso di riabilitazione post ricostruzione lca [ASSISTENTE] Per quanto riguarda i percorsi di riabilitazione post ricostruzione del lega...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': "Risposta non strutturata: Questa conversazione verte principalmente sull'assistenza fornita da Humanitas per il recupero funzi"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: Questa conversazione verte principalmente sull'assistenza fornita da Humanitas per il recupero funzi
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: Questa conversazione verte principalmente sull'assistenza fornita da Humanitas per il recupero funzi
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione c690cb03628eaebb2e23315d7cf65789 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 89
   📊 Token totali: 537
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 537 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 89
   📊 Token conversazione finale: 89
   📊 Token totali: 537
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 309 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Contatti telefonici risorse umane  [ASSISTENTE] Per contattare le Risorse Umane di Humanitas, ti consiglio di visitare la pagina dedicata alle opportunità di lavoro e alle candidature spontanee su [jobs. [...]  Se hai bisogno di ulteriori informazioni, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2943 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 89
   📊 Token totali stimati: 537
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Contatti telefonici risorse umane  [ASSISTENTE] Per contattare le Risorse Umane di Humanitas, ti consiglio di visitare la pagina dedicata alle opportunità di lavoro e alle candidature spontanee su [jobs. [...]  Se hai bisogno di ulteriori informazioni, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:54.219715
====================================================================================================
📋 Session ID: classify_1756762914
⏱️  Processing Time: 3.228s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (309 chars):
   [UTENTE] Contatti telefonici risorse umane  [ASSISTENTE] Per contattare le Risorse Umane di Humanitas, ti consiglio di visitare la pagina dedicata alle opportunità di lavoro e alle candidature spon...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione c72f9224acd4de774d74f1871c7e4443 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 91
   📊 Token totali: 539
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 539 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 91
   📊 Token conversazione finale: 91
   📊 Token totali: 539
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 312 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Fate il microbiota? [ASSISTENTE] Sì, in Humanitas è possibile effettuare esami relativi al microbiota. [...]  Se hai bisogno di ulteriori informazioni o assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2855 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 91
   📊 Token totali stimati: 539
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Fate il microbiota? [ASSISTENTE] Sì, in Humanitas è possibile effettuare esami relativi al microbiota. [...]  Se hai bisogno di ulteriori informazioni o assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'esistenza e la disponibilità dell'ospedale Humanitas di effettuare esami relativi al microbiota.", 'predicted_label': 'Analisi'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:55.757329
====================================================================================================
📋 Session ID: classify_1756762915
⏱️  Processing Time: 1.449s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (312 chars):
   [UTENTE] Fate il microbiota? [ASSISTENTE] Sì, in Humanitas è possibile effettuare esami relativi al microbiota. Per maggiori dettagli, ti consiglio di contattare direttamente l'ospedale o consultar...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (192 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'esistenza e la disponibilità dell'ospedale Humanitas di effettuare esami relativi al microbiota.", 'predicted_label': 'Analisi'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.95
   motivation: La conversazione verte sull'esistenza e la disponibilità dell'ospedale Humanitas di effettuare esami relativi al microbiota.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'esistenza e la disponibilità dell'ospedale Humanitas di effettuare esami relativi al microbiota.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 5dad80abea9f615e47c8fb0bd68d625c classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 234
   📊 Token totali: 662
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 662 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 234
   📊 Token conversazione finale: 234
   📊 Token totali: 662
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 741 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Contatti pancreas center [ASSISTENTE] Il Centro per le Malattie del Pancreas e del Duodeno si trova presso l'Istituto Clinico Humanitas, in Via Manzoni 56, 20089 Rozzano (Milano). Per maggiori informazioni, puoi visitare la pagina dedicata al [Centro per le Malattie del Pancreas e del Du..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 234
   📊 Token totali stimati: 662
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Contatti pancreas center [ASSISTENTE] Il Centro per le Malattie del Pancreas e del Duodeno si trova presso l'Istituto Clinico Humanitas, in Via Manzoni 56, 20089 Rozzano (Milano). Per maggiori informazioni, puoi visitare la pagina dedicata al [Centro per le Malattie del Pancreas e del Du..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': 'La conversazione verte sul Centro per le Malattie del Pancreas e del Duodeno, che rientra nella categoria delle Malattie del Metabolismo e della Nutrizione.', 'predicted_label': 'Centro Malattie del Metabolismo e della Nutrizione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:41:57.737577
====================================================================================================
📋 Session ID: classify_1756762917
⏱️  Processing Time: 1.882s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (741 chars):
   [UTENTE] Contatti pancreas center [ASSISTENTE] Il Centro per le Malattie del Pancreas e del Duodeno si trova presso l'Istituto Clinico Humanitas, in Via Manzoni 56, 20089 Rozzano (Milano). Per magg...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (266 chars):
   {'confidence': 0.9, 'motivation': 'La conversazione verte sul Centro per le Malattie del Pancreas e del Duodeno, che rientra nella categoria delle Malattie del Metabolismo e della Nutrizione.', 'predicted_label': 'Centro Malattie del Metabolismo e della Nutrizione'}

📊 Parsed Response:
   predicted_label: Centro Malattie del Metabolismo e della Nutrizione
   confidence: 0.9
   motivation: La conversazione verte sul Centro per le Malattie del Pancreas e del Duodeno, che rientra nella categoria delle Malattie del Metabolismo e della Nutrizione.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sul Centro per le Malattie del Pancreas e del Duodeno, che rientra nella categoria delle Malattie del Metabolismo e della Nutrizione.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 317fabc782e0d47980e4e1df74499b7a classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Centro Malattie del Metabolismo e della Nutrizione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 475
   📊 Token totali: 923
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 923 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 475
   📊 Token conversazione finale: 475
   📊 Token totali: 923
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1618 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] informazione su riabilitazione post intervento protesi anca [ASSISTENTE] La riabilitazione post-intervento di protesi d'anca è un processo fondamentale per il recupero ottimale. [...] it/unita-operative/ortopedia-protesica-mininvasiva-anca-ginocchio)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2927 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 475
   📊 Token totali stimati: 923
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] informazione su riabilitazione post intervento protesi anca [ASSISTENTE] La riabilitazione post-intervento di protesi d'anca è un processo fondamentale per il recupero ottimale. [...] it/unita-operative/ortopedia-protesica-mininvasiva-anca-ginocchio)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'Analisi', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:00.228176
====================================================================================================
📋 Session ID: classify_1756762920
⏱️  Processing Time: 2.398s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1618 chars):
   [UTENTE] informazione su riabilitazione post intervento protesi anca [ASSISTENTE] La riabilitazione post-intervento di protesi d'anca è un processo fondamentale per il recupero ottimale. In Humanit...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (99 chars):
   {'predicted_label': 'Analisi', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.6
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.600
   [████████████░░░░░░░░] 60.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 1de6e585b0ff63a5faa65acd27d9effd classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 137
   📊 Token totali: 565
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 565 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 137
   📊 Token conversazione finale: 137
   📊 Token totali: 565
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 436 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Il centro prelievi a fiordaliso è aperto? [ASSISTENTE] Il centro prelievi di Humanitas Medical Care Fiordaliso si trova in Via Eugenio Curiel, 25, 20089 - Rozzano (MI). [...]  Se hai bisogno di ulteriori dettagli, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2841 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 137
   📊 Token totali stimati: 565
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Il centro prelievi a fiordaliso è aperto? [ASSISTENTE] Il centro prelievi di Humanitas Medical Care Fiordaliso si trova in Via Eugenio Curiel, 25, 20089 - Rozzano (MI). [...]  Se hai bisogno di ulteriori dettagli, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{\n  "name": "classify_conversation",\n  "arguments": {\n    "predicted_label": "Servizi aziendali",\n'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:02.138583
====================================================================================================
📋 Session ID: classify_1756762922
⏱️  Processing Time: 1.819s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (436 chars):
   [UTENTE] Il centro prelievi a fiordaliso è aperto? [ASSISTENTE] Il centro prelievi di Humanitas Medical Care Fiordaliso si trova in Via Eugenio Curiel, 25, 20089 - Rozzano (MI). Per informazioni su...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{\n  "name": "classify_conversation",\n  "arguments": {\n    "predicted_label": "Servizi aziendali",\n'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{
  "name": "classify_conversation",
  "arguments": {
    "predicted_label": "Servizi aziendali",

----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{
  "name": "classify_conversation",
  "arguments": {
    "predicted_label": "Servizi aziendali",

----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7073e30ce3134e5e69f0a5dc4951fc7a classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 213
   📊 Token totali: 641
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 641 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 213
   📊 Token conversazione finale: 213
   📊 Token totali: 641
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 718 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, stamattina ho fatto un monitoraggio presso l'humanitas fertility center ma mi sono dimenticata di richiedere il certificato giustificativo per il lavoro. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2844 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 213
   📊 Token totali stimati: 641
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, stamattina ho fatto un monitoraggio presso l'humanitas fertility center ma mi sono dimenticata di richiedere il certificato giustificativo per il lavoro. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:05.100974
====================================================================================================
📋 Session ID: classify_1756762925
⏱️  Processing Time: 2.874s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (718 chars):
   [UTENTE] Buongiorno, stamattina ho fatto un monitoraggio presso l'humanitas fertility center ma mi sono dimenticata di richiedere il certificato giustificativo per il lavoro. Come posso fare? [ASSI...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 70e56fb277344c11c3bdfc0082ff6b6c classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 364
   📊 Token totali: 792
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 792 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 364
   📊 Token conversazione finale: 364
   📊 Token totali: 792
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1166 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non ho ricevuto il rimborso per una visita non effettuata  [ASSISTENTE] Se non hai ricevuto il rimborso per una visita non effettuata, posso aiutarti a capire come procedere. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2808 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 364
   📊 Token totali stimati: 792
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non ho ricevuto il rimborso per una visita non effettuata  [ASSISTENTE] Se non hai ricevuto il rimborso per una visita non effettuata, posso aiutarti a capire come procedere. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla richiesta di rimborso per una visita non effettuata e sul modo per ottenerlo. L'assistente fornisce inf"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:07.409464
====================================================================================================
📋 Session ID: classify_1756762927
⏱️  Processing Time: 2.215s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1166 chars):
   [UTENTE] Non ho ricevuto il rimborso per una visita non effettuata  [ASSISTENTE] Se non hai ricevuto il rimborso per una visita non effettuata, posso aiutarti a capire come procedere. Sei attualmen...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla richiesta di rimborso per una visita non effettuata e sul modo per ottenerlo. L'assistente fornisce inf"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla richiesta di rimborso per una visita non effettuata e sul modo per ottenerlo. L'assistente fornisce inf
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla richiesta di rimborso per una visita non effettuata e sul modo per ottenerlo. L'assistente fornisce inf
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione debff910c9c22c0459630108a927f219 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 279
   📊 Token totali: 727
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 727 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 279
   📊 Token conversazione finale: 279
   📊 Token totali: 727
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 902 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao! Fate il [ASSISTENTE] Potresti specificare meglio la tua domanda? Così posso aiutarti nel modo migliore! [UTENTE] fate il percorso microbiota? [ASSISTENTE] Sì, in Humanitas è possibile effettuare il percorso per la valutazione del microbiota. Per maggiori dettagli, puoi visitare la ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 279
   📊 Token totali stimati: 727
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao! Fate il [ASSISTENTE] Potresti specificare meglio la tua domanda? Così posso aiutarti nel modo migliore! [UTENTE] fate il percorso microbiota? [ASSISTENTE] Sì, in Humanitas è possibile effettuare il percorso per la valutazione del microbiota. Per maggiori dettagli, puoi visitare la ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'informativa relativa al percorso microbiota offerto da Humanitas. L'utente richiede e riceve un link all"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:09.162539
====================================================================================================
📋 Session ID: classify_1756762929
⏱️  Processing Time: 1.659s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (902 chars):
   [UTENTE] Ciao! Fate il [ASSISTENTE] Potresti specificare meglio la tua domanda? Così posso aiutarti nel modo migliore! [UTENTE] fate il percorso microbiota? [ASSISTENTE] Sì, in Humanitas è possibil...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'informativa relativa al percorso microbiota offerto da Humanitas. L'utente richiede e riceve un link all"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sull'informativa relativa al percorso microbiota offerto da Humanitas. L'utente richiede e riceve un link all
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sull'informativa relativa al percorso microbiota offerto da Humanitas. L'utente richiede e riceve un link all
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 8f819b18b1d6f7d3f6638796e801988f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 187
   📊 Token totali: 615
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 615 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 187
   📊 Token conversazione finale: 187
   📊 Token totali: 615
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 553 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] E' possibile fare presso di voi scintigrafia total body  [ASSISTENTE] Sì, presso Humanitas è possibile effettuare la scintigrafia ossea globale corporea, che è una metodica di diagnostica per immagini utilizzata per studiare l'apparato scheletrico. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2865 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 187
   📊 Token totali stimati: 615
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] E' possibile fare presso di voi scintigrafia total body  [ASSISTENTE] Sì, presso Humanitas è possibile effettuare la scintigrafia ossea globale corporea, che è una metodica di diagnostica per immagini utilizzata per studiare l'apparato scheletrico. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:11.121768
====================================================================================================
📋 Session ID: classify_1756762931
⏱️  Processing Time: 1.868s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (553 chars):
   [UTENTE] E' possibile fare presso di voi scintigrafia total body  [ASSISTENTE] Sì, presso Humanitas è possibile effettuare la scintigrafia ossea globale corporea, che è una metodica di diagnostica ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 23e8069cd4d378c7662de7c8fd9b407f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 213
   📊 Token totali: 661
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 661 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 213
   📊 Token conversazione finale: 213
   📊 Token totali: 661
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 768 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere il nome di questa relazione per l'ecografia per fare Vicenza Venosa agli arti inferiori [ASSISTENTE] Non ho trovato informazioni specifiche per l'ecografia venosa agli arti inferiori nei documenti caricati. Se hai bisogno di ulteriori dettagli o di un documento specifico, f..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 213
   📊 Token totali stimati: 661
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere il nome di questa relazione per l'ecografia per fare Vicenza Venosa agli arti inferiori [ASSISTENTE] Non ho trovato informazioni specifiche per l'ecografia venosa agli arti inferiori nei documenti caricati. Se hai bisogno di ulteriori dettagli o di un documento specifico, f..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'Analisi', 'confidence': 0.95, 'motivation': "La conversazione verte sull'ottenere informazioni su una specifica ecografia e sulle sue preparazioni, il che indica chiaramente la categoria 'Analisi'. La confidenza è alta poiché l'intento dell'utente è molto chiaro."}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:13.107478
====================================================================================================
📋 Session ID: classify_1756762933
⏱️  Processing Time: 1.896s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (768 chars):
   [UTENTE] Vorrei sapere il nome di questa relazione per l'ecografia per fare Vicenza Venosa agli arti inferiori [ASSISTENTE] Non ho trovato informazioni specifiche per l'ecografia venosa agli arti i...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (286 chars):
   {'predicted_label': 'Analisi', 'confidence': 0.95, 'motivation': "La conversazione verte sull'ottenere informazioni su una specifica ecografia e sulle sue preparazioni, il che indica chiaramente la categoria 'Analisi'. La confidenza è alta poiché l'intento dell'utente è molto chiaro."}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.95
   motivation: La conversazione verte sull'ottenere informazioni su una specifica ecografia e sulle sue preparazioni, il che indica chiaramente la categoria 'Analisi'. La confidenza è alta poiché l'intento dell'utente è molto chiaro.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ottenere informazioni su una specifica ecografia e sulle sue preparazioni, il che indica chiaramente la categoria 'Analisi'. La confidenza è alta poiché l'intento dell'utente è molto chiaro.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione e3163386f017938857bce8630bef2523 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 180
   📊 Token totali: 628
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 628 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 180
   📊 Token conversazione finale: 180
   📊 Token totali: 628
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 607 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] mi serve sapere solo devo fare scrivere sull impegnativa per iniziare a fare radioterapia con il servizio sanitario nazionale [ASSISTENTE] Non ho trovato informazioni specifiche su cosa scrivere sull'impegnativa per iniziare la radioterapia con il Servizio Sanitario Nazionale. Ti consigl..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 180
   📊 Token totali stimati: 628
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] mi serve sapere solo devo fare scrivere sull impegnativa per iniziare a fare radioterapia con il servizio sanitario nazionale [ASSISTENTE] Non ho trovato informazioni specifiche su cosa scrivere sull'impegnativa per iniziare la radioterapia con il Servizio Sanitario Nazionale. Ti consigl..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name":"classify_conversation","arguments": {"predicted_label": "Servizi aziendali", "confidence"'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:15.213929
====================================================================================================
📋 Session ID: classify_1756762935
⏱️  Processing Time: 2.020s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (607 chars):
   [UTENTE] mi serve sapere solo devo fare scrivere sull impegnativa per iniziare a fare radioterapia con il servizio sanitario nazionale [ASSISTENTE] Non ho trovato informazioni specifiche su cosa sc...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name":"classify_conversation","arguments": {"predicted_label": "Servizi aziendali", "confidence"'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name":"classify_conversation","arguments": {"predicted_label": "Servizi aziendali", "confidence"
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name":"classify_conversation","arguments": {"predicted_label": "Servizi aziendali", "confidence"
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d5eee37f505376d9fa500eb48faac701 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 195
   📊 Token totali: 623
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 623 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 195
   📊 Token conversazione finale: 195
   📊 Token totali: 623
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 632 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, durante la visita proctologica viene eseguita anche l'anoscopia? [ASSISTENTE] Durante la visita proctologica, il medico può decidere di eseguire un'anoscopia se lo ritiene opportuno per una più accurata esplorazione rettale interna. [...] it/visite-ed-esami/visita-proctologica)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2895 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 195
   📊 Token totali stimati: 623
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, durante la visita proctologica viene eseguita anche l'anoscopia? [ASSISTENTE] Durante la visita proctologica, il medico può decidere di eseguire un'anoscopia se lo ritiene opportuno per una più accurata esplorazione rettale interna. [...] it/visite-ed-esami/visita-proctologica)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.7, 'motivation': "La conversazione verte sulla visita proctologica e sull'esecuzione dell'anoscopia durante la stessa, il che indica una discussione su una visita specialistica.", 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:16.984401
====================================================================================================
📋 Session ID: classify_1756762936
⏱️  Processing Time: 1.683s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (632 chars):
   [UTENTE] Buongiorno, durante la visita proctologica viene eseguita anche l'anoscopia? [ASSISTENTE] Durante la visita proctologica, il medico può decidere di eseguire un'anoscopia se lo ritiene oppo...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (239 chars):
   {'confidence': 0.7, 'motivation': "La conversazione verte sulla visita proctologica e sull'esecuzione dell'anoscopia durante la stessa, il che indica una discussione su una visita specialistica.", 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.7
   motivation: La conversazione verte sulla visita proctologica e sull'esecuzione dell'anoscopia durante la stessa, il che indica una discussione su una visita specialistica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.700
   [██████████████░░░░░░] 70.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla visita proctologica e sull'esecuzione dell'anoscopia durante la stessa, il che indica una discussione su una visita specialistica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 971f3a0289d41be4a0e9ee02c7bffbdb classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 482
   📊 Token totali: 910
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 910 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 482
   📊 Token conversazione finale: 482
   📊 Token totali: 910
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1654 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Quanto costa la rinoplastica in questo ospedale? [ASSISTENTE] Non ho informazioni specifiche sui costi delle procedure come la rinoplastica. [...]  Se hai altre domande, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2797 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 482
   📊 Token totali stimati: 910
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Quanto costa la rinoplastica in questo ospedale? [ASSISTENTE] Non ho informazioni specifiche sui costi delle procedure come la rinoplastica. [...]  Se hai altre domande, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.85, 'motivation': 'La conversazione verte principalmente sulla prenotazione di un intervento di rinoplastica e sul costo associato a tale procedura.', 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:18.772544
====================================================================================================
📋 Session ID: classify_1756762938
⏱️  Processing Time: 1.701s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1654 chars):
   [UTENTE] Quanto costa la rinoplastica in questo ospedale? [ASSISTENTE] Non ho informazioni specifiche sui costi delle procedure come la rinoplastica. Ti consiglio di contattare direttamente l'osped...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (202 chars):
   {'confidence': 0.85, 'motivation': 'La conversazione verte principalmente sulla prenotazione di un intervento di rinoplastica e sul costo associato a tale procedura.', 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.85
   motivation: La conversazione verte principalmente sulla prenotazione di un intervento di rinoplastica e sul costo associato a tale procedura.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.850
   [█████████████████░░░] 85.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla prenotazione di un intervento di rinoplastica e sul costo associato a tale procedura.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione e6c2087fd16d2ad26350a1ea6b9c3001 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 405
   📊 Token totali: 859
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 859 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 405
   📊 Token conversazione finale: 405
   📊 Token totali: 859
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1372 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho registrato mio figlio minorenne francesco scaccia, il sito e' PESSIMO [UTENTE] non riesco a scaricare il suo refertto [ASSISTENTE] Mi dispiace che abbia avuto un'esperienza negativa con il sito. [...]  Come posso aiutarti oggi?"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2938 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 405
   📊 Token totali stimati: 859
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho registrato mio figlio minorenne francesco scaccia, il sito e' PESSIMO [UTENTE] non riesco a scaricare il suo refertto [ASSISTENTE] Mi dispiace che abbia avuto un'esperienza negativa con il sito. [...]  Come posso aiutarti oggi?"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'Referti e Cartelle Cliniche', 'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla difficoltà dell'utente nel recuperare il referto del figlio minorenne, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata."}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:20.722510
====================================================================================================
📋 Session ID: classify_1756762940
⏱️  Processing Time: 1.864s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1372 chars):
   [UTENTE] ho registrato mio figlio minorenne francesco scaccia, il sito e' PESSIMO [UTENTE] non riesco a scaricare il suo refertto [ASSISTENTE] Mi dispiace che abbia avuto un'esperienza negativa con...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (267 chars):
   {'predicted_label': 'Referti e Cartelle Cliniche', 'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla difficoltà dell'utente nel recuperare il referto del figlio minorenne, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata."}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte principalmente sulla difficoltà dell'utente nel recuperare il referto del figlio minorenne, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla difficoltà dell'utente nel recuperare il referto del figlio minorenne, quindi la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7621fa85861839cfbb8c78b2af9e5a02 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 371
   📊 Token totali: 819
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 819 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 371
   📊 Token conversazione finale: 371
   📊 Token totali: 819
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1214 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno vi contatto seguito visita effettuata nella quale mi hanno informato che ho un tumore al seno. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2851 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 371
   📊 Token totali stimati: 819
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno vi contatto seguito visita effettuata nella quale mi hanno informato che ho un tumore al seno. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of conversation:**\n\n```json\n{\n  "function": "classify_conversation",\n  "arguments":'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:22.970468
====================================================================================================
📋 Session ID: classify_1756762942
⏱️  Processing Time: 2.162s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1214 chars):
   [UTENTE] Buongiorno vi contatto seguito visita effettuata nella quale mi hanno informato che ho un tumore al seno. Vorrei quindi chiedere tempistica per vedere specialista attraverso servizio sanit...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Classification of conversation:**\n\n```json\n{\n  "function": "classify_conversation",\n  "arguments":'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Classification of conversation:**

```json
{
  "function": "classify_conversation",
  "arguments":
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Classification of conversation:**

```json
{
  "function": "classify_conversation",
  "arguments":
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d9d30181e039a4c2d01200713e450e4d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 175
   📊 Token totali: 624
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 624 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 175
   📊 Token conversazione finale: 175
   📊 Token totali: 624
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 619 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Volevo prenotare la visita del programma di prevenzione infarto che voi avete Proposto iscrivendovi al sito [ASSISTENTE] Per quanto riguarda la prenotazione di visite o programmi specifici, ti consiglio di fornirmi maggiori dettagli sul programma di prevenzione infarto a cui ti riferisci..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 175
   📊 Token totali stimati: 624
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Volevo prenotare la visita del programma di prevenzione infarto che voi avete Proposto iscrivendovi al sito [ASSISTENTE] Per quanto riguarda la prenotazione di visite o programmi specifici, ti consiglio di fornirmi maggiori dettagli sul programma di prevenzione infarto a cui ti riferisci..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '** La conversazione principale è incentrata sulla prenotazione della visita del programma di prevenzione infarto offerto da Humanitas, il che giust'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:26.016937
====================================================================================================
📋 Session ID: classify_1756762946
⏱️  Processing Time: 2.959s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (619 chars):
   [UTENTE] Volevo prenotare la visita del programma di prevenzione infarto che voi avete Proposto iscrivendovi al sito [ASSISTENTE] Per quanto riguarda la prenotazione di visite o programmi specifici...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (212 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '** La conversazione principale è incentrata sulla prenotazione della visita del programma di prevenzione infarto offerto da Humanitas, il che giust'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione principale è incentrata sulla prenotazione della visita del programma di prevenzione infarto offerto da Humanitas, il che giust
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione principale è incentrata sulla prenotazione della visita del programma di prevenzione infarto offerto da Humanitas, il che giust
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione c091e0a37408f57713fa2bdec51b0feb classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 324
   📊 Token totali: 752
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 752 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 324
   📊 Token conversazione finale: 324
   📊 Token totali: 752
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1126 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2687 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 324
   📊 Token totali stimati: 752
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai referti degli esami del sangue attraverso la piattaforma 'Humanitas con te', pertanto la categoria più adatta è 'Referti e Cartelle Cliniche'. La confidenza è alta poiché l'argomento trattato è molto specifico e ben definito.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:28.454854
====================================================================================================
📋 Session ID: classify_1756762948
⏱️  Processing Time: 2.351s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1126 chars):
   [UTENTE] Ciao Giulia. [ASSISTENTE] Ciao! Come posso esserti utile oggi? 😊 [UTENTE] È possibile che su “humanitas con te” io abbia potuto scaricare un referto parziali degli esami del sangue che ho ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (352 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai referti degli esami del sangue attraverso la piattaforma 'Humanitas con te', pertanto la categoria più adatta è 'Referti e Cartelle Cliniche'. La confidenza è alta poiché l'argomento trattato è molto specifico e ben defini...

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'accesso ai referti degli esami del sangue attraverso la piattaforma 'Humanitas con te', pertanto la categoria più adatta è 'Referti e Cartelle Cliniche'. La confidenza è alta poiché l'argomento trattato è molto specifico e ben definito.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso ai referti degli esami del sangue attraverso la piattaforma 'Humanitas con te', pertanto la categoria più adatta è 'Referti e Cartelle Cliniche'. La confidenza è alta poiché l'argomento trattato è molto specifico e ben definito.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione cb47a1a5360c7352dff05db8a4e532ed classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 215
   📊 Token totali: 664
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 664 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 215
   📊 Token conversazione finale: 215
   📊 Token totali: 664
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 789 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] devo manmdare una ricetta a voi unita operativa dermatologica come faccio [ASSISTENTE] Per inviare una ricetta all'unità operativa dermatologica, ti consiglio di verificare se ci sono indicazioni specifiche nei documenti che hai caricato. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2928 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 215
   📊 Token totali stimati: 664
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] devo manmdare una ricetta a voi unita operativa dermatologica come faccio [ASSISTENTE] Per inviare una ricetta all'unità operativa dermatologica, ti consiglio di verificare se ci sono indicazioni specifiche nei documenti che hai caricato. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione riguarda l'invio di una ricetta all'unità operativa dermatologica dell'ospedale Humanitas, che rientra nella categoria dei servizi aziendali.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:30.313620
====================================================================================================
📋 Session ID: classify_1756762950
⏱️  Processing Time: 1.773s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (789 chars):
   [UTENTE] devo manmdare una ricetta a voi unita operativa dermatologica come faccio [ASSISTENTE] Per inviare una ricetta all'unità operativa dermatologica, ti consiglio di verificare se ci sono indi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (236 chars):
   {'confidence': 0.95, 'motivation': "La conversazione riguarda l'invio di una ricetta all'unità operativa dermatologica dell'ospedale Humanitas, che rientra nella categoria dei servizi aziendali.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione riguarda l'invio di una ricetta all'unità operativa dermatologica dell'ospedale Humanitas, che rientra nella categoria dei servizi aziendali.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda l'invio di una ricetta all'unità operativa dermatologica dell'ospedale Humanitas, che rientra nella categoria dei servizi aziendali.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 4ca9f74a061bd8f47b2523f4044a6b00 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 439
   📊 Token totali: 887
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 887 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 439
   📊 Token conversazione finale: 439
   📊 Token totali: 887
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1473 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buonasera,  [ASSISTENTE] Buonasera! Come posso esserti utile? [UTENTE] ho scritto alla mail della dottoressa Trotta Manuela ma non è attiva  [ASSISTENTE] Per ottenere informazioni sulla dottoressa Manuela Trotta o per contattarla, ti consiglio di visitare la pagina [Ricerca Medici](https..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 439
   📊 Token totali stimati: 887
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buonasera,  [ASSISTENTE] Buonasera! Come posso esserti utile? [UTENTE] ho scritto alla mail della dottoressa Trotta Manuela ma non è attiva  [ASSISTENTE] Per ottenere informazioni sulla dottoressa Manuela Trotta o per contattarla, ti consiglio di visitare la pagina [Ricerca Medici](https..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '** La conversazione verte principalmente sulla ricerca di informazioni relative al centro bariatrico di Rozzano, inclusi gli orari di contatto. Non ci'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:33.210160
====================================================================================================
📋 Session ID: classify_1756762953
⏱️  Processing Time: 2.810s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1473 chars):
   [UTENTE] Buonasera,  [ASSISTENTE] Buonasera! Come posso esserti utile? [UTENTE] ho scritto alla mail della dottoressa Trotta Manuela ma non è attiva  [ASSISTENTE] Per ottenere informazioni sulla do...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '** La conversazione verte principalmente sulla ricerca di informazioni relative al centro bariatrico di Rozzano, inclusi gli orari di contatto. Non ci'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla ricerca di informazioni relative al centro bariatrico di Rozzano, inclusi gli orari di contatto. Non ci
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla ricerca di informazioni relative al centro bariatrico di Rozzano, inclusi gli orari di contatto. Non ci
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione fa76dbf0c73fc9313d6f49ea436ad523 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 331
   📊 Token totali: 779
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 779 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 331
   📊 Token conversazione finale: 331
   📊 Token totali: 779
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1062 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buonasera, vorrei poter consultare la cartella clinica di ADAMI MARIA, nata a Calci (PI) il 28/11/1943, operata presso il centro ortopedico il 22 luglio scorso e poi sottoposta ad un intervento d'urgenza all'intestino, dimessa il 7 agosto scorso. grazie [UTENTE] daniela Pugi, nuora della..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 331
   📊 Token totali stimati: 779
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buonasera, vorrei poter consultare la cartella clinica di ADAMI MARIA, nata a Calci (PI) il 28/11/1943, operata presso il centro ortopedico il 22 luglio scorso e poi sottoposta ad un intervento d'urgenza all'intestino, dimessa il 7 agosto scorso. grazie [UTENTE] daniela Pugi, nuora della..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '** La conversazione verte principalmente sulla richiesta di accesso alla cartella clinica della signora Adami Maria. La richiesta è stata inoltrata da'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:36.353486
====================================================================================================
📋 Session ID: classify_1756762956
⏱️  Processing Time: 3.057s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1062 chars):
   [UTENTE] buonasera, vorrei poter consultare la cartella clinica di ADAMI MARIA, nata a Calci (PI) il 28/11/1943, operata presso il centro ortopedico il 22 luglio scorso e poi sottoposta ad un inter...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '** La conversazione verte principalmente sulla richiesta di accesso alla cartella clinica della signora Adami Maria. La richiesta è stata inoltrata da'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla richiesta di accesso alla cartella clinica della signora Adami Maria. La richiesta è stata inoltrata da
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla richiesta di accesso alla cartella clinica della signora Adami Maria. La richiesta è stata inoltrata da
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d2da45e267dce199c28ffab0e0d4a27d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 379
   📊 Token totali: 827
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 827 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 379
   📊 Token conversazione finale: 379
   📊 Token totali: 827
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1310 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] sono stata operata in Humanitas per untumore al seno, il 17 dicembre 2024 e ho anche fatto le radioterapie  fino al 4 marzo. [...] 

Se hai bisogno di ulteriori informazioni, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2865 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 379
   📊 Token totali stimati: 827
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] sono stata operata in Humanitas per untumore al seno, il 17 dicembre 2024 e ho anche fatto le radioterapie  fino al 4 marzo. [...] 

Se hai bisogno di ulteriori informazioni, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione riguarda un appuntamento per una visita specialistica oncologica in Humanitas dopo che l'utente ha subito un intervento e terapie per un tumore al seno.", 'predicted_label': 'Visita Specialistica Oncologica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:38.318967
====================================================================================================
📋 Session ID: classify_1756762958
⏱️  Processing Time: 1.878s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1310 chars):
   [UTENTE] sono stata operata in Humanitas per untumore al seno, il 17 dicembre 2024 e ho anche fatto le radioterapie  fino al 4 marzo. ieri mi è arrivato un promemoria per unappuntamento per domani ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (261 chars):
   {'confidence': 0.95, 'motivation': "La conversazione riguarda un appuntamento per una visita specialistica oncologica in Humanitas dopo che l'utente ha subito un intervento e terapie per un tumore al seno.", 'predicted_label': 'Visita Specialistica Oncologica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica Oncologica
   confidence: 0.95
   motivation: La conversazione riguarda un appuntamento per una visita specialistica oncologica in Humanitas dopo che l'utente ha subito un intervento e terapie per un tumore al seno.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda un appuntamento per una visita specialistica oncologica in Humanitas dopo che l'utente ha subito un intervento e terapie per un tumore al seno.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 01638e4506811fcf0337d5f1a75db9e1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica Oncologica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 194
   📊 Token totali: 643
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 643 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 194
   📊 Token conversazione finale: 194
   📊 Token totali: 643
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 557 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno, devo ritirare un farmaco presso la farmacia dell'ospedale e volevo sapeere gli oraridella farmacua [ASSISTENTE] La Farmacia dell’Istituto Clinico Humanitas è aperta dal lunedì al venerdì (esclusi i festivi) nei seguenti orari:  
- Mattina: dalle 8:30 alle 13:00;  
- Pomeriggi..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 194
   📊 Token totali stimati: 643
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno, devo ritirare un farmaco presso la farmacia dell'ospedale e volevo sapeere gli oraridella farmacua [ASSISTENTE] La Farmacia dell’Istituto Clinico Humanitas è aperta dal lunedì al venerdì (esclusi i festivi) nei seguenti orari:  
- Mattina: dalle 8:30 alle 13:00;  
- Pomeriggi..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '| Etichetta predetta | Confidenza | Motivazione |'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:41.386135
====================================================================================================
📋 Session ID: classify_1756762961
⏱️  Processing Time: 2.980s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (557 chars):
   [UTENTE] buongiorno, devo ritirare un farmaco presso la farmacia dell'ospedale e volevo sapeere gli oraridella farmacua [ASSISTENTE] La Farmacia dell’Istituto Clinico Humanitas è aperta dal lunedì ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (114 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': '| Etichetta predetta | Confidenza | Motivazione |'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: | Etichetta predetta | Confidenza | Motivazione |
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   | Etichetta predetta | Confidenza | Motivazione |
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione c58654edd048a0b171a27dfb0bdece8a classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 161
   📊 Token totali: 610
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 610 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 161
   📊 Token conversazione finale: 161
   📊 Token totali: 610
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 569 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei mandare dei referti per mi ha madre che ha un tumore al pancreas per un consulto, devo prendere appuntamento o li posso inviare tramite email? [ASSISTENTE] Per richiedere un consulto o una "second opinion" presso Humanitas, è necessario seguire una procedura specifica. Ti consigli..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 161
   📊 Token totali stimati: 610
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei mandare dei referti per mi ha madre che ha un tumore al pancreas per un consulto, devo prendere appuntamento o li posso inviare tramite email? [ASSISTENTE] Per richiedere un consulto o una "second opinion" presso Humanitas, è necessario seguire una procedura specifica. Ti consigli..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:42.926012
====================================================================================================
📋 Session ID: classify_1756762962
⏱️  Processing Time: 1.451s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (569 chars):
   [UTENTE] Vorrei mandare dei referti per mi ha madre che ha un tumore al pancreas per un consulto, devo prendere appuntamento o li posso inviare tramite email? [ASSISTENTE] Per richiedere un consult...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche", 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3e301031034ea430e630918a143f11e9 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 169
   📊 Token totali: 617
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 617 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 169
   📊 Token conversazione finale: 169
   📊 Token totali: 617
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 541 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Programmare un viaggio [ASSISTENTE] Posso aiutarti a calcolare il percorso per raggiungere una delle sedi Humanitas. [...]  Fammi sapere come posso esserti utile!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2839 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 169
   📊 Token totali stimati: 617
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Programmare un viaggio [ASSISTENTE] Posso aiutarti a calcolare il percorso per raggiungere una delle sedi Humanitas. [...]  Fammi sapere come posso esserti utile!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.95,'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:44.710968
====================================================================================================
📋 Session ID: classify_1756762964
⏱️  Processing Time: 1.699s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (541 chars):
   [UTENTE] Programmare un viaggio [ASSISTENTE] Posso aiutarti a calcolare il percorso per raggiungere una delle sedi Humanitas. Da dove parti e quale sede desideri raggiungere? Inoltre, preferisci vi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.95,'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.95,
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.95,
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione bc9144424e42297a5cc897ebc2908688 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 245
   📊 Token totali: 673
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 673 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 245
   📊 Token conversazione finale: 245
   📊 Token totali: 673
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 863 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] non riesco a vedere i miei esami e la mia cartella clinica [UTENTE] mi dice non disponibili [ASSISTENTE] Ciao! Sono Giulia, l’assistente digitale dell’Istituto Clinico Humanitas. [...] 

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2856 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 245
   📊 Token totali stimati: 673
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] non riesco a vedere i miei esami e la mia cartella clinica [UTENTE] mi dice non disponibili [ASSISTENTE] Ciao! Sono Giulia, l’assistente digitale dell’Istituto Clinico Humanitas. [...] 

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai referti e alle cartelle cliniche dell'utente.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:46.346193
====================================================================================================
📋 Session ID: classify_1756762966
⏱️  Processing Time: 1.548s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (863 chars):
   [UTENTE] non riesco a vedere i miei esami e la mia cartella clinica [UTENTE] mi dice non disponibili [ASSISTENTE] Ciao! Sono Giulia, l’assistente digitale dell’Istituto Clinico Humanitas. Come poss...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (172 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai referti e alle cartelle cliniche dell'utente.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'accesso ai referti e alle cartelle cliniche dell'utente.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso ai referti e alle cartelle cliniche dell'utente.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 00955212a46b980820fc515f0fb437fa classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 256
   📊 Token totali: 704
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 704 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 256
   📊 Token conversazione finale: 256
   📊 Token totali: 704
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 813 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao Giulia devo fare un intervento di tenolisi dei flessori con il SSN come devo fare per prenotare [ASSISTENTE] Per effettuare un intervento con un'impegnativa del Servizio Sanitario Nazionale (SSN), ti consiglio di contattare direttamente Humanitas. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2958 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 256
   📊 Token totali stimati: 704
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao Giulia devo fare un intervento di tenolisi dei flessori con il SSN come devo fare per prenotare [ASSISTENTE] Per effettuare un intervento con un'impegnativa del Servizio Sanitario Nazionale (SSN), ti consiglio di contattare direttamente Humanitas. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:48.207720
====================================================================================================
📋 Session ID: classify_1756762968
⏱️  Processing Time: 1.775s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (813 chars):
   [UTENTE] ciao Giulia devo fare un intervento di tenolisi dei flessori con il SSN come devo fare per prenotare [ASSISTENTE] Per effettuare un intervento con un'impegnativa del Servizio Sanitario Naz...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f633ed7080f5b5695a4da6a523c822d0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 142
   📊 Token totali: 591
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 591 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 142
   📊 Token conversazione finale: 142
   📊 Token totali: 591
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 457 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, vorrei prenotare con il servizio sanitario nazionale di persona presso l'ospedale, dove devo andare?  [ASSISTENTE] Per prenotare una visita o un esame tramite il Servizio Sanitario Nazionale (SSN) di persona presso l'Istituto Clinico Humanitas, puoi recarti al **Building 4**,..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 142
   📊 Token totali stimati: 591
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, vorrei prenotare con il servizio sanitario nazionale di persona presso l'ospedale, dove devo andare?  [ASSISTENTE] Per prenotare una visita o un esame tramite il Servizio Sanitario Nazionale (SSN) di persona presso l'Istituto Clinico Humanitas, puoi recarti al **Building 4**,..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte chiaramente sulla prenotazione di una visita o esame tramite il Servizio Sanitario Nazionale (SSN) di persona presso l'Istituto Clinico Humanitas.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:50.040148
====================================================================================================
📋 Session ID: classify_1756762970
⏱️  Processing Time: 1.745s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (457 chars):
   [UTENTE] Buongiorno, vorrei prenotare con il servizio sanitario nazionale di persona presso l'ospedale, dove devo andare?  [ASSISTENTE] Per prenotare una visita o un esame tramite il Servizio Sanit...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (242 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte chiaramente sulla prenotazione di una visita o esame tramite il Servizio Sanitario Nazionale (SSN) di persona presso l'Istituto Clinico Humanitas.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte chiaramente sulla prenotazione di una visita o esame tramite il Servizio Sanitario Nazionale (SSN) di persona presso l'Istituto Clinico Humanitas.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte chiaramente sulla prenotazione di una visita o esame tramite il Servizio Sanitario Nazionale (SSN) di persona presso l'Istituto Clinico Humanitas.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione ccca60736fc7c2053c15618c3611bbba classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 175
   📊 Token totali: 603
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 603 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 175
   📊 Token conversazione finale: 175
   📊 Token totali: 603
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 640 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao mi sono accorta che nell' app Humanitas è rimasto registrato il mio vecchio recapito telefonico e quindi non ricevo il codice OTP. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2809 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 175
   📊 Token totali stimati: 603
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao mi sono accorta che nell' app Humanitas è rimasto registrato il mio vecchio recapito telefonico e quindi non ricevo il codice OTP. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:51.844545
====================================================================================================
📋 Session ID: classify_1756762971
⏱️  Processing Time: 1.719s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (640 chars):
   [UTENTE] Ciao mi sono accorta che nell' app Humanitas è rimasto registrato il mio vecchio recapito telefonico e quindi non ricevo il codice OTP. [ASSISTENTE] Per aggiornare il tuo recapito telefoni...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [74 more lines] ...
     Line 78: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Servizi aziendali", "confidenc
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 969f7e7726de935d576cefe5aa90f575 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 207
   📊 Token totali: 655
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 655 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 207
   📊 Token conversazione finale: 207
   📊 Token totali: 655
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 674 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] posso sapere il listini prezzi ? [ASSISTENTE] Potresti specificare a quale tipo di listino prezzi ti riferisci? Ad esempio, stai cercando informazioni sui costi di:

- Parcheggi;
- Ricoveri;
- Visite ed esami ambulatoriali;
- Cartelle cliniche.

Fammi sapere così posso aiutarti al meglio..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 207
   📊 Token totali stimati: 655
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] posso sapere il listini prezzi ? [ASSISTENTE] Potresti specificare a quale tipo di listino prezzi ti riferisci? Ad esempio, stai cercando informazioni sui costi di:

- Parcheggi;
- Ricoveri;
- Visite ed esami ambulatoriali;
- Cartelle cliniche.

Fammi sapere così posso aiutarti al meglio..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte sull'asportazione di condilomi e la richiesta di informazioni sui costi dell'intervento, che è una visita specialistica oncologica.", 'predicted_label': 'Visita Specialistica Oncologica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:53.598724
====================================================================================================
📋 Session ID: classify_1756762973
⏱️  Processing Time: 1.667s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (674 chars):
   [UTENTE] posso sapere il listini prezzi ? [ASSISTENTE] Potresti specificare a quale tipo di listino prezzi ti riferisci? Ad esempio, stai cercando informazioni sui costi di:

- Parcheggi;
- Ricover...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [80 more lines] ...
     Line 84: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (246 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte sull'asportazione di condilomi e la richiesta di informazioni sui costi dell'intervento, che è una visita specialistica oncologica.", 'predicted_label': 'Visita Specialistica Oncologica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica Oncologica
   confidence: 0.75
   motivation: La conversazione verte sull'asportazione di condilomi e la richiesta di informazioni sui costi dell'intervento, che è una visita specialistica oncologica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'asportazione di condilomi e la richiesta di informazioni sui costi dell'intervento, che è una visita specialistica oncologica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 34640bdbc253c19dd3a6e3888c5d6c7d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica Oncologica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 472
   📊 Token totali: 920
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 920 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 472
   📊 Token conversazione finale: 472
   📊 Token totali: 920
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1447 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Voglio prenotare in Torino  [ASSISTENTE] A Torino, Humanitas è presente con diverse strutture. [...]  

Se hai bisogno di ulteriori informazioni, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2836 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 472
   📊 Token totali stimati: 920
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Voglio prenotare in Torino  [ASSISTENTE] A Torino, Humanitas è presente con diverse strutture. [...]  

Se hai bisogno di ulteriori informazioni, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Prenotazione",\n  "confidence": 0.9,\n  "mo'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:55.412140
====================================================================================================
📋 Session ID: classify_1756762975
⏱️  Processing Time: 1.727s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1447 chars):
   [UTENTE] Voglio prenotare in Torino  [ASSISTENTE] A Torino, Humanitas è presente con diverse strutture. Potresti specificare se desideri prenotare presso una di queste sedi? Ecco le opzioni disponi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (197 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n  "predicted_label": "Prenotazione",\n  "confidence": 0.9,\n  "mo'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Prenotazione",
  "confidence": 0.9,
  "mo
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
  "predicted_label": "Prenotazione",
  "confidence": 0.9,
  "mo
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 283bce83513fcacad6afd5d4e902cd5e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 285
   📊 Token totali: 713
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 713 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 285
   📊 Token conversazione finale: 285
   📊 Token totali: 713
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 936 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] infusione di ferro per via endovenosa [ASSISTENTE] L'infusione di ferro per via endovenosa è una modalità di trattamento utilizzata per correggere l'anemia da carenza di ferro, specialmente nei casi in cui l'assorbimento orale è insufficiente o non praticabile. Tra i farmaci utilizzati p..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 285
   📊 Token totali stimati: 713
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] infusione di ferro per via endovenosa [ASSISTENTE] L'infusione di ferro per via endovenosa è una modalità di trattamento utilizzata per correggere l'anemia da carenza di ferro, specialmente nei casi in cui l'assorbimento orale è insufficiente o non praticabile. Tra i farmaci utilizzati p..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Analisi"}}'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:56.272238
====================================================================================================
📋 Session ID: classify_1756762976
⏱️  Processing Time: 0.774s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (936 chars):
   [UTENTE] infusione di ferro per via endovenosa [ASSISTENTE] L'infusione di ferro per via endovenosa è una modalità di trattamento utilizzata per correggere l'anemia da carenza di ferro, specialment...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (171 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Analisi"}}'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Analisi"}}
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Analisi"}}
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione e26ea7d487729cfee28090b0035a482b classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 272
   📊 Token totali: 721
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 721 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 272
   📊 Token conversazione finale: 272
   📊 Token totali: 721
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 930 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dopo quanto tempo scade una visita? [ASSISTENTE] Le ricette emesse prima del 30 dicembre 2024 hanno una validità di 180 giorni dalla data di prescrizione per effettuare la prenotazione. Le prestazioni possono essere erogabili e rendicontabili solo fino al 31 dicembre 2025【6:17†scraped_ht..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 272
   📊 Token totali stimati: 721
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Dopo quanto tempo scade una visita? [ASSISTENTE] Le ricette emesse prima del 30 dicembre 2024 hanno una validità di 180 giorni dalla data di prescrizione per effettuare la prenotazione. Le prestazioni possono essere erogabili e rendicontabili solo fino al 31 dicembre 2025【6:17†scraped_ht..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sulla durata di validità delle ricette mediche e la possibilità di utilizzare una visita precedente per prenotare un'operazione.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:58.053530
====================================================================================================
📋 Session ID: classify_1756762978
⏱️  Processing Time: 1.695s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (930 chars):
   [UTENTE] Dopo quanto tempo scade una visita? [ASSISTENTE] Le ricette emesse prima del 30 dicembre 2024 hanno una validità di 180 giorni dalla data di prescrizione per effettuare la prenotazione. Le...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (224 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sulla durata di validità delle ricette mediche e la possibilità di utilizzare una visita precedente per prenotare un'operazione.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte sulla durata di validità delle ricette mediche e la possibilità di utilizzare una visita precedente per prenotare un'operazione.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla durata di validità delle ricette mediche e la possibilità di utilizzare una visita precedente per prenotare un'operazione.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b067c4bcdc83e045fbea133686fc0996 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 167
   📊 Token totali: 616
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 616 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 167
   📊 Token conversazione finale: 167
   📊 Token totali: 616
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 576 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] devo prenotare esami del sangue e urine quale prestazione devo selezionare [ASSISTENTE] Per prenotare esami del sangue e delle urine, è necessario selezionare le prestazioni specifiche indicate dal medico nella prescrizione. [...] it/visite-ed-esami/esame-delle-urine-completo)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2955 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 167
   📊 Token totali stimati: 616
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] devo prenotare esami del sangue e urine quale prestazione devo selezionare [ASSISTENTE] Per prenotare esami del sangue e delle urine, è necessario selezionare le prestazioni specifiche indicate dal medico nella prescrizione. [...] it/visite-ed-esami/esame-delle-urine-completo)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Analisi", "confidence": 0.9, "'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:42:59.636679
====================================================================================================
📋 Session ID: classify_1756762979
⏱️  Processing Time: 1.497s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (576 chars):
   [UTENTE] devo prenotare esami del sangue e urine quale prestazione devo selezionare [ASSISTENTE] Per prenotare esami del sangue e delle urine, è necessario selezionare le prestazioni specifiche ind...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Analisi", "confidence": 0.9, "'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Analisi", "confidence": 0.9, "
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Analisi", "confidence": 0.9, "
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a27d4ae15d32ea5b16c21c408c4687b3 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 158
   📊 Token totali: 607
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 607 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 158
   📊 Token conversazione finale: 158
   📊 Token totali: 607
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 484 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Voglio fare una lamentela  [ASSISTENTE] Puoi inoltrare la tua lamentela all'Ufficio Relazioni con il Pubblico (URP) di Humanitas. [...]  

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2879 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 158
   📊 Token totali stimati: 607
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Voglio fare una lamentela  [ASSISTENTE] Puoi inoltrare la tua lamentela all'Ufficio Relazioni con il Pubblico (URP) di Humanitas. [...]  

Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'inoltro di una lamentela attraverso il servizio URP dell'ospedale Humanitas, pertanto la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:01.544474
====================================================================================================
📋 Session ID: classify_1756762981
⏱️  Processing Time: 1.821s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (484 chars):
   [UTENTE] Voglio fare una lamentela  [ASSISTENTE] Puoi inoltrare la tua lamentela all'Ufficio Relazioni con il Pubblico (URP) di Humanitas. Puoi inviare una segnalazione tramite il form dedicato che...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (239 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'inoltro di una lamentela attraverso il servizio URP dell'ospedale Humanitas, pertanto la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'inoltro di una lamentela attraverso il servizio URP dell'ospedale Humanitas, pertanto la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'inoltro di una lamentela attraverso il servizio URP dell'ospedale Humanitas, pertanto la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 7f71a919d94a45b4908da083d3fa4bc1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 260
   📊 Token totali: 709
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 709 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 260
   📊 Token conversazione finale: 260
   📊 Token totali: 709
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 924 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a pre otarw una visita. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2781 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 260
   📊 Token totali stimati: 709
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non riesco a pre otarw una visita. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sul problema riscontrato durante la prenotazione di una visita e l'assistente fornisce istruzioni su come risolvere il problema.", 'predicted_label': 'Prenotazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:03.352855
====================================================================================================
📋 Session ID: classify_1756762983
⏱️  Processing Time: 1.720s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (924 chars):
   [UTENTE] Non riesco a pre otarw una visita. Inserisco il cf pee [UTENTE] non riesco a prenotare una visita inserisco il codice fiscale ma non mi fa andare avanti con la password e mi dice di rivolg...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (224 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sul problema riscontrato durante la prenotazione di una visita e l'assistente fornisce istruzioni su come risolvere il problema.", 'predicted_label': 'Prenotazione'}

📊 Parsed Response:
   predicted_label: Prenotazione
   confidence: 0.95
   motivation: La conversazione verte sul problema riscontrato durante la prenotazione di una visita e l'assistente fornisce istruzioni su come risolvere il problema.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sul problema riscontrato durante la prenotazione di una visita e l'assistente fornisce istruzioni su come risolvere il problema.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione db1308122280aba989b3b1eb70de529d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Prenotazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 617
   📊 Token totali: 1065
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1065 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 617
   📊 Token conversazione finale: 617
   📊 Token totali: 1065
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1989 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, avrei bisogno di ritirare le immagini della mia tac con contrasto fatta il 28 Giugno. [...] it/info/referti-cartelle-cliniche/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2816 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 617
   📊 Token totali stimati: 1065
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, avrei bisogno di ritirare le immagini della mia tac con contrasto fatta il 28 Giugno. [...] it/info/referti-cartelle-cliniche/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sull'ottenimento del referto della TAC con contrasto eseguita dall'utente il 28 giugno. L'assistente fornisce informazioni dettagliate su dove e come ritirare il referto, inclusi gli orari di apertura dell'Ufficio Ritiro Referti.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:06.023573
====================================================================================================
📋 Session ID: classify_1756762986
⏱️  Processing Time: 2.583s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1989 chars):
   [UTENTE] Buongiorno, avrei bisogno di ritirare le immagini della mia tac con contrasto fatta il 28 Giugno. [ASSISTENTE] Per ritirare le immagini della tua TAC con contrasto, puoi seguire queste ind...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (355 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sull'ottenimento del referto della TAC con contrasto eseguita dall'utente il 28 giugno. L'assistente fornisce informazioni dettagliate su dove e come ritirare il referto, inclusi gli orari di apertura dell'Ufficio Ritiro Re...

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte principalmente sull'ottenimento del referto della TAC con contrasto eseguita dall'utente il 28 giugno. L'assistente fornisce informazioni dettagliate su dove e come ritirare il referto, inclusi gli orari di apertura dell'Ufficio Ritiro Referti.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sull'ottenimento del referto della TAC con contrasto eseguita dall'utente il 28 giugno. L'assistente fornisce informazioni dettagliate su dove e come ritirare il referto, inclusi gli orari di apertura dell'Ufficio Ritiro Referti.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 22608ba4b75c9e8e1c699de82e2d68b4 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 1026
   📊 Token totali: 1474
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1474 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 1026
   📊 Token conversazione finale: 1026
   📊 Token totali: 1474
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 3369 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE]  vorrei prenotare una visita per valutare una rinosettoplastica combinata. [...]  

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2898 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 1026
   📊 Token totali stimati: 1474
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE]  vorrei prenotare una visita per valutare una rinosettoplastica combinata. [...]  

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: Ecco i risultati della classificazione automatica della conversazione:\n\n| predicted_label       | co'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:09.195044
====================================================================================================
📋 Session ID: classify_1756762989
⏱️  Processing Time: 3.085s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (3369 chars):
   [UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE]  vorrei prenotare una visita per valutare una rinosettoplastica combinata.

Ho già effettuato visite e una TAC ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (193 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: Ecco i risultati della classificazione automatica della conversazione:\n\n| predicted_label       | co'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: Ecco i risultati della classificazione automatica della conversazione:

| predicted_label       | co
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: Ecco i risultati della classificazione automatica della conversazione:

| predicted_label       | co
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 5381d4c9da2317608c710047ffb8c1ea classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 329
   📊 Token totali: 777
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 777 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 329
   📊 Token conversazione finale: 329
   📊 Token totali: 777
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1102 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ieri sono stata contattata da questo numero 0282248506 perché tramite il dottor Toschi è stata prenotata una sacca è total body con senza mezzo di contrasto e una TAC in cefalo il problema che mi sono dimenticata di chiedere i codici esatti perché mi hanno detto di far fare l'impegnativa..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 329
   📊 Token totali stimati: 777
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ieri sono stata contattata da questo numero 0282248506 perché tramite il dottor Toschi è stata prenotata una sacca è total body con senza mezzo di contrasto e una TAC in cefalo il problema che mi sono dimenticata di chiedere i codici esatti perché mi hanno detto di far fare l'impegnativa..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:10.960875
====================================================================================================
📋 Session ID: classify_1756762990
⏱️  Processing Time: 1.679s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1102 chars):
   [UTENTE] Ieri sono stata contattata da questo numero 0282248506 perché tramite il dottor Toschi è stata prenotata una sacca è total body con senza mezzo di contrasto e una TAC in cefalo il problema...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d9a9e67f1a3d3a4f348a05f5ece09f22 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
   📈 Progresso LLM: 100/624
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 109
   📊 Token totali: 557
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 557 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 109
   📊 Token conversazione finale: 109
   📊 Token totali: 557
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 366 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia dopo il mio intervento c'è qualche servizio di trasporto a pagamento  [ASSISTENTE] Sì, Humanitas offre un servizio di trasporto a pagamento per i pazienti. [...]  Se hai bisogno di ulteriori informazioni o di assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2923 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 109
   📊 Token totali stimati: 557
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao Giulia dopo il mio intervento c'è qualche servizio di trasporto a pagamento  [ASSISTENTE] Sì, Humanitas offre un servizio di trasporto a pagamento per i pazienti. [...]  Se hai bisogno di ulteriori informazioni o di assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sul servizio di trasporto a pagamento offerto dall'ospedale Humanitas per i pazienti.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:12.551242
====================================================================================================
📋 Session ID: classify_1756762992
⏱️  Processing Time: 1.503s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (366 chars):
   [UTENTE] Ciao Giulia dopo il mio intervento c'è qualche servizio di trasporto a pagamento  [ASSISTENTE] Sì, Humanitas offre un servizio di trasporto a pagamento per i pazienti. Per maggiori dettagl...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (186 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sul servizio di trasporto a pagamento offerto dall'ospedale Humanitas per i pazienti.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sul servizio di trasporto a pagamento offerto dall'ospedale Humanitas per i pazienti.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sul servizio di trasporto a pagamento offerto dall'ospedale Humanitas per i pazienti.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 0b58a364c5dabf3c9b7b0da0c9ffcbd0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 273
   📊 Token totali: 722
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 722 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 273
   📊 Token conversazione finale: 273
   📊 Token totali: 722
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 995 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Giulia Devo scaricare on-line dei dei referti diagnostici con immagini ma sono due mesi che non riesco a farlo Come posso avere questi referti [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www.humanitas.it/info/refer..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 273
   📊 Token totali stimati: 722
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Giulia Devo scaricare on-line dei dei referti diagnostici con immagini ma sono due mesi che non riesco a farlo Come posso avere questi referti [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www.humanitas.it/info/refer..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche"}}'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:13.491197
====================================================================================================
📋 Session ID: classify_1756762993
⏱️  Processing Time: 0.853s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (995 chars):
   [UTENTE] Giulia Devo scaricare on-line dei dei referti diagnostici con immagini ma sono due mesi che non riesco a farlo Come posso avere questi referti [ASSISTENTE] Per i risultati del tuo esame, p...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche"}}'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche"}}
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Referti e Cartelle Cliniche"}}
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 8c44f78210bb5b54dc9af8d0f89977be classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 247
   📊 Token totali: 695
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 695 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 247
   📊 Token conversazione finale: 247
   📊 Token totali: 695
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 891 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei avere notizie sull’utilizzo del chondro filler nell’ artrosi del ginocchio, grazie  [ASSISTENTE] Non ho trovato informazioni specifiche sull'utilizzo del chondro filler nell'artrosi del ginocchio nei documenti forniti. [...] it/info/contatti/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2927 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 247
   📊 Token totali stimati: 695
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei avere notizie sull’utilizzo del chondro filler nell’ artrosi del ginocchio, grazie  [ASSISTENTE] Non ho trovato informazioni specifiche sull'utilizzo del chondro filler nell'artrosi del ginocchio nei documenti forniti. [...] it/info/contatti/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:14.345748
====================================================================================================
📋 Session ID: classify_1756762994
⏱️  Processing Time: 0.768s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (891 chars):
   [UTENTE] Vorrei avere notizie sull’utilizzo del chondro filler nell’ artrosi del ginocchio, grazie  [ASSISTENTE] Non ho trovato informazioni specifiche sull'utilizzo del chondro filler nell'artrosi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (184 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 3fdd406bc33afa73ed86ed62b917bd91 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 322
   📊 Token totali: 770
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 770 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 322
   📊 Token conversazione finale: 322
   📊 Token totali: 770
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 991 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno, in quale area trovo le convenzioni con alloggi vicino all'ospedale di rossno? [ASSISTENTE] Puoi trovare informazioni sulle convenzioni con alloggi vicino all'ospedale di Rozzano alla pagina dedicata. [...] it/info/viaggi/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2911 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 322
   📊 Token totali stimati: 770
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno, in quale area trovo le convenzioni con alloggi vicino all'ospedale di rossno? [ASSISTENTE] Puoi trovare informazioni sulle convenzioni con alloggi vicino all'ospedale di Rozzano alla pagina dedicata. [...] it/info/viaggi/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.9, '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:15.985067
====================================================================================================
📋 Session ID: classify_1756762995
⏱️  Processing Time: 1.553s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (991 chars):
   [UTENTE] buongiorno, in quale area trovo le convenzioni con alloggi vicino all'ospedale di rossno? [ASSISTENTE] Puoi trovare informazioni sulle convenzioni con alloggi vicino all'ospedale di Rozzan...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.9, '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.9, 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "alloggio", "confidence": 0.9, 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f78fbef4fac060d2e3503db1386fe29e classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 392
   📊 Token totali: 820
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 820 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 392
   📊 Token conversazione finale: 392
   📊 Token totali: 820
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1379 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao ho fatto una tac sabto 12/07/25 non vedo ancora i referti on line [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www. [...] it, indicando nome, cognome, codice fiscale e motivo della richiesta di assistenza"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2887 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 392
   📊 Token totali stimati: 820
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao ho fatto una tac sabto 12/07/25 non vedo ancora i referti on line [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www. [...] it, indicando nome, cognome, codice fiscale e motivo della richiesta di assistenza"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai referti online della TAC eseguita dall'utente il 12/07/25. L'assistente fornisce informazioni su come accedere alla sezione 'Referti e Cartelle Cliniche' del sito Humanitas e suggerisce di verificare la corretta procedura di accesso in caso di problemi.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:18.701495
====================================================================================================
📋 Session ID: classify_1756762998
⏱️  Processing Time: 2.630s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1379 chars):
   [UTENTE] ciao ho fatto una tac sabto 12/07/25 non vedo ancora i referti on line [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https:/...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (380 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai referti online della TAC eseguita dall'utente il 12/07/25. L'assistente fornisce informazioni su come accedere alla sezione 'Referti e Cartelle Cliniche' del sito Humanitas e suggerisce di verificare la corretta procedura ...

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'accesso ai referti online della TAC eseguita dall'utente il 12/07/25. L'assistente fornisce informazioni su come accedere alla sezione 'Referti e Cartelle Cliniche' del sito Humanitas e suggerisce di verificare la corretta procedura di accesso in caso di problemi.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso ai referti online della TAC eseguita dall'utente il 12/07/25. L'assistente fornisce informazioni su come accedere alla sezione 'Referti e Cartelle Cliniche' del sito Humanitas e suggerisce di verificare la corretta procedura di accesso in caso di problemi.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 63b3bf9ff2ba73412d147434d52d3d64 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 225
   📊 Token totali: 673
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 673 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 225
   📊 Token conversazione finale: 225
   📊 Token totali: 673
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 781 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, avrei necessità di sapere se il vostro macchinario aperto per un risonanza magnetica rachide lombosacrale supporta un circonferenza di cm 140 [ASSISTENTE] Non ho trovato informazioni specifiche sulla capacità del macchinario per la risonanza magnetica aperta in termini di sup..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 225
   📊 Token totali stimati: 673
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, avrei necessità di sapere se il vostro macchinario aperto per un risonanza magnetica rachide lombosacrale supporta un circonferenza di cm 140 [ASSISTENTE] Non ho trovato informazioni specifiche sulla capacità del macchinario per la risonanza magnetica aperta in termini di sup..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sull'ottenere informazioni specifiche sulla capacità del macchinario per la risonanza magnetica aperta in termini di supporto per una circonferenza di 140 cm.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:20.692540
====================================================================================================
📋 Session ID: classify_1756763000
⏱️  Processing Time: 1.904s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (781 chars):
   [UTENTE] Buongiorno, avrei necessità di sapere se il vostro macchinario aperto per un risonanza magnetica rachide lombosacrale supporta un circonferenza di cm 140 [ASSISTENTE] Non ho trovato inform...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (268 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sull'ottenere informazioni specifiche sulla capacità del macchinario per la risonanza magnetica aperta in termini di supporto per una circonferenza di 140 cm.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.9
   motivation: La conversazione verte sull'ottenere informazioni specifiche sulla capacità del macchinario per la risonanza magnetica aperta in termini di supporto per una circonferenza di 140 cm.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ottenere informazioni specifiche sulla capacità del macchinario per la risonanza magnetica aperta in termini di supporto per una circonferenza di 140 cm.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f132859c25781292baa67a202e10ceb0 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 674
   📊 Token totali: 1122
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1122 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 674
   📊 Token conversazione finale: 674
   📊 Token totali: 1122
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2237 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, volevo sapere se la dottoressa nutrizionista può prepararmi la dieta del sistema immunitario e come posso contattarla per metterla al corrente dei mie problemi di salute. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2882 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 674
   📊 Token totali stimati: 1122
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno, volevo sapere se la dottoressa nutrizionista può prepararmi la dieta del sistema immunitario e come posso contattarla per metterla al corrente dei mie problemi di salute. [...]  Buona giornata!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** Prenotazione\n\n**Confidence:** 0.75\n\n**Motivation:** La conversazione verte prin'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:22.920761
====================================================================================================
📋 Session ID: classify_1756763002
⏱️  Processing Time: 2.142s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2237 chars):
   [UTENTE] Buongiorno, volevo sapere se la dottoressa nutrizionista può prepararmi la dieta del sistema immunitario e come posso contattarla per metterla al corrente dei mie problemi di salute. Ovvia...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** Prenotazione\n\n**Confidence:** 0.75\n\n**Motivation:** La conversazione verte prin'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted label:** Prenotazione

**Confidence:** 0.75

**Motivation:** La conversazione verte prin
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted label:** Prenotazione

**Confidence:** 0.75

**Motivation:** La conversazione verte prin
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 8429ea9319ce353dd858957a654505f1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 427
   📊 Token totali: 875
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 875 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 427
   📊 Token conversazione finale: 427
   📊 Token totali: 875
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1419 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao Giulia, mi puoi raccontare di più sul percorso del microbiota [ASSISTENTE] Il microbiota intestinale è un insieme di microrganismi che vivono nel nostro intestino e svolgono funzioni essenziali per la salute, come la regolazione dell'assorbimento dei nutrienti, la produzione di vita..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 427
   📊 Token totali stimati: 875
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao Giulia, mi puoi raccontare di più sul percorso del microbiota [ASSISTENTE] Il microbiota intestinale è un insieme di microrganismi che vivono nel nostro intestino e svolgono funzioni essenziali per la salute, come la regolazione dell'assorbimento dei nutrienti, la produzione di vita..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'Analisi', 'confidence': 0.6, 'motivation': '| predicted_label       | confidenza | motivazione                                                                 |'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:26.128042
====================================================================================================
📋 Session ID: classify_1756763006
⏱️  Processing Time: 3.120s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1419 chars):
   [UTENTE] ciao Giulia, mi puoi raccontare di più sul percorso del microbiota [ASSISTENTE] Il microbiota intestinale è un insieme di microrganismi che vivono nel nostro intestino e svolgono funzioni ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (183 chars):
   {'predicted_label': 'Analisi', 'confidence': 0.6, 'motivation': '| predicted_label       | confidenza | motivazione                                                                 |'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.6
   motivation: | predicted_label       | confidenza | motivazione                                                                 |
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.600
   [████████████░░░░░░░░] 60.0%

🧠 Reasoning/Motivation:
   | predicted_label       | confidenza | motivazione                                                                 |
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 5326f31e302b1429bc00f4667690502d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 86
   📊 Token totali: 514
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 514 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 86
   📊 Token conversazione finale: 86
   📊 Token totali: 514
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 272 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Un e-mail de contact al spitalului  [ASSISTENTE] Pentru a contacta spitalul Humanitas din străinătate, vă recomand să utilizați pagina [Contact US](https://www.humanitas.net/contact/). Acolo veți găsi toate informațiile necesare pentru a lua legătura cu spitalul."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2868 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 86
   📊 Token totali stimati: 514
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Un e-mail de contact al spitalului  [ASSISTENTE] Pentru a contacta spitalul Humanitas din străinătate, vă recomand să utilizați pagina [Contact US](https://www.humanitas.net/contact/). Acolo veți găsi toate informațiile necesare pentru a lua legătura cu spitalul."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:29.151439
====================================================================================================
📋 Session ID: classify_1756763009
⏱️  Processing Time: 2.936s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (272 chars):
   [UTENTE] Un e-mail de contact al spitalului  [ASSISTENTE] Pentru a contacta spitalul Humanitas din străinătate, vă recomand să utilizați pagina [Contact US](https://www.humanitas.net/contact/). Aco...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (97 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 1ab2665ea4d71cfb1f75b8fd1def1dbd classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 366
   📊 Token totali: 814
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 814 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 366
   📊 Token conversazione finale: 366
   📊 Token totali: 814
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1240 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo ritirare il referto di una tac con contrasto di Parodi Damiano Mario è  [ASSISTENTE] Per il ritiro del referto di una TAC con contrasto, ti consiglio di verificare se il referto è disponibile online tramite [Humanitas con te](https://www.humanitasconte.it). Se non fosse consultabile..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 366
   📊 Token totali stimati: 814
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Devo ritirare il referto di una tac con contrasto di Parodi Damiano Mario è  [ASSISTENTE] Per il ritiro del referto di una TAC con contrasto, ti consiglio di verificare se il referto è disponibile online tramite [Humanitas con te](https://www.humanitasconte.it). Se non fosse consultabile..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: '}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:32.306990
====================================================================================================
📋 Session ID: classify_1756763012
⏱️  Processing Time: 3.068s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1240 chars):
   [UTENTE] Devo ritirare il referto di una tac con contrasto di Parodi Damiano Mario è  [ASSISTENTE] Per il ritiro del referto di una TAC con contrasto, ti consiglio di verificare se il referto è dis...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (91 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: '}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: 
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: 
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 41c484fc21ba0817f2bd3dee7a6033fd classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 245
   📊 Token totali: 693
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 693 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 245
   📊 Token conversazione finale: 245
   📊 Token totali: 693
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 827 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere come si svolge la visita cardiologica e se c'è una preparazione da fare [ASSISTENTE] La visita cardiologica è fondamentale per diagnosticare o monitorare disturbi cardiologici. [...] it/visite-ed-esami/visita-cardiologica)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2913 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 245
   📊 Token totali stimati: 693
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Vorrei sapere come si svolge la visita cardiologica e se c'è una preparazione da fare [ASSISTENTE] La visita cardiologica è fondamentale per diagnosticare o monitorare disturbi cardiologici. [...] it/visite-ed-esami/visita-cardiologica)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sulla visita cardiologica e sulle sue procedure, il che la rende pertinente alla categoria 'Visita Specialistica'.", 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:33.948534
====================================================================================================
📋 Session ID: classify_1756763013
⏱️  Processing Time: 1.555s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (827 chars):
   [UTENTE] Vorrei sapere come si svolge la visita cardiologica e se c'è una preparazione da fare [ASSISTENTE] La visita cardiologica è fondamentale per diagnosticare o monitorare disturbi cardiologic...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (217 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sulla visita cardiologica e sulle sue procedure, il che la rende pertinente alla categoria 'Visita Specialistica'.", 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.9
   motivation: La conversazione verte sulla visita cardiologica e sulle sue procedure, il che la rende pertinente alla categoria 'Visita Specialistica'.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla visita cardiologica e sulle sue procedure, il che la rende pertinente alla categoria 'Visita Specialistica'.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 989bac7812bf5fd5921ba4e691b8ff38 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 206
   📊 Token totali: 634
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 634 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 206
   📊 Token conversazione finale: 206
   📊 Token totali: 634
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 732 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno avrei bisogno del prezzo per l'esame fatto privatamente del testosterone totale [ASSISTENTE] Non ho trovato informazioni specifiche sul costo dell'esame del testosterone totale nei documenti forniti. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2887 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 206
   📊 Token totali stimati: 634
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno avrei bisogno del prezzo per l'esame fatto privatamente del testosterone totale [ASSISTENTE] Non ho trovato informazioni specifiche sul costo dell'esame del testosterone totale nei documenti forniti. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'esame del testosterone totale e sul costo associato a tale esame. L'utente cerca informazioni specifiche"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:36.159940
====================================================================================================
📋 Session ID: classify_1756763016
⏱️  Processing Time: 2.124s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (732 chars):
   [UTENTE] Buongiorno avrei bisogno del prezzo per l'esame fatto privatamente del testosterone totale [ASSISTENTE] Non ho trovato informazioni specifiche sul costo dell'esame del testosterone totale ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'esame del testosterone totale e sul costo associato a tale esame. L'utente cerca informazioni specifiche"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sull'esame del testosterone totale e sul costo associato a tale esame. L'utente cerca informazioni specifiche
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sull'esame del testosterone totale e sul costo associato a tale esame. L'utente cerca informazioni specifiche
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 63341102c69d7a04607744951982457d classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 93
   📊 Token totali: 541
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 541 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 93
   📊 Token conversazione finale: 93
   📊 Token totali: 541
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 333 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] chi è il direttore generale  [ASSISTENTE] Non ho trovato informazioni specifiche sul direttore generale di Humanitas nei documenti forniti. [...] it/info/contatti/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2841 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 93
   📊 Token totali stimati: 541
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] chi è il direttore generale  [ASSISTENTE] Non ho trovato informazioni specifiche sul direttore generale di Humanitas nei documenti forniti. [...] it/info/contatti/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione riguarda informazioni generali sull'ospedale Humanitas e non ha un contesto specifico per una categoria medica.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:37.800276
====================================================================================================
📋 Session ID: classify_1756763017
⏱️  Processing Time: 1.551s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (333 chars):
   [UTENTE] chi è il direttore generale  [ASSISTENTE] Non ho trovato informazioni specifiche sul direttore generale di Humanitas nei documenti forniti. Ti consiglio di contattare direttamente l'ospeda...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (206 chars):
   {'confidence': 0.95, 'motivation': "La conversazione riguarda informazioni generali sull'ospedale Humanitas e non ha un contesto specifico per una categoria medica.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione riguarda informazioni generali sull'ospedale Humanitas e non ha un contesto specifico per una categoria medica.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda informazioni generali sull'ospedale Humanitas e non ha un contesto specifico per una categoria medica.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 0dc863356f5f9483002d15fc6763fb43 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 281
   📊 Token totali: 729
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 729 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 281
   📊 Token conversazione finale: 281
   📊 Token totali: 729
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 912 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] fa TAC abdome vompleto senza e con mdc? [ASSISTENTE] Per sapere se Humanitas esegue una TAC addome completo senza e con mezzo di contrasto, devo verificare nella base di conoscenza. Un momento, per favore.Sì, Hu..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 281
   📊 Token totali stimati: 729
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] fa TAC abdome vompleto senza e con mdc? [ASSISTENTE] Per sapere se Humanitas esegue una TAC addome completo senza e con mezzo di contrasto, devo verificare nella base di conoscenza. Un momento, per favore.Sì, Hu..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'Analisi', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:39.259399
====================================================================================================
📋 Session ID: classify_1756763019
⏱️  Processing Time: 1.371s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (912 chars):
   [UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] fa TAC abdome vompleto senza e con mdc? [ASSISTENTE] Per sapere se Humanitas esegue una TAC addome completo sen...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (99 chars):
   {'predicted_label': 'Analisi', 'confidence': 0.6, 'motivation': 'Estratto da risposta descrittiva'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.6
   motivation: Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.600
   [████████████░░░░░░░░] 60.0%

🧠 Reasoning/Motivation:
   Estratto da risposta descrittiva
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 2e7ad7ae52baed67dda9b09d382bf76f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 229
   📊 Token totali: 677
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 677 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 229
   📊 Token conversazione finale: 229
   📊 Token totali: 677
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 700 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho un problema con una prenotazione [ASSISTENTE] Capisco, potresti dirmi di che tipo di prenotazione si tratta? È per una visita, un esame, un ricovero o altro? Inoltre, è stata effettuata tramite il Servizio Sanitario Nazionale (SSN) o privatamente? [UTENTE] privatamente [ASSISTENTE] Se..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 229
   📊 Token totali stimati: 677
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ho un problema con una prenotazione [ASSISTENTE] Capisco, potresti dirmi di che tipo di prenotazione si tratta? È per una visita, un esame, un ricovero o altro? Inoltre, è stata effettuata tramite il Servizio Sanitario Nazionale (SSN) o privatamente? [UTENTE] privatamente [ASSISTENTE] Se..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla prenotazione di un appuntamento privato presso Humanitas. L'assistente fornisce informazioni su come ac"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:42.341128
====================================================================================================
📋 Session ID: classify_1756763022
⏱️  Processing Time: 2.993s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (700 chars):
   [UTENTE] ho un problema con una prenotazione [ASSISTENTE] Capisco, potresti dirmi di che tipo di prenotazione si tratta? È per una visita, un esame, un ricovero o altro? Inoltre, è stata effettuata...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla prenotazione di un appuntamento privato presso Humanitas. L'assistente fornisce informazioni su come ac"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla prenotazione di un appuntamento privato presso Humanitas. L'assistente fornisce informazioni su come ac
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla prenotazione di un appuntamento privato presso Humanitas. L'assistente fornisce informazioni su come ac
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 303228343216069eef41503b759584c7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 179
   📊 Token totali: 607
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 607 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 179
   📊 Token conversazione finale: 179
   📊 Token totali: 607
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 620 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2686 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 179
   📊 Token totali stimati: 607
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno. [...]  Se hai bisogno di ulteriore assistenza, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:43.165085
====================================================================================================
📋 Session ID: classify_1756763023
⏱️  Processing Time: 0.738s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (620 chars):
   [UTENTE] buongiorno. [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] ho la sindrome di Good...ho bisogno di capire se ci sono medici nel vostro centro dove poter venire a fare una ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (184 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Visita Specialistica"}}
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 6ff7a7c4846810dd3495846c1ff77715 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 276
   📊 Token totali: 724
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 724 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 276
   📊 Token conversazione finale: 276
   📊 Token totali: 724
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 895 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno. [...]  Da lì, potranno indirizzarti al reparto specifico"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2745 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 276
   📊 Token totali stimati: 724
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno. [...]  Da lì, potranno indirizzarti al reparto specifico"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla necessità dell'utente di contattare il reparto di oculistica presso l'Istituto Clinico Humanitas di Roz"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:46.283473
====================================================================================================
📋 Session ID: classify_1756763026
⏱️  Processing Time: 3.032s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (895 chars):
   [UTENTE] Buongiorno. Volevo capire come si chiama il dottore che mi deve visitare lunedì 11/08/2025 alle 14:00 [ASSISTENTE] Mi dispiace, ma non ho accesso a informazioni personali o specifiche sugl...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sulla necessità dell'utente di contattare il reparto di oculistica presso l'Istituto Clinico Humanitas di Roz"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sulla necessità dell'utente di contattare il reparto di oculistica presso l'Istituto Clinico Humanitas di Roz
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sulla necessità dell'utente di contattare il reparto di oculistica presso l'Istituto Clinico Humanitas di Roz
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione ba45801a4cf33e7b29e7f37f2949a4e5 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 315
   📊 Token totali: 763
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 763 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 315
   📊 Token conversazione finale: 315
   📊 Token totali: 763
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1083 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] Volevo chiedere un'informazione la risonanza magnetica aperta È solo a regime privato o anche a regime convenzionato con regime sanitario nazionale [ASSISTENTE] Non ho trovato informazioni specifiche sul fatto c..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 315
   📊 Token totali stimati: 763
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] Volevo chiedere un'informazione la risonanza magnetica aperta È solo a regime privato o anche a regime convenzionato con regime sanitario nazionale [ASSISTENTE] Non ho trovato informazioni specifiche sul fatto c..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'accessibilità della risonanza magnetica aperta sia in regime privato che convenzionato con il Servizio S"}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:50.672033
====================================================================================================
📋 Session ID: classify_1756763030
⏱️  Processing Time: 4.299s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1083 chars):
   [UTENTE] Buongiorno  [ASSISTENTE] Buongiorno! Come posso esserti utile oggi? [UTENTE] Volevo chiedere un'informazione la risonanza magnetica aperta È solo a regime privato o anche a regime convenzi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (215 chars):
   {'predicted_label': 'altro', 'confidence': 0.3, 'motivation': "** La conversazione verte principalmente sull'accessibilità della risonanza magnetica aperta sia in regime privato che convenzionato con il Servizio S"}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.3
   motivation: ** La conversazione verte principalmente sull'accessibilità della risonanza magnetica aperta sia in regime privato che convenzionato con il Servizio S
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.300
   [██████░░░░░░░░░░░░░░] 30.0%

🧠 Reasoning/Motivation:
   ** La conversazione verte principalmente sull'accessibilità della risonanza magnetica aperta sia in regime privato che convenzionato con il Servizio S
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione b0734819b315cb885de7557e08ca7b2f classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 613
   📊 Token totali: 1061
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1061 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 613
   📊 Token conversazione finale: 613
   📊 Token totali: 1061
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1914 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] cosa puoi fare?  [ASSISTENTE] Posso fornire informazioni di carattere generale relative all’ospedale Humanitas. [...]  Fammi sapere come posso esserti utile! 😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2836 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 613
   📊 Token totali stimati: 1061
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] cosa puoi fare?  [ASSISTENTE] Posso fornire informazioni di carattere generale relative all’ospedale Humanitas. [...]  Fammi sapere come posso esserti utile! 😊"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** Prenotazione\n\n**Confidence:** 0.75\n\n**Motivation:** La conversazione verte prin'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:53.956875
====================================================================================================
📋 Session ID: classify_1756763033
⏱️  Processing Time: 3.197s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1914 chars):
   [UTENTE] cosa puoi fare?  [ASSISTENTE] Posso fornire informazioni di carattere generale relative all’ospedale Humanitas. Puoi farmi domande, ad esempio, sui nomi dei professionisti sanitari di Huma...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (195 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **Predicted label:** Prenotazione\n\n**Confidence:** 0.75\n\n**Motivation:** La conversazione verte prin'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **Predicted label:** Prenotazione

**Confidence:** 0.75

**Motivation:** La conversazione verte prin
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **Predicted label:** Prenotazione

**Confidence:** 0.75

**Motivation:** La conversazione verte prin
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 97c80b96d9a8f043f5fe70afe6a5d5ad classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 130
   📊 Token totali: 578
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 578 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 130
   📊 Token conversazione finale: 130
   📊 Token totali: 578
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 427 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho due spese a 730 che risultano pagate da me e poi rimborsate ma che non riconosco  [ASSISTENTE] Per questioni relative a spese sanitarie e rimborsi, ti consiglio di contattare direttamente l'ufficio amministrativo o il servizio clienti di Humanitas. Puoi anche verificare eventuali dett..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2968 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 130
   📊 Token totali stimati: 578
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho due spese a 730 che risultano pagate da me e poi rimborsate ma che non riconosco  [ASSISTENTE] Per questioni relative a spese sanitarie e rimborsi, ti consiglio di contattare direttamente l'ufficio amministrativo o il servizio clienti di Humanitas. Puoi anche verificare eventuali dett..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'assistenza per spese sanitarie e rimborsi, che rientra nei servizi amministrativi dell'ospedale.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:55.676995
====================================================================================================
📋 Session ID: classify_1756763035
⏱️  Processing Time: 1.634s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (427 chars):
   [UTENTE] Ho due spese a 730 che risultano pagate da me e poi rimborsate ma che non riconosco  [ASSISTENTE] Per questioni relative a spese sanitarie e rimborsi, ti consiglio di contattare direttamen...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (202 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'assistenza per spese sanitarie e rimborsi, che rientra nei servizi amministrativi dell'ospedale.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'assistenza per spese sanitarie e rimborsi, che rientra nei servizi amministrativi dell'ospedale.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'assistenza per spese sanitarie e rimborsi, che rientra nei servizi amministrativi dell'ospedale.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 993051e5add9047d93ec5894bd115023 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 260
   📊 Token totali: 688
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 688 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 260
   📊 Token conversazione finale: 260
   📊 Token totali: 688
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 845 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao ho un problema non mi è' arrivato il promemoria di una prenotazione di una visita ortopedica  [ASSISTENTE] Se non hai ricevuto il promemoria per una prenotazione di una visita ortopedica, ti consiglio di verificare direttamente con il servizio prenotazioni di Humanitas. Puoi contatt..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 260
   📊 Token totali stimati: 688
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao ho un problema non mi è' arrivato il promemoria di una prenotazione di una visita ortopedica  [ASSISTENTE] Se non hai ricevuto il promemoria per una prenotazione di una visita ortopedica, ti consiglio di verificare direttamente con il servizio prenotazioni di Humanitas. Puoi contatt..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione"}}'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:56.544855
====================================================================================================
📋 Session ID: classify_1756763036
⏱️  Processing Time: 0.780s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (845 chars):
   [UTENTE] Ciao ho un problema non mi è' arrivato il promemoria di una prenotazione di una visita ortopedica  [ASSISTENTE] Se non hai ricevuto il promemoria per una prenotazione di una visita ortoped...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (176 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione"}}'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione"}}
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione"}}
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione edc32f0f43166cef0ee9d1a7f9f5d649 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 491
   📊 Token totali: 939
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 939 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 491
   📊 Token conversazione finale: 491
   📊 Token totali: 939
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1475 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Urologia  [ASSISTENTE] Per maggiori informazioni sul reparto di Urologia, ti consiglio di visitare la pagina dedicata sul sito di Humanitas. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2846 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 491
   📊 Token totali stimati: 939
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Urologia  [ASSISTENTE] Per maggiori informazioni sul reparto di Urologia, ti consiglio di visitare la pagina dedicata sul sito di Humanitas. [...] it/info/prenotazioni/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte principalmente sulla prenotazione di una visita specialistica presso l'Istituto Clinico Humanitas.", 'predicted_label': 'Visita Specialistica'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:58.269627
====================================================================================================
📋 Session ID: classify_1756763038
⏱️  Processing Time: 1.638s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1475 chars):
   [UTENTE] Urologia  [ASSISTENTE] Per maggiori informazioni sul reparto di Urologia, ti consiglio di visitare la pagina dedicata sul sito di Humanitas. Se hai bisogno di dettagli specifici o di assis...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (202 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte principalmente sulla prenotazione di una visita specialistica presso l'Istituto Clinico Humanitas.", 'predicted_label': 'Visita Specialistica'}

📊 Parsed Response:
   predicted_label: Visita Specialistica
   confidence: 0.75
   motivation: La conversazione verte principalmente sulla prenotazione di una visita specialistica presso l'Istituto Clinico Humanitas.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla prenotazione di una visita specialistica presso l'Istituto Clinico Humanitas.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 87a40c6cef45719d0e2ba8392c6c5949 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Visita Specialistica' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 172
   📊 Token totali: 600
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 600 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 172
   📊 Token conversazione finale: 172
   📊 Token totali: 600
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 582 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Il nome sul contenitore dell' urina viene applicato dal personale? [ASSISTENTE] Il nome sul contenitore dell'urina non viene applicato dal personale. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2766 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 172
   📊 Token totali stimati: 600
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Il nome sul contenitore dell' urina viene applicato dal personale? [ASSISTENTE] Il nome sul contenitore dell'urina non viene applicato dal personale. [...] json】"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.9, 'motivation': "La conversazione verte sull'esame delle urine completo e sul modo corretto di utilizzare il contenitore per l'urina.", 'predicted_label': 'Analisi'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:43:59.823748
====================================================================================================
📋 Session ID: classify_1756763039
⏱️  Processing Time: 1.467s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (582 chars):
   [UTENTE] Il nome sul contenitore dell' urina viene applicato dal personale? [ASSISTENTE] Il nome sul contenitore dell'urina non viene applicato dal personale. È necessario che il paziente utilizzi ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (183 chars):
   {'confidence': 0.9, 'motivation': "La conversazione verte sull'esame delle urine completo e sul modo corretto di utilizzare il contenitore per l'urina.", 'predicted_label': 'Analisi'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.9
   motivation: La conversazione verte sull'esame delle urine completo e sul modo corretto di utilizzare il contenitore per l'urina.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.900
   [██████████████████░░] 90.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'esame delle urine completo e sul modo corretto di utilizzare il contenitore per l'urina.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione e25587617d60f31879bdd4c4771a6b18 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 100
   📊 Token totali: 548
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 548 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 100
   📊 Token conversazione finale: 100
   📊 Token totali: 548
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 360 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Contatto ufficio selezioni del personale  [ASSISTENTE] Puoi consultare le posizioni aperte per tutte le strutture del gruppo Humanitas e candidarti collegandoti alla pagina [jobs. [...]  

Se hai bisogno di ulteriori informazioni, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2921 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 100
   📊 Token totali stimati: 548
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Contatto ufficio selezioni del personale  [ASSISTENTE] Puoi consultare le posizioni aperte per tutte le strutture del gruppo Humanitas e candidarti collegandoti alla pagina [jobs. [...]  

Se hai bisogno di ulteriori informazioni, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso alle posizioni lavorative all'interno dell'ospedale Humanitas.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:01.377445
====================================================================================================
📋 Session ID: classify_1756763041
⏱️  Processing Time: 1.467s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (360 chars):
   [UTENTE] Contatto ufficio selezioni del personale  [ASSISTENTE] Puoi consultare le posizioni aperte per tutte le strutture del gruppo Humanitas e candidarti collegandoti alla pagina [jobs.humanitas...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (176 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso alle posizioni lavorative all'interno dell'ospedale Humanitas.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.95
   motivation: La conversazione verte sull'accesso alle posizioni lavorative all'interno dell'ospedale Humanitas.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso alle posizioni lavorative all'interno dell'ospedale Humanitas.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f4a0210525d59c7596a9db4f911e8b04 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 289
   📊 Token totali: 738
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 738 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 289
   📊 Token conversazione finale: 289
   📊 Token totali: 738
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 923 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao, in quale palazzina si fa l'esame istologico [ASSISTENTE] Gli esami istologici non sono consultabili online e devono essere ritirati presso lo sportello dell'ufficio referti. [...] it/info/come-raggiungere-humanitas/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2900 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 289
   📊 Token totali stimati: 738
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] ciao, in quale palazzina si fa l'esame istologico [ASSISTENTE] Gli esami istologici non sono consultabili online e devono essere ritirati presso lo sportello dell'ufficio referti. [...] it/info/come-raggiungere-humanitas/)"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'esame istologico e sul luogo dove ritirarlo, pertanto la categoria 'Referti e Cartelle Cliniche' è appropriata.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:03.209069
====================================================================================================
📋 Session ID: classify_1756763043
⏱️  Processing Time: 1.744s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (923 chars):
   [UTENTE] ciao, in quale palazzina si fa l'esame istologico [ASSISTENTE] Gli esami istologici non sono consultabili online e devono essere ritirati presso lo sportello dell'ufficio referti. Per quan...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (227 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'esame istologico e sul luogo dove ritirarlo, pertanto la categoria 'Referti e Cartelle Cliniche' è appropriata.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'esame istologico e sul luogo dove ritirarlo, pertanto la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'esame istologico e sul luogo dove ritirarlo, pertanto la categoria 'Referti e Cartelle Cliniche' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione a7a03ccda5ab18b468d9a5c7eb1458b1 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 454
   💬 Token conversazione: 183
   📊 Token totali: 637
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 637 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 454
   📊 Token conversazione originale: 183
   📊 Token conversazione finale: 183
   📊 Token totali: 637
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 584 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho una visita cardiologica prenotata per mio papà l'11 di agosto, ma fece la stessa visita già una settimana fa, volevo capire se non fosse un errore o va rifatta? [ASSISTENTE] Non ho accesso ai dettagli delle prenotazioni personali o alla gestione degli appuntamenti. Ti consiglio di con..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2999 characters
🔢 Token Analysis:
   📊 Token prompt base: 454
   📊 Token conversazione: 183
   📊 Token totali stimati: 637
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Problema tecnico di accesso - priorità problema_accesso_portale su altre categorie

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ho una visita cardiologica prenotata per mio papà l'11 di agosto, ma fece la stessa visita già una settimana fa, volevo capire se non fosse un errore o va rifatta? [ASSISTENTE] Non ho accesso ai dettagli delle prenotazioni personali o alla gestione degli appuntamenti. Ti consiglio di con..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Visita Specialistica",\n    "confidence"'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:04.905157
====================================================================================================
📋 Session ID: classify_1756763044
⏱️  Processing Time: 1.610s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (584 chars):
   [UTENTE] Ho una visita cardiologica prenotata per mio papà l'11 di agosto, ma fece la stessa visita già una settimana fa, volevo capire se non fosse un errore o va rifatta? [ASSISTENTE] Non ho acce...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (196 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **classify_conversation**\n\n```json\n{\n    "predicted_label": "Visita Specialistica",\n    "confidence"'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Visita Specialistica",
    "confidence"
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **classify_conversation**

```json
{
    "predicted_label": "Visita Specialistica",
    "confidence"
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 777c4d864142550245571066b0198e55 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 97
   📊 Token totali: 546
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 546 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 97
   📊 Token conversazione finale: 97
   📊 Token totali: 546
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 342 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] che ricetta mi serve prenotare il pacchetto cornea? [ASSISTENTE] Non ho trovato informazioni specifiche sulla ricetta necessaria per prenotare il pacchetto cornea. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2913 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 97
   📊 Token totali stimati: 546
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] che ricetta mi serve prenotare il pacchetto cornea? [ASSISTENTE] Non ho trovato informazioni specifiche sulla ricetta necessaria per prenotare il pacchetto cornea. [...]  Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:06.448426
====================================================================================================
📋 Session ID: classify_1756763046
⏱️  Processing Time: 1.457s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (342 chars):
   [UTENTE] che ricetta mi serve prenotare il pacchetto cornea? [ASSISTENTE] Non ho trovato informazioni specifiche sulla ricetta necessaria per prenotare il pacchetto cornea. Ti consiglio di contatta...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "Prenotazione", "confidence": 0
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 439eb6398a9d306e636ee67cd0f0e601 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 167
   📊 Token totali: 595
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 595 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 167
   📊 Token conversazione finale: 167
   📊 Token totali: 595
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 554 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] cosa include il pacchettp p [ASSISTENTE] Non ho trovato informazioni specifiche sul "pacchetto p" nei documenti caricati. [...]  Potresti fornirmi ulteriori dettagli o chiarire a cosa ti riferisci? Sarò felice di aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2827 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 167
   📊 Token totali stimati: 595
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] cosa include il pacchettp p [ASSISTENTE] Non ho trovato informazioni specifiche sul "pacchetto p" nei documenti caricati. [...]  Potresti fornirmi ulteriori dettagli o chiarire a cosa ti riferisci? Sarò felice di aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.9, "mo'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:08.125966
====================================================================================================
📋 Session ID: classify_1756763048
⏱️  Processing Time: 1.583s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (554 chars):
   [UTENTE] cosa include il pacchettp p [ASSISTENTE] Non ho trovato informazioni specifiche sul "pacchetto p" nei documenti caricati. Potresti fornirmi maggiori dettagli o chiarire a cosa ti riferisci...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (191 chars):
   {'predicted_label': 'altro', 'confidence': 0.2, 'motivation': 'Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.9, "mo'}

📊 Parsed Response:
   predicted_label: altro
   confidence: 0.2
   motivation: Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.9, "mo
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.200
   [████░░░░░░░░░░░░░░░░] 20.0%

🧠 Reasoning/Motivation:
   Risposta non strutturata: **{"name": "classify_conversation", "arguments": {"predicted_label": "altro", "confidence": 0.9, "mo
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione ccf605d826c1597bbd0bab07e98349a7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'altro' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 183
   📊 Token totali: 631
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 631 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 183
   📊 Token conversazione finale: 183
   📊 Token totali: 631
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 634 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Salve, sto provando a mettermi in contatto con il dott. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2806 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 183
   📊 Token totali stimati: 631
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Salve, sto provando a mettermi in contatto con il dott. [...]  

Se hai bisogno di ulteriori informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.75, 'motivation': "La conversazione verte sull'ottenere informazioni su come contattare un medico dell'ospedale Humanitas per una consulenza medica, quindi la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:10.107871
====================================================================================================
📋 Session ID: classify_1756763050
⏱️  Processing Time: 1.896s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (634 chars):
   [UTENTE] Salve, sto provando a mettermi in contatto con il dott. Alessio D'Addona per mia madre che vive in Sicilia . Cosa posso fare per avere un suo parere medico? A quale numero o indirizzo mail...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (262 chars):
   {'confidence': 0.75, 'motivation': "La conversazione verte sull'ottenere informazioni su come contattare un medico dell'ospedale Humanitas per una consulenza medica, quindi la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.75
   motivation: La conversazione verte sull'ottenere informazioni su come contattare un medico dell'ospedale Humanitas per una consulenza medica, quindi la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.750
   [███████████████░░░░░] 75.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'ottenere informazioni su come contattare un medico dell'ospedale Humanitas per una consulenza medica, quindi la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 951ccc5caea77a23e36bc702b207137b classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 659
   📊 Token totali: 1108
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1108 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 659
   📊 Token conversazione finale: 659
   📊 Token totali: 1108
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2194 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao l’esito della tac era previsto per il 6/8, ma non ho ricevuto l’sms che conferma la disponibilità  [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www.humanitas.it/info/referti-cartelle-cliniche/). Se hai bisogno ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 659
   📊 Token totali stimati: 1108
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao l’esito della tac era previsto per il 6/8, ma non ho ricevuto l’sms che conferma la disponibilità  [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www.humanitas.it/info/referti-cartelle-cliniche/). Se hai bisogno ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai referti delle analisi mediche, in particolare della TAC Total Body.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:12.010652
====================================================================================================
📋 Session ID: classify_1756763052
⏱️  Processing Time: 1.812s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2194 chars):
   [UTENTE] Ciao l’esito della tac era previsto per il 6/8, ma non ho ricevuto l’sms che conferma la disponibilità  [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Carte...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (194 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'accesso ai referti delle analisi mediche, in particolare della TAC Total Body.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'accesso ai referti delle analisi mediche, in particolare della TAC Total Body.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'accesso ai referti delle analisi mediche, in particolare della TAC Total Body.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 9e946e3fada5facef0175b5a16299824 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 241
   📊 Token totali: 669
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 669 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 241
   📊 Token conversazione finale: 241
   📊 Token totali: 669
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 828 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] mi sono resa conto di avere dato un email sbagliata [ASSISTENTE] Capisco, potresti dirmi in quale contesto hai fornito l'email sbagliata? Ad esempio, è per una prenotazione, un referto o un altro servizio? Così posso aiutarti al meglio. [UTENTE] durante la visita medica per un check up h..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 241
   📊 Token totali stimati: 669
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] mi sono resa conto di avere dato un email sbagliata [ASSISTENTE] Capisco, potresti dirmi in quale contesto hai fornito l'email sbagliata? Ad esempio, è per una prenotazione, un referto o un altro servizio? Così posso aiutarti al meglio. [UTENTE] durante la visita medica per un check up h..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione ruota attorno alla difficoltà dell'utente nel recuperare i referti a causa di un'indirizzo email fornito in modo errato durante una visita medica per un check-up.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:13.993099
====================================================================================================
📋 Session ID: classify_1756763053
⏱️  Processing Time: 1.896s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (828 chars):
   [UTENTE] mi sono resa conto di avere dato un email sbagliata [ASSISTENTE] Capisco, potresti dirmi in quale contesto hai fornito l'email sbagliata? Ad esempio, è per una prenotazione, un referto o u...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (267 chars):
   {'confidence': 0.95, 'motivation': "La conversazione ruota attorno alla difficoltà dell'utente nel recuperare i referti a causa di un'indirizzo email fornito in modo errato durante una visita medica per un check-up.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione ruota attorno alla difficoltà dell'utente nel recuperare i referti a causa di un'indirizzo email fornito in modo errato durante una visita medica per un check-up.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione ruota attorno alla difficoltà dell'utente nel recuperare i referti a causa di un'indirizzo email fornito in modo errato durante una visita medica per un check-up.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione f02d6532aa4af88efbaa8651d35afc07 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 178
   📊 Token totali: 627
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 627 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 178
   📊 Token conversazione finale: 178
   📊 Token totali: 627
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 604 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non è chiaro a chi devo fare la richiesta di ristampa del referto “Trascorsi 30 giorni dalla prima data utile di ritiro segnalata il referto potrà essere ritirato in struttura previa richiesta di ristampa del documento.” [ASSISTENTE] Per richiedere la ristampa di un referto trascorsi 30 ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2969 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 178
   📊 Token totali stimati: 627
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Non è chiaro a chi devo fare la richiesta di ristampa del referto “Trascorsi 30 giorni dalla prima data utile di ritiro segnalata il referto potrà essere ritirato in struttura previa richiesta di ristampa del documento.” [ASSISTENTE] Per richiedere la ristampa di un referto trascorsi 30 ..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': 'La conversazione verte sulla richiesta di ristampa del referto dopo i primi 30 giorni dalla data utile di ritiro.', 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:15.664604
====================================================================================================
📋 Session ID: classify_1756763055
⏱️  Processing Time: 1.581s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (604 chars):
   [UTENTE] Non è chiaro a chi devo fare la richiesta di ristampa del referto “Trascorsi 30 giorni dalla prima data utile di ritiro segnalata il referto potrà essere ritirato in struttura previa richi...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (201 chars):
   {'confidence': 0.95, 'motivation': 'La conversazione verte sulla richiesta di ristampa del referto dopo i primi 30 giorni dalla data utile di ritiro.', 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sulla richiesta di ristampa del referto dopo i primi 30 giorni dalla data utile di ritiro.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sulla richiesta di ristampa del referto dopo i primi 30 giorni dalla data utile di ritiro.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione e302dfe2cbc01d2690863d3c98e1bd55 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 341
   📊 Token totali: 789
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 789 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 341
   📊 Token conversazione finale: 341
   📊 Token totali: 789
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1134 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao effettuare un’analisi del Microbiota giusto? [ASSISTENTE] Sì, in Humanitas è possibile effettuare l'analisi del microbiota. [...]  Posso aiutarti in altro?"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2837 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 341
   📊 Token totali stimati: 789
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao effettuare un’analisi del Microbiota giusto? [ASSISTENTE] Sì, in Humanitas è possibile effettuare l'analisi del microbiota. [...]  Posso aiutarti in altro?"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sull'analisi del microbiota e sui relativi costi, pertanto la categoria 'Analisi' è appropriata.", 'predicted_label': 'Analisi'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:17.396062
====================================================================================================
📋 Session ID: classify_1756763057
⏱️  Processing Time: 1.643s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1134 chars):
   [UTENTE] Ciao effettuare un’analisi del Microbiota giusto? [ASSISTENTE] Sì, in Humanitas è possibile effettuare l'analisi del microbiota. Se hai bisogno di ulteriori informazioni o desideri sapere ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (202 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sull'analisi del microbiota e sui relativi costi, pertanto la categoria 'Analisi' è appropriata.", 'predicted_label': 'Analisi'}

📊 Parsed Response:
   predicted_label: Analisi
   confidence: 0.95
   motivation: La conversazione verte principalmente sull'analisi del microbiota e sui relativi costi, pertanto la categoria 'Analisi' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sull'analisi del microbiota e sui relativi costi, pertanto la categoria 'Analisi' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 50353d82f48f4c5ef464ef97647e8da7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Analisi' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 357
   📊 Token totali: 805
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 805 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 357
   📊 Token conversazione finale: 357
   📊 Token totali: 805
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1194 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno non mi fa regiestrare al portale [ASSISTENTE] Se riscontri problemi con la registrazione al portale [Humanitas con te](https://www. [...]  Se hai bisogno di ulteriore assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2880 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 357
   📊 Token totali stimati: 805
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno non mi fa regiestrare al portale [ASSISTENTE] Se riscontri problemi con la registrazione al portale [Humanitas con te](https://www. [...]  Se hai bisogno di ulteriore assistenza, fammi sapere!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla difficoltà dell'utente nel registrarsi al portale Humanitas con te e la richiesta di supporto per risolvere il problema.", 'predicted_label': 'Humanitas con te - Registrazione'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:19.320954
====================================================================================================
📋 Session ID: classify_1756763059
⏱️  Processing Time: 1.838s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1194 chars):
   [UTENTE] buongiorno non mi fa regiestrare al portale [ASSISTENTE] Se riscontri problemi con la registrazione al portale [Humanitas con te](https://www.humanitasconte.it), ti consiglio di verificare...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [73 more lines] ...
     Line 77: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (257 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte principalmente sulla difficoltà dell'utente nel registrarsi al portale Humanitas con te e la richiesta di supporto per risolvere il problema.", 'predicted_label': 'Humanitas con te - Registrazione'}

📊 Parsed Response:
   predicted_label: Humanitas con te - Registrazione
   confidence: 0.95
   motivation: La conversazione verte principalmente sulla difficoltà dell'utente nel registrarsi al portale Humanitas con te e la richiesta di supporto per risolvere il problema.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sulla difficoltà dell'utente nel registrarsi al portale Humanitas con te e la richiesta di supporto per risolvere il problema.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 2e77586108f1d1380156bac81b4b3cec classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Humanitas con te - Registrazione' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 428
   💬 Token conversazione: 112
   📊 Token totali: 540
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 540 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 428
   📊 Token conversazione originale: 112
   📊 Token conversazione finale: 112
   📊 Token totali: 540
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 371 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno, ho effettuato una TAC i cui risultati dovevano essere disponbili dal 26/06 ma non vedo ancora nulla: come è possibile? [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www.humanitas.it/info/referti-cartelle-..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2896 characters
🔢 Token Analysis:
   📊 Token prompt base: 428
   📊 Token conversazione: 112
   📊 Token totali stimati: 540
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica




OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] buongiorno, ho effettuato una TAC i cui risultati dovevano essere disponbili dal 26/06 ma non vedo ancora nulla: come è possibile? [ASSISTENTE] Per i risultati del tuo esame, puoi visitare la pagina [Referti e Cartelle Cliniche - Humanitas](https://www.humanitas.it/info/referti-cartelle-..."

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione riguarda l'accesso ai risultati di un esame TAC, quindi la categoria più adatta è 'Referti e Cartelle Cliniche'.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:21.108423
====================================================================================================
📋 Session ID: classify_1756763061
⏱️  Processing Time: 1.700s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (371 chars):
   [UTENTE] buongiorno, ho effettuato una TAC i cui risultati dovevano essere disponbili dal 26/06 ma non vedo ancora nulla: come è possibile? [ASSISTENTE] Per i risultati del tuo esame, puoi visitare...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [72 more lines] ...
     Line 76: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (217 chars):
   {'confidence': 0.95, 'motivation': "La conversazione riguarda l'accesso ai risultati di un esame TAC, quindi la categoria più adatta è 'Referti e Cartelle Cliniche'.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione riguarda l'accesso ai risultati di un esame TAC, quindi la categoria più adatta è 'Referti e Cartelle Cliniche'.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione riguarda l'accesso ai risultati di un esame TAC, quindi la categoria più adatta è 'Referti e Cartelle Cliniche'.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 4032f70a0bcb23f6e2dbd460bc3023fb classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 581
   📊 Token totali: 1029
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1029 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 581
   📊 Token conversazione finale: 581
   📊 Token totali: 1029
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 2072 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Il codice otp non arriva [ASSISTENTE] Se il codice OTP non arriva, ti consiglio di verificare che il numero di telefono o l'indirizzo email associato al tuo account sia corretto. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2924 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 581
   📊 Token totali stimati: 1029
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Il codice otp non arriva [ASSISTENTE] Se il codice OTP non arriva, ti consiglio di verificare che il numero di telefono o l'indirizzo email associato al tuo account sia corretto. [...] 

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.85, 'motivation': "La conversazione verte principalmente sull'assistenza tecnica per il recupero del codice OTP e la verifica delle informazioni di contatto dell'utente.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:23.067861
====================================================================================================
📋 Session ID: classify_1756763063
⏱️  Processing Time: 1.872s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (2072 chars):
   [UTENTE] Il codice otp non arriva [ASSISTENTE] Se il codice OTP non arriva, ti consiglio di verificare che il numero di telefono o l'indirizzo email associato al tuo account sia corretto. Se il pro...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (228 chars):
   {'confidence': 0.85, 'motivation': "La conversazione verte principalmente sull'assistenza tecnica per il recupero del codice OTP e la verifica delle informazioni di contatto dell'utente.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.85
   motivation: La conversazione verte principalmente sull'assistenza tecnica per il recupero del codice OTP e la verifica delle informazioni di contatto dell'utente.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.850
   [█████████████████░░░] 85.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sull'assistenza tecnica per il recupero del codice OTP e la verifica delle informazioni di contatto dell'utente.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione 510fe27ceb46d9af817065be7c2a555a classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 585
   📊 Token totali: 1033
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 1033 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 585
   📊 Token conversazione finale: 585
   📊 Token totali: 1033
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 1705 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao! Ho parcheggiato la macchina fuori dall'ospedale. [...] 

Se hai bisogno di ulteriori indicazioni o informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2818 characters
🔢 Token Analysis:
   📊 Token prompt base: 448
   📊 Token conversazione: 585
   📊 Token totali stimati: 1033
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] Ciao! Ho parcheggiato la macchina fuori dall'ospedale. [...] 

Se hai bisogno di ulteriori indicazioni o informazioni, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.7, 'motivation': "La conversazione verte principalmente sull'accesso e i parcheggi dell'ospedale Humanitas, quindi la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:25.098506
====================================================================================================
📋 Session ID: classify_1756763065
⏱️  Processing Time: 1.943s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (1705 chars):
   [UTENTE] Ciao! Ho parcheggiato la macchina fuori dall'ospedale. Posso entrare con la macchina per prendere mio marito appena operato? [ASSISTENTE] Sì, è consentito l'accesso con l'auto fino all'ing...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (221 chars):
   {'confidence': 0.7, 'motivation': "La conversazione verte principalmente sull'accesso e i parcheggi dell'ospedale Humanitas, quindi la categoria 'Servizi aziendali' è appropriata.", 'predicted_label': 'Servizi aziendali'}

📊 Parsed Response:
   predicted_label: Servizi aziendali
   confidence: 0.7
   motivation: La conversazione verte principalmente sull'accesso e i parcheggi dell'ospedale Humanitas, quindi la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.700
   [██████████████░░░░░░] 70.0%

🧠 Reasoning/Motivation:
   La conversazione verte principalmente sull'accesso e i parcheggi dell'ospedale Humanitas, quindi la categoria 'Servizi aziendali' è appropriata.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d13af40e26d202b8f2818f74bfd165b3 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Servizi aziendali' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 449
   💬 Token conversazione: 278
   📊 Token totali: 727
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 727 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 449
   📊 Token conversazione originale: 278
   📊 Token conversazione finale: 278
   📊 Token totali: 727
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 963 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] in data 27. [...]  

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 
================================================================================

🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🚀 PROMPT COMPLETO FINALE INVIATO ALL'LLM
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
🤖 Model: mistral-nemo:latest
🌐 Ollama URL: http://localhost:11434
🏢 Tenant: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Total Prompt Length: 2759 characters
🔢 Token Analysis:
   📊 Token prompt base: 449
   📊 Token conversazione: 278
   📊 Token totali stimati: 727
   📊 Limite configurato: 8000
   ✅ STATUS: Conversazione COMPLETA
--------------------------------------------------------------------------------
📄 FULL PROMPT CONTENT:
--------------------------------------------------------------------------------
<|system|>
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta operativa - preferisci etichette di azione

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.

<|user|>
Analizza questo testo seguendo l'approccio degli esempi 

<|ESEMPI|>

user: "Ci sono convenzioni con hotel per assistere un ricoverato?"
assistant: {"confidence": 1, "motivation": "Richiesta info convenzioni viaggio", "predicted_label": "convenzioni_viaggio"}

user: "Non trovo l'id per scaricare il referto"
assistant: {"confidence": 1, "motivation": "Problema ID per ritiri referti e cartella clinica", "predicted_label": "problema_ritiro_referti_cartella_clinica"}

user: "Non mi fa registrare al portale, dice codice fiscale errato"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Quando inserisco il CF dice che non è valido"
assistant: {"confidence": 1, "motivation": "Problema tecnico di accesso al portale online", "predicted_label": "problema_accesso_portale"}

user: "Devo cambiare la mail con cui mi sono registrato al portale"
assistant: {"confidence": 1, "motivation": "Cambio delle informazioni anagrafiche richiesto", "predicted_label": "cambio_anagrafica"}





<|TESTO DA CLASSIFICARE|>:
"[UTENTE] in data 27. [...]  

Se hai bisogno di ulteriore supporto, sono qui per aiutarti!"

RAGIONA STEP-BY-STEP:
1. Identifica l'intento principale
2. Confronta con gli esempi
3. Scegli l'etichetta più appropriata
4. Valuta la tua certezza

VINCOLI OUTPUT (SOLO JSON). 

<|assistant|>
🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

🔍 STRUCTURED RESPONSE DEBUG: {'confidence': 0.95, 'motivation': "La conversazione verte sull'assenza del referto di un esame TACTOR00 sul portale Humanitas con te e sulle opzioni per recuperarlo.", 'predicted_label': 'Referti e Cartelle Cliniche'}

====================================================================================================
🤖 LLM DEBUG - CLASSIFICATION | 2025-09-01T21:44:26.964084
====================================================================================================
📋 Session ID: classify_1756763066
⏱️  Processing Time: 1.777s
----------------------------------------------------------------------------------------------------
📥 INPUT SECTION
--------------------------------------------------
💬 Original Text (963 chars):
   [UTENTE] in data 27.05.2025 ho fatto una TACTOR00, il referto sarebbero dovuto essere pronto in data 04.06.2025 ad oggi non e' presente sul portale humanitas con te e non ho ricevuto ancora sms di ...

🎯 Prompt Template:
   
     Line 1: <|system|>
     Line 2: Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario
     Line 3: 
     ... [75 more lines] ...
     Line 79: <|assistant|>

⚙️  Model Parameters:
   model: mistral-nemo:latest
   temperature: 0.1
   max_tokens: 150
   timeout: 300
----------------------------------------------------------------------------------------------------
📤 OUTPUT SECTION
--------------------------------------------------
🔍 Raw Response (218 chars):
   {'confidence': 0.95, 'motivation': "La conversazione verte sull'assenza del referto di un esame TACTOR00 sul portale Humanitas con te e sulle opzioni per recuperarlo.", 'predicted_label': 'Referti e Cartelle Cliniche'}

📊 Parsed Response:
   predicted_label: Referti e Cartelle Cliniche
   confidence: 0.95
   motivation: La conversazione verte sull'assenza del referto di un esame TACTOR00 sul portale Humanitas con te e sulle opzioni per recuperarlo.
----------------------------------------------------------------------------------------------------
📈 ANALYSIS SECTION
--------------------------------------------------
🎯 Confidence Score: 0.950
   [███████████████████░] 95.0%

🧠 Reasoning/Motivation:
   La conversazione verte sull'assenza del referto di un esame TACTOR00 sul portale Humanitas con te e sulle opzioni per recuperarlo.
----------------------------------------------------------------------------------------------------
🔍 CONTEXT & METADATA
--------------------------------------------------
   model_used: mistral-nemo:latest
   cache_hit: False
   context_provided: False
   embedding_validation_enabled: True
   client_name: humanitas
   raw_mode_used: False
----------------------------------------------------------------------------------------------------
✅ LLM DEBUG COMPLETED
====================================================================================================

📊 Collection generata: humanitas_015007d9-d413-11ef-86a5-96000228e7fe per tenant Humanitas
🤖 LLM DIRECT CLASSIFICATION: Sessione d37b9fd3b006e134f1bec6fad76b43a7 classificata tramite LLM diretto (classificazione=unknown)
Connessione al database TAG stabilita con successo
  ℹ️ Tag 'Referti e Cartelle Cliniche' già esistente per tenant 015007d9-d413-11ef-86a5-96000228e7fe
Connessione al database TAG chiusa
Connessione al database TAG stabilita con successo
Connessione al database TAG chiusa

================================================================================
🤖 DEBUG PROMPT SYSTEM - DATABASE
================================================================================
📋 Prompt Name: LLM/SYSTEM/intelligent_classifier_system
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📝 Variables Used: ['available_labels', 'priority_labels', 'context_guidance']
--------------------------------------------------------------------------------
📄 SYSTEM PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
Sei un classificatore esperto per l'ospedale Humanitas con profonda conoscenza del dominio sanitario.

MISSIONE: Classifica conversazioni con pazienti/utenti in base al loro intento principale.

APPROCCIO ANALITICO:
1. Identifica l'intento principale (non dettagli secondari)
2. Considera il contesto ospedaliero (prenotazioni, referti, informazioni)
3. Distingui richieste operative da richieste informative
4. Se incerto tra 2 etichette, scegli la più specifica

CONFIDENCE GUIDELINES:
- 0.9-1.0: Intento chiarissimo e inequivocabile
- 0.7-0.8: Intento probabile con piccole ambiguità
- 0.5-0.6: Intento possibile ma con dubbi ragionevoli  
- 0.3-0.4: Molto incerto, probabilmente "altro"
- 0.0-0.2: Impossibile classificare

LABELING GUIDELINES:
la logica con cui devi creare le etichette è: <tipologia di richiesta>_<ambito a cui si riferisce> 

#LABELING EXAMPLE 
- info_prenotazione
- info_esame
- info_ricovero
- info_prericovero
- parere_clinico
- info_fertility_center 
- problema_accesso_portale
- problema_registrazione_portale
- info_ritiro_referto_cartella_clinica



CONTESTO SPECIFICO: Richiesta informativa - preferisci etichette info_*

OUTPUT FORMAT (SOLO JSON):
{"predicted_label": "etichetta_precisa", "confidence": 0.X, "motivation": "ragionamento_breve"}

CRITICAL: Genera ESCLUSIVAMENTE JSON valido. Zero testo aggiuntivo.
================================================================================

🔍 TOKENIZZAZIONE PREVENTIVA LLM CLASSIFICATION
============================================================
🤖 ELABORAZIONE CONVERSAZIONE PER LLM
   🆔 Session ID: llm_conversation
   📝 Token prompt: 448
   💬 Token conversazione: 230
   📊 Token totali: 678
   🎯 Limite massimo: 8000
   ✅ Conversazione OK: 678 ≤ 8000
✅ Tokenizzazione LLM completata:
   📊 Token prompt base: 448
   📊 Token conversazione originale: 230
   📊 Token conversazione finale: 230
   📊 Token totali: 678
   📊 Limite configurato: 8000
   ✅ Conversazione entro i limiti, nessun troncamento
============================================================

================================================================================
👤 DEBUG PROMPT USER - DATABASE
================================================================================
📋 Prompt Name: LLM/TEMPLATE/intelligent_classifier_user_template
🏢 Tenant ID: 015007d9-d413-11ef-86a5-96000228e7fe
📏 Text Length: 736 chars
--------------------------------------------------------------------------------
📄 USER PROMPT CONTENT (dopo sostituzione placeholder):
--------------------------------------------------------------------------------
